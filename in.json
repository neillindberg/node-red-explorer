{
    "_id": "Stellaris-Flow-n/flow",
    "_rev": "42-24c4450233df02782ca03d5c1e830543",
    "flow": [
      {
        "id": "57a5a054.9dfd3",
        "type": "tab",
        "label": "System",
        "disabled": false,
        "info": ""
      },
      {
        "id": "61ffb71b.d286f",
        "type": "tab",
        "label": "Devices",
        "disabled": false,
        "info": ""
      },
      {
        "id": "c1ec6ee7.981a18",
        "type": "tab",
        "label": "Sim",
        "disabled": false,
        "info": ""
      },
      {
        "id": "1dff07f1.603c08",
        "type": "tab",
        "label": "Users",
        "disabled": false,
        "info": ""
      },
      {
        "id": "a17d8665.50cb88",
        "type": "tab",
        "label": "Tickets",
        "disabled": false,
        "info": ""
      },
      {
        "id": "c012d9b9.f1e028",
        "type": "tab",
        "label": "Pairing",
        "disabled": false,
        "info": ""
      },
      {
        "id": "fc9978cc.27301",
        "type": "tab",
        "label": "Files",
        "disabled": false,
        "info": ""
      },
      {
        "id": "c13a158d.882c9",
        "type": "tab",
        "label": "Logs",
        "disabled": false,
        "info": ""
      },
      {
        "id": "429bd64.63fc828",
        "type": "tab",
        "label": "Data App",
        "disabled": false,
        "info": ""
      },
      {
        "id": "92b74b12.836b78",
        "type": "tab",
        "label": "Maintenance",
        "disabled": false,
        "info": "These flows are for general maintenance"
      },
      {
        "id": "8c1ef78e.3b4798",
        "type": "tab",
        "label": "DashDB",
        "disabled": false,
        "info": ""
      },
      {
        "id": "313bd1d3.01c06e",
        "type": "subflow",
        "name": "Clean Records 2.1",
        "info": "It looks at the following object to find the object to apply the delete process.\nmsg.records.object\nmsg.payload\nIt then sets msg.records.object with that object\nIf msg.records.delete list exist it goes through each record in msg.object and delete any field that match the list.",
        "category": "",
        "in": [
          {
            "x": 80,
            "y": 160,
            "wires": [
              {
                "id": "f9ef366a.b61188"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 920,
            "y": 140,
            "wires": [
              {
                "id": "51211fa9.904fe",
                "port": 0
              },
              {
                "id": "f9ef366a.b61188",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "bc6ff87.05a2908",
        "type": "subflow",
        "name": "Returns 2.3",
        "info": "Returns act in order of existance:\nmsg.records.returns\nmsg.records.object\nmsg.payload\n\nIf returns exists it uses the array of objectNames and creates a JSON return object containing the msg.objectNames in the order they appear on the list.\nIf object exists it returns msg.object.\nOtherwise it returns the payload unchanged.",
        "category": "",
        "in": [
          {
            "x": 80,
            "y": 200,
            "wires": [
              {
                "id": "e20763f5.33406"
              }
            ]
          }
        ],
        "out": []
      },
      {
        "id": "d35dd8d5.3b2a88",
        "type": "subflow",
        "name": "Cloudant Http 2.2",
        "info": "Variables uses:\n msg.cloudant[\"server\", \"request\", \"body\", ]\nUses msg.cloudant.server as the abse url for the cloudant instance.\nIf not found it creates it from VCAP_CLOUDANT global variable.\nFormats the url using the cloudant base address and \n20190515 2.2 Changed auth to explicit basic header, deleted old versions",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 220,
            "wires": [
              {
                "id": "54621c9b.f201d4"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2400,
            "y": 220,
            "wires": [
              {
                "id": "2a03c952.1c9bc6",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "f83a5f50.ef8e",
        "type": "subflow",
        "name": "Cloudant Setup 2.0",
        "info": "",
        "in": [
          {
            "x": 60,
            "y": 160,
            "wires": [
              {
                "id": "1addfec1.69f9f1"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 960,
            "y": 160,
            "wires": [
              {
                "id": "30b52c07.dc8dd4",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "71afa3f9.81defc",
        "type": "subflow",
        "name": "Inputs 2.2",
        "info": "copies msg.payload to msg.inputs.body and deletes the payload\ncopies msg.inputs.body.fitler_options to msg.fitlers.options if it exist\n\nChecks msg.inputs.body for required and allowed fields from:\nmsg.inputs.required\nmsg.inputs.allowed\n\nChecks msg.filters.options for required and allowed fields from:\nmsg.filters.required\nmsg.fitlers.allowed\n\nChecks for email format\nChecks for uid format\n\nChecks msg.inputs.params and add those values to msg.filters.options\n\nProcess all msg.filters.options and remove \"\" and [] filters from the list.\nProcess the reminder of filters and separate them in 3 lists:\nmsg.filters.values single value filters\nmsg.filters.arrays array of values filters\nmsg.filters.dates _range_begin and _range_end filters\n",
        "category": "",
        "in": [
          {
            "x": 80,
            "y": 120,
            "wires": [
              {
                "id": "9366b740.5b24c8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1960,
            "y": 100,
            "wires": [
              {
                "id": "1cce4f59.4185d1",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "3962857e.44abba",
        "type": "subflow",
        "name": "Authentication 2.1",
        "info": "Imprements Node-Red Authentication for each API",
        "category": "",
        "in": [
          {
            "x": 20,
            "y": 160,
            "wires": [
              {
                "id": "bfe490a.2c4cf7"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1340,
            "y": 80,
            "wires": [
              {
                "id": "81dc9242.80e54",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "5dbd57cc.fc9bb8",
        "type": "subflow",
        "name": "Email 2.2",
        "info": "msg.email =\n{\n  \"send\": \"true\",\n  \"template_type\": \"default\",\n  \"fields\": {},\n  \"to\": [\"to@b.com\"],\n  \"cc\": [\"cc@b.com\"]\n  \"bcc\": [\"bcc@b.com\"]\n  \"topic\": \"\"\n}\nOverrides:\nmsg.email.send === \"false\"\nor\nmsg.email.send === \"true\"\nmsg.api.debug === \"true\"\nmsg.debug.email.to = <override email>\n\nTemplate fields out replaced:\n{{{field}}}",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 100,
            "wires": [
              {
                "id": "bb960040.7d816"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2240,
            "y": 80,
            "wires": [
              {
                "id": "96c73689.41cd78",
                "port": 0
              },
              {
                "id": "bb960040.7d816",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "42e57474.0f0cac",
        "type": "subflow",
        "name": "Cloudant Test Data 2.0",
        "info": "Set \npayload to JSON with the following fields:\n{ \n  \"api_name\": <common name of the API>,\n  \"test_name\": <name of the test>,\n  \"object\": <field in the record to be inserted in payload>\n}\n\nReturns record[object] in payload\nIf no record is found a node.warn is returned and flow stops",
        "in": [
          {
            "x": 40,
            "y": 40,
            "wires": [
              {
                "id": "34cfd7dc.07ad48"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 800,
            "y": 40,
            "wires": [
              {
                "id": "8c590d57.95c94",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "68197f61.7975",
        "type": "subflow",
        "name": "Record Update 2.2",
        "info": "This subflow expects the following\nobject id located in msg.records.id\nobject type located in msg.records.doc_type\nfields to update locate in msg.inputs.body\nNote: msg.inputs.body should not include \"id\" or \"_id\"",
        "category": "",
        "in": [
          {
            "x": 60,
            "y": 220,
            "wires": [
              {
                "id": "90877aec.e498b8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2340,
            "y": 220,
            "wires": [
              {
                "id": "c5424b86.7d0048",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "e0cd8199.1ad77",
        "type": "subflow",
        "name": "Record New 2.2",
        "info": "Verifies the previous http call did not return a record\nIf record is found, returns an error\nGet a model of the record\nUpdate the model with inputs\nInsert the record in Cloudant\nlookup and return the inserted record\n\nuses:\nmsg.records.doc_type to determine which cloudant database to target\nmsg.records.models to setup a model to populate\nmsg.inputs.body to find the fields to populate the model with\n",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 220,
            "wires": [
              {
                "id": "aa7ba18f.b2222"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2760,
            "y": 180,
            "wires": [
              {
                "id": "f5e9fd9a.06e74",
                "port": 0
              },
              {
                "id": "a610ab5b.d8e668",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "df6d98dd.00d378",
        "type": "subflow",
        "name": "Record Model 2.1",
        "info": "Create a msg.records.<model name> for each element in msg.records.models array.\nWarning:\nSome models require sub models.\n\"help_tickets\" model requires \"geo_location\", \"cell_data\", \"cell_tower_info\"\nmsg.records.models array order must be ordered to create sub models first.",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 120,
            "wires": [
              {
                "id": "4b326353.484a3c"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1320,
            "y": 80,
            "wires": [
              {
                "id": "86fcedb.068ad1",
                "port": 0
              },
              {
                "id": "4b326353.484a3c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "2638fa4d.cb43e6",
        "type": "subflow",
        "name": "Return Error 2.1",
        "info": "Format and returns the last error in the msg.errors array",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 160,
            "wires": [
              {
                "id": "66468412.9e2ccc"
              }
            ]
          }
        ],
        "out": []
      },
      {
        "id": "da740a9b.08ed88",
        "type": "subflow",
        "name": "Kore Http 2.0",
        "info": "Expects msg.kore.request to present\nmsg.kore.return_obj contains the field return by KORE (\"d\")\nIf data is return msg.kore.object is needed.",
        "in": [
          {
            "x": 60,
            "y": 140,
            "wires": [
              {
                "id": "8f27b7b4.9190d8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 920,
            "y": 100,
            "wires": [
              {
                "id": "75722218.98ad1c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "f4989ebd.9314",
        "type": "subflow",
        "name": "Object Storage 2.1",
        "info": "2.1 20190515 delete 4K flows and replaced token with IAM Management",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 160,
            "wires": [
              {
                "id": "25f95225.2b743e"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1900,
            "y": 180,
            "wires": [
              {
                "id": "43f0142a.79e35c",
                "port": 1
              }
            ]
          }
        ]
      },
      {
        "id": "a8815016.d1158",
        "type": "subflow",
        "name": "IAM Token 2.0",
        "info": "",
        "in": [
          {
            "x": 40,
            "y": 100,
            "wires": [
              {
                "id": "f57d2f7d.1ee9c"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 860,
            "y": 120,
            "wires": [
              {
                "id": "7270274.a1b58d8",
                "port": 1
              }
            ]
          }
        ]
      },
      {
        "id": "4f94cf29.53815",
        "type": "subflow",
        "name": "SMS 2.2",
        "info": "msg.sms =\n{\n  \"send\": \"true\",\n  \"template_type\": \"default\",\n  \"fields\": {},\n  \"to\": [\"+1-555-123-4567\"]\n}\nTemplate options:\nremove msg.sms.template_type\nmsg.sms.template = <manual template utf-8 string>\n\nOverrides:\nmsg.sms.send === \"false\"\nor\nmsg.sms.send === \"true\"\nmsg.api.debug === \"true\"\nmsg.debug.sms.to = <override sms-number>\n\nTemplate fields out replaced:\n{{{field}}}",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 120,
            "wires": [
              {
                "id": "9d11623.9608ba"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2100,
            "y": 100,
            "wires": [
              {
                "id": "f9cb1c7.d26aee",
                "port": 0
              },
              {
                "id": "9d11623.9608ba",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "d1af1cc8.e0fda",
        "type": "subflow",
        "name": "Google Location 2.0",
        "info": "uses\nmsg.inputs.body.location\nand returns\nmsg.inputs.body.geo_location",
        "in": [
          {
            "x": 40,
            "y": 60,
            "wires": [
              {
                "id": "9531b8f5.005c08"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1500,
            "y": 60,
            "wires": [
              {
                "id": "9531b8f5.005c08",
                "port": 0
              },
              {
                "id": "e220d288.2368c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "e08f785c.844a68",
        "type": "subflow",
        "name": "Support Users 2.1",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 60,
            "y": 120,
            "wires": [
              {
                "id": "ea8d6a75.315508"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1100,
            "y": 120,
            "wires": [
              {
                "id": "ea8d6a75.315508",
                "port": 0
              },
              {
                "id": "7dbf778a.7d5328",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "b6210d1b.09e3a",
        "type": "subflow",
        "name": "Info & Stats 2.0",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 80,
            "y": 180,
            "wires": [
              {
                "id": "7296ac0b.83c144"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 460,
            "y": 180,
            "wires": [
              {
                "id": "6b661b5.70e66e4",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "81f022a0.cad36",
        "type": "subflow",
        "name": "User Mgmt 2.0",
        "info": "Management of User PII stored in memory\n1. add user PII to cloudant user records\n2. sort cloudant records by PII fields\n3. Search user records by PII fields\n4. down filter cloudant user lists by PII fields\n\nmsg.userMgmt = {\n    \"method\": \"Add PII\" //add PII to json or array\n    \"object\": \"users\" //msg.users contains an array of users\n    \"fields\": [\"first_name\", \"last_name\"] //limit the fields to be added. All if property is missing\n}",
        "category": "",
        "in": [
          {
            "x": 60,
            "y": 140,
            "wires": [
              {
                "id": "f43d6fba.3663a"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1140,
            "y": 100,
            "wires": [
              {
                "id": "f43d6fba.3663a",
                "port": 0
              },
              {
                "id": "e72b0ed8.94d46",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "ab306e30.d0cc3",
        "type": "subflow",
        "name": "IAM Mgmt 2.0",
        "info": "Manages all IAM Tokens in the system.\nStored them in TOKENS global variable\ninputs:\nmsg.iam = {\n    \"type\": <type>\n}\nchecks if a valid token is available and return it\nchecks the expiration if present and refresh it if necessary\nuses the appropriate VCAP credentials to get the token\nreturns:\nmsg.iam[type] = <access_token>\nmsg[type].token = \"<token_type> <access_token>\"\nSupported type: cos, cloudant, keyprotect",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 180,
            "wires": [
              {
                "id": "be86d379.943a6"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1720,
            "y": 160,
            "wires": [
              {
                "id": "be86d379.943a6",
                "port": 0
              },
              {
                "id": "5440f228.63411c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "3cbceae5.45c156",
        "type": "subflow",
        "name": "AppID New Device",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 20,
            "y": 120,
            "wires": [
              {
                "id": "19ed28b8.769907"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1480,
            "y": 80,
            "wires": [
              {
                "id": "da807d9a.f69fc",
                "port": 0
              },
              {
                "id": "19ed28b8.769907",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "11fa1bee.eb6984",
        "type": "subflow",
        "name": "AppID Update Device",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 20,
            "y": 260,
            "wires": [
              {
                "id": "bb709a71.dcf858"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2000,
            "y": 200,
            "wires": [
              {
                "id": "34dc469d.d26f8a",
                "port": 0
              },
              {
                "id": "bb709a71.dcf858",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "16e7afc8.9866e",
        "type": "subflow",
        "name": "AppID Lists",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 180,
            "wires": [
              {
                "id": "609f1982.3171a8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1960,
            "y": 180,
            "wires": [
              {
                "id": "8aa34922.d66d78",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "2a17b7c7.4eaf08",
        "type": "subflow",
        "name": "DashDB Http",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 60,
            "y": 100,
            "wires": [
              {
                "id": "b19df8b3.0b1828"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1440,
            "y": 100,
            "wires": [
              {
                "id": "b19df8b3.0b1828",
                "port": 0
              },
              {
                "id": "3ccc46f8.57cdfa",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "5b840ccd.bdbfc4",
        "type": "subflow",
        "name": "DashDB SQL",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 120,
            "wires": [
              {
                "id": "8c5f15d.8f4dce8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1940,
            "y": 100,
            "wires": [
              {
                "id": "b3baa402.ee4498",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "80a169dd.f18e78",
        "type": "subflow",
        "name": "Sim Http 1.1",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 60,
            "y": 160,
            "wires": [
              {
                "id": "5425652f.98238c"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2580,
            "y": 140,
            "wires": [
              {
                "id": "b8d8f269.e59ea",
                "port": 0
              },
              {
                "id": "5425652f.98238c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "f7b5cbff.598508",
        "type": "subflow",
        "name": "Decryption",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 80,
            "wires": [
              {
                "id": "e1900411.9c5ae8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1240,
            "y": 80,
            "wires": [
              {
                "id": "ca46ff2a.7ec5e",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "12505187.8b5d0e",
        "type": "subflow",
        "name": "AppID New User",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 120,
            "wires": [
              {
                "id": "3953d8fd.d97d18"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1480,
            "y": 100,
            "wires": [
              {
                "id": "79db8e2c.ed8df",
                "port": 0
              },
              {
                "id": "3953d8fd.d97d18",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "98ce8d35.4c824",
        "type": "subflow",
        "name": "Webbing Http 2.0",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 140,
            "wires": [
              {
                "id": "d5efcd6a.a13f8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 1820,
            "y": 80,
            "wires": [
              {
                "id": "634242b2.d749bc",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "86df012b.3eb7e",
        "type": "subflow",
        "name": "Encryption",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 160,
            "wires": [
              {
                "id": "ac2f644e.9dd8f8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 780,
            "y": 160,
            "wires": [
              {
                "id": "64c933b6.4c341c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "67ed0408.e2437c",
        "type": "subflow",
        "name": "AppID Update User",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 180,
            "wires": [
              {
                "id": "95eb6b24.16f7f8"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2020,
            "y": 120,
            "wires": [
              {
                "id": "95eb6b24.16f7f8",
                "port": 0
              },
              {
                "id": "45b1df63.9e79a",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "9791a478.8db8f8",
        "type": "subflow",
        "name": "AppID Delete User",
        "info": "",
        "category": "",
        "in": [
          {
            "x": 40,
            "y": 140,
            "wires": [
              {
                "id": "f6e12cb0.b33c6"
              }
            ]
          }
        ],
        "out": [
          {
            "x": 2000,
            "y": 80,
            "wires": [
              {
                "id": "f6e12cb0.b33c6",
                "port": 0
              },
              {
                "id": "6a38926f.37894c",
                "port": 0
              }
            ]
          }
        ]
      },
      {
        "id": "62fcc92b.e876a8",
        "type": "catch",
        "z": "61ffb71b.d286f",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "bab60eaa.3a63e"
          ]
        ]
      },
      {
        "id": "bab60eaa.3a63e",
        "type": "link out",
        "z": "61ffb71b.d286f",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 185,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "c2b4c605.70dce",
        "type": "catch",
        "z": "1dff07f1.603c08",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "fa18c32.a739e4"
          ]
        ]
      },
      {
        "id": "fa18c32.a739e4",
        "type": "link out",
        "z": "1dff07f1.603c08",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 175,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "c9deb5be.0cafc",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID",
        "method": "delete",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 380,
        "wires": [
          [
            "359d6f1.81ae79"
          ]
        ]
      },
      {
        "id": "b46523.d68f1ae",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] User Delete",
        "info": "Set user to inactive if they exist and are set to \nactive. Also sets any links to inactive and deletes\nfiles.",
        "x": 100,
        "y": 340,
        "wires": []
      },
      {
        "id": "686439bb.f798e",
        "type": "http in",
        "z": "c012d9b9.f1e028",
        "name": "",
        "url": "/pairing/pair/device_to_user",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 240,
        "wires": [
          [
            "543f09e7.6d93a8"
          ]
        ]
      },
      {
        "id": "1d94d6c2.d965c9",
        "type": "comment",
        "z": "c012d9b9.f1e028",
        "name": "[CN] [DEVICES] Device User Pair",
        "info": "API paths:\n1. Missing Inputs\n2. Fake user_id\n3. Fake email\n4. Fake device_id\n5. New link record\n6. Existing inactive link record\n7. Existing active link record",
        "x": 150,
        "y": 120,
        "wires": []
      },
      {
        "id": "48f76f93.99f7c8",
        "type": "http in",
        "z": "c012d9b9.f1e028",
        "name": "",
        "url": "/pairing/unpair/:method/id/:id_one/id/:id_two",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 440,
        "wires": [
          [
            "e56e273b.ffa378"
          ]
        ]
      },
      {
        "id": "5232b9f.24173c8",
        "type": "http in",
        "z": "fc9978cc.27301",
        "name": "",
        "url": "/files/file/:file_id/download",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 560,
        "wires": [
          [
            "9e2d292d.0788d8"
          ]
        ]
      },
      {
        "id": "30452576.97619a",
        "type": "comment",
        "z": "fc9978cc.27301",
        "name": "[DEVICES] Settings File Download",
        "info": "This returns the file itself",
        "x": 160,
        "y": 520,
        "wires": []
      },
      {
        "id": "b1cd7fa0.aa0ff8",
        "type": "http in",
        "z": "fc9978cc.27301",
        "name": "",
        "url": "/files/file/:file_id",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 400,
        "wires": [
          [
            "393e4eee.cc57e2"
          ]
        ]
      },
      {
        "id": "f567ea3b.2b037",
        "type": "comment",
        "z": "fc9978cc.27301",
        "name": "[CN] [DEVICES] Settings File Info",
        "info": "This returns the cloudant document information",
        "x": 150,
        "y": 360,
        "wires": []
      },
      {
        "id": "adeb9398.3a078",
        "type": "http in",
        "z": "fc9978cc.27301",
        "name": "",
        "url": "/files/file/:file_id",
        "method": "delete",
        "upload": true,
        "swaggerDoc": "",
        "x": 120,
        "y": 480,
        "wires": [
          [
            "d108f000.97357"
          ]
        ]
      },
      {
        "id": "1ffabe3a.c52db2",
        "type": "comment",
        "z": "fc9978cc.27301",
        "name": "[DEVICES] Settings File Delete",
        "info": "",
        "x": 150,
        "y": 440,
        "wires": []
      },
      {
        "id": "a49f9abe.f1875",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] [ERPLX] KORE Activate To State",
        "info": "",
        "x": 170,
        "y": 120,
        "wires": []
      },
      {
        "id": "9ae4b1ea.9c4f58",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] KORE Custom Info Update",
        "info": "",
        "x": 150,
        "y": 480,
        "wires": []
      },
      {
        "id": "d7bf8863.3055a",
        "type": "catch",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "3a34f75f.ce0b98"
          ]
        ]
      },
      {
        "id": "3a34f75f.ce0b98",
        "type": "link out",
        "z": "c1ec6ee7.981a18",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 175,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "93bc6524.bfd398",
        "type": "catch",
        "z": "c012d9b9.f1e028",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "cbb433fa.24b308"
          ]
        ]
      },
      {
        "id": "cbb433fa.24b308",
        "type": "link out",
        "z": "c012d9b9.f1e028",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 235,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "c4f6496d.97fa98",
        "type": "catch",
        "z": "fc9978cc.27301",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "f9f59051.f09818"
          ]
        ]
      },
      {
        "id": "f9f59051.f09818",
        "type": "link out",
        "z": "fc9978cc.27301",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 175,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "7def1326.713414",
        "type": "catch",
        "z": "c13a158d.882c9",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "5aadbd7c.0eeec4"
          ]
        ]
      },
      {
        "id": "5aadbd7c.0eeec4",
        "type": "link out",
        "z": "c13a158d.882c9",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 175,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "f34cbf73.3358a",
        "type": "comment",
        "z": "c012d9b9.f1e028",
        "name": "[CN] [DEVICES] Device User Unpair",
        "info": "API paths:\n1. Missing Inputs\n2. Active Link record not found\n7. Active Link record found",
        "x": 160,
        "y": 320,
        "wires": []
      },
      {
        "id": "df76e264.5c7708",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] KORE Deactivate",
        "info": "",
        "x": 120,
        "y": 660,
        "wires": []
      },
      {
        "id": "f7f360f6.6436e8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/deactivate",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 700,
        "wires": [
          [
            "c393c069.a7c09"
          ]
        ]
      },
      {
        "id": "cbf65815.edb",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] [ERPLX] KORE Reactivate",
        "info": "",
        "x": 150,
        "y": 300,
        "wires": []
      },
      {
        "id": "6873271a.841af8",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] KORE Plan Code Update",
        "info": "",
        "x": 140,
        "y": 1140,
        "wires": []
      },
      {
        "id": "cd9aa429.1a8688",
        "type": "comment",
        "z": "fc9978cc.27301",
        "name": "[DEVICES] Settings File New",
        "info": "",
        "x": 140,
        "y": 100,
        "wires": []
      },
      {
        "id": "c9bc65a6.e50db8",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] User New Surgeon",
        "info": "Check if user exists, if not send email with one time link to create user",
        "x": 120,
        "y": 980,
        "wires": []
      },
      {
        "id": "1fc3deba.47e321",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/surgeon",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 1020,
        "wires": [
          [
            "6dab3b10.8c28a4"
          ]
        ]
      },
      {
        "id": "dec06ec.6860e9",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "users/verify/:key",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 140,
        "wires": [
          [
            "701a5d1a.ff39a4"
          ]
        ]
      },
      {
        "id": "929715a4.55ebc8",
        "type": "http response",
        "z": "1dff07f1.603c08",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1870,
        "y": 120,
        "wires": []
      },
      {
        "id": "6b388ca.b247f74",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[EULA] Surgeon Verify",
        "info": "",
        "x": 120,
        "y": 101,
        "wires": []
      },
      {
        "id": "d85da47d.445228",
        "type": "function",
        "z": "bc6ff87.05a2908",
        "name": "debug",
        "func": "if(msg.api.debug) {\n    node.warn({\"Returns\": msg});\n}\nvar warn = {};\nif(!msg.api.hasOwnProperty(\"name\")) {\n    msg.api.name = \"API Results\";    \n}\nvar apic = \"\";\nif (msg.api.hasOwnProperty(\"apic\")) {\n    apic = \" - [\" + msg.api.apic.catalog + \"][\" + msg.api.apic.version + \"]\";\n}\nif(msg.api.hasOwnProperty(\"example\")) {\n    warn[msg.api.name + \" - \" + msg.api.example + apic] = { \"Returns\": msg.payload, \"msg\": msg };\n}\nelse {\n   warn[msg.api.name + apic] = msg.payload; \n}\nnode.warn(warn);",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 140,
        "wires": [
          []
        ]
      },
      {
        "id": "1addfec1.69f9f1",
        "type": "function",
        "z": "f83a5f50.ef8e",
        "name": "Setup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 160,
        "wires": [
          [
            "23b78bed.56ef34"
          ]
        ]
      },
      {
        "id": "30b52c07.dc8dd4",
        "type": "function",
        "z": "f83a5f50.ef8e",
        "name": "Cleanup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 160,
        "wires": [
          [
            "44061979.9f3078"
          ]
        ]
      },
      {
        "id": "23b78bed.56ef34",
        "type": "function",
        "z": "f83a5f50.ef8e",
        "name": "Filter To Cloudant",
        "func": "if(msg.hasOwnProperty(\"filters\") && msg.filters.hasOwnProperty(\"options\")){\n    if(msg.hasOwnProperty(\"cloudant\")) {\n        //format filters for cloudant filtering\n        var andFilters = [];\n        if(msg.filters.hasOwnProperty(\"values\")) {\n            Object.keys(msg.filters.values).forEach(function(propertyName){\n                var andObject = {};\n                andObject[propertyName] = msg.filters.values[propertyName];\n                andFilters.push(andObject);\n            });\n        }\n        if(msg.filters.hasOwnProperty(\"arrays\")) {\n            Object.keys(msg.filters.arrays).forEach(function(propertyName){\n                var inArray = {};\n                inArray[propertyName] = {};\n                inArray[propertyName].$in = msg.filters.arrays[propertyName];\n                andFilters.push(inArray);\n            });\n        }\n        if(msg.filters.hasOwnProperty(\"dates\")) {\n        Object.keys(msg.filters.dates).forEach(function(rangePropertyName){\n                var dateObject = {};\n                var dateValue = parseInt(msg.filters.dates[rangePropertyName]);\n                var propertyName = rangePropertyName.substring(0,rangePropertyName.indexOf(\"_range\",0));\n                if(rangePropertyName.includes(\"_range_begin\")){\n                     dateObject[propertyName] = { \"$gt\": dateValue};\n                }\n                else{\n                    dateObject[propertyName] = { \"$lt\": dateValue};\n                }\n                andFilters.push(dateObject);\n            });\n        }\n        if(msg.filters.hasOwnProperty(\"partial\")) {\n        Object.keys(msg.filters.partial).forEach(function(partialPropertyName){\n                var partialObject = {};\n                var partialValue = msg.filters.partial[partialPropertyName];\n                var propertyName = partialPropertyName.substring(0,partialPropertyName.indexOf(\"_partial\",0));\n                partialObject[propertyName] = {\"$regex\": \"(?i)^\" + partialValue};\n                andFilters.push(partialObject);\n            });\n        }\n        if(msg.filters.hasOwnProperty(\"like\")) {\n        Object.keys(msg.filters.like).forEach(function(likePropertyName){\n                var likeObject = {};\n                var likeValue = msg.filters.like[likePropertyName];\n                var propertyName = likePropertyName.substring(0,likePropertyName.indexOf(\"_like\",0));\n                likeObject[propertyName] = {\"$regex\": likeValue};\n                andFilters.push(likeObject);\n            });\n        }\n        /*\n        if(andFilters.length >1) {\n            msg.cloudant.selector = {\"$and\": andFilters};\n        }\n        else {\n            msg.cloudant.selector = andFilters[0];\n        }*/\n        msg.cloudant.selector = {\"$and\": andFilters};\n    }\n}\nif(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"fields\")){\n    msg.cloudant.fields = msg.records.fields;\n}\nif(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"sort\")){\n    msg.cloudant.sort = msg.records.sort; //array of { \"<propertyName>:<value Type>\": \"asc\"/\"desc\" }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 160,
        "wires": [
          [
            "2db3ffe8.069ff"
          ]
        ]
      },
      {
        "id": "44061979.9f3078",
        "type": "function",
        "z": "f83a5f50.ef8e",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Cloudant Setup\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 990,
        "y": 120,
        "wires": [
          []
        ]
      },
      {
        "id": "2db3ffe8.069ff",
        "type": "function",
        "z": "f83a5f50.ef8e",
        "name": "Pagination to Cloudant",
        "func": "if(msg.cloudant.hasOwnProperty(\"pagination\") && msg.cloudant.pagination) {\n    if(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n        if(msg.req.query.hasOwnProperty(\"limit\")) {\n            msg.cloudant.limit = parseInt(msg.req.query.limit);\n        }\n        if(msg.req.query.hasOwnProperty(\"offset\")) {\n            msg.cloudant.skip = parseInt(msg.req.query.offset);\n        }\n        //msg.records.returns.push(\"bookmark\"); //Not Needed\n        msg.cloudant.bookmark_save = true;\n    }\n    else {\n        msg.cloudant.bookmark_save = false;\n    }\n}\nelse {\n    msg.cloudant.bookmark_save = false;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 160,
        "wires": [
          [
            "30b52c07.dc8dd4"
          ]
        ]
      },
      {
        "id": "b0a3f154.45812",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Inputs\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1990,
        "y": 60,
        "wires": [
          []
        ]
      },
      {
        "id": "a6e5ec6a.96ded",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Check Inputs",
        "func": "var errors = [];\nif(msg.hasOwnProperty(\"inputs\")) {\n    if(msg.inputs.hasOwnProperty(\"required\") && Array.isArray(msg.inputs.required))\n    {\n        msg.inputs.required.forEach(function(field)\n        {\n            if(!msg.inputs.body.hasOwnProperty(field))\n            {\n                errors.push(field);\n            }\n        });\n         if(errors.length !== 0)\n        {\n            msg.error_fields = errors;\n            return [ null, msg ];\n        }\n    }\n    if(msg.inputs.hasOwnProperty(\"allowed\") && Array.isArray(msg.inputs.allowed))\n    {\n        if(msg.inputs.hasOwnProperty(\"required\")) {msg.inputs.allowed = msg.inputs.required.concat(msg.inputs.allowed)} //All required fields are allowed\n        Object.keys(msg.inputs.body).forEach(function(field)\n        {\n            if(msg.inputs.allowed.indexOf(field)<0)\n            {\n                delete msg.inputs.body[field]; //remove illegal fields do not error\n                //errors.push(field);\n            }\n        });\n    /* Add if return error for not allowed fields\n         if(errors.length === 0)\n        {\n            return [ msg, null ];\n        }\n        else\n        {\n            msg.headers = {\"Content-type\" : \"application/json\"};\n            msg.statusCode = 400;\n            msg.payload = {\"illegal_body_fields\":[errors]};\n            return [ null, msg ];\n        }\n    */\n    }\n}\n/*if(msg.inputs.body.hasOwnProperty(\"mobile_phone\")){\n    var phone_regex = new RegExp(global.get(\"REGEXP\").mobile_phone,\"g\");\n    if(typeof msg.inputs.body.mobile_phone !== 'string' || (!phone_regex.test(msg.inputs.body.mobile_phone)))\n    {\n        if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n            msg.errors.push({\n                \"code\": 412,\n                \"message\": \"The Mobile Phone (\" + msg.inputs.body.mobile_phone + \") is not in the correct format.\"\n            });\n        return [  null, msg ];\n    }\n}\nif(msg.inputs.body.hasOwnProperty(\"voice_phone\")){\n    var phone_regex = new RegExp(global.get(\"REGEXP\").voice_phone,\"g\");\n    if(typeof msg.inputs.body.voice_phone !== 'string' || (!phone_regex.test(msg.inputs.body.voice_phone)))\n    {\n        if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n            msg.errors.push({\n                \"code\": 412,\n                \"message\": \"The Voice Phone (\" + msg.inputs.body.voice_phone + \") is not in the correct format.\"\n            });\n        return [  null, msg ];\n    }\n}*/\nif(msg.inputs.body.hasOwnProperty(\"password\")){\n    var password_regex = new RegExp(global.get(\"REGEXP\").password,\"g\");\n    if(typeof msg.inputs.body.password !== 'string' || (!password_regex.test(msg.inputs.body.password)))\n    {\n        if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n            msg.errors.push({\n                \"code\": 412,\n                \"message\": \"The password doesn't meet the strength requirements.\"\n            });\n        return [  null, msg ];\n    }\n}\nif(msg.inputs.body.hasOwnProperty(\"system_sn\")){\n    var system_sn_regex = new RegExp(global.get(\"REGEXP\").system_sn,\"g\");\n    msg.inputs.body.system_sn = msg.inputs.body.system_sn.toUpperCase();\n    if(typeof msg.inputs.body.system_sn !== 'string' || (!system_sn_regex.test(msg.inputs.body.system_sn)))\n    {\n        if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n            msg.errors.push({\n                \"code\": 412,\n                \"message\": \"System SN (\" + msg.inputs.body.system_sn + \") not in proper format.\"\n            });\n        return [  null, msg ];\n    }\n}\nif(msg.inputs.body.hasOwnProperty(\"email\")){\n    var re = new RegExp(global.get(\"REGEXP\").email);\n    if(typeof msg.inputs.body.email !== 'string' || (!re.test(msg.inputs.body.email)))\n    {\n        if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n            msg.errors.push({\n                \"code\": 412,\n                \"message\": \"Email (\" + msg.inputs.body.email + \") not in proper format.\"\n            });\n        return [  null, msg ];\n    }\n    msg.inputs.body.email = msg.inputs.body.email.toLowerCase();\n    if(msg.inputs.body.uid && msg.inputs.body.uid.length>0)\n    {   \n        msg.inputs.body.uid = safeToString(msg.inputs.body.uid);\n    }\n}\n\nreturn [ msg, null ];\n\n//Used to convert something to a string\nfunction safeToString(x) {\n  switch (typeof x) {\n    case 'object':\n      return 'object';\n    case 'function':\n      return 'function';\n    default:\n      return x + '';\n  }\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 370,
        "y": 120,
        "wires": [
          [
            "c2650b08.281dc8"
          ],
          [
            "6e62136f.a8385c"
          ]
        ]
      },
      {
        "id": "9366b740.5b24c8",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Setup",
        "func": "msg.inputs.body = Object.assign({},msg.payload);\nif(msg.inputs.body.hasOwnProperty(\"filter_options\") && msg.hasOwnProperty(\"filters\")) { msg.filters.options = Object.assign({},msg.inputs.body.filter_options)}\nmsg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 120,
        "wires": [
          [
            "a6e5ec6a.96ded"
          ]
        ]
      },
      {
        "id": "1cce4f59.4185d1",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Cleanup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1620,
        "y": 120,
        "wires": [
          [
            "b0a3f154.45812"
          ]
        ]
      },
      {
        "id": "c2650b08.281dc8",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Check Filters",
        "func": "var errors = [];\nif(msg.hasOwnProperty(\"filters\")) {\n    if(msg.filters.hasOwnProperty(\"required\")  && msg.filters.hasOwnProperty(\"options\") && Array.isArray(msg.filters.required))\n    {\n        msg.filters.required.forEach(function(field)\n        {\n            if(!msg.filters.options.hasOwnProperty(field))\n            {\n                errors.push(field);\n            }\n        });\n        if(errors.length !== 0)\n        {\n            msg.error_fields = errors;\n            return [ null, msg ];\n        }\n    }\n    if(msg.filters.hasOwnProperty(\"allowed\") && msg.filters.hasOwnProperty(\"options\") && Array.isArray(msg.filters.allowed))\n    {\n        if(msg.filters.hasOwnProperty(\"required\")) {msg.filters.allowed = msg.filters.required.concat(msg.filters.allowed)} //All required fields are allowed\n        Object.keys(msg.filters.options).forEach(function(field)\n        {\n            if(msg.filters.allowed.indexOf(field)<0)\n            {\n                delete msg.filters.options[field]; //remove illegal filter option do not error\n                //node.warn({\"CHK Inputs\": \"Remove Filter\", \"Filter Field\": field});\n                //errors.push(field);\n            }\n        });\n    /* Add if return error for not allowed fields\n         if(errors.length === 0)\n        {\n            return [ msg, null ];\n        }\n        else\n        {\n            msg.headers = {\"Content-type\" : \"application/json\"};\n            msg.statusCode = 400;\n            msg.payload = {\"illegal_filter_options\":[errors]};\n            return [ null, msg ];\n        }\n    */\n    }\n}\nreturn [ msg, null ];",
        "outputs": 2,
        "noerr": 0,
        "x": 550,
        "y": 120,
        "wires": [
          [
            "9120565a.7298f8"
          ],
          [
            "6814fe1c.ec122"
          ]
        ]
      },
      {
        "id": "9120565a.7298f8",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Process Filters",
        "func": "if(msg.hasOwnProperty(\"filters\") && msg.filters.hasOwnProperty(\"params\")){\n    if(!msg.filters.hasOwnProperty(\"options\")){\n        msg.filters.options = {}\n    }\n    Object.keys(msg.filters.params).forEach(function(paramKey)\n    {\n        msg.filters.options[paramKey] = msg.filters.params[paramKey];\n    });\n}\nif(msg.hasOwnProperty(\"filters\") && msg.filters.hasOwnProperty(\"options\")){\n    //remove empty filters\n    Object.keys(msg.filters.options).forEach(function(propertyName){\n    \tvar propertyValue = msg.filters.options[propertyName];\n    \t//check if empty string\n    \tif(propertyValue === \"\" || (propertyValue.length === 0)) {\n    \t\tdelete msg.filters.options[propertyName];\n    \t}\n    });\n    var filterList = Object.assign({},msg.filters.options);\n    msg.filters.values = {}; //will contain single filters\n    msg.filters.dates = {}; //will contain date filters\n    msg.filters.arrays = {}; //will contain array filters\n    msg.filters.partial = {}; //will contain partial filters\n    msg.filters.like = {}; //will contain like filters\n    //move array and time filters to thier lists\n    Object.keys(filterList).forEach(function(propertyName){\n    \tvar propertyValue = filterList[propertyName];\n    \t//relocate if array and not empty to arrayFilter\n    \tif(Array.isArray(propertyValue)){\n    \t\tif(propertyValue.length > 0){\n    \t\t\tmsg.filters.arrays[propertyName] = propertyValue;\n    \t\t}\n    \t\tdelete filterList[propertyName];\n    \t}\n    \t//relocate time filters to timeFilter\n    \tif(propertyName.includes(\"_range_begin\") || propertyName.includes(\"_range_end\")) {\n    \t\tmsg.filters.dates[propertyName] = propertyValue;\n    \t\tdelete filterList[propertyName];\n    \t}\n    \t//relocated partial search\n    \tif(propertyName.includes(\"_like\")) {\n    \t\tmsg.filters.like[propertyName] = propertyValue;\n    \t\tdelete filterList[propertyName];\n    \t}\n    \tmsg.filters.values = filterList;\n    });\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 120,
        "wires": [
          [
            "8bc261aa.d6ad2"
          ]
        ]
      },
      {
        "id": "51fa0754.778cc8",
        "type": "http response",
        "z": "bc6ff87.05a2908",
        "name": "Return",
        "statusCode": "",
        "headers": {},
        "x": 1450,
        "y": 200,
        "wires": []
      },
      {
        "id": "53775c5.a4da7a4",
        "type": "function",
        "z": "bc6ff87.05a2908",
        "name": "IF Http Res Exist",
        "func": "if(msg.hasOwnProperty(\"res\")) {return msg}",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 200,
        "wires": [
          [
            "51fa0754.778cc8"
          ]
        ]
      },
      {
        "id": "701a5d1a.ff39a4",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 140,
        "wires": [
          [
            "951b9520.93d548"
          ]
        ]
      },
      {
        "id": "1e2c5f61.780851",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 1020,
        "wires": [
          [
            "99270dcc.02d"
          ]
        ]
      },
      {
        "id": "359d6f1.81ae79",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 380,
        "wires": [
          [
            "99ed5a41.876fc8"
          ]
        ]
      },
      {
        "id": "543f09e7.6d93a8",
        "type": "subflow:3962857e.44abba",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 410,
        "y": 160,
        "wires": [
          [
            "995dac1d.9d569"
          ]
        ]
      },
      {
        "id": "7b3d1734.bde8f8",
        "type": "subflow:3962857e.44abba",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 430,
        "y": 140,
        "wires": [
          [
            "11388bff.03f9d4"
          ]
        ]
      },
      {
        "id": "393e4eee.cc57e2",
        "type": "subflow:3962857e.44abba",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 430,
        "y": 400,
        "wires": [
          [
            "61f7839a.67e86c"
          ]
        ]
      },
      {
        "id": "9e2d292d.0788d8",
        "type": "subflow:3962857e.44abba",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 430,
        "y": 560,
        "wires": [
          [
            "c7e9071b.9ddcc8"
          ]
        ]
      },
      {
        "id": "d108f000.97357",
        "type": "subflow:3962857e.44abba",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 430,
        "y": 480,
        "wires": [
          [
            "422dc920.572258"
          ]
        ]
      },
      {
        "id": "5925f00f.811ee",
        "type": "catch",
        "z": "a17d8665.50cb88",
        "name": "",
        "scope": null,
        "x": 80,
        "y": 40,
        "wires": [
          [
            "dbc254a8.7a13b8"
          ]
        ]
      },
      {
        "id": "dbc254a8.7a13b8",
        "type": "link out",
        "z": "a17d8665.50cb88",
        "name": "To Error Handling",
        "links": [
          "f0d6de8d.dda6",
          "bd0472cc.d443f"
        ],
        "x": 175,
        "y": 40,
        "wires": [],
        "inputLabels": [
          "Error Handling"
        ]
      },
      {
        "id": "65919f4d.91575",
        "type": "switch",
        "z": "5dbd57cc.fc9bb8",
        "name": "template_type",
        "property": "email.template_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "welcome",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "thankyou",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "acceptance",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "help_ticket",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "rem_conn",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "config_file",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device_birth",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device_change",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 9,
        "x": 500,
        "y": 300,
        "wires": [
          [
            "593bdd0b.fbdf34"
          ],
          [
            "8212c433.518408"
          ],
          [
            "e315f683.67cbd8"
          ],
          [
            "37d7d60f.cf7bba"
          ],
          [
            "5ccb4407.36faec"
          ],
          [
            "25c6e7df.230978"
          ],
          [
            "521ce329.1a21dc"
          ],
          [
            "11c00066.cca8b"
          ],
          [
            "bf320d02.d8846"
          ]
        ]
      },
      {
        "id": "bd2fe652.82c918",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Template Processing",
        "func": "if(msg.email.template && msg.email.fields) {\n    Object.keys(msg.email.fields).forEach(function(field) {\n        var tag = \"{{{\" + field + \"}}}\";\n        msg.email.template = msg.email.template.replace(RegExp(tag, 'g'), msg.email.fields[field])\n    });\n}\nmsg.payload = msg.email.template;\nif(msg.email.topic) {msg.topic = msg.email.topic}\nif(msg.email.to) {\n    if (Array.isArray(msg.email.to)) {\n        msg.to = msg.email.to.join(\" , \");\n    } else {\n        msg.to = msg.email.to;\n    }\n}\nif(msg.email.cc) {\n        if (Array.isArray(msg.email.cc)) {\n        msg.cc = msg.email.cc.join(\" , \");\n    } else {\n        msg.cc = msg.email.cc;\n    }\n}\nif(msg.email.bcc) {\n    if (Array.isArray(msg.email.bcc)) {\n        msg.bcc = msg.email.bcc.join(\" , \");\n    } else {\n        msg.bcc = msg.email.bcc;\n    }\n}\nif(msg.email.files && msg.email.files.length > 0) {\n    // file attachements\n    var file = msg.email.files[0];\n    msg.filename = file.originalname;\n    msg.payload = file.buffer;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1880,
        "y": 120,
        "wires": [
          [
            "96c73689.41cd78"
          ]
        ]
      },
      {
        "id": "96c73689.41cd78",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Debug Setup",
        "func": "var SPACE = global.get(\"SPACE\");\nif ([\"Development\", \"US Test\"].indexOf(SPACE) >= 0) {\n   msg.topic = \"[\" + SPACE + \"] \" + msg.topic;\n}\nif(msg.api.hasOwnProperty(\"debug\") && (msg.api.debug === true || msg.api.debug.override)) {\n    if(msg.hasOwnProperty(\"debug\") && msg.debug.hasOwnProperty(\"email\")){\n        if(msg.debug.email.hasOwnProperty(\"to\")){ msg.to = msg.debug.email.to; }\n        if(msg.debug.email.hasOwnProperty(\"send\") && (msg.debug.email.send === false)){\n            node.warn({\"Email Not Sent to\": msg.to});\n            delete msg.to;\n        } else {\n            node.warn({\"Email Sent to\": msg.to});\n        }\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2090,
        "y": 120,
        "wires": [
          [
            "891726ae.68c7b8",
            "6cc5e7f5.857148"
          ]
        ]
      },
      {
        "id": "b5f8e84c.b5b468",
        "type": "e-mail",
        "z": "5dbd57cc.fc9bb8",
        "server": "smtp.office365.com",
        "port": "587",
        "secure": false,
        "name": "",
        "dname": "Elite.IoT@bausch.com",
        "x": 2500,
        "y": 120,
        "wires": []
      },
      {
        "id": "593bdd0b.fbdf34",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Welcome",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_EULA_v1.html",
            "tot": "str"
          },
          {
            "t": "set",
            "p": "email.topic",
            "pt": "msg",
            "to": "EULA Agreement",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 280,
        "wires": [
          [
            "1b3ef7f5.121ef8"
          ]
        ]
      },
      {
        "id": "8212c433.518408",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Thank You",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_ThankYou_v1.html",
            "tot": "str"
          },
          {
            "t": "set",
            "p": "email.topic",
            "pt": "msg",
            "to": "EULA Agreement Confirmation",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 320,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "e315f683.67cbd8",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Acceptance",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Acceptance_v1.html",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 360,
        "wires": [
          [
            "5a100d21.bc08b4"
          ]
        ]
      },
      {
        "id": "22e14e88.081322",
        "type": "comment",
        "z": "5dbd57cc.fc9bb8",
        "name": "Setup Example",
        "info": "msg.email = {\n    \"template_type\": \"welcome\", //switch value\n    \"topic\": \"Welcome\", //subject of the email\n    \"to\": \"dick.tracy@bausch.com\", /list of destination separated by ','\n    \"fields\": { //JSON that is the template is tagged with {{{field name}}}\n        \"surgeon_first_name\": \"Dick\",\n        \"surgeon_last_name\": \"Tracy\",\n        \"sales_first_name\": \"Roberto\",\n        \"sales_last_name\": \"Lanzara\"\n    }\n};",
        "x": 120,
        "y": 420,
        "wires": []
      },
      {
        "id": "1b3ef7f5.121ef8",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "EULA Link",
        "func": "msg.email.fields.eula_link = msg.apic.url + \"/users/verify/\" + msg.email.key\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1030,
        "y": 280,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "4bbb7397.cd5c4c",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1740,
        "y": 120,
        "wires": [
          [
            "929715a4.55ebc8"
          ]
        ]
      },
      {
        "id": "b7ac4c51.d02d7",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Thank You Email",
        "func": "msg.email = {\n    \"template_type\": \"thankyou\",\n    \"to\": msg.inputs.body.email,\n    \"fields\": {},\n    \"return\": true\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1570,
        "y": 120,
        "wires": [
          [
            "4bbb7397.cd5c4c"
          ]
        ]
      },
      {
        "id": "70bac3a1.fdbdec",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 2100,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "160fa73c.a2f439",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Acceptance Email",
        "func": "msg.email = {\n    \"template_type\": \"acceptance\",\n    \"to\": msg.inputs.body.email,\n    \"fields\": {\n        \"surgeon_first_name\": msg.inputs.body.first_name,\n        \"surgeon_last_name\": msg.inputs.body.last_name,\n        \"sales_first_name\": msg.sales_user[0].first_name,\n        \"sales_last_name\": msg.sales_user[0].last_name\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1930,
        "y": 80,
        "wires": [
          [
            "70bac3a1.fdbdec"
          ]
        ]
      },
      {
        "id": "5a100d21.bc08b4",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Acceptance Topic",
        "func": "msg.email.topic = \"Confirmation of user creation for Dr. \" + msg.email.fields.surgeon_first_name + \" \" + msg.email.fields.surgeon_last_name\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1030,
        "y": 360,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "c4a24f6a.37c1b",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Headers",
        "func": "if (msg.hasOwnProperty(\"req\") && msg.req.hasOwnProperty(\"headers\")) {\n    if (msg.req.headers.hasOwnProperty(\"api_info\")) {\n        msg.api.info = (msg.req.headers.api_info === \"true\");\n    } else {\n        msg.api.info = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_debug\")) {\n        msg.api.debug = (msg.req.headers.api_debug === \"true\");\n    } else {\n        msg.api.debug = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_stats\")) {\n        msg.api.stats = (msg.req.headers.api_stats === \"true\");\n    } else {\n        msg.api.stats = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"debug\")) {\n        msg.debug = JSON.parse(msg.req.headers.debug)\n    }\n    if (msg.req.headers.hasOwnProperty(\"apic\")) {\n        msg.api.apic = JSON.parse(msg.req.headers.apic)\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_encrypt\")) {\n        msg.api.override_encrypt = (msg.req.headers.api_encrypt === \"true\")\n    }\n}\n// override info flag here for vx environment\n//if (global.get(\"VCAP\").app.application_name.substr(-1) === \"x\"){ msg.api.info = true; }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1040,
        "y": 80,
        "wires": [
          [
            "aca5a392.3f18f",
            "81dc9242.80e54"
          ]
        ]
      },
      {
        "id": "b1a1c80a.2529c8",
        "type": "function",
        "z": "313bd1d3.01c06e",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Clean Records\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 100,
        "wires": [
          []
        ]
      },
      {
        "id": "e5007f19.1a783",
        "type": "function",
        "z": "313bd1d3.01c06e",
        "name": "Records Delete Fields",
        "func": "if(msg.records.hasOwnProperty(\"return_deletes\") && msg.records.hasOwnProperty(\"returns\")){\n    var obj_list = msg.records.returns.filter(function(object) {\n       return [\"info\",\"stats\",\"message\"].indexOf(object) < 0; \n    });\n    obj_list.forEach(function(object){\n        if (msg.hasOwnProperty(object) && msg.records.return_deletes.hasOwnProperty(object)) {\n            msg[object].forEach(function(record) {\n                msg.records.return_deletes[object].forEach(function(propertyName){\n                    if(record.hasOwnProperty(propertyName)){\n                        delete record[propertyName];\n                    }\n                });\n            });\n        }\n    });\n    return msg;\n}\nif(msg.records.hasOwnProperty(\"object\") && msg.records.hasOwnProperty(\"delete\")){\n    msg[msg.records.object].forEach(function(record) {\n        msg.records.delete.forEach(function(propertyName){\n            if(record.hasOwnProperty(propertyName)){\n                delete record[propertyName];\n            }\n        });\n    });\n}\nelse {\n    msg.payload.forEach(function(record) {\n        msg.records.delete.forEach(function(propertyName){\n            if(record.hasOwnProperty(propertyName)){\n                delete record[propertyName];\n            }\n        });\n    });\n}\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 180,
        "wires": [
          [
            "51211fa9.904fe"
          ]
        ]
      },
      {
        "id": "f9ef366a.b61188",
        "type": "function",
        "z": "313bd1d3.01c06e",
        "name": "Clean Record Setup",
        "func": "if(!msg.records.hasOwnProperty(\"object\")){\n        if(!msg.cloudant.hasOwnProperty(\"object\")) {\n            msg.records.object = \"payload\";\n        }\n        else {\n            msg.records.object = msg.cloudant.object;\n        }\n}\nif (msg.hasOwnProperty(msg.records.object)) {\n    return [null,msg];\n} else {\n    return [msg,null];\n}\n    ",
        "outputs": 2,
        "noerr": 0,
        "x": 260,
        "y": 160,
        "wires": [
          [],
          [
            "e5007f19.1a783"
          ]
        ],
        "outputLabels": [
          "skip",
          "execute"
        ]
      },
      {
        "id": "51211fa9.904fe",
        "type": "function",
        "z": "313bd1d3.01c06e",
        "name": "Clean Record Cleanup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 180,
        "wires": [
          [
            "b1a1c80a.2529c8"
          ]
        ]
      },
      {
        "id": "34cfd7dc.07ad48",
        "type": "function",
        "z": "42e57474.0f0cac",
        "name": "Get Test Data",
        "func": "msg = msg.payload\nmsg.url = global.get(\"VCAP_CLOUDANT\").credentials.url + \"/test_data/_find\";\nmsg.method = \"POST\";\nmsg.payload = {\n    \"selector\": {\n        \"api_name\": msg.api_name,\n        \"test_name\": msg.test_name\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 180,
        "y": 40,
        "wires": [
          [
            "19b980a0.a9002f"
          ]
        ]
      },
      {
        "id": "19b980a0.a9002f",
        "type": "http request",
        "z": "42e57474.0f0cac",
        "name": "Get Test Data",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 380,
        "y": 40,
        "wires": [
          [
            "8c590d57.95c94"
          ]
        ]
      },
      {
        "id": "8c590d57.95c94",
        "type": "function",
        "z": "42e57474.0f0cac",
        "name": "Inject Data in Payload",
        "func": "if(msg.payload.hasOwnProperty(\"docs\") && msg.payload.docs.length > 0 && msg.hasOwnProperty(\"object\")) {\n    msg = {\n        \"payload\": msg.payload.docs[0][msg.object]\n    }\n    return msg;\n} else {\n    node.warn({\"Cloudant Test Data 2.0\": \"Test Data NOT found\"})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 620,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "37d7d60f.cf7bba",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Help Ticket",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Help_Ticket_00.html",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 400,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "5f138d96.afa2e4",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Record Found",
        "func": "if([\"help_ticket\", \"dapp_user\"].includes(msg.cloudant.doc_type)) { //help_ticket and dapp_user do not have doc_type\n    if(msg.hasOwnProperty(msg.records.object) && msg[msg.records.object].length === 1 && msg[msg.records.object][0]._id === msg.records.id) {\n        msg.records.rev = msg[msg.records.object][0]._rev;\n        return [ msg, null ];\n    } else {\n        return [ null, msg ];\n    }\n} else {\n    if(msg.hasOwnProperty(msg.records.object) && msg[msg.records.object].length === 1 && msg[msg.records.object][0].doc_type === msg.records.doc_type && msg[msg.records.object][0]._id === msg.records.id) {\n        msg.records.rev = msg[msg.records.object][0]._rev;\n        return [ msg, null ];\n    } else {\n        return [ null, msg ];\n    } \n}",
        "outputs": 2,
        "noerr": 0,
        "x": 620,
        "y": 220,
        "wires": [
          [
            "17232310.01f24d"
          ],
          [
            "6296d1ff.4ba9"
          ]
        ]
      },
      {
        "id": "6296d1ff.4ba9",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Record Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Record with id: \" + msg.records.id + \" was not found\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 300,
        "wires": [
          [
            "68e3cec6.a0ed2",
            "1357e27e.bc178e"
          ]
        ]
      },
      {
        "id": "1357e27e.bc178e",
        "type": "function",
        "z": "68197f61.7975",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Update Record\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2370,
        "y": 160,
        "wires": [
          []
        ]
      },
      {
        "id": "17232310.01f24d",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Update Record Values",
        "func": "var record = msg[msg.records.object][0];\nvar update_appid = false;\nvar new_appid = false;\nvar appid_fields = [\"last_name\", \"first_name\", \"email\", \"password\", \"mobile_phone\", \"voice_phone\", \"role\"]; //\"sub_roles\"\nvar appid_objects = [\"device\",\"user\"];\nif (record.hasOwnProperty(\"doc_type\") && appid_objects.indexOf(record.doc_type) >= 0){\n    update_appid = true;\n    if(!msg.appid) { msg.appid = {} }\n    if(record.idp_id) {\n        msg.appid.id = record.idp_id;\n    } else {\n        var appid = global.get(\"APPID\")\n        var record_idx = appid[record.doc_type + \"s\"].c_ids.indexOf(record._id);\n        if(record_idx >= 0){\n            msg.appid.id = appid[record.doc_type + \"s\"].idp_ids[record_idx];\n            msg.inputs.body.idp_id = msg.appid.id;\n        } else {\n            //return an error\n            node.warn(\"WARNING: Record is not in APP ID\");\n            new_appid = true;\n        }\n    }\n    if(msg.records.password){msg.inputs.body.password = msg.records.password}\n    msg.appid.updates = {};\n}\nObject.keys(msg.inputs.body).forEach(function(field){\n    if(field === \"ticket_notes\" && record.hasOwnProperty(field)) {\n        record[field] = record[field] + \"\\n\" + msg.inputs.body[field];\n    } else if(field === \"responder_id\" && record.hasOwnProperty(field)) {\n        record[field].push(msg.inputs.body[field]);\n    } else {\n        if (update_appid && appid_fields.indexOf(field) >=0) {\n            msg.appid.updates[field] = msg.inputs.body[field];\n            record[field] = msg.inputs.body[field]; // update all in cloudant for now\n        } else {\n            record[field] = msg.inputs.body[field];\n        }\n    }\n    if(field === \"_id\" || field === \"c_id\") {msg.appid.updates.c_id = msg.inputs.body[field];}\n});\nif(msg.records.object === \"help_ticket\") {\n    var field_list = [\"contact_name\", \"contact_number\", \"surgeon_settings_name\"];\n    var cryptojs = global.get('cryptojs');\n    var key = global.get('CRYPTO_KEYS').cloudant.payload;\n    field_list.forEach(function(field){\n        var efield = \"e_\" + field;\n        if(record[field]) {\n            if(record[field] !== \"\") {\n                record[efield] = cryptojs.AES.encrypt(JSON.stringify(record[field]),key).toString();\n            } else {\n                record[efield] = \"\";\n            }\n            delete record[field];\n        }\n    })\n}\nmsg[msg.records.object][0] = record;\nif (update_appid && Object.keys(msg.appid.updates).length > 0) {\n    if(new_appid){\n        msg.records[msg.records.object] = record;\n        return [null,null,msg];\n    } else {\n        return [msg,null,null];\n    }\n} else {\n    return [null,msg,null];\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 840,
        "y": 200,
        "wires": [
          [
            "7294442a.03530c"
          ],
          [
            "f5704060.0564c"
          ],
          [
            "3bb8e474.ba6abc"
          ]
        ],
        "outputLabels": [
          "appid update",
          "cloudant only",
          "appid new"
        ]
      },
      {
        "id": "51cdf21e.e0a42c",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Setup Record Reload",
        "func": "msg.cloudant.return_obj = \"\";\nif (msg.hasOwnProperty(msg.records.object)) { delete msg[msg.records.object] }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1920,
        "y": 220,
        "wires": [
          [
            "c5424b86.7d0048"
          ]
        ]
      },
      {
        "id": "9fa0d4af.a95a58",
        "type": "http request",
        "z": "68197f61.7975",
        "name": "PUT Request",
        "method": "PUT",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1700,
        "y": 220,
        "wires": [
          [
            "51cdf21e.e0a42c"
          ]
        ]
      },
      {
        "id": "f5704060.0564c",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Setup Cloudant Insert",
        "func": "msg.url = msg.cloudant.url;\nmsg.headers = msg.cloudant.headers;\nmsg.payload = msg[msg.records.object][0];\nif(!msg.payload.idp_id || msg.payload.idp_id === \"\") {\n    msg.payload.idp_id = msg.records.idp_id;\n    node.warn({\"New Surgeon Add idp_id\":msg});\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 200,
        "wires": [
          [
            "9fa0d4af.a95a58"
          ]
        ]
      },
      {
        "id": "fb687ee1.7f9ad",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Record Not Found",
        "func": "var return_object = msg.records.object;\nif(msg.cloudant.hasOwnProperty(\"object\")){ return_object = msg.cloudant.object }\nif(msg.hasOwnProperty(return_object) && msg[return_object].length > 0 && msg[return_object][0].hasOwnProperty(\"_id\") ){\n    if ( msg.records.doc_type === \"dapp_user\" ) {\n        return [ null, msg ];\n    } else {\n        if ( msg[return_object][0].doc_type === msg.records.doc_type) {\n            return [ null, msg ];\n        } else {\n            return [ msg, null ];\n        }\n    }\n} else {\n    return [ msg, null ];\n}\n",
        "outputs": 2,
        "noerr": 0,
        "x": 610,
        "y": 220,
        "wires": [
          [
            "4e06e02a.6185e"
          ],
          [
            "a610ab5b.d8e668"
          ]
        ]
      },
      {
        "id": "a610ab5b.d8e668",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Record Already Exist",
        "func": "if (!msg.records.hasOwnProperty(\"error_on_exist\") || msg.records.error_on_exist === true) {\n    var error_id = msg.records.id;\n    var error_obj = \"id\";\n    if(msg.records.hasOwnProperty(\"email\")) {\n        error_id = msg.records.email;\n        error_obj = \"email\";\n    }\n    if(msg.records.hasOwnProperty(\"log_id\")) {\n        error_id = msg.records.log_id;\n        error_obj = \"log_id\";\n    }\n    var error_return_object = msg.records.object;\n    if (msg.cloudant.hasOwnProperty(\"object\")) { error_return_object = msg.cloudant.object }\n    if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n    msg.errors.push({\n        \"code\": 400,\n        \"message\": \"The \" + msg.records.object + \" with \" + error_obj + \": \" + error_id + \" already exists.\",\n        \"returns\": [error_return_object]\n    })\n    delete msg[error_return_object][0].doc_type;\n    return [null,msg];\n} else {\n    msg.records.found = true;\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 840,
        "y": 260,
        "wires": [
          [
            "e11bfea5.e8f09"
          ],
          [
            "bf795f.ef8d86a"
          ]
        ],
        "outputLabels": [
          "Exist Override",
          "Exist Error"
        ]
      },
      {
        "id": "e11bfea5.e8f09",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"New Record\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2790,
        "y": 120,
        "wires": [
          []
        ]
      },
      {
        "id": "73b7ca8a.39dd04",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Update Record Values",
        "func": "if ( msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"body\")) {\n    Object.keys(msg.inputs.body).forEach(function(field){\n        msg.records[msg.records.object][field] = msg.inputs.body[field]\n    });\n}\nif(msg.records.object === \"user\" && (msg.records.user.password === \"\" || msg.records.user.email === \"\")) {\n    node.warn({\"User New: Skip Surgeon Create\": msg});\n    return [null,msg];\n}\nif(msg.records.object === \"device\") {\n    msg.records[msg.records.object]._id = msg.records.id\n}\nif(msg.records.object === \"dapp_user\") {\n    msg.records[msg.records.object]._id = msg.records.id;\n    msg.records[msg.records.object].filters.data_user_id = msg.records.id;\n}\nif(msg.records.object === \"help_ticket\") {\n    var field_list = [\"contact_name\", \"contact_number\", \"surgeon_settings_name\"];\n    var cryptojs = global.get('cryptojs');\n    var key = global.get('CRYPTO_KEYS').cloudant.payload;\n    field_list.forEach(function(field){\n        var efield = \"e_\" + field;\n        if(msg.records[msg.records.object][field]) {\n            if(msg.records[msg.records.object][field] !== \"\") {\n                msg.records[msg.records.object][efield] = cryptojs.AES.encrypt(JSON.stringify(msg.records[msg.records.object][field]),key).toString();\n            } else {\n                msg.records[msg.records.object][efield] = \"\";\n            }\n            delete msg.records[msg.records.object][field];\n        }\n    })\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1040,
        "y": 180,
        "wires": [
          [
            "f10e4ede.450cb"
          ],
          [
            "7f36f4fa.4c3d1c"
          ]
        ],
        "outputLabels": [
          "standard",
          "skip (user surgeon)"
        ]
      },
      {
        "id": "20975717.82edb8",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Setup Record Reload",
        "func": "if(msg.payload.hasOwnProperty(\"ok\") && msg.payload.ok && msg.payload.hasOwnProperty(\"id\")) { \n    msg.records.id = msg.payload.id;\n    msg.records[msg.records.object]._id = msg.payload.id;\n    if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"id\")){\n        msg.cloudant.method = \"GET\";\n        msg.cloudant.return_obj = \"\";\n        msg.cloudant.request = \"/\" +  msg.cloudant.db_table + \"/\" + msg.records.id;\n    }\n    return [msg,null];\n} else {\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 2320,
        "y": 180,
        "wires": [
          [
            "f5e9fd9a.06e74"
          ],
          [
            "b84c1252.a892c"
          ]
        ]
      },
      {
        "id": "1d679b99.e2ad74",
        "type": "http request",
        "z": "e0cd8199.1ad77",
        "name": "POST Request",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 2100,
        "y": 180,
        "wires": [
          [
            "20975717.82edb8"
          ]
        ]
      },
      {
        "id": "7f36f4fa.4c3d1c",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Setup Cloudant Insert",
        "func": "if(!msg.cloudant.hasOwnProperty(\"server\")) {\n    var cloudant = global.get(\"VCAP_CLOUDANT\");\n    msg.cloudant.server = \"https://\" + cloudant.credentials.host;\n    msg.cloudant.headers = {\n        \"Authorization\": \"Basic \" + Buffer.from(cloudant.credentials.username + ':' + cloudant.credentials.password).toString('base64')\n    }\n}\nmsg.url = msg.cloudant.server + \"/\" + msg.cloudant.db_table;\nmsg.headers = msg.cloudant.headers;\nmsg.cloudant.body = msg.records[msg.records.object]\nmsg.payload = msg.cloudant.body;\ndelete msg.cloudant.method;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1880,
        "y": 180,
        "wires": [
          [
            "1d679b99.e2ad74"
          ]
        ]
      },
      {
        "id": "495056ad.f6a658",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug) {\n    node.warn({\"Record Models\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1350,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "f41eb87f.3fe8e8",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "user",
        "func": "msg.records.user = {\n  \"doc_type\": \"user\",\n  \"status\": \"active\",\n  \"role\": \"\",\n  \"sub_roles\": [], \n  \"password\": \"\",\n  \"uid\": \"\",\n  \"first_name\": \"\",\n  \"last_name\": \"\",\n  \"mobile_phone\": \"\",\n  \"email\": \"\",\n  \"gets_change_email\": false,\n  \"bart_sart\": \"\",\n  \"business_unit\": \"\",\n  \"sales_area\": \"\",\n  \"sales_region\": \"\",\n  \"sales_territory\": \"\",\n  \"service_area\": \"\",\n  \"service_region\": \"\",\n  \"service_territory\": \"\",\n  \"created_by\": \"\", \n  \"eula_create_date\": 0,\n  \"eula_accept_status\": \"\",\n  \"eula_accept_date\": 0,\n  \"remote_access_allowed\": false,\n  \"idp_id\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 180,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "3d594598.444a5a",
        "type": "switch",
        "z": "df6d98dd.00d378",
        "name": "doc_type",
        "property": "records.model_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "user",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "cell_data",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "geo_location",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "cell_tower_info",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "help_ticket",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "edhr",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "machine_life",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "settings_file",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "machine_link",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "provider_link",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "case",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "dapp_user",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 14,
        "x": 440,
        "y": 220,
        "wires": [
          [
            "f41eb87f.3fe8e8"
          ],
          [
            "e65b1849.fa8ef8"
          ],
          [
            "b50566a4.bafa58"
          ],
          [
            "f6c4cc23.e611d"
          ],
          [
            "b80809e7.3a0438"
          ],
          [
            "1181b084.21530f"
          ],
          [
            "b7a43a54.bed748"
          ],
          [
            "64c927c5.1f5948"
          ],
          [
            "60e8682c.16a928"
          ],
          [
            "36a87de1.f725d2"
          ],
          [
            "d75b2252.f82da"
          ],
          [
            "e237bae3.862198"
          ],
          [
            "3be3718a.91923e"
          ],
          [
            "320704c9.c219fc"
          ]
        ]
      },
      {
        "id": "13f08a81.b16255",
        "type": "link in",
        "z": "df6d98dd.00d378",
        "name": "ForEach_Model",
        "links": [
          "b3d679ba.4c1868"
        ],
        "x": 95,
        "y": 160,
        "wires": [
          [
            "4b326353.484a3c"
          ]
        ]
      },
      {
        "id": "b3d679ba.4c1868",
        "type": "link out",
        "z": "df6d98dd.00d378",
        "name": "ForEach_Model",
        "links": [
          "13f08a81.b16255"
        ],
        "x": 1275,
        "y": 140,
        "wires": []
      },
      {
        "id": "4b326353.484a3c",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "For Each Model",
        "func": "if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"models\") && Array.isArray(msg.records.models) && msg.records.models.length > 0){\n    msg.records.model_type = msg.records.models.pop();\n    return [null, msg];\n}\nelse {\n    // ignore models\n    return [msg, null];\n}\n\n",
        "outputs": 2,
        "noerr": 0,
        "x": 220,
        "y": 120,
        "wires": [
          [
            "495056ad.f6a658"
          ],
          [
            "3d594598.444a5a"
          ]
        ]
      },
      {
        "id": "86fcedb.068ad1",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "Combine for Each",
        "func": "if(msg.records.models.length >= 1){\n    return [null, msg];\n}\nelse {\n    delete msg.records.model_type;\n    return [msg, null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1070,
        "y": 120,
        "wires": [
          [
            "495056ad.f6a658"
          ],
          [
            "b3d679ba.4c1868"
          ]
        ]
      },
      {
        "id": "e65b1849.fa8ef8",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "device",
        "func": "msg.records.device = {\n  \"_id\": \"\",\n  \"doc_type\": \"device\",\n  \"status\": \"active\",\n  \"system_type\": \"\",\n  \"business_unit\": \"\",\n  \"sales_area\": \"\",\n  \"sales_region\": \"\",\n  \"sales_territory\": \"\",\n  \"service_area\": \"\",\n  \"service_region\": \"\",\n  \"service_territory\": \"\",\n  \"customer_id\": \"\",\n  \"facility_id\": \"\",\n  \"facility_name\": \"\",\n  \"facility_address\": \"\",\n  \"sales_status\": \"\",\n  \"status_date\": 0,\n  \"get_me_help_allowed\": false,\n  \"placed_by\": \"\",\n  \"birth_date\": Date.now(),\n  \"edhr_birth_record_id\": \"\",\n  \"idp_id\": \"\",\n  \"password\": \"\",\n  \"email\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 220,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "320704c9.c219fc",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "Not Found",
        "func": "node.warn({\"Model\": \"Not Found\",  \"doc_type\": msg.records.doc_type});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 700,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "1181b084.21530f",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "help_ticket",
        "func": "msg.records.help_ticket = {\n    \"system_sn\": \"\",\n    \"system_type\": \"\",\n    \"doctor_id\": \"\",\n    \"cell_tower_info\": {},\n    \"geo_location\": {},\n    \"address\": \"\",\n    \"start_time\": Date.now(),\n    \"close_time\": 0,\n    \"ticket_status\": \"New\",\n    \"reason\": \"\",\n    \"contact_name\": \"\",\n    \"contact_number\": \"\",\n    \"machine_state\": {},\n    \"assigned_id\": [],\n    \"responder_id\": [],\n    \"ticket_notes\": \"\",\n    \"surgeon_settings_file_id\": \"\",\n    \"surgeon_settings_name\": \"\",\n    \"device_ip\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 380,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "b50566a4.bafa58",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "cell_data",
        "func": "msg.records.cell_data = {\n    \"carrier\" : \"\",\n    \"considerIP\" : false,\n    \"cellTowers\" : [\n        {\n            \"cellId\": 0,\n            \"locationAreaCode\": 0,\n            \"mobileCountryCode\": 0,\n            \"mobileNetworkCode\": 0\n        }\n    ]\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 260,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "b7a43a54.bed748",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "edhr",
        "func": "msg.records.edhr = {\n  \"doc_type\": \"edhr\",\n  \"status\": \"active\",\n  \"system_sn\": \"\",\n  \"system_type\": \"\",\n  \"timestamp\": Date.now(),\n  \"geo_location\": {},\n  \"modlist\": [],\n  \"software_options\": []\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 420,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "f6c4cc23.e611d",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "geo_location",
        "func": "msg.records.geo_location = {\n    \"location\": {\n        \"lat\": 0,\n        \"lng\": 0\n    },\n    \"accuracy\": 0\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 300,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "64c927c5.1f5948",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "machine_life",
        "func": "msg.records.machine_life = {\n    \"doc_type\": \"machine_life\",\n    \"status\": \"active\",\n    \"system_sn\": \"\",\n    \"power_on_time_stamp\": 0,\n    \"prev_power_off_time_stamp\": 0, \n    \"function_accumulator\": []\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 460,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "b80809e7.3a0438",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "cell_tower_info",
        "func": "msg.records.cell_tower_info = {\n    \"Carrier\":\"\",\n    \"CellID\":0,\n    \"LAC\":0,\n    \"MCC\":0,\n    \"MNC\":0\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 340,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "4e06e02a.6185e",
        "type": "subflow:df6d98dd.00d378",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 830,
        "y": 180,
        "wires": [
          [
            "73b7ca8a.39dd04"
          ]
        ]
      },
      {
        "id": "c5424b86.7d0048",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "68197f61.7975",
        "name": "",
        "x": 2150,
        "y": 220,
        "wires": [
          [
            "1357e27e.bc178e",
            "5ded422f.342e1c"
          ]
        ]
      },
      {
        "id": "f5e9fd9a.06e74",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 2550,
        "y": 160,
        "wires": [
          [
            "e11bfea5.e8f09",
            "582c62cd.3bc4ac"
          ]
        ]
      },
      {
        "id": "c8f1b2d5.de0b7",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 390,
        "y": 220,
        "wires": [
          [
            "fb687ee1.7f9ad"
          ]
        ]
      },
      {
        "id": "a009dac3.412498",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "68197f61.7975",
        "name": "",
        "x": 430,
        "y": 220,
        "wires": [
          [
            "5f138d96.afa2e4"
          ]
        ]
      },
      {
        "id": "90877aec.e498b8",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Find Record",
        "func": "if(!msg.hasOwnProperty(\"cloudant\")) {msg.cloudant = {}}\nif(!msg.cloudant.hasOwnProperty(\"id\") && msg.records.hasOwnProperty(\"id\") ) {msg.cloudant.id = msg.records.id}\nif(!msg.cloudant.hasOwnProperty(\"doc_type\") && msg.records.hasOwnProperty(\"doc_type\") ) {msg.cloudant.doc_type = msg.records.doc_type}\nif (msg.hasOwnProperty(msg.cloudant.object)) { delete msg[msg.cloudant.object] }\nif(msg.cloudant.hasOwnProperty(\"id\")){\n    msg.cloudant.db_table = \"stellaris_documents\";\n    msg.cloudant.object=\"doc_type\";\n    msg.cloudant.method = \"GET\";\n    msg.cloudant.return_obj = \"\";\n    if(msg.cloudant.hasOwnProperty(\"doc_type\") && msg.cloudant.doc_type === \"help_ticket\") {\n        msg.cloudant.db_table = \"help_tickets\";\n        msg.cloudant.object = \"help_ticket\";\n    }\n    if(msg.cloudant.hasOwnProperty(\"doc_type\") && (msg.cloudant.doc_type === \"machine_life\" || msg.cloudant.doc_type === \"case\" || msg.cloudant.doc_type === \"edhr\")) {\n        msg.cloudant.db_table = \"stellaris_logs\";\n    }\n    if(msg.cloudant.hasOwnProperty(\"doc_type\") && msg.cloudant.doc_type === \"dapp_user\") { \n        msg.cloudant.db_table = \"dataapp_documents\";\n        msg.cloudant.object = \"dapp_user\";\n    }\n    msg.cloudant.request = \"/\" + msg.cloudant.db_table + \"/\" + msg.cloudant.id;\n    return [msg, null]\n} else {\n    return [null, msg]\n}\n",
        "outputs": 2,
        "noerr": 0,
        "x": 210,
        "y": 220,
        "wires": [
          [
            "a009dac3.412498"
          ],
          [
            "fe7d02fa.eeed3"
          ]
        ]
      },
      {
        "id": "aa7ba18f.b2222",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Find Record",
        "func": "if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"id\") && msg.records.id !== \"\"){\n    msg.cloudant = {\n        \"method\": \"GET\",\n        \"return_obj\": \"\",\n        \"db_table\": \"stellaris_documents\"\n    };\n    if(msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"help_ticket\") {  msg.cloudant.db_table = \"help_tickets\" }\n    if(msg.records.hasOwnProperty(\"doc_type\") && (msg.records.doc_type === \"machine_life\" || msg.records.doc_type === \"case\" || msg.records.doc_type === \"edhr\")) {  msg.cloudant.db_table = \"stellaris_logs\" }\n    if(msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"dapp_user\") { \n        msg.cloudant.db_table = \"dataapp_documents\";\n        msg.cloudant.object = \"dapp_user\";\n    }\n    msg.cloudant.request = \"/\" +  msg.cloudant.db_table + \"/\" + msg.records.id;\n    if (msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"body\")) {\n        if(msg.inputs.body.hasOwnProperty(\"id\")) { delete msg.inputs.body.id }\n        if(msg.inputs.body.hasOwnProperty(\"_id\")) { delete msg.inputs.body._id }\n    }\n    return [null,msg,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"user\" && msg.records.hasOwnProperty(\"email\")){\n    msg.cloudant = {\n        \"db_table\": \"stellaris_documents\",\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"user\",\n        \"selector\": {\n            \"doc_type\": \"user\",\n            \"email\": msg.records.email,\n            \"status\": \"active\"\n        },\n        \"fields\": [\"_id\", \"doc_type\", \"email\"]\n    }\n    return [null,msg,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"case\" && msg.records.hasOwnProperty(\"log_id\")){\n    msg.cloudant = {\n        \"db_table\": \"stellaris_logs\",\n        \"request\": \"/stellaris_logs/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"case\",\n        \"selector\": {\n            \"doc_type\": \"case\",\n            \"log_id\": msg.records.log_id\n        },\n        \"fields\": [\"_id\", \"doc_type\", \"log_id\"]\n    }\n    return [null,msg,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") &&(msg.records.doc_type === \"machine_life\" || msg.records.doc_type === \"edhr\") && !msg.records.hasOwnProperty(\"id\")){\n    msg.cloudant = {\n        \"db_table\": \"stellaris_logs\",\n        \"object\": msg.records.doc_type\n    }\n    return [msg,null,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"help_ticket\" && !msg.records.hasOwnProperty(\"id\")){\n    msg.cloudant = {\n        \"db_table\": \"help_tickets\",\n        \"object\": msg.records.doc_type\n    }\n    return [msg,null,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"settings_file\" && !msg.records.hasOwnProperty(\"id\")){\n    msg.cloudant = {\n        \"db_table\": \"stellaris_documents\",\n        \"object\": msg.records.doc_type\n    }\n    return [msg,null,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"machine_link\"){\n    msg.cloudant = {\n        \"db_table\": \"stellaris_documents\",\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"machine_link\",\n        \"selector\": {\n            \"doc_type\": \"machine_link\",\n            \"user\": msg.inputs.user_id,\n            \"device\": msg.inputs.device_id\n        },\n        \"fields\": [\"_id\", \"doc_type\", \"device\", \"user\"]\n    }\n    return [msg,null,null]\n} else if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"doc_type\") && msg.records.doc_type === \"provider_link\"){\n    msg.cloudant = {\n        \"db_table\": \"stellaris_documents\",\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"provider_link\",\n        \"selector\": {\n            \"doc_type\": \"provider_link\",\n            \"provider_id\": msg.inputs.provider_id,\n            \"consumer_id\": msg.inputs.consumer_id\n        },\n        \"fields\": [\"_id\", \"doc_type\", \"provider_id\", \"consumer_id\"]\n    }\n    return [msg,null,null]\n} else {\n    return [null,null, msg]\n}\n\n    ",
        "outputs": 3,
        "noerr": 0,
        "x": 170,
        "y": 220,
        "wires": [
          [
            "4e06e02a.6185e"
          ],
          [
            "c8f1b2d5.de0b7"
          ],
          [
            "bc93e10d.9f064"
          ]
        ]
      },
      {
        "id": "bc93e10d.9f064",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "doc_type not supported",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The provided doc_type: \" + msg.records.doc_type + \" is not supported by the New Record subflow\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 850,
        "y": 300,
        "wires": [
          [
            "bf795f.ef8d86a"
          ]
        ]
      },
      {
        "id": "fe7d02fa.eeed3",
        "type": "function",
        "z": "68197f61.7975",
        "name": "Invalid id Provided",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Provided ID is not valid\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 340,
        "wires": [
          [
            "1357e27e.bc178e",
            "68e3cec6.a0ed2"
          ]
        ]
      },
      {
        "id": "66468412.9e2ccc",
        "type": "function",
        "z": "2638fa4d.cb43e6",
        "name": "Compile Error",
        "func": "msg.payload = {};\nmsg.api.end_time = Date.now();\nif (msg.api.hasOwnProperty(\"statistics\")) {msg.api.statistics.time_ms = msg.api.end_time - msg.api.start_time}\nif(msg.hasOwnProperty(\"errors\") && msg.errors.length > 0) {\n    var first_error = msg.errors[0];\n    msg.headers = {\"Content-type\" : \"application/json\"};\n    if(typeof first_error.message === \"string\") { msg.payload = { \"error\": first_error.message } } else { msg.payload = { \"error\": first_error.message } }\n    msg.statusCode = first_error.code;\n    if(first_error.hasOwnProperty(\"returns\") && first_error.returns.length > 0) {\n        first_error.returns.forEach(function(object){\n            if(msg.hasOwnProperty(object)){\n                if(msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"format\") && msg.records.format === \"JSON\") {\n                    msg.payload[object] = msg[object][0];\n                }\n                else {\n                    msg.payload[object] = msg[object];\n                }\n            }\n            else{\n                node.warn({\"Returns\": \"Error\", \"Expected object not found in msg: \": object})\n            }\n        });\n    }\n} else {\n    msg.statusCode = 400;\n    msg.payload = { \"error\": \"Unhandled Error was triggered\" }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 200,
        "y": 160,
        "wires": [
          [
            "9340a5fc.f0d5d8"
          ]
        ]
      },
      {
        "id": "fae978dd.b05238",
        "type": "function",
        "z": "2638fa4d.cb43e6",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Return Error\": msg});\n}\nif(!msg.api.hasOwnProperty(\"name\")) {\n    msg.api.name = \"API Results\";    \n}\nvar api_name = \"[ERROR] - Returns\";\nvar apic = \"\";\nif (msg.api.hasOwnProperty(\"apic\")) {\n    apic = \" - [\" + msg.api.apic.catalog + \"][\" + msg.api.apic.version + \"]\";\n}\nif(msg.api.hasOwnProperty(\"example\")) {\n    api_name = \"[ERROR] - \" + msg.api.name + \" - \" + msg.api.example + apic;\n}\nelse {\n   api_name = \"[ERROR] - \" + msg.api.name + apic; \n}\nvar warn = {}\nwarn[api_name] = msg.payload;\nwarn.msg = msg;\nnode.warn(warn);",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 120,
        "wires": [
          []
        ]
      },
      {
        "id": "56b6ae51.32017",
        "type": "http response",
        "z": "2638fa4d.cb43e6",
        "name": "Error",
        "statusCode": "",
        "headers": {},
        "x": 990,
        "y": 160,
        "wires": []
      },
      {
        "id": "4394da9d.caf384",
        "type": "function",
        "z": "2638fa4d.cb43e6",
        "name": "IF Http Res Exist",
        "func": "if(msg.hasOwnProperty(\"res\")) {return msg}\nelse { node.warn({ \"Return Error\": msg}) }",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 160,
        "wires": [
          [
            "56b6ae51.32017"
          ]
        ]
      },
      {
        "id": "68e3cec6.a0ed2",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "68197f61.7975",
        "name": "",
        "x": 1080,
        "y": 340,
        "wires": []
      },
      {
        "id": "bf795f.ef8d86a",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 2820,
        "y": 300,
        "wires": []
      },
      {
        "id": "44304eec.b88b6",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "71afa3f9.81defc",
        "name": "",
        "x": 2020,
        "y": 160,
        "wires": []
      },
      {
        "id": "6e62136f.a8385c",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Missing Required Body Fields",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 412,\n    \"message\": \"Missing required body fields.\",\n    \"returns\": [\"error_fields\"]\n});\nmsg.records.format = \"array\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1690,
        "y": 320,
        "wires": [
          [
            "44304eec.b88b6"
          ]
        ]
      },
      {
        "id": "6814fe1c.ec122",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Missing Required filter_options Fields",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 412,\n    \"message\": \"Missing required filter_options fields.\",\n    \"returns\": [\"error_fields\"]\n});\nmsg.records.format = \"array\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1710,
        "y": 280,
        "wires": [
          [
            "44304eec.b88b6"
          ]
        ]
      },
      {
        "id": "b84c1252.a892c",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Insert Failed",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The \" + msg.records.object + \" insertion failed.\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2530,
        "y": 240,
        "wires": [
          [
            "bf795f.ef8d86a"
          ]
        ]
      },
      {
        "id": "7c53d266.ff837c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "da740a9b.08ed88",
        "name": "",
        "x": 980,
        "y": 180,
        "wires": []
      },
      {
        "id": "d9a454ac.e85b08",
        "type": "function",
        "z": "da740a9b.08ed88",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Kore Http\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 60,
        "wires": [
          []
        ]
      },
      {
        "id": "8f27b7b4.9190d8",
        "type": "function",
        "z": "da740a9b.08ed88",
        "name": "KORE URL",
        "func": "if(msg.hasOwnProperty(\"kore\") && !msg.kore.hasOwnProperty(\"server\")){\n    var kore = global.get(\"VCAP_KORE\");\n    msg.kore.server = kore.credentials.url\n    msg.headers = {\n        \"content-type\": \"application/json\",\n        \"Authorization\": kore.credentials.type + \" \" + kore.credentials.apikey\n    };\n}\nmsg.url = msg.kore.server + \"/json/\" + msg.kore.request\nmsg.payload = msg.kore.body\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 210,
        "y": 140,
        "wires": [
          [
            "d712f801.098658"
          ]
        ]
      },
      {
        "id": "d712f801.098658",
        "type": "http request",
        "z": "da740a9b.08ed88",
        "name": "KORE http",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 390,
        "y": 140,
        "wires": [
          [
            "75722218.98ad1c"
          ]
        ]
      },
      {
        "id": "75722218.98ad1c",
        "type": "function",
        "z": "da740a9b.08ed88",
        "name": "KORE Returns",
        "func": "delete msg.statusCode;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.responseCookies;\nif (msg.kore.return_obj === \"items\" && msg.payload.hasOwnProperty(\"d\")) { msg.payload = msg.payload.d }\nif (msg.payload.hasOwnProperty(msg.kore.return_obj))\n{\n    msg[msg.kore.object] = [];\n    if(Array.isArray(msg.payload[msg.kore.return_obj])) {\n        msg[msg.kore.object] = msg.payload[msg.kore.return_obj];\n    } else {\n        msg[msg.kore.object][0] = msg.payload[msg.kore.return_obj];\n    }\n    msg.payload = {};\n    return [msg, null];\n}\nif (msg.payload.hasOwnProperty(\"errorCode\")) {\n    msg.kore.error = {\n        \"code\": msg.payload.errorCode,\n        \"description\": msg.payload.errorMessage,\n        \"source\": \"kore\"\n    }\n    msg.payload = {};\n    return [null,msg];\n}\nif (typeof msg.payload === \"number\") {\n    msg.kore.return_code = msg.payload;\n    msg.payload = {};\n    if(msg.kore.return_code === 0) {\n        return [msg, null];\n    } else {\n        return [null,msg];\n    }\n}\n\n",
        "outputs": 2,
        "noerr": 0,
        "x": 580,
        "y": 140,
        "wires": [
          [
            "d9a454ac.e85b08"
          ],
          [
            "ecc66f3a.fe958"
          ]
        ],
        "outputLabels": [
          "Data",
          "Error"
        ]
      },
      {
        "id": "ecc66f3a.fe958",
        "type": "function",
        "z": "da740a9b.08ed88",
        "name": "KORE Error",
        "func": "/*if(msg.kore.hasOwnProperty(\"return_code\")) {\n    if(msg.kore.return_code === 1) { msg.kore.error_message = \"Access Denied\" }\n    else if(msg.kore.return_code === 2) { msg.kore.error_message = \"Invalid Action\" }\n    else if(msg.kore.return_code === 3) { msg.kore.error_message = \"Invalid Device Number\" }\n    else { msg.kore.error_message = \"Unknown KORE return code.\"}\n}*/\nif(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": msg.kore.error\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 180,
        "wires": [
          [
            "7c53d266.ff837c"
          ]
        ]
      },
      {
        "id": "e6a4d1f.c44fb3",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 590,
        "y": 1860,
        "wires": [
          [
            "d7ddbf7b.cd38f"
          ]
        ]
      },
      {
        "id": "da8f01e9.05b3e",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/users/role/:role",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 1860,
        "wires": [
          [
            "11e5486f.2c6b08"
          ]
        ]
      },
      {
        "id": "2b53bbc7.445774",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] [DEVICES] Device Users by Role",
        "info": "Similar to Get Device Users but filters to only \ninclude specified role\n",
        "x": 170,
        "y": 1820,
        "wires": []
      },
      {
        "id": "c800309c.a7b85",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Devices by Region",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Devices by Region\"\n    });\nmsg.records = {\n    \"doc_type\": \"device\",\n    \"format\": \"array\",\n    \"object\": \"devices\",\n    \"fields\": [\"_id\", \"system_type\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\", \"customer_id\", \"facility_id\", \"facility_name\", \"facility_address\", \"sales_status\", \"status_date\", \"get_me_help_allowed\", \"placed_by\", \"birth_date\"],\n    \"sort\": [{\"_id:string\": \"asc\"}],\n    \"returns\": [\"devices\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"facility_name\", \"system_type\", \"get_me_help_allowed\", \"sales_status\", \"status_date_range_begin\", \"status_date_range_end\", \"birth_date_range_begin\", \"birth_date_range_end\"]};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.filters.params = {\n    \"doc_type\": msg.records.doc_type,\n    \"status\": \"active\"\n}\nif(msg.req.params.bart_sart === \"bart\"){\n        var area = \"sales_area\";\n        var region = \"sales_region\";\n        var territory = \"sales_territory\";\n}\nelse {\n        var area = \"service_area\";\n        var region = \"service_region\";\n        var territory = \"service_territory\";\n}\nif(msg.req.params.business_unit.trim() != \"ALL\"){\n    msg.filters.params.business_unit =  msg.req.params.business_unit\n\tif(msg.req.params.area.trim() != \"ALL\"){\n\t    msg.filters.params[area] = msg.req.params.area;\n\t    if(msg.req.params.region.trim() != \"ALL\"){\n\t        msg.filters.params[region] = msg.req.params.region;\n\t        if(msg.req.params.territory.trim() != \"ALL\"){\n\t            msg.filters.params[territory] = msg.req.params.territory;\n\t        }\n\t    }\n\t}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 910,
        "y": 2120,
        "wires": [
          [
            "6600b63.2b7c748"
          ]
        ]
      },
      {
        "id": "6600b63.2b7c748",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1080,
        "y": 2120,
        "wires": [
          [
            "82ea1731.21f0a8"
          ]
        ]
      },
      {
        "id": "9e9a8543.2136d8",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 710,
        "y": 2120,
        "wires": [
          [
            "c800309c.a7b85"
          ]
        ]
      },
      {
        "id": "82ea1731.21f0a8",
        "type": "subflow:f83a5f50.ef8e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1250,
        "y": 2120,
        "wires": [
          [
            "be38e306.9877d"
          ]
        ]
      },
      {
        "id": "b28eea96.003b78",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device_query/region/:bart_sart/:business_unit/:area/:region/:territory",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 310,
        "y": 2120,
        "wires": [
          [
            "9e9a8543.2136d8"
          ]
        ]
      },
      {
        "id": "be38e306.9877d",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1450,
        "y": 2120,
        "wires": [
          [
            "afcb683f.2783b8"
          ]
        ]
      },
      {
        "id": "afcb683f.2783b8",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1630,
        "y": 2120,
        "wires": []
      },
      {
        "id": "925bdbb8.f64418",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Devices by Region",
        "info": "Pending\n-IBM Internal Testing/Validation\n-B&L Testing",
        "x": 120,
        "y": 2080,
        "wires": []
      },
      {
        "id": "6b9cb50d.ed09ec",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Query Cases",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Query Cases\"\n    });\nmsg.records = {\n    //\"delete\": [\"_rev\", \"doc_type\"],\n    \"doc_type\": \"case\", //\"user\", \"device\", \"settings_file\", ...\n    \"format\": \"array\", //\"JSON\", \"Complex JSON\"\n    \"object\": \"cases\",\n    \"returns\": [\"cases_count\",\"cases\"],\n    \"fields\": [ \"_id\",\n                \"log_id\",\n                \"system_sn\",\n                \"system_type\",\n                \"location\",\n                \"geo_location\",\n                \"address\",\n                \"user_id\",\n                \"settings_file_name\",\n                \"start_time\",\n                \"stop_time\"\n               ],\n    \"sort\": [{\"stop_time:number\": \"desc\"}]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\", \"return_users\"]\n};\nmsg.filters = {\n    \"allowed\": [\"stop_time_range_begin\" , \"stop_time_range_end\" , \"user_id\"],\n    \"required\": []\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\", //\"payload\", \"parameter\"\n    \"pagination\": true\n};\nmsg.filters.params = {\n    \"system_sn\": msg.req.params.deviceID,\n    \"doc_type\": \"case\"\n};\nif(msg.req.body.hasOwnProperty(\"return_users\") && msg.req.body.return_users === true) {\n    msg.records.returns.push(\"users\");\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 1100,
        "wires": [
          [
            "653b6772.a90c08"
          ]
        ]
      },
      {
        "id": "adeec21.295e54",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 1100,
        "wires": [
          [
            "6b9cb50d.ed09ec"
          ]
        ]
      },
      {
        "id": "653b6772.a90c08",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 920,
        "y": 1100,
        "wires": [
          [
            "1185d464.9784cc"
          ]
        ]
      },
      {
        "id": "83a1dd9a.28cb6",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/logs/cases_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1100,
        "wires": [
          [
            "adeec21.295e54"
          ]
        ]
      },
      {
        "id": "1185d464.9784cc",
        "type": "subflow:f83a5f50.ef8e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1090,
        "y": 1100,
        "wires": [
          [
            "9bee9e05.bdbc5"
          ]
        ]
      },
      {
        "id": "9bee9e05.bdbc5",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1290,
        "y": 1100,
        "wires": [
          [
            "2f460015.d3ce5"
          ]
        ]
      },
      {
        "id": "2f460015.d3ce5",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Case Count",
        "func": "msg.cloudant.pagination = false;\nmsg.cloudant.fields = [\"user_id\"];\nmsg.cloudant.object = \"user_ids\";\ndelete msg.cloudant.sort;\ndelete msg.cloudant.limit;\ndelete msg.cloudant.skip;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1470,
        "y": 1100,
        "wires": [
          [
            "dfb8c8a7.7fd8c8"
          ]
        ]
      },
      {
        "id": "dfb8c8a7.7fd8c8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1650,
        "y": 1100,
        "wires": [
          [
            "20d29d22.c2b2f2"
          ]
        ]
      },
      {
        "id": "20d29d22.c2b2f2",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Distinct user_id List",
        "func": "msg.cases_count = msg.user_ids.length;\nif(msg.hasOwnProperty(\"cases\") && msg.cases.length > 0){\n    var unique_user_ids = [];\n    if(msg.hasOwnProperty(\"user_ids\") && msg.user_ids.length > 0) {\n        msg.user_ids = msg.user_ids.map(a => a.user_id);\n            msg.user_ids.forEach(function(id){\n                if(unique_user_ids.indexOf(id) < 0 && (id !== null) && (id !== \"\")){\n                    unique_user_ids.push(id);\n                }\n        });\n        if(unique_user_ids.length > 0){\n            msg.cloudant.request = \"/stellaris_documents/_find\";\n            msg.cloudant.method = \"POST\";\n            msg.cloudant.selector = { \"_id\":  { \"$in\": unique_user_ids  }};\n            msg.cloudant.fields = [\"_id\", \"first_name\", \"last_name\"];\n            msg.cloudant.sort= [];\n            msg.cloudant.object = \"users\";\n            msg.cloudant.pagination = false;\n            msg.cloudant.bookmark_use = false;\n            msg.cloudant.bookmark_save = false;\n            return [msg, null];\n        }\n    }\n}\nmsg.users = [];\nmsg.api.path = 2;\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1850,
        "y": 1100,
        "wires": [
          [
            "213570ca.bd8e4"
          ],
          [
            "479f4979.b437c8"
          ]
        ]
      },
      {
        "id": "213570ca.bd8e4",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 2050,
        "y": 1060,
        "wires": [
          [
            "479f4979.b437c8"
          ]
        ]
      },
      {
        "id": "479f4979.b437c8",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Add User Name",
        "func": "if(msg.hasOwnProperty(\"cases\") && msg.cases.length > 0){\n    msg.user_ids = msg.users.map(a => a._id);\n    msg.cases.forEach(function(record){\n        var user_index = msg.user_ids.indexOf(record.user_id);\n        var first_name = \"\";\n        var last_name = \"\";\n        if(user_index >= 0){\n            first_name = msg.users[user_index].first_name;\n            last_name = msg.users[user_index].last_name;\n        }\n        record.first_name = first_name;\n        record.last_name = last_name;\n    });\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2240,
        "y": 1100,
        "wires": [
          [
            "e84aa179.d71ac"
          ]
        ]
      },
      {
        "id": "e84aa179.d71ac",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 2410,
        "y": 1100,
        "wires": []
      },
      {
        "id": "d4cff42e.203498",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Query Cases",
        "info": "",
        "x": 130,
        "y": 1060,
        "wires": []
      },
      {
        "id": "fc4d821a.6eaef",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Info",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Info\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"password\", \"doc_type\", \"status\"],\n    \"object\": \"device\",\n    \"format\": \"JSON\",\n    \"returns\": [\"device\", \"edhr\"]\n};\nmsg.inputs = {\n    \"device_id\": msg.req.params.deviceID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.inputs.device_id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 380,
        "wires": [
          [
            "cd21da35.fcb318"
          ]
        ]
      },
      {
        "id": "f0870c4b.e5e78",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 380,
        "wires": [
          [
            "fc4d821a.6eaef"
          ]
        ]
      },
      {
        "id": "cd21da35.fcb318",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 890,
        "y": 380,
        "wires": [
          [
            "d2d90a8b.f2aa78"
          ]
        ]
      },
      {
        "id": "abdb4835.b62b48",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 380,
        "wires": [
          [
            "f0870c4b.e5e78"
          ]
        ]
      },
      {
        "id": "d94cab78.361dd8",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1630,
        "y": 360,
        "wires": [
          [
            "27ce8ddc.b00b62"
          ]
        ]
      },
      {
        "id": "d2d90a8b.f2aa78",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "EDHR Info",
        "func": "if (!msg.hasOwnProperty(\"device\") || !msg.device[0].hasOwnProperty(\"_id\")) {\n    return [null,msg];\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"edhr\",\n    \"selector\": {\n        \"$and\": [{\"system_sn\": msg.inputs.device_id},\n                 {\"doc_type\": \"edhr\"}]\n    },\n    \"fields\": [\"_id\", \"system_sn\", \"system_type\", \"timestamp\", \"geo_location\", \"modlist\", \"software_options\"],\n    \"sort\": [{\"timestamp:number\": \"desc\"}],\n    \"limit\": 1\n};\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1070,
        "y": 380,
        "wires": [
          [
            "d62553c7.c1f2d"
          ],
          [
            "462cf092.5a01d"
          ]
        ]
      },
      {
        "id": "d62553c7.c1f2d",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1250,
        "y": 360,
        "wires": [
          [
            "e82e23f3.b5e2e"
          ]
        ]
      },
      {
        "id": "e82e23f3.b5e2e",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Empty EDHR",
        "func": "if(msg.hasOwnProperty(\"edhr\") && Array.isArray(msg.edhr) && msg.edhr.length === 0) {\n    msg.edhr[0] = {}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1440,
        "y": 360,
        "wires": [
          [
            "d94cab78.361dd8"
          ]
        ]
      },
      {
        "id": "27ce8ddc.b00b62",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1810,
        "y": 360,
        "wires": []
      },
      {
        "id": "19674e75.dc5bc2",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Info",
        "info": "Checks for device in cloudant and\nreturns data without some cloudant/logic fields.",
        "x": 100,
        "y": 340,
        "wires": []
      },
      {
        "id": "1e7df28d.5f119d",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Maintenance Files",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Maintenance Files\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\",\"doc_type\", \"status\"],\n    \"format\": \"array\",\n    \"object\": \"settings_files\",\n    \"returns\": [\"settings_files\"]\n};\nmsg.inputs = {\n    \"device_id\": msg.req.params.deviceID\n};\nmsg.filters = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\n        \"$or\": [\n            {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"device\": msg.inputs.device_id}]},\n            {\"$and\": [{\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": msg.inputs.device_id}]}\n            ]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 700,
        "wires": [
          [
            "22a26830.d90308"
          ]
        ]
      },
      {
        "id": "3e3e2224.0c5eae",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 700,
        "wires": [
          [
            "1e7df28d.5f119d"
          ]
        ]
      },
      {
        "id": "22a26830.d90308",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 970,
        "y": 700,
        "wires": [
          [
            "4bdf6281.10ab5c"
          ]
        ]
      },
      {
        "id": "4bdf6281.10ab5c",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Unique Surgeon Users",
        "func": "msg.unique_user_ids = []\nif (msg.hasOwnProperty(\"devices\") && msg.devices.length >0 && msg.devices[0]._id === msg.inputs.device_id) {\n    if(msg.hasOwnProperty(\"machine_links\") && msg.machine_links.length > 0) {\n        var user_ids = msg.machine_links.map(a => a.user);\n        user_ids.forEach(function(id){\n            if(msg.unique_user_ids.indexOf(id) < 0 && (id !== null) && (id !== \"\")){\n                msg.unique_user_ids.push(id);\n            }\n        })\n        msg.cloudant = {\n            \"request\": \"/stellaris_documents/_find\",\n            \"method\": \"POST\",\n            \"return_obj\": \"docs\",\n            \"object\": \"users\",\n            \"fields\": [\"_id\",\"role\"],\n            \"selector\": {\n                \"doc_type\": \"user\",\n                \"status\": \"active\",\n                \"role\": \"Surgeon\",\n                \"_id\": {\"$in\": msg.unique_user_ids}\n            }\n        };\n        return [msg, null,null];\n    } else {\n        msg.settings_files = [];\n        msg.api.path = 2;\n        return [null, msg,null];\n    }\n}\nreturn [null,null,msg]",
        "outputs": 3,
        "noerr": 0,
        "x": 1180,
        "y": 700,
        "wires": [
          [
            "fb6ec3dc.c771f"
          ],
          [
            "fc11ab63.470a38"
          ],
          [
            "60a33077.686ee"
          ]
        ],
        "outputLabels": [
          "",
          "",
          "no device"
        ]
      },
      {
        "id": "fb6ec3dc.c771f",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1390,
        "y": 680,
        "wires": [
          [
            "b691428f.d32be"
          ]
        ]
      },
      {
        "id": "fc11ab63.470a38",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 2090,
        "y": 700,
        "wires": []
      },
      {
        "id": "b691428f.d32be",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Settings_files by Device and Surgeon",
        "func": "if(msg.hasOwnProperty(\"users\") && msg.users.length > 0){\n    var user_ids = msg.users.map(a => a._id);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"settings_files\",\n        \"fields\": [\"_id\",\"updating_timestamp\",\"file_name\",\"updating_system\",\"user_id\",\"objectDB_id\",\"file_id\"],\n        \"selector\": {\n            \"doc_type\": \"settings_file\",\n            \"status\": \"active\",\n            \"user_id\": {\"$in\": user_ids}\n        }\n    };\n    if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n    if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n    return [msg, null];\n} else {\n    msg.settings_files = [];\n    msg.api.path = 3;\n    return [null, msg];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1650,
        "y": 680,
        "wires": [
          [
            "8c4d8834.9f3658"
          ],
          [
            "fc11ab63.470a38"
          ]
        ]
      },
      {
        "id": "8c4d8834.9f3658",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1910,
        "y": 660,
        "wires": [
          [
            "fc11ab63.470a38"
          ]
        ]
      },
      {
        "id": "1dc30273.a8f99e",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[DEVICES] Device Maintenance",
        "info": "This returns settings files in cloudant for users \nassigned to the device.",
        "x": 150,
        "y": 660,
        "wires": []
      },
      {
        "id": "4ef9d2fa.90724c",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 2300,
        "wires": [
          [
            "420bf8e3.2388a8"
          ]
        ]
      },
      {
        "id": "51206c7c.5ce264",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/partial_deviceID/:partial_deviceID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 220,
        "y": 2300,
        "wires": [
          [
            "4ef9d2fa.90724c"
          ]
        ]
      },
      {
        "id": "a4df82c5.79e99",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Devices Partial ID",
        "info": "Returns Devices by device id matching partial input",
        "x": 120,
        "y": 2260,
        "wires": []
      },
      {
        "id": "3552abc6.5a3964",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 930,
        "y": 2300,
        "wires": [
          [
            "7c4b1e7a.ee495"
          ]
        ]
      },
      {
        "id": "420bf8e3.2388a8",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Devices Partial ID",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Devices Partial ID\"\n    });\nmsg.records = {\n    \"doc_type\": \"device\",\n    \"format\": \"array\",\n    \"object\": \"devices\",\n    \"returns\": [\"devices\"]\n};\nmsg.inputs = {};\nmsg.filters = {\n    \"options\": {}\n};\nmsg.filters.values = {\n    \"doc_type\": \"device\",\n    \"status\": \"active\"\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"selector\": {\n        \"$and\": [{\"doc_type\": \"device\"},\n                 {\"status\": \"active\"},\n                 {\"_id\": { \"$regex\": msg.req.params.partial_deviceID }}]\n    },\n    \"fields\": [\"_id\", \"system_type\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\", \"customer_id\", \"facility_id\", \"facility_name\", \"facility_address\", \"sales_status\", \"status_date\", \"get_me_help_allowed\", \"placed_by\", \"birth_date\"],\n    \"sort\": [{\"_id:string\": \"asc\"}]\n}\nif(msg.req.query.hasOwnProperty(\"limit\")) { msg.cloudant.limit = parseInt(msg.req.query.limit); }\nif(msg.req.query.hasOwnProperty(\"offset\")) { msg.cloudant.skip = parseInt(msg.req.query.offset); }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 2300,
        "wires": [
          [
            "3552abc6.5a3964"
          ]
        ]
      },
      {
        "id": "7c4b1e7a.ee495",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1110,
        "y": 2300,
        "wires": []
      },
      {
        "id": "98bb2284.b6a32",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/logs/machine_life",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 560,
        "wires": [
          [
            "4e0b9f9c.f23d6"
          ]
        ]
      },
      {
        "id": "3697cff4.990eb",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Machine Lifes",
        "info": "",
        "x": 130,
        "y": 520,
        "wires": []
      },
      {
        "id": "4e0b9f9c.f23d6",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 560,
        "wires": [
          [
            "c31a1810.6ae3a8"
          ]
        ]
      },
      {
        "id": "c31a1810.6ae3a8",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Machine Lifes",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Machine Lifes\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"machine_life\",\n    \"format\": \"array\",\n    \"object\": \"machine_lifes\",\n    \"returns\": [\"machine_lifes\"],\n};\nmsg.inputs = {};\nmsg.filters = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\", //\"payload\", \"parameter\"\n    \"pagination\": true,\n    \"bookmark_use\": false,\n    \"selector\": {\n        \"doc_type\": \"machine_life\",\n        \"system_sn\": msg.req.params.deviceID\n    },\n    \"fields\": [\n        \"_id\",\n        \"status\",\n        \"system_sn\",\n        \"function_accumulator\",\n        \"power_on_time_stamp\",\n        \"prev_power_off_time_stamp\"\n           ],\n    \"sort\": [{\"power_on_time_stamp:number\": \"desc\"}]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 560,
        "wires": [
          [
            "12834e2e.2fa082"
          ]
        ]
      },
      {
        "id": "44caf25f.165efc",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1150,
        "y": 560,
        "wires": [
          [
            "2858c3cb.b105ec"
          ]
        ]
      },
      {
        "id": "2858c3cb.b105ec",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1330,
        "y": 560,
        "wires": []
      },
      {
        "id": "12834e2e.2fa082",
        "type": "subflow:f83a5f50.ef8e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 950,
        "y": 560,
        "wires": [
          [
            "44caf25f.165efc"
          ]
        ]
      },
      {
        "id": "ba21b781.afb958",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 1580,
        "wires": [
          [
            "d97a87aa.231238"
          ]
        ]
      },
      {
        "id": "dcd9142f.ab1568",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 1580,
        "wires": [
          [
            "ba21b781.afb958"
          ]
        ]
      },
      {
        "id": "9170e4a0.0fac88",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Update",
        "info": "Checks for device and then updates. Any fields \nother than cloudant/logic ones can be updated",
        "x": 110,
        "y": 1540,
        "wires": []
      },
      {
        "id": "d97a87aa.231238",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Update",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Update\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"device\",\n    \"object\": \"device\",\n    \"format\": \"JSON\",\n    \"returns\": [\"device\"],\n    \"id\": msg.req.params.deviceID\n};\nmsg.inputs = {\n    \"allowed\": [\"status\", \"system_type\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\", \"customer_id\", \"facility_id\", \"facility_name\", \"facility_address\", \"sales_status\", \"status_date\", \"get_me_help_allowed\", \"placed_by\", \"birth_date\"],\n    \"required\": [],\n    \"device_id\": msg.req.params.deviceID\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 1580,
        "wires": [
          [
            "fb807dbd.cbdb2"
          ]
        ]
      },
      {
        "id": "927fc68d.425388",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1250,
        "y": 1580,
        "wires": [
          [
            "5386afd6.ac515"
          ]
        ]
      },
      {
        "id": "fb807dbd.cbdb2",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 880,
        "y": 1580,
        "wires": [
          [
            "ff1da99d.8919b8"
          ]
        ]
      },
      {
        "id": "5386afd6.ac515",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1430,
        "y": 1580,
        "wires": []
      },
      {
        "id": "43985337.bfdbfc",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 270,
        "y": 880,
        "wires": [
          [
            "28717099.edb24"
          ]
        ]
      },
      {
        "id": "b3443c46.9f8e1",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 880,
        "wires": [
          [
            "43985337.bfdbfc"
          ]
        ]
      },
      {
        "id": "a78d7f54.4aa83",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] [ERPLX] Device New",
        "info": "This flow checks if body has id and system_type\nincluded before continuing.\nThen it checks if the ID exists in Cloudant.\nIf it doesn't than we create a new document and \ncreates it in IoTP.\n",
        "x": 130,
        "y": 840,
        "wires": []
      },
      {
        "id": "74272503.f6446c",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device New",
        "func": "var genPwd = global.get(\"genpwd\");\nmsg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device New\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"device\", //\"user\", \"device\", \"settings_file\", ...\n    \"object\": \"device\",\n    \"format\": \"JSON\",\n    \"models\": [\"device\"],\n    \"returns\": [\"device\"],\n    \"return_code\": 201,\n    \"password\": genPwd.generate(global.get(\"PWD_GEN\"))\n};\nmsg.inputs = {\n    \"allowed\": [\"status\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\", \"customer_id\", \"facility_id\", \"facility_name\", \"facility_address\", \"sales_status\", \"status_date\", \"get_me_help_allowed\", \"placed_by\", \"birth_date\"],\n    \"required\": [\"id\", \"system_type\"]\n};\nif(msg.payload.hasOwnProperty(\"id\")) {\n    msg.records.id = msg.payload.id;\n    msg.inputs.device_id = msg.payload.id;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 880,
        "wires": [
          [
            "6f85db50.5efd64"
          ]
        ]
      },
      {
        "id": "4e07670a.ba2538",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 900,
        "y": 880,
        "wires": [
          [
            "865e8269.a0baa"
          ]
        ]
      },
      {
        "id": "865e8269.a0baa",
        "type": "subflow:e0cd8199.1ad77",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1060,
        "y": 880,
        "wires": [
          [
            "fb3cad03.2c30a"
          ]
        ]
      },
      {
        "id": "ff1da99d.8919b8",
        "type": "subflow:68197f61.7975",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1050,
        "y": 1580,
        "wires": [
          [
            "927fc68d.425388"
          ]
        ]
      },
      {
        "id": "fb3cad03.2c30a",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1250,
        "y": 880,
        "wires": [
          [
            "880a03ea.a0a8d"
          ]
        ]
      },
      {
        "id": "ec1fc6ba.b78038",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 280,
        "wires": [
          [
            "2b9f4642.62eada"
          ]
        ]
      },
      {
        "id": "cc93554d.279138",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/help",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 280,
        "wires": [
          [
            "ec1fc6ba.b78038"
          ]
        ]
      },
      {
        "id": "b33b1b34.1707d8",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[DEVICE] Device Help Allowed",
        "info": "Similar to get Device Data but only returns help \nflag",
        "x": 150,
        "y": 240,
        "wires": []
      },
      {
        "id": "2b9f4642.62eada",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Help Allowed",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Help Allowed\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\", \"system_type\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\", \"facility_name\", \"facility_address\", \"sales_status\", \"status_date\", \"customer_id\", \"facility_id\", \"placed_by\", \"birth_date\",\"edhr_birth_record_id\"],\n    \"doc_type\": \"device\",\n    \"object\": \"device\",\n    \"format\": \"JSON\",\n    \"returns\": [\"device\"],\n    \"id\": msg.req.params.deviceID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.req.params.deviceID,\n    \"method\": \"GET\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 280,
        "wires": [
          [
            "3968ed8d.c17272"
          ]
        ]
      },
      {
        "id": "3968ed8d.c17272",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 950,
        "y": 280,
        "wires": [
          [
            "6300f0e4.c7701"
          ]
        ]
      },
      {
        "id": "1360a50b.80cecb",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Users",
        "info": "This returns an array of documents of users \npaired to a device",
        "x": 110,
        "y": 1720,
        "wires": []
      },
      {
        "id": "d40f7c31.814cb",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/users",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 1760,
        "wires": [
          [
            "4f9e1739.3ceb98"
          ]
        ]
      },
      {
        "id": "d8827839.727638",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 1760,
        "wires": [
          [
            "2657e692.db45da"
          ]
        ]
      },
      {
        "id": "46328c96.587d34",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 890,
        "y": 1760,
        "wires": [
          [
            "9b7473f5.0e646"
          ]
        ]
      },
      {
        "id": "e710b701.e50df8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1270,
        "y": 1740,
        "wires": [
          [
            "80e18637.e25728"
          ]
        ]
      },
      {
        "id": "29eb87f5.122698",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1650,
        "y": 1760,
        "wires": []
      },
      {
        "id": "2657e692.db45da",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Users",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Users\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"users\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"returns\": [\"users\"]\n};\nmsg.inputs = {\n    \"device_id\": msg.req.params.deviceID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": msg.inputs.device_id}]},\n                {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"device\": msg.inputs.device_id}]}]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 1760,
        "wires": [
          [
            "46328c96.587d34"
          ]
        ]
      },
      {
        "id": "9b7473f5.0e646",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Paired User Ids",
        "func": "if (!msg.hasOwnProperty(\"devices\") || msg.devices.length === 0) {\n    return [null,null,msg];\n}\nif (msg.hasOwnProperty(\"machine_links\") && msg.machine_links.length > 0) {\n    msg.paired_user_ids = msg.machine_links.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"selector\": {\n            \"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\":  { \"$in\": msg.paired_user_ids }}]\n        },\n        \"sort\": [{ \"last_name:string\": \"asc\"}],\n        \"object\": \"users\"\n    };\n    if(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n        if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n        if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n    }\n    return [msg,null,null];\n}\nmsg.users = [];\nmsg.api.path = 2;\nreturn [null,msg,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1080,
        "y": 1760,
        "wires": [
          [
            "e710b701.e50df8"
          ],
          [
            "29eb87f5.122698"
          ],
          [
            "d66b9503.38cc28"
          ]
        ],
        "outputLabels": [
          "yes paired",
          "no paired",
          "no device"
        ]
      },
      {
        "id": "880a03ea.a0a8d",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "add clientId & authToken",
        "func": "msg.device[0].mqtt_clientId = msg.device[0]._id;\nmsg.device[0].mqtt_authToken = msg.records.password;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1470,
        "y": 880,
        "wires": [
          [
            "4fca716f.e6562"
          ]
        ]
      },
      {
        "id": "4fca716f.e6562",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1670,
        "y": 880,
        "wires": []
      },
      {
        "id": "cdb0e8ba.fab598",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device EDHRs",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device EDHRs\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"password\", \"doc_type\", \"status\"],\n    \"doc_type\": \"edhr\",\n    \"format\": \"array\",\n    \"object\": \"edhrs\",\n    \"fields\": [\"_id\", \"system_sn\", \"system_type\", \"timestamp\", \"geo_location\", \"modlist\", \"software_options\"],\n    \"sort\": [{\"timestamp:number\": \"desc\"}],\n    \"returns\": [\"edhrs\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": []\n};\nmsg.filters = {\n    \"allowed\": [],\n    \"required\": []\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true\n};\nmsg.filters.params = {\n    \"system_sn\": msg.req.params.deviceID,\n    \"doc_type\": \"edhr\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 140,
        "wires": [
          [
            "3d70ed41.3ef232"
          ]
        ]
      },
      {
        "id": "ad824aa7.b8df68",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 140,
        "wires": [
          [
            "cdb0e8ba.fab598"
          ]
        ]
      },
      {
        "id": "3d70ed41.3ef232",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 880,
        "y": 140,
        "wires": [
          [
            "da446430.465b28"
          ]
        ]
      },
      {
        "id": "d076e27b.08b44",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/logs/edhr",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 140,
        "wires": [
          [
            "ad824aa7.b8df68"
          ]
        ]
      },
      {
        "id": "da446430.465b28",
        "type": "subflow:f83a5f50.ef8e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1050,
        "y": 140,
        "wires": [
          [
            "9d25c8f6.8767b8"
          ]
        ]
      },
      {
        "id": "9d25c8f6.8767b8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1250,
        "y": 140,
        "wires": [
          [
            "362a67a3.030188"
          ]
        ]
      },
      {
        "id": "362a67a3.030188",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1430,
        "y": 140,
        "wires": []
      },
      {
        "id": "fbc3af0.876ce5",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device EDHR",
        "info": "",
        "x": 110,
        "y": 100,
        "wires": []
      },
      {
        "id": "6300f0e4.c7701",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1150,
        "y": 280,
        "wires": [
          [
            "973d8b53.713388"
          ]
        ]
      },
      {
        "id": "973d8b53.713388",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1330,
        "y": 280,
        "wires": []
      },
      {
        "id": "cc806b8d.710d78",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] [ERPLX] KORE Status",
        "info": "",
        "x": 140,
        "y": 820,
        "wires": []
      },
      {
        "id": "20d575d6.1807ca",
        "type": "comment",
        "z": "c1ec6ee7.981a18",
        "name": "[CN] KORE Plan Codes",
        "info": "",
        "x": 120,
        "y": 1000,
        "wires": []
      },
      {
        "id": "a5c84bb.37d00b8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/plan_codes",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 1040,
        "wires": [
          [
            "b5c4a534.d50fa8"
          ]
        ]
      },
      {
        "id": "b7ab7769.c2efb8",
        "type": "function",
        "z": "f4989ebd.9314",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Object Storage\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1930,
        "y": 140,
        "wires": [
          []
        ]
      },
      {
        "id": "9c968e0d.e9e5e",
        "type": "function",
        "z": "f4989ebd.9314",
        "name": "Object Storage Message",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": msg.cos.message\n})\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1690,
        "y": 60,
        "wires": [
          [
            "b1b0bc4a.da5dd"
          ]
        ]
      },
      {
        "id": "b1b0bc4a.da5dd",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "f4989ebd.9314",
        "name": "",
        "x": 1960,
        "y": 80,
        "wires": []
      },
      {
        "id": "f269bccf.265eb",
        "type": "function",
        "z": "f4989ebd.9314",
        "name": "Object Storage Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": msg.payload.Error.Message[0],\n    \"returns\": [ \"cos_error\" ]\n})\nmsg.cos_error = {\n    \"Code\": msg.payload.Error.Code[0],\n    \"Message\": msg.payload.Error.Message[0],\n    \"Resource\": msg.payload.Error.Resource[0],\n    \"RequestId\": msg.payload.Error.RequestId[0],\n    \"httpStatusCode\": msg.payload.Error.httpStatusCode[0]\n}\nnode.warn({\"COS Error\": msg.payload});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1700,
        "y": 100,
        "wires": [
          [
            "b1b0bc4a.da5dd"
          ]
        ]
      },
      {
        "id": "25f95225.2b743e",
        "type": "function",
        "z": "f4989ebd.9314",
        "name": "Check Inputs",
        "func": "if (!msg.cos.hasOwnProperty(\"container\") && !msg.cos.hasOwnProperty(\"filename\")) {\n    msg.cos.message = \"Object Storage with missing inputs (container, filename).\";\n    return [msg,null,null];\n} \nif (!msg.cos.hasOwnProperty(\"method\")) {\n    msg.cos.message = \"Object Storage called with missing method (GET, PUT, DELETE).\";\n    return [msg,null,null];\n}\nif (msg.cos.method === \"PUT\" && !msg.cos.hasOwnProperty(\"file\")) {\n    msg.cos.message = \"Object Storage PUT request with missing file.\";\n    return [msg,null,null];\n}\nvar COS = global.get(\"VCAP_COS\");\nif (!msg.cos.hasOwnProperty(\"server\")) { msg.cos.server = COS.url }\nif (!msg.cos.hasOwnProperty(\"id\")) { msg.cos.id = COS.credentials.resource_instance_id }\nif (!msg.cos.hasOwnProperty(\"base_path\") && COS.base_path !== \"\") { msg.cos.base_path = COS.base_path }\nif (msg.cos.hasOwnProperty(\"base_path\")) {\n    msg.cos.url = msg.cos.server + \"/\" + msg.cos.base_path + \".\" + msg.cos.container + \"/\" + msg.cos.filename;\n} else {\n    msg.cos.url = msg.cos.server + \"/\" + msg.cos.container + \"/\" + msg.cos.filename;\n}\nif(!msg.iam) { msg.iam = {}; }\nmsg.iam.type = \"cos\";\nreturn [null,msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 250,
        "y": 160,
        "wires": [
          [
            "9c968e0d.e9e5e"
          ],
          [
            "e8efde41.fb3c3"
          ]
        ],
        "outputLabels": [
          "error",
          "ok"
        ]
      },
      {
        "id": "9f08a84b.dfa518",
        "type": "function",
        "z": "a8815016.d1158",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"IAM Token\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 890,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "f57d2f7d.1ee9c",
        "type": "function",
        "z": "a8815016.d1158",
        "name": "IAM Inputs",
        "func": "if (msg.hasOwnProperty(\"iam\") && msg.iam.hasOwnProperty(\"apikey\")){\n    msg.iam.url = \"https://iam.bluemix.net/oidc/token\";\n    msg.iam.body = \"grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey=\" + msg.iam.apikey + \"&response_type=cloud_iam\"\n    msg.iam.headers = {\n        \"accept\": \"application/json\",\n        \"content-type\": \"application/x-www-form-urlencoded\"\n    };\n} else {\n    return [msg,null]\n}\nmsg.url = msg.iam.url;\n//msg.url = \"https://iam.bluemix.net/oidc/token\";\nmsg.headers = msg.iam.headers;\nmsg.payload = msg.iam.body;\n//msg.payload = \"grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey=WPplASjWGKPKJeF-HCcVDk-OfgQ1wcT059f6I57zXI7X&response_type=cloud_iam\"\nreturn [null,msg]",
        "outputs": 2,
        "noerr": 0,
        "x": 190,
        "y": 100,
        "wires": [
          [
            "c626119d.cdecf"
          ],
          [
            "a6247270.c8aee"
          ]
        ],
        "outputLabels": [
          "error",
          "ok"
        ]
      },
      {
        "id": "a6247270.c8aee",
        "type": "http request",
        "z": "a8815016.d1158",
        "name": "POST",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 350,
        "y": 120,
        "wires": [
          [
            "7270274.a1b58d8"
          ]
        ]
      },
      {
        "id": "7270274.a1b58d8",
        "type": "function",
        "z": "a8815016.d1158",
        "name": "Auth Token",
        "func": "if (msg.statusCode === 200) {\n    msg.iam.auth = Object.assign(msg.payload, msg.iam.auth)\n    if (msg.iam.hasOwnProperty(\"add_obj\") && msg.hasOwnProperty(msg.iam.add_obj)) { msg[msg.iam.add_obj].auth = msg.iam.auth }\n    msg.payload = {};\n    delete msg.headers;\n    delete msg.url;\n    delete msg.statusCode;\n    delete msg.reponseUrl;\n    delete msg.responseCookies;\n    return [null,msg];\n} else {\n    return [msg,null]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 510,
        "y": 120,
        "wires": [
          [
            "447a939f.1a92fc"
          ],
          [
            "9f08a84b.dfa518"
          ]
        ],
        "outputLabels": [
          "error",
          "ok"
        ]
      },
      {
        "id": "c626119d.cdecf",
        "type": "function",
        "z": "a8815016.d1158",
        "name": "IAM Inputs Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"IAM subflow missing inputs\"\n})",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 20,
        "wires": [
          [
            "97678e95.32f21"
          ]
        ]
      },
      {
        "id": "97678e95.32f21",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "a8815016.d1158",
        "name": "",
        "x": 920,
        "y": 40,
        "wires": []
      },
      {
        "id": "447a939f.1a92fc",
        "type": "function",
        "z": "a8815016.d1158",
        "name": "IAM Auth Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": msg.payload\n})",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 60,
        "wires": [
          [
            "97678e95.32f21"
          ]
        ]
      },
      {
        "id": "dcfa8b29.377188",
        "type": "function",
        "z": "f4989ebd.9314",
        "name": "COS Http Setup",
        "func": "if (!msg.cos.headers) { msg.cos.headers = {}; }\nmsg.cos.headers.Authorization = msg.cos.authorization;\nmsg.method = msg.cos.method\nmsg.url = msg.cos.url\nmsg.headers = msg.cos.headers\nif (msg.cos.method === \"PUT\") {\n    msg.payload = msg.cos.file.buffer;\n    msg[\"content-type\"] = msg.cos.file.mimetype;\n} else {\n    msg.payload = {};\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 180,
        "wires": [
          [
            "d11807d.309b6f8"
          ]
        ]
      },
      {
        "id": "43f0142a.79e35c",
        "type": "function",
        "z": "f4989ebd.9314",
        "name": "COS Http Return",
        "func": "delete msg.headers;\ndelete msg.url;\ndelete msg.responseUrl;\nif (msg.method === \"GET\") {\n    if (msg.statusCode === 200) {\n        if (msg.cos.hasOwnProperty(\"object\")) {\n            msg[msg.cos.object] = msg.payload;\n        } else {\n            msg.cos.return = msg.payload;\n        }\n        msg.payload = {};\n        delete msg.method;\n        delete msg.statusCode;\n        return [null,msg];\n    }\n}\nif (msg.method === \"PUT\") {\n    if (msg.statusCode === 200) {\n        if (msg.cos.hasOwnProperty(\"object\")) { msg[msg.cos.object] = \"File \" + msg.cos.filename + \" was successfully added\" }\n        delete msg.method;\n        delete msg.statusCode;\n        return [null,msg];\n    }\n}\nif (msg.method === \"DELETE\") {\n    if (msg.statusCode === 204) {\n        if (msg.cos.hasOwnProperty(\"object\")) {msg[msg.cos.object] = \"File \" + msg.cos.filename + \" was successfully deleted\" }\n        delete msg.method;\n        delete msg.statusCode;\n        return [null,msg];\n    }\n}\ndelete msg.method;\nmsg.payload = msg.payload.toString(\"utf-8\");\nreturn [msg,null]",
        "outputs": 2,
        "noerr": 0,
        "x": 1090,
        "y": 180,
        "wires": [
          [
            "d118bfe4.87601"
          ],
          [
            "b7ab7769.c2efb8"
          ]
        ],
        "outputLabels": [
          "error",
          "ok"
        ]
      },
      {
        "id": "d118bfe4.87601",
        "type": "xml",
        "z": "f4989ebd.9314",
        "name": "COS Error",
        "property": "payload",
        "attr": "",
        "chr": "",
        "x": 1490,
        "y": 100,
        "wires": [
          [
            "f269bccf.265eb"
          ]
        ]
      },
      {
        "id": "61f7839a.67e86c",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Settings File Info",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Settings File Info\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"settings_file\",\n    \"object\": \"settings_file\",\n    \"format\": \"JSON\",\n    \"returns\": [\"settings_file\"]\n};\nmsg.inputs = {\n    \"file_id\": msg.req.params.file_id\n};\nmsg.filters = {};\nmsg.filters.params = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"settings_file\",\n    \"selector\": {\n        \"file_id\": msg.inputs.file_id,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\"\n    },\n    \"sort\": [{\"updating_timestamp:number\": \"asc\"}]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 400,
        "wires": [
          [
            "3c1c7788.cd9538"
          ]
        ]
      },
      {
        "id": "3c1c7788.cd9538",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 830,
        "y": 400,
        "wires": [
          [
            "3c9946e9.11561a"
          ]
        ]
      },
      {
        "id": "28e890af.5d066",
        "type": "subflow:bc6ff87.05a2908",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1350,
        "y": 380,
        "wires": []
      },
      {
        "id": "3c9946e9.11561a",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Exist",
        "func": "if (!msg.hasOwnProperty(\"settings_file\") || msg.settings_file.length === 0 || msg.settings_file[0].doc_type !== \"settings_file\") {\n    return [null,msg]\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1000,
        "y": 400,
        "wires": [
          [
            "83d350cf.1e6e"
          ],
          [
            "36c0c3d1.557abc"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "d6ed1de9.c2986",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1340,
        "y": 420,
        "wires": []
      },
      {
        "id": "36c0c3d1.557abc",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active File \" + msg.inputs.file_id + \" doesn't exist\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 420,
        "wires": [
          [
            "d6ed1de9.c2986"
          ]
        ]
      },
      {
        "id": "c7e9071b.9ddcc8",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Settings File Download",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Settings File Download\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"settings_file\",\n    \"format\": \"JSON\",\n    \"returns\": [\"file\"]\n};\nmsg.inputs = {\n    \"file_id\": msg.req.params.file_id\n};\nmsg.filters = {};\nmsg.filters.params = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"settings_file\",\n    \"selector\": {\n        \"file_id\": msg.inputs.file_id,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\"\n    },\n    \"sort\": [{\"updating_timestamp:number\": \"asc\"}]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 560,
        "wires": [
          [
            "3cb8037b.a2fd9c"
          ]
        ]
      },
      {
        "id": "3cb8037b.a2fd9c",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 850,
        "y": 560,
        "wires": [
          [
            "be057315.791e7"
          ]
        ]
      },
      {
        "id": "be057315.791e7",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Exist",
        "func": "if (!msg.hasOwnProperty(\"settings_file\") || msg.settings_file.length === 0 || msg.settings_file[0].doc_type !== \"settings_file\" || msg.settings_file[0].objectDB_id === \"\") {\n    return [null,msg]\n}\nmsg.cos = {\n    \"method\": \"GET\",\n    \"object\": \"file\",\n    \"filename\": msg.settings_file[0].objectDB_id,\n    \"container\": \"stellaris-settings\"\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1020,
        "y": 560,
        "wires": [
          [
            "10841c1e.c6fe34"
          ],
          [
            "8af95a39.cc1db8"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "ab36f240.b3a58",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1360,
        "y": 580,
        "wires": []
      },
      {
        "id": "8af95a39.cc1db8",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active File \" + msg.inputs.file_id + \" doesn't exist\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 580,
        "wires": [
          [
            "ab36f240.b3a58"
          ]
        ]
      },
      {
        "id": "10841c1e.c6fe34",
        "type": "subflow:f4989ebd.9314",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1190,
        "y": 540,
        "wires": [
          [
            "737c91e3.9dee4"
          ]
        ]
      },
      {
        "id": "ccd38f05.bc594",
        "type": "subflow:bc6ff87.05a2908",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1770,
        "y": 540,
        "wires": []
      },
      {
        "id": "737c91e3.9dee4",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Attachment Header",
        "func": "if (!msg.hasOwnProperty(\"headers\")) { msg.headers = {} }\nmsg.headers[\"content-disposition\"] = \"attachment; filename=\" + msg.settings_file[0].file_name;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1390,
        "y": 540,
        "wires": [
          [
            "c101df63.e161e"
          ]
        ]
      },
      {
        "id": "422dc920.572258",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Settings File Delete",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Settings File Delete\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"settings_file\",\n    \"object\": \"settings_file\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\", \"settings_file\"]\n};\nmsg.inputs = {\n    \"file_id\": msg.req.params.file_id\n};\nmsg.message = \"File_id: \" + msg.inputs.file_id + \" Successfully deleted.\";\nmsg.filters = {};\nmsg.filters.params = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"settings_file\",\n    \"selector\": {\n        \"file_id\": msg.inputs.file_id,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\"\n    },\n    \"sort\": [{\"updating_timestamp:number\": \"asc\"}]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 480,
        "wires": [
          [
            "a667240c.3a1778"
          ]
        ]
      },
      {
        "id": "a667240c.3a1778",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 830,
        "y": 480,
        "wires": [
          [
            "6d612f56.2d4d4"
          ]
        ]
      },
      {
        "id": "6d612f56.2d4d4",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Exist",
        "func": "if (!msg.hasOwnProperty(\"settings_file\") || msg.settings_file.length === 0 || msg.settings_file[0].doc_type !== \"settings_file\") {\n    return [null,msg]\n}\nmsg.records.id = msg.settings_file[0]._id;\nmsg.inputs.body = {\"status\": \"inactive\"};\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1000,
        "y": 480,
        "wires": [
          [
            "179c7b87.b6c5e4"
          ],
          [
            "9706f9f0.7e6418"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "376d1ca.b84ece4",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1340,
        "y": 500,
        "wires": []
      },
      {
        "id": "9706f9f0.7e6418",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active File \" + msg.inputs.file_id + \" doesn't exist\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 500,
        "wires": [
          [
            "376d1ca.b84ece4"
          ]
        ]
      },
      {
        "id": "3cb69122.9642de",
        "type": "subflow:bc6ff87.05a2908",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1550,
        "y": 460,
        "wires": []
      },
      {
        "id": "179c7b87.b6c5e4",
        "type": "subflow:68197f61.7975",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1170,
        "y": 460,
        "wires": [
          [
            "8474bcea.06e8e"
          ]
        ]
      },
      {
        "id": "60e8682c.16a928",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "settings_file",
        "func": "msg.records.settings_file = {\n    \"doc_type\": \"settings_file\",\n    \"status\": \"active\",\n    \"file_id\": \"\",\n    \"updating_system\": \"\", \n    \"file_name\": \"\",\n    \"user_id\": \"\",\n    \"updating_timestamp\": 0,\n    \"objectDB_id\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 500,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "11388bff.03f9d4",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Settings File New",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Settings File New\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"settings_file\",\n    \"object\": \"settings_file\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\",\"settings_file\"],\n    \"models\": [\"settings_file\"]\n};\nmsg.inputs = {\n    \"file_id\": msg.req.params.file_id,\n    \"objectDB_id\": msg.req.params.file_id + \"_\" + msg.payload.updating_timestamp,\n    \"required\": [\"file_name\", \"updating_system\", \"updating_timestamp\", \"user_id\"],\n    \"allowed\": [],\n    \"attach_num\": 1\n};\nmsg.cos = {\n    \"method\": \"PUT\",\n    \"container\": \"stellaris-settings\",\n    \"filename\": msg.inputs.objectDB_id,\n    \"object\": \"message\"\n}\nif (msg.req.hasOwnProperty(\"files\")) {\n    msg.cos.file = msg.req.files[0]\n} else if (msg.req.body.hasOwnProperty(\"file\")) {\n    var cryptojs = global.get('cryptojs');\n    msg.cos.file_string = cryptojs.enc.Utf8.stringify(cryptojs.enc.Base64.parse(msg.req.body.file));\n    msg.cos.file = {\n        \"buffer\": Buffer.from(msg.cos.file_string, 'utf8'),\n        \"mimetype\": \"text/plain\"\n    }\n    delete msg.payload.file;\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"settings_file\",\n    \"selector\": {\n        \"file_id\": msg.inputs.file_id,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\"\n    },\n    \"sort\": [{\"updating_timestamp:number\": \"asc\"}]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 140,
        "wires": [
          [
            "2dbaa227.50f91e"
          ]
        ]
      },
      {
        "id": "c6fde4a7.09f7c8",
        "type": "subflow:71afa3f9.81defc",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 960,
        "y": 140,
        "wires": [
          [
            "9fee4799.288e88"
          ]
        ]
      },
      {
        "id": "acdaf127.7ffc5",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Check Attachments",
        "func": "var errors = [];\nif(msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"attach_num\") && msg.inputs.attach_num > 0) {\n    // Check if there is an attachment or a file field in the body\n    if (msg.req.headers.hasOwnProperty(\"content-type\") && msg.req.headers[\"content-type\"].includes(\"multipart/form-data\")) {\n        if (msg.req.hasOwnProperty(\"files\") && msg.req.files.length === msg.inputs.attach_num) { return [msg,null] } else { return [null,msg] }\n    } else if (msg.req.headers.hasOwnProperty(\"content-type\") && msg.req.headers[\"content-type\"].includes(\"application/json\")) {\n        if ((msg.req.hasOwnProperty(\"body\") && msg.req.body.hasOwnProperty(\"file\") && msg.req.body.file !== \"\") || (msg.cos && msg.cos.file && msg.cos.file.buffer && msg.cos.file.buffer.length > 0)) { return [msg,null] } else { return [null,msg] }\n    } else {\n        return [null,msg]\n    }\n}\nreturn [msg,null]",
        "outputs": 2,
        "noerr": 0,
        "x": 1430,
        "y": 120,
        "wires": [
          [
            "1cce4f59.4185d1"
          ],
          [
            "fb30b5a0.4a80e8"
          ]
        ]
      },
      {
        "id": "fb30b5a0.4a80e8",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Missing Required Attachment",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 412,\n    \"message\": \"Missing required file attachment.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1680,
        "y": 160,
        "wires": [
          [
            "44304eec.b88b6"
          ]
        ]
      },
      {
        "id": "102b38b7.d949c7",
        "type": "subflow:e0cd8199.1ad77",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2380,
        "y": 80,
        "wires": [
          [
            "2e212846.440a88"
          ]
        ]
      },
      {
        "id": "4d8f7ca9.bd4c54",
        "type": "subflow:f4989ebd.9314",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2190,
        "y": 80,
        "wires": [
          [
            "102b38b7.d949c7"
          ]
        ]
      },
      {
        "id": "2e212846.440a88",
        "type": "subflow:313bd1d3.01c06e",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2570,
        "y": 80,
        "wires": [
          [
            "873725d1.a72bf8"
          ]
        ]
      },
      {
        "id": "873725d1.a72bf8",
        "type": "subflow:bc6ff87.05a2908",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2750,
        "y": 80,
        "wires": []
      },
      {
        "id": "9fee4799.288e88",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1130,
        "y": 140,
        "wires": [
          [
            "8dce59a6.9f9ee8"
          ]
        ]
      },
      {
        "id": "8dce59a6.9f9ee8",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Exist",
        "func": "if (!msg.hasOwnProperty(\"settings_file\") || msg.settings_file.length === 0 || msg.settings_file[0].doc_type !== \"settings_file\") {\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"user\",\n        \"selector\": {\n            \"_id\": msg.inputs.body.user_id,\n            \"doc_type\": \"user\",\n            \"status\": \"active\"\n        }\n    };\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1300,
        "y": 140,
        "wires": [
          [
            "a1432bf7.1f2948"
          ],
          [
            "15a3f33e.b9c3ad"
          ]
        ],
        "outputLabels": [
          "no",
          "yes"
        ]
      },
      {
        "id": "87528dda.92cfb",
        "type": "http in",
        "z": "fc9978cc.27301",
        "name": "",
        "url": "/files/file/settings/update/:file_id",
        "method": "post",
        "upload": true,
        "swaggerDoc": "",
        "x": 170,
        "y": 320,
        "wires": [
          [
            "fcc9a595.312b78"
          ]
        ]
      },
      {
        "id": "f9e75698.eeee38",
        "type": "comment",
        "z": "fc9978cc.27301",
        "name": "[DEVICES] Settings File Update",
        "info": "",
        "x": 150,
        "y": 280,
        "wires": []
      },
      {
        "id": "fcc9a595.312b78",
        "type": "subflow:3962857e.44abba",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 430,
        "y": 320,
        "wires": [
          [
            "2bf2afcb.87bdf"
          ]
        ]
      },
      {
        "id": "a061b3d1.5281a",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2380,
        "y": 160,
        "wires": []
      },
      {
        "id": "15a3f33e.b9c3ad",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active File \" + msg.inputs.file_id + \" already exists\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1450,
        "y": 160,
        "wires": [
          [
            "57d0e6f5.67b918"
          ]
        ]
      },
      {
        "id": "a1432bf7.1f2948",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1470,
        "y": 120,
        "wires": [
          [
            "c458e074.fbee"
          ]
        ]
      },
      {
        "id": "c458e074.fbee",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "User Exist",
        "func": "if (!msg.hasOwnProperty(\"user\") || msg.user.length === 0 || msg.user[0].doc_type !== \"user\") {\n    return [null,msg]\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"filename_list\",\n    \"selector\": {\n        \"user_id\": msg.inputs.body.user_id,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\",\n        \"file_name\": msg.inputs.body.file_name\n    }\n};\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1640,
        "y": 120,
        "wires": [
          [
            "5c27e9aa.3e1648"
          ],
          [
            "2ba1b03b.10276"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "e71429fc.aebf28",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File_name Exist",
        "func": "if (!msg.hasOwnProperty(\"filename_list\") || msg.filename_list.length === 0 || msg.filename_list[0].doc_type !== \"settings_file\") {\n    msg.inputs.body.file_id = msg.inputs.file_id;\n    msg.inputs.body.objectDB_id = msg.inputs.objectDB_id;\n    return [msg,null]\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 2000,
        "y": 100,
        "wires": [
          [
            "4d8f7ca9.bd4c54"
          ],
          [
            "93187c7c.ddda1"
          ]
        ],
        "outputLabels": [
          "no",
          "yes"
        ]
      },
      {
        "id": "5c27e9aa.3e1648",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1810,
        "y": 100,
        "wires": [
          [
            "e71429fc.aebf28"
          ]
        ]
      },
      {
        "id": "2ba1b03b.10276",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id \" + msg.inputs.body.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1800,
        "y": 140,
        "wires": [
          [
            "a061b3d1.5281a"
          ]
        ]
      },
      {
        "id": "93187c7c.ddda1",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File_name Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"File_name \" + msg.inputs.body.file_name + \" already exists for this user with id \" + msg.inputs.body.user_id + \".\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2190,
        "y": 120,
        "wires": [
          [
            "a061b3d1.5281a"
          ]
        ]
      },
      {
        "id": "2bf2afcb.87bdf",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Settings File Update",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Settings File Update\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"settings_file\",\n    \"object\": \"settings_file\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\",\"settings_file\"],\n    \"models\": [\"settings_file\"]\n};\nmsg.inputs = {\n    \"file_id\": msg.req.params.file_id,\n    \"objectDB_id\": msg.req.params.file_id + \"_\" + msg.payload.updating_timestamp,\n    \"required\": [\"file_name\", \"updating_system\", \"updating_timestamp\"], //user_id is not allowed. Can't be changed\n    \"allowed\": [],\n    \"attach_num\": 1\n};\nmsg.message = \"File_id: \" + msg.inputs.file_id + \" has been successfully updated.\";\nmsg.cos = {\n    \"method\": \"PUT\",\n    \"container\": \"stellaris-settings\",\n    \"filename\": msg.inputs.objectDB_id\n}\nif (msg.req.hasOwnProperty(\"files\")) {\n    msg.cos.file = msg.req.files[0]\n} else if (msg.req.body.hasOwnProperty(\"file\")) {\n    var cryptojs = global.get('cryptojs');\n    msg.cos.file = cryptojs.enc.Utf8.stringify(cryptojs.enc.Base64.parse(msg.req.body.file));\n    delete msg.payload.file;\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"settings_file\",\n    \"selector\": {\n        \"file_id\": msg.inputs.file_id,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\"\n    },\n    \"sort\": [{\"updating_timestamp:number\": \"asc\"}]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 320,
        "wires": [
          [
            "4d823372.5cde6c"
          ]
        ]
      },
      {
        "id": "8df95eb8.f7ae3",
        "type": "subflow:71afa3f9.81defc",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 980,
        "y": 320,
        "wires": [
          [
            "b8c198d3.924768"
          ]
        ]
      },
      {
        "id": "b8c198d3.924768",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1150,
        "y": 320,
        "wires": [
          [
            "adaaa8f8.136fd8"
          ]
        ]
      },
      {
        "id": "adaaa8f8.136fd8",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Exist",
        "func": "if (!msg.hasOwnProperty(\"settings_file\") || msg.settings_file.length === 0 || msg.settings_file[0].doc_type !== \"settings_file\") {\n    return [null,msg]\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1320,
        "y": 320,
        "wires": [
          [
            "c1f5d569.f103a8"
          ],
          [
            "820cb737.c3d288"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "74596a0f.233c14",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2240,
        "y": 320,
        "wires": []
      },
      {
        "id": "820cb737.c3d288",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active File \" + msg.inputs.file_id + \" doesn't exist\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 340,
        "wires": [
          [
            "74596a0f.233c14"
          ]
        ]
      },
      {
        "id": "c1bfea7b.7d61a8",
        "type": "subflow:313bd1d3.01c06e",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2450,
        "y": 260,
        "wires": [
          [
            "2a8e726d.2d300e"
          ]
        ]
      },
      {
        "id": "2a8e726d.2d300e",
        "type": "subflow:bc6ff87.05a2908",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2630,
        "y": 260,
        "wires": []
      },
      {
        "id": "25739575.0f457a",
        "type": "subflow:68197f61.7975",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2610,
        "y": 220,
        "wires": [
          []
        ]
      },
      {
        "id": "89dcb35f.a0052",
        "type": "subflow:f4989ebd.9314",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2070,
        "y": 260,
        "wires": [
          [
            "ec6e1945.8e0a38"
          ]
        ]
      },
      {
        "id": "ec6e1945.8e0a38",
        "type": "subflow:e0cd8199.1ad77",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 2260,
        "y": 260,
        "wires": [
          [
            "c1bfea7b.7d61a8",
            "db5a3b27.f7e7e8"
          ]
        ]
      },
      {
        "id": "db5a3b27.f7e7e8",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "Set Inactive",
        "func": "msg.records.id = msg.records.old_file_id;\nmsg.inputs.body = {\"status\": \"inactive\"}\ndelete msg.settings_file;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2430,
        "y": 220,
        "wires": [
          [
            "25739575.0f457a"
          ]
        ]
      },
      {
        "id": "77e10d4a.554344",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1670,
        "y": 280,
        "wires": [
          [
            "1a72069e.a97329"
          ]
        ]
      },
      {
        "id": "1a72069e.a97329",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File_name Exist",
        "func": "if (!msg.hasOwnProperty(\"filename_list\") || msg.filename_list.length === 0 || msg.filename_list[0].doc_type !== \"settings_file\") {\n    return [msg,null]\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1860,
        "y": 280,
        "wires": [
          [
            "89dcb35f.a0052"
          ],
          [
            "d8ede6c6.8d9298"
          ]
        ],
        "outputLabels": [
          "no",
          "yes"
        ]
      },
      {
        "id": "d8ede6c6.8d9298",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "File_name Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"File_name \" + msg.inputs.body.file_name + \" already exists for this user wth id \" + msg.inputs.body.user_id + \".\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2050,
        "y": 300,
        "wires": [
          [
            "74596a0f.233c14"
          ]
        ]
      },
      {
        "id": "c1f5d569.f103a8",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "User Match",
        "func": "msg.inputs.file_user = msg.inputs.body.file_name.split('_').pop();\nif (msg.settings_file[0].user_id !== msg.inputs.file_user) {\n    return [null,msg]\n}\nmsg.inputs.body.user_id = msg.settings_file[0].user_id;\nmsg.inputs.body.file_id = msg.settings_file[0].file_id;\nmsg.inputs.body.objectDB_id = msg.inputs.objectDB_id;\nmsg.records.old_file_id = msg.settings_file[0]._id;\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"filename_list\",\n    \"selector\": {\n        \"user_id\": msg.inputs.body.user_id ,\n        \"doc_type\": \"settings_file\",\n        \"status\": \"active\",\n        \"file_name\": msg.inputs.body.file_name,\n        \"_id\": {\"$ne\": msg.records.old_file_id}\n    }\n};\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1470,
        "y": 300,
        "wires": [
          [
            "77e10d4a.554344"
          ],
          [
            "b67d4e6.df716b"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "b67d4e6.df716b",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "User Do Not Match",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User id \" + msg.settings_file[0].user_id + \" does not match the record or the file_name \" + msg.inputs.body.file_name + \".\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1670,
        "y": 320,
        "wires": [
          [
            "74596a0f.233c14"
          ]
        ]
      },
      {
        "id": "c437bfe6.4eb7b",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/activate_to_state",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 160,
        "wires": [
          [
            "6f3005b7.1b698c"
          ]
        ]
      },
      {
        "id": "f64cf819.f54698",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/reactivate",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 340,
        "wires": [
          [
            "cc6048c0.ed4cf8"
          ]
        ]
      },
      {
        "id": "62d9b8dd.115968",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/modify_device_custom_info",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 520,
        "wires": [
          [
            "ad4d16d7.a27ac8"
          ]
        ]
      },
      {
        "id": "71d39268.77f7ec",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/device_status",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 860,
        "wires": [
          [
            "dc53ae32.cc78b"
          ]
        ]
      },
      {
        "id": "a0735513.b59128",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/KORE/modify_plan_codes",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1180,
        "wires": [
          [
            "3ff0e8c.7279e18"
          ]
        ]
      },
      {
        "id": "39b570e5.7807d",
        "type": "http in",
        "z": "c012d9b9.f1e028",
        "name": "",
        "url": "/pairing/unpair/device_user",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 360,
        "wires": [
          [
            "dbee4981.7c9998"
          ]
        ]
      },
      {
        "id": "dbee4981.7c9998",
        "type": "subflow:3962857e.44abba",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 410,
        "y": 360,
        "wires": [
          [
            "d88d0d95.c768a"
          ]
        ]
      },
      {
        "id": "d88d0d95.c768a",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Unpair Device and User",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Unpair Device and User\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"machine_link\",\n    \"object\": \"machine_link\",\n    \"format\": \"JSON\",\n    \"returns\": [\"machine_link\"],\n};\nmsg.inputs = {\n    \"required\": [\"device_id\", \"user_id\"],\n    \"device_id\": msg.payload.device_id,\n    \"user_id\": msg.payload.user_id\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"machine_link\",\n    \"selector\": {\n        \"doc_type\": \"machine_link\",\n        \"device\": msg.inputs.device_id,\n        \"user\": msg.inputs.user_id\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 360,
        "wires": [
          [
            "7188c7c5.f89e28"
          ]
        ]
      },
      {
        "id": "fca2ce1e.60d5c",
        "type": "subflow:71afa3f9.81defc",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 980,
        "y": 360,
        "wires": [
          [
            "2dda1550.4ac74a"
          ]
        ]
      },
      {
        "id": "2dda1550.4ac74a",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1150,
        "y": 360,
        "wires": [
          [
            "4a567afe.2bfee4"
          ]
        ]
      },
      {
        "id": "4a567afe.2bfee4",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Link Exists",
        "func": "if(!msg.hasOwnProperty(\"machine_link\") || msg.machine_link.length === 0){\n    return [null,msg,null]\n}\nif(msg.hasOwnProperty(\"machine_link\") && msg.machine_link[0].status === \"inactive\"){\n    return [null,null,msg]\n}\nmsg.inputs.machine_link = msg.machine_link[0]._id;\nmsg.records.id = msg.machine_link[0]._id;\ndelete msg.machine_link;\nmsg.inputs.body = { \"status\": \"inactive\" };\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1330,
        "y": 360,
        "wires": [
          [
            "4755c42e.196ccc"
          ],
          [
            "b4dbd532.031d08"
          ],
          [
            "8e78e591.f1a9e8"
          ]
        ],
        "outputLabels": [
          "yes",
          "no",
          ""
        ]
      },
      {
        "id": "b4dbd532.031d08",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Link Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active Link between Device: \" + msg.inputs.device_id + \" and User: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1500,
        "y": 380,
        "wires": [
          [
            "29b16398.3bde7c"
          ]
        ]
      },
      {
        "id": "bcabe882.080058",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1900,
        "y": 380,
        "wires": []
      },
      {
        "id": "1e092205.03841e",
        "type": "subflow:313bd1d3.01c06e",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1770,
        "y": 340,
        "wires": [
          [
            "4d87f9a0.988378"
          ]
        ]
      },
      {
        "id": "4d87f9a0.988378",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1950,
        "y": 340,
        "wires": []
      },
      {
        "id": "571417f.b82ade8",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Pair Device and User",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Pair Device and User\",\n        \"paths\": 3\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\"],\n    \"doc_type\": \"machine_link\",\n    \"object\": \"machine_link\",\n    \"format\": \"JSON\",\n    \"returns\": [\"machine_link\"],\n    \"models\": [\"machine_link\"]\n};\nmsg.inputs = {\n    \"required\": [\"device_id\"],\n    \"device_id\": msg.payload.device_id\n};\nif (msg.payload.hasOwnProperty(\"email\")) {\n    msg.inputs.required.push(\"email\");\n    msg.inputs.email = msg.payload.email.toLowerCase();\n    var user_filter = {\"email\": msg.inputs.email};\n} else {\n    msg.inputs.required.push(\"user_id\");\n    msg.inputs.user_id = msg.payload.user_id;\n    var user_filter = {\"_id\": msg.inputs.user_id};\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_type\",\n    \"selector\": {\n        \"$or\": [ { \"$and\": [ {\"doc_type\": \"user\"},{\"status\": \"active\"},user_filter ] },\n                 { \"$and\": [ {\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": msg.inputs.device_id} ] }\n               ]\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 160,
        "wires": [
          [
            "a83e2e96.a3ec7"
          ]
        ]
      },
      {
        "id": "2d2eb37c.8ee20c",
        "type": "subflow:71afa3f9.81defc",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1100,
        "y": 160,
        "wires": [
          [
            "d8af0157.14296"
          ]
        ]
      },
      {
        "id": "d8af0157.14296",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1270,
        "y": 160,
        "wires": [
          [
            "3edae6c0.5d3eda"
          ]
        ]
      },
      {
        "id": "1ab3d2d9.dd1e8d",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Link Exists",
        "func": "if(!msg.hasOwnProperty(\"machine_link\") || msg.machine_link.length === 0){\n    msg.inputs.body = {\n        \"device\": msg.inputs.device_id,\n        \"user\": msg.inputs.user_id\n    }\n    msg.records.id = \"\";\n    return [msg,null,null];\n}\nif (msg.machine_link[0].status === \"inactive\") {\n    msg.inputs.machine_link = msg.machine_link[0]._id;\n    msg.records.id = msg.machine_link[0]._id;\n    delete msg.machine_link;\n    msg.inputs.body = { \"status\": \"active\" }\n    node.warn({\"Update Link\": msg})\n    msg.api.path = 3\n    return [null,null,msg];\n} else {\n    msg.api.path = 2\n    return [null,msg,null];\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 1870,
        "y": 120,
        "wires": [
          [
            "263ba63e.c9fe1a"
          ],
          [
            "c8aa9dc8.12735"
          ],
          [
            "706fb4bb.6b0c0c"
          ]
        ],
        "outputLabels": [
          "no",
          "yes active",
          "yes inactive"
        ]
      },
      {
        "id": "e9fa2dce.721d5",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1880,
        "y": 180,
        "wires": []
      },
      {
        "id": "c8aa9dc8.12735",
        "type": "subflow:313bd1d3.01c06e",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 2270,
        "y": 120,
        "wires": [
          [
            "e32b93e.7aadc7"
          ]
        ]
      },
      {
        "id": "e32b93e.7aadc7",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 2470,
        "y": 120,
        "wires": []
      },
      {
        "id": "4755c42e.196ccc",
        "type": "subflow:68197f61.7975",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1510,
        "y": 340,
        "wires": [
          [
            "1e092205.03841e"
          ]
        ]
      },
      {
        "id": "263ba63e.c9fe1a",
        "type": "subflow:e0cd8199.1ad77",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 2040,
        "y": 100,
        "wires": [
          [
            "c8aa9dc8.12735"
          ]
        ]
      },
      {
        "id": "36a87de1.f725d2",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "machine_link",
        "func": "msg.records.machine_link = {\n    \"doc_type\": \"machine_link\",\n    \"status\": \"active\",\n    \"device\": \"\",\n    \"user\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 540,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "27042ffd.d801",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User: \" + (msg.inputs.user_id || msg.inputs.email) + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1680,
        "y": 200,
        "wires": [
          [
            "e9fa2dce.721d5"
          ]
        ]
      },
      {
        "id": "b552f73a.ccac78",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Device: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1690,
        "y": 160,
        "wires": [
          [
            "e9fa2dce.721d5"
          ]
        ]
      },
      {
        "id": "841cff74.703b5",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 1690,
        "y": 120,
        "wires": [
          [
            "1ab3d2d9.dd1e8d"
          ]
        ]
      },
      {
        "id": "706fb4bb.6b0c0c",
        "type": "subflow:68197f61.7975",
        "z": "c012d9b9.f1e028",
        "name": "",
        "x": 2050,
        "y": 140,
        "wires": [
          [
            "c8aa9dc8.12735"
          ]
        ]
      },
      {
        "id": "e56e273b.ffa378",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "v1 Inputs",
        "func": "if(msg.req.params.id_one && msg.req.params.id_two)\n{\n    if (msg.req.params.method == \"device_to_user\")\n    {\n        msg.payload = {\n            \"device_id\": msg.req.params.id_one,\n            \"user_id\": msg.req.params.id_two\n        }\n    }\n    else if (msg.req.params.method == \"user_to_device\")\n    {\n        msg.payload = {\n            \"device_id\": msg.req.params.id_two,\n            \"user_id\": msg.req.params.id_one\n        }\n    }\n}\nmsg.v1 = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 460,
        "y": 440,
        "wires": [
          [
            "dbee4981.7c9998"
          ]
        ]
      },
      {
        "id": "c4369d37.22b4c",
        "type": "subflow:3962857e.44abba",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 410,
        "y": 440,
        "wires": [
          [
            "5fd442b1.24a51c"
          ]
        ]
      },
      {
        "id": "c96ffa76.06f018",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/system/info",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 440,
        "wires": [
          [
            "114a461b.bf575a"
          ]
        ]
      },
      {
        "id": "5fd442b1.24a51c",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "System Info",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"System Info\"\n    });\nmsg.records = {\n    \"format\": \"JSON\",\n    \"returns\": [\"info\",\"nodered\", \"variables\", \"CF\", \"npm\", \"VCAP_APPLICATION\", \"VCAP_SERVICES\", \"other\"]\n};\nvar ENV = context.global.process.env;\nvar key_list = [];\nObject.keys(ENV).forEach(function(key) {\n    key_list.push([key, ENV[key]])\n});\nkey_list.sort();\nmsg.npm = [{\n    \"config\": {},\n    \"package\": {\n        \"dependencies\": {}\n    }\n}];\nmsg.CF = [{\n    \"INSTANCE\": {}\n}];\nvar env_var = [\"API_Connect_url\", \"Birth_Email_Distribution\", \"Google_Geocoding_url\", \"Google_Geolocate_url\", \"IOT_Devices_Authorization\", \"IOT_Devices_Path\", \"KORE_url\", \"NODE_RED_FLOW_NAME\", \"NODE_RED_PASSWORD\", \"NODE_RED_STORAGE_NAME\", \"NODE_RED_USERNAME\"];\nmsg.variables = [{}];\nlet list = Object.assign([], key_list);\nlist.forEach(function(key_value) {\n    if (key_value[0].startsWith(\"npm_\")) {\n        key = key_value[0].replace(/^npm_/, '');\n        if (key_value[0].startsWith(\"npm_config_\")) {\n            key = key_value[0].replace(/^npm_config_/, '');\n            msg.npm[0].config[key] = key_value[1];\n        } else\n        if (key_value[0].startsWith(\"npm_package_\")) {\n            key = key_value[0].replace(/^npm_package_/, '');\n            if (key_value[0].startsWith(\"npm_package_dependencies_\")) {\n                key = key_value[0].replace(/^npm_package_dependencies_/, '');\n                msg.npm[0].package.dependencies[key] = key_value[1];\n            } else {\n                msg.npm[0].package[key] = key_value[1];\n            }\n        } else {\n            msg.npm[0][key] = key_value[1];\n        }\n        key_list.splice(key_list.indexOf(key_value),1);\n    } else\n    if (key_value[0].startsWith(\"CF_\")) {\n        key = key_value[0].replace(/^CF_/, '');\n        if (key_value[0].startsWith(\"CF_INSTANCE_\")) {\n            key = key_value[0].replace(/^CF_INSTANCE_/, '');\n            msg.CF[0].INSTANCE[key] = key_value[1];\n        } else {\n            msg.CF[0][key] = key_value[1];\n        }\n        key_list.splice(key_list.indexOf(key_value),1);\n    } else\n    if (key_value[0].startsWith(\"VCAP_SERVICES\")) {\n        msg.VCAP_SERVICES = [JSON.parse(ENV.VCAP_SERVICES)];\n        key_list.splice(key_list.indexOf(key_value),1);\n    } else\n    if (key_value[0].startsWith(\"VCAP_APPLICATION\")) {\n        msg.VCAP_APPLICATION = [JSON.parse(ENV.VCAP_APPLICATION)];\n        key_list.splice(key_list.indexOf(key_value),1);\n    }else\n    if (env_var.indexOf(key_value[0]) >= 0) {\n        msg.variables[0][key_value[0]] = key_value[1];\n        key_list.splice(key_list.indexOf(key_value),1);\n    }\n})\nvar sorted_ENV = {};\nkey_list.forEach(function(key_value) {\n    sorted_ENV[key_value[0]] = key_value[1];\n})\nmsg.other = [sorted_ENV];\nmsg.nodered = [{\n    \"cloudant_query_limit\": global.get(\"cloudant_query_limit\"),\n    \"FLOW_FILE\": global.get(\"FLOW_FILE\")\n}]\nnode.warn({\"sys-info\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 440,
        "wires": [
          [
            "bdf6a6b3.6e3418"
          ]
        ]
      },
      {
        "id": "bdf6a6b3.6e3418",
        "type": "subflow:bc6ff87.05a2908",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 750,
        "y": 440,
        "wires": []
      },
      {
        "id": "c04b5a3a.0360c8",
        "type": "comment",
        "z": "57a5a054.9dfd3",
        "name": "[SYSTEM] System Info",
        "info": "",
        "x": 120,
        "y": 400,
        "wires": []
      },
      {
        "id": "490f80a5.a2d2b",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Set VCAP",
        "func": "//*****API version\n    global.set(\"API_VERSION\", \"10.1\");\n\nglobal.set(\"cloudant_query_limit\",5);\n//***** VCAP Start\n    var ENV = context.global.process.env;\n    var VCAP_APP = JSON.parse(ENV.VCAP_APPLICATION); //legacy\n    var VCAP = JSON.parse(ENV.VCAP_SERVICES); //legacy\n    global.set(\"VCAP_APP\", VCAP_APP); //legacy\n    global.set(\"VCAP_SERVICES\", VCAP); //legacy\n    var env_vcap = {\n        \"app\": JSON.parse(ENV.VCAP_APPLICATION),\n        \"services\": JSON.parse(ENV.VCAP_SERVICES)\n    };\n    global.set(\"SPACE\", env_vcap.app.space_name);\n    global.set(\"VCAP\", env_vcap);\n    var system = {\n        \"name\": VCAP_APP.application_name,\n        \"instance\": VCAP_APP.instance_index,\n        \"instance_id\": VCAP_APP.instance_id,\n        \"version\": VCAP_APP.application_version,\n        \"space\": VCAP_APP.space_name\n    }\n    global.set(\"SYSTEM\", system);\n//***** VCAP End\n\n\n//***** user-provided Start\nif(VCAP[\"user-provided\"]) { \n    var sms = {};\n    var email = {};\n    VCAP[\"user-provided\"].forEach(function(service){\n        if(service.name.includes(\"SMS\")) {\n            if(service.name.includes(\"ATT\")){\n                sms.att = {\n                    \"name\": service.name,\n                    \"credentials\": service.credentials,\n                    \"subAction\": \"20\",\n                    \"language\": 1,\n                    \"loop\": 2,\n                    \"voice\": 1\n                };\n                global.set(\"VCAP_SMS\", sms);\n            }\n            if(service.name.includes(\"Twilio\")){\n                sms.twilio = {\n                    \"name\": service.name,\n                    \"credentials\": service.credentials\n                };\n                global.set(\"VCAP_SMS\", sms);\n            }\n        }\n        if(service.name.includes(\"Email\")){\n            email.office365 = {\n                \"name\": service.name,\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_EMAIL\", email);\n        }\n        if(service.name.includes(\"KORE\")){\n            var kore = {\n                \"name\": service.name,\n                //\"iccid_prefix\": \"89014\",\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_KORE\", kore);\n        }\n        if(service.name.includes(\"Webbing\")){\n            var webbing = {\n                \"name\": service.name,\n                //\"iccid_prefix\": \"89462\",\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_WEBBING\", webbing);\n        }\n        if(service.name.includes(\"Config\")){\n            var config = {\n                \"name\": service.name,\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_CONFIG\", config);\n        }\n        if(service.name.includes(\"KeyProtect\")){\n            var keyprotect = {\n                \"name\": service.name,\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_KEYPROTECT\", keyprotect);\n        }\n        if(service.name.includes(\"Google\")){\n            var google = {\n                \"name\": service.name,\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_GOOGLE\", google);\n        }\n        if(service.name.includes(\"Auth\")){\n            var auth = {\n                \"name\": service.name,\n                \"credentials\": service.credentials,\n                \"auth_key\": Buffer.from(service.credentials.username + ':' + service.credentials.password).toString('base64')\n            };\n            global.set(\"VCAP_AUTH\", auth);\n        }\n        if(service.name.includes(\"DashDB\")){\n            var dashdb = {\n                \"name\": service.name,\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_DASHDB\", dashdb);\n        }\n        if(service.name.includes(\"APP ID\")){\n            var appid = {\n                \"name\": service.name,\n                \"label\": \"AppID\",\n                \"credentials\": service.credentials\n            };\n            global.set(\"VCAP_APPID\", appid);\n        }\n    });\n} else { node.warn(\"NO User Provided Service Available\") }\n//***** user-provided End\n//***** COS Start\nif(VCAP[\"cloud-object-storage\"]) { \n    var COS =  VCAP[\"cloud-object-storage\"][0];\n    var CONFIG = global.get(\"VCAP_CONFIG\");\n    if (context.global.process.env.hasOwnProperty(\"COS_BASE_PATH\")) {\n        COS.base_path = context.global.process.env[\"COS_BASE_PATH\"]; // find it in the global variable first\n    } else if(CONFIG && CONFIG.hasOwnProperty(\"COS_BASE_PATH\")) {\n        COS.base_path = CONFIG.COS_BASE_PATH; // find it in the linked config service second\n    } else {\n        if (COS.name.includes(\"Dev\")) { COS.base_path = \"bl.us.dev\" }\n        if (COS.name.includes(\"Test\")) { COS.base_path = \"bl.us.test\" }\n        if (COS.name.includes(\"Prod\")) { COS.base_path = \"bl.us.prod\" }\n    }\n    global.set(\"VCAP_COS\", COS);\n} else { node.warn(\"COS Service NOT Available\") }\n//***** COS END\n//***** Cloudant Start\nif(VCAP[\"cloudantNoSQLDB\"]) {\n    var CLOUDANT = VCAP[\"cloudantNoSQLDB\"][0];\n    global.set(\"VCAP_CLOUDANT\", CLOUDANT);\n} else { node.warn(\"CLOUDANT Service NOT Available\") }\n//***** Cloudant End\n//***** APP ID Start\nif(VCAP[\"AppID\"]) {\n    var APPID = VCAP[\"AppID\"][0];\n    global.set(\"VCAP_APPID\", APPID);\n} else { node.warn(\"APPID Service NOT Available\") }\n//***** APP ID End\n//***** DashDB Start\nif(VCAP[\"dashDB\"]) {\n    var DASHDB = VCAP[\"dashDB\"][0];\n    global.set(\"VCAP_DASHDB\", DASHDB);\n} else { node.warn(\"DASHDB Service NOT Available\") }\n//***** DashDB End\n//***** PWD Generator Start\n    var PWD_GEN = {\n        length: 18,\n        numbers: true,\n        symbols: true,\n        uppercase: true,\n        exclude: \"_,;:/'`<>{}[]~|?\\\"\",\n        strict: true\n    };\n    global.set(\"PWD_GEN\", PWD_GEN);\n//***** PWD Generator End\n//***** REGEXP Start\n    var regexp = {\n        \"mobile_phone\": \"^[2-9]\\d{2}-\\\\d{3}-\\\\d{4}$|^[+][1-99]-[2-9]\\\\d{2}-\\\\d{3}-\\\\d{4}$|^[1-99]-[2-9]\\\\d{2}-\\\\d{3}-\\\\d{4}$|^[2-9]\\\\d{9}$\",\n        \"email\": \"\\\\S+@\\\\S+\\\\.\\\\S+\",\n        \"password\": \"^(?=.*[a-z])(?=.*[A-Z])(?=.*\\\\d)(?=.*[.]).{8,20}$\", //\"password\": \"^(?=.*[a-z])(?=.*[A-Z])(?=.*\\\\d)(?=.*[#$.^+=!*()@%&]).{8,20}$\",\n        \"system_sn\": \"[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9][0-9]\",\n    };\n    /*var regex = {\n        \"mobile_phone\": \"/^[2-9]\\d{2}-\\d{3}-\\d{4}$|^[+][1-99]-[2-9]\\d{2}-\\d{3}-\\d{4}$|^[1-99]-[2-9]\\d{2}-\\d{3}-\\d{4}$|^[2-9]\\d{9}$/g\",\n        \"email\": \"/\\S+@\\S+\\.\\S+/\",\n        \"password\": \"/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[#$.^+=!*()@%&]).{8,20}$/g\",\n        \"system_sn\": \"/[A-Z][A-Z][A-Z][0-9][0-9][0-9][0-9][0-9]/g\",\n    };*/\n    global.set(\"REGEXP\", regexp);\n//***** REGEX End\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 260,
        "y": 100,
        "wires": [
          [
            "7fb9763a.bffa58"
          ]
        ]
      },
      {
        "id": "1bef120b.f5d41e",
        "type": "inject",
        "z": "57a5a054.9dfd3",
        "name": "",
        "topic": "",
        "payload": "Started!",
        "payloadType": "str",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "x": 100,
        "y": 100,
        "wires": [
          [
            "490f80a5.a2d2b"
          ]
        ]
      },
      {
        "id": "9f2e173d.84bf48",
        "type": "comment",
        "z": "57a5a054.9dfd3",
        "name": "[SYSTEM] Version",
        "info": "",
        "x": 110,
        "y": 480,
        "wires": []
      },
      {
        "id": "8a0d37e.69793c8",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Set COS_URL",
        "func": "var COS = global.get(\"VCAP_COS\");\nvar CONFIG = global.get(\"VCAP_CONFIG\");\nCOS[\"service-endpoints\"] = msg.payload[\"service-endpoints\"];\nvar standard_paths = [\"bl.us.dev\", \"bl.us.test\", \"bl.us.prod\"];\nif (standard_paths.indexOf(COS.base_path) >= 0 ) {\n    COS.url =  \"https://\"+ COS[\"service-endpoints\"][\"cross-region\"][\"us\"][\"public\"][\"us-geo\"];\n} else { //Development custom base paths should be created in regional us-south only\n    COS.url = \"https://\"+ COS[\"service-endpoints\"][\"regional\"][\"us-south\"][\"public\"][\"us-south\"];\n}\nglobal.set(\"VCAP_COS\", COS);\nmsg.iam = { \"type\": \"cos\" }\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1080,
        "y": 100,
        "wires": [
          [
            "72dc701a.d7ecf"
          ]
        ]
      },
      {
        "id": "520a449b.27e6dc",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/version",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 520,
        "wires": [
          [
            "c01fdfa9.82752"
          ]
        ]
      },
      {
        "id": "4f8e3057.22691",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Version",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Version\",\n        \"encrypt\": false\n    });\nmsg.records = {\n    \"format\": \"JSON\",\n    \"returns\": [\"space\",\"version\", \"nodered\", \"cloudapp\", \"connections\"]\n};\nvar vcap = global.get(\"VCAP\");\nvar ENV = context.global.process.env;\nmsg.space = [global.get(\"SPACE\")];\nmsg.version = [global.get(\"API_VERSION\")];\nmsg.nodered = [{\n    \"flow\": global.get(\"API_VERSION\"),\n    \"file\": global.get(\"FLOW_FILE\"),\n    \"engine\": ENV.npm_package_engines_node,\n    \"editor\": ENV.npm_package_dependencies_node_red\n}];\nmsg.cloudapp = [{\n    \"name\": vcap.app.application_name,\n    \"instance\": vcap.app.instance_index,\n    \"instance_id\": vcap.app.instance_id,\n    \"version\": vcap.app.application_version,\n    \"space\": vcap.app.space_name\n}];\nvar connections = { }\nvar connections_list = [\"config\",\"appid\",\"cloudant\",\"dashdb\",\"cos\",\"keyprotect\",\"kore\",\"webbing\",\"email\",\"sms\",\"google\"]\nconnections_list.forEach(function(con){\n    var service = global.get(\"VCAP_\" + con.toUpperCase());\n    if(service) { \n        if(con === \"email\") {\n            connections[con] = service.office365.name;\n        } else if(con === \"sms\") {\n            connections[con + \"_att\"] = service.att.name;\n            connections[con + \"_twilio\"] = service.twilio.name;\n        } else {\n            connections[con] = service.name;\n        }\n    }\n})\n/*if(global.get(\"VCAP_EMAIL\")) { connections.email = global.get(\"VCAP_EMAIL\").office365.name }\nif(global.get(\"VCAP_SMS\")) {\n    if(global.get(\"VCAP_SMS\").att) { connections.sms_att = global.get(\"VCAP_SMS\").att.name }\n    if(global.get(\"VCAP_SMS\").twilio) { connections.sms_twilio = global.get(\"VCAP_SMS\").twilio.name }\n}*/\nmsg.connections = [connections];\nif (msg.req.headers.hasOwnProperty(\"apic\")) {\n    var apicInfo = JSON.parse(msg.req.headers[\"apic\"]);\n    node.warn({\"APIc Info\": apicInfo});\n    msg.apic = [apicInfo];\n    msg.records.returns = [\"version\", \"apic\", \"nodered\", \"cloudapp\", \"connections\"];\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 520,
        "y": 520,
        "wires": [
          [
            "ee85cac2.558588"
          ]
        ]
      },
      {
        "id": "ee85cac2.558588",
        "type": "subflow:bc6ff87.05a2908",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 670,
        "y": 520,
        "wires": []
      },
      {
        "id": "c01fdfa9.82752",
        "type": "subflow:3962857e.44abba",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 350,
        "y": 520,
        "wires": [
          [
            "4f8e3057.22691"
          ]
        ]
      },
      {
        "id": "6748df65.acb22",
        "type": "http in",
        "z": "c012d9b9.f1e028",
        "name": "",
        "url": "/pairing/pair/device_user",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 160,
        "wires": [
          [
            "543f09e7.6d93a8"
          ]
        ]
      },
      {
        "id": "3edae6c0.5d3eda",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "User & Device Exists",
        "func": "if(!msg.hasOwnProperty(\"user\") || msg.user.length === 0 || msg.user[0].doc_type !== \"user\"){\n    return [null,null,msg]\n}\nmsg.inputs.user_id = msg.user[0]._id\nif(!msg.hasOwnProperty(\"device\") || msg.device.length === 0 || msg.device[0].doc_type !== \"device\"){\n    return [null,msg,null]\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"machine_link\",\n    \"selector\": {\n        \"doc_type\": \"machine_link\",\n        \"device\": msg.inputs.device_id,\n        \"user\": msg.inputs.user_id\n    }\n};\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1480,
        "y": 160,
        "wires": [
          [
            "841cff74.703b5"
          ],
          [
            "b552f73a.ccac78"
          ],
          [
            "27042ffd.d801"
          ]
        ],
        "outputLabels": [
          "yes",
          "no device",
          "no user"
        ]
      },
      {
        "id": "648a0f22.9fbd6",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "COS Endpoint",
        "method": "GET",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 890,
        "y": 100,
        "wires": [
          [
            "8a0d37e.69793c8"
          ]
        ]
      },
      {
        "id": "f9cb1c7.d26aee",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "SMS Debug",
        "func": "node.warn({\"Sms\": msg});\nif(msg.api.hasOwnProperty(\"debug\") && (msg.api.debug === true || msg.api.debug.override)) {\n    if(msg.hasOwnProperty(\"debug\") && msg.debug.hasOwnProperty(\"sms\")){\n        if(msg.debug.sms.hasOwnProperty(\"to\")){\n            if (Array.isArray(msg.debug.sms.to)) {\n                msg.sms_list = msg.debug.sms.to;\n            } else {\n                msg.sms_list = [msg.debug.sms.to];\n            }\n        }\n        if(msg.debug.sms.hasOwnProperty(\"to_voice\")){\n            if (Array.isArray(msg.debug.sms.to_voice)) {\n                msg.sms_voice_list = msg.debug.sms.to_voice;\n            } else {\n                msg.sms_voice_list = [msg.debug.sms.to_voice];\n            }\n        }\n        if(msg.debug.sms.hasOwnProperty(\"send\") && (msg.debug.sms.send === false)){\n            node.warn({\"Sms Not Sent to\": msg.sms_list});\n            delete msg.sms_list;\n            node.warn({\"Sms Voice Not Sent to\": msg.sms_voice_list});\n            delete msg.sms_voice_list;\n        }\n    }\n}\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1950,
        "y": 180,
        "wires": [
          [
            "13885be8.270ac4"
          ]
        ]
      },
      {
        "id": "410a31fd.1f91e",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "Twilio Process SMS List",
        "func": "if (msg.hasOwnProperty(\"sms_list\")  && msg.sms_list.length > 0) {\n    msg.topic = msg.sms_list.pop();\n    if (msg.sms_list.length === 0) \n    {\n        return [msg, null];\n    }\n    return [msg, msg];\n}\n\n\n",
        "outputs": 2,
        "noerr": 0,
        "x": 2430,
        "y": 200,
        "wires": [
          [
            "41619fef.427f2"
          ],
          [
            "120eb9f2.662d36"
          ]
        ]
      },
      {
        "id": "120eb9f2.662d36",
        "type": "link out",
        "z": "4f94cf29.53815",
        "name": "sms loop in",
        "links": [
          "39badb90.713a24"
        ],
        "x": 2595,
        "y": 240,
        "wires": []
      },
      {
        "id": "39badb90.713a24",
        "type": "link in",
        "z": "4f94cf29.53815",
        "name": "sms loop out",
        "links": [
          "120eb9f2.662d36"
        ],
        "x": 2275,
        "y": 240,
        "wires": [
          [
            "410a31fd.1f91e"
          ]
        ]
      },
      {
        "id": "812ba212.bb63c",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "SMS Template Processing",
        "func": "msg.sms.message = msg.sms.template;\nif(msg.sms.hasOwnProperty(\"fields\")) {\n    Object.keys(msg.sms.fields).forEach(function(field) {\n        var tag = \"{{{\" + field + \"}}}\";\n        msg.sms.message = msg.sms.message.replace(RegExp(tag, 'g'), msg.sms.fields[field])\n    });\n}\nvar SPACE = global.get(\"SPACE\");\nif ([\"Development\", \"US Test\"].indexOf(SPACE) >= 0) {\nmsg.sms.message = \"[\" + SPACE + \"] \" + msg.sms.message;\n}\nif(msg.sms.hasOwnProperty(\"to\")) {\n    if (Array.isArray(msg.sms.to)) {\n        msg.sms_list = cleanPhoneNumbers(msg.sms.to);\n    } else {\n        msg.sms_list = cleanPhoneNumbers(msg.sms.to.splice(\",\"));\n    }\n}\nif(msg.sms.hasOwnProperty(\"to_voice\")) {\n    if (Array.isArray(msg.sms.to_voice)) {\n        msg.sms_voice_list = cleanPhoneNumbers(msg.sms.to_voice);\n    } else {\n        msg.sms_voice_list = cleanPhoneNumbers(msg.sms.to_voice.splice(\",\"));\n    }\n}\nreturn msg;\n\nfunction cleanPhoneNumbers(list) {\n    var clean_list = [];\n    list.forEach(function(phone){\n        if(phone == null) {\n            //delete entry\n        } else if (phone.length <= 9 || phone === \"\" || phone === \"\\s+\" || phone === \"null\") {\n            //delete entry\n        } else {\n            clean_list.push(phone)\n        }\n    });\n    return clean_list;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1720,
        "y": 180,
        "wires": [
          [
            "f9cb1c7.d26aee"
          ]
        ]
      },
      {
        "id": "4eba1c75.b38284",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "SMS Object Setup",
        "func": "msg.cos = {\n    \"method\": \"GET\",\n    \"filename\": msg.sms.template_file,\n    \"container\": \"sms-templates\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1070,
        "y": 240,
        "wires": [
          [
            "68fd1464.02b56c"
          ]
        ]
      },
      {
        "id": "57cdc08a.c8efa",
        "type": "switch",
        "z": "4f94cf29.53815",
        "name": "template_type",
        "property": "sms.template_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "help_ticket",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 260,
        "wires": [
          [
            "20c6f0d6.45b89"
          ],
          [
            "4802e9c2.173bf8"
          ]
        ]
      },
      {
        "id": "20c6f0d6.45b89",
        "type": "change",
        "z": "4f94cf29.53815",
        "name": "Help Ticket",
        "rules": [
          {
            "t": "set",
            "p": "sms.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Help_Ticket_00.txt",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 870,
        "y": 240,
        "wires": [
          [
            "4eba1c75.b38284"
          ]
        ]
      },
      {
        "id": "f00b78cb.ad3a28",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "SMS Check Template",
        "func": "\nif (msg.sms.hasOwnProperty(\"template_type\")) {\n    return [null,msg];\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 420,
        "y": 180,
        "wires": [
          [
            "812ba212.bb63c"
          ],
          [
            "57cdc08a.c8efa"
          ]
        ],
        "outputLabels": [
          "no template",
          "yes template"
        ]
      },
      {
        "id": "68fd1464.02b56c",
        "type": "subflow:f4989ebd.9314",
        "z": "4f94cf29.53815",
        "name": "",
        "x": 1270,
        "y": 240,
        "wires": [
          [
            "1762d850.0daed8"
          ]
        ]
      },
      {
        "id": "4802e9c2.173bf8",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "Template Not Supported",
        "func": "node.warn({\"Sms Error:\" : \"SMS template type: \" + msg.sms.template_type + \" is not supported.\"})\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1090,
        "y": 320,
        "wires": [
          []
        ]
      },
      {
        "id": "bf320d02.d8846",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Template Not Supported",
        "func": "node.warn({\"Email Error:\" : \"Email template type: \" + msg.email.template_type + \" is not supported.\"})",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 600,
        "wires": [
          []
        ]
      },
      {
        "id": "9d11623.9608ba",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "SMS Setup",
        "func": "if (msg.hasOwnProperty(\"sms\") && (msg.sms.hasOwnProperty(\"to\") || msg.sms.hasOwnProperty(\"to_voice\"))) {\n    if ( (Array.isArray(msg.sms.to) && msg.sms.to.length === 0) || msg.sms.to === \"\" ) {\n        return [msg,null];\n    }\n    delete msg.res;\n    delete msg.req;\n    return [null,msg];\n}\nreturn [msg,null]",
        "outputs": 2,
        "noerr": 0,
        "x": 210,
        "y": 120,
        "wires": [
          [],
          [
            "f00b78cb.ad3a28"
          ]
        ],
        "outputLabels": [
          "no sms",
          "yes sms"
        ]
      },
      {
        "id": "9f406a53.f97dc8",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Check Template",
        "func": "if (msg.email.hasOwnProperty(\"template_type\")) {\n    if (!msg.email.hasOwnProperty(\"fields\")) {msg.email.fields = {}}\n    msg.email.fields.apic_server = msg.apic.url;\n    msg.email.fields.email_from = \"no-reply.IoTServices@Bausch.com\";\n    return [null,msg];\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 320,
        "y": 140,
        "wires": [
          [
            "bd2fe652.82c918"
          ],
          [
            "65919f4d.91575"
          ]
        ],
        "outputLabels": [
          "no template",
          "yes template"
        ]
      },
      {
        "id": "bb960040.7d816",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Setup",
        "func": "if (msg.hasOwnProperty(\"email\") && msg.email.hasOwnProperty(\"to\") && ( (Array.isArray(msg.email.to) && msg.email.to.length > 0) ||  msg.email.to !== \"\") ) {\n    if ( (Array.isArray(msg.email.to) && msg.email.to.length === 0) || msg.email.to === \"\") {\n             return [msg,null];\n    }\n    msg.apic = {\n        \"url\": global.get(\"EULA_CATALOG\")\n    }\n    if(!msg.email.return) {\n        delete msg.res;\n        delete msg.req;\n    }\n    return [null,msg];\n}\nreturn [msg,null]",
        "outputs": 2,
        "noerr": 0,
        "x": 150,
        "y": 100,
        "wires": [
          [],
          [
            "9f406a53.f97dc8"
          ]
        ],
        "outputLabels": [
          "no email",
          "yes email"
        ]
      },
      {
        "id": "2988c5c0.8b57aa",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Object Setup",
        "func": "msg.cos = {\n    \"method\": \"GET\",\n    \"filename\": msg.email.template_file,\n    \"container\": \"email-templates\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 280,
        "wires": [
          [
            "f637ef7b.74e6a"
          ]
        ]
      },
      {
        "id": "f637ef7b.74e6a",
        "type": "subflow:f4989ebd.9314",
        "z": "5dbd57cc.fc9bb8",
        "name": "",
        "x": 1450,
        "y": 280,
        "wires": [
          [
            "8041ed2a.a021d"
          ]
        ]
      },
      {
        "id": "8041ed2a.a021d",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Object Return",
        "func": "msg.email.template = msg.cos.return.toString(\"utf-8\")\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1660,
        "y": 280,
        "wires": [
          [
            "bd2fe652.82c918"
          ]
        ]
      },
      {
        "id": "1762d850.0daed8",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "SMS Object Return",
        "func": "msg.sms.template = msg.cos.return.toString(\"utf-8\")\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1470,
        "y": 240,
        "wires": [
          [
            "812ba212.bb63c"
          ]
        ]
      },
      {
        "id": "47b93e95.3ec1e",
        "type": "subflow:3962857e.44abba",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 350,
        "y": 140,
        "wires": [
          [
            "2f410b84.ebfd44"
          ]
        ]
      },
      {
        "id": "2f410b84.ebfd44",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Ticket Update",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Ticket Update\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\"],\n    \"doc_type\": \"help_ticket\",\n    \"object\": \"help_ticket\",\n    \"format\": \"JSON\",\n    \"returns\": [\"help_ticket\"],\n    \"id\": msg.req.params.ticketID\n};\nmsg.inputs = {\n    \"allowed\": [\"close_time\",\"ticket_status\",\"reason\",\"responder_id\",\"ticket_notes\"],\n    \"required\": [],\n    \"values\": {\n        \"reason\": [\"Setup\", \"Order Packs\", \"Another Issue\", \"Technical Support\"]\n    },\n    \"ticket_id\": msg.req.params.ticketID\n};\nmsg.cloudant = {\n    \"request\": \"/help_tickets/\" + msg.records.id,\n    \"method\": \"get\",\n    \"return_obj\": \"\",\n    \"object\": \"help_ticket\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 540,
        "y": 140,
        "wires": [
          [
            "b634508d.20d92"
          ]
        ]
      },
      {
        "id": "302565b1.05779a",
        "type": "http in",
        "z": "a17d8665.50cb88",
        "name": "",
        "url": "/tickets/ticket/:ticketID",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 140,
        "wires": [
          [
            "47b93e95.3ec1e"
          ]
        ]
      },
      {
        "id": "b634508d.20d92",
        "type": "subflow:71afa3f9.81defc",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 700,
        "y": 140,
        "wires": [
          [
            "8cbc90e.74d727"
          ]
        ]
      },
      {
        "id": "8cbc90e.74d727",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Check Reassigned or Reason",
        "func": "if(Object.keys(msg.inputs.body).length > 0) {\n    if((msg.inputs.body.ticket_status && msg.inputs.body.ticket_status === \"Reassigned\") || (msg.inputs.body.reason)) {\n        return [null,msg,null]\n    } else {\n        return [msg,null,null]\n    }\n} else {\n    return [null,null,msg]\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 910,
        "y": 140,
        "wires": [
          [
            "3f45bfe3.b37e2"
          ],
          [
            "52481ef9.55d1e"
          ],
          [
            "9066da0d.905eb8"
          ]
        ],
        "outputLabels": [
          "Update",
          "Update & Email",
          "no body"
        ]
      },
      {
        "id": "3f45bfe3.b37e2",
        "type": "subflow:68197f61.7975",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2830,
        "y": 80,
        "wires": [
          [
            "185cef8a.e6049",
            "17cfc529.01751b"
          ]
        ]
      },
      {
        "id": "185cef8a.e6049",
        "type": "subflow:313bd1d3.01c06e",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 3030,
        "y": 60,
        "wires": [
          [
            "ada1b83a.b05318"
          ]
        ]
      },
      {
        "id": "17cfc529.01751b",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "EMAIL & SMS",
        "func": "if(msg.hasOwnProperty(\"support_users\") && msg.support_users.length > 0){\n    msg.email = {\n        \"to\": msg.support_users.map(a => a.email),\n        \"operation\": \"updated\"\n    };\n    msg.sms = {\n        \"to\": msg.support_users.map(a => a.mobile_phone),\n        \"to_voice\": msg.support_users.map(a => a.voice_phone),\n        \"operation\": \"updated\"\n    }\n} else {\n    //do nothing\n    msg.email = {};\n    msg.sms = {};\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3020,
        "y": 100,
        "wires": [
          [
            "a04840d5.e19e6",
            "97de7ab6.1754f8"
          ]
        ]
      },
      {
        "id": "907e0f31.64e57",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Add Support Person",
        "func": "if(msg.hasOwnProperty(\"support_users\") && msg.support_users.length > 0){\n    msg.inputs.body.assigned_id = msg.support_users.map(a => a._id);\n} else {\n    msg.inputs.body.assigned_id = [];\n}\nmsg.cloudant.object = \"help_ticket\";\nreturn msg;  ",
        "outputs": 1,
        "noerr": 0,
        "x": 2600,
        "y": 120,
        "wires": [
          [
            "3f45bfe3.b37e2"
          ]
        ]
      },
      {
        "id": "52481ef9.55d1e",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1150,
        "y": 140,
        "wires": [
          [
            "4477f43e.4e0d5c"
          ]
        ]
      },
      {
        "id": "ada1b83a.b05318",
        "type": "subflow:bc6ff87.05a2908",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 3210,
        "y": 60,
        "wires": []
      },
      {
        "id": "a04840d5.e19e6",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Email Setup",
        "func": "var ticket = msg.help_ticket[0];\nmsg.email.template_type = \"help_ticket\";\nvar mod_string = \"n/a\";\nvar settings_string = \"n/a\";\nvar machine_errors = \"n/a\";\nvar posterior = [\"BL15455\", \"BL15335\"] // Stellaris PC Laser System - 7.5K, 5.0K\nvar combined = [\"BL14455\", \"BL14335\"] // Stellaris PC Combined System - 7.5K, 5.0K\nvar anterior = [\"BL11145\", \"BL11115\", \"BL11125\"] // Anterior System - HFM, VFM, AFM\nif (ticket.hasOwnProperty(\"machine_state\"))  {\n    var edhr = ticket.machine_state;\n    if (edhr.hasOwnProperty(\"modlist\")) {\n        var full_modlist = {\n            \"uic_info\" : \"UIC\",\n            \"remote_info\" : \"Remote\",\n            \"anterior_info\" : \"Anterior\",\n            \"ivpole_info\" : \"IVPole\",\n            \"footcan_info\" : \"FCIB\",\n            \"footrx_info\" : \"FC Receiver\",\n            \"footctrl_info\" : \"Foot Control\",\n            \"foottx_info\" : \"FC Transmitter\",\n            \"power_info\" : \"Power Supply\",\n            \"fluidics_info\" : \"Fluidics\",\n            \"compressor_info\" : \"Compressor\",\n            \"posterior_info\" : \"Illumination\",\n            \"glm_info\" : \"Laser\",\n            \"lamp1_info\" : \"Lamp 1\",\n            \"lamp2_info\" : \"Lamp 2\",\n            \"mmc_info\" : \"MMC\",\n            \"gateway_info\" : \"Gateway\",\n            \"sim1_iccid\" : \"SIM 1\",\n            \"sim2_iccid\" : \"SIM 2\"\n        };\n        var system_modlist = full_modlist;\n        if (posterior.indexOf(ticket.system_type.substring(0,7)) >= 0) {\n            delete system_modlist.mmc_info;\n            delete system_modlist.sim2_iccid;\n        }\n        if (combined.indexOf(ticket.system_type.substring(0,7)) >= 0) {\n            delete system_modlist.mmc_info;\n            delete system_modlist.sim2_iccid;\n            delete system_modlist.laser;\n        }\n        if (anterior.indexOf(ticket.system_type.substring(0,7)) >= 0) {\n            delete system_modlist.mmc_info;\n            delete system_modlist.sim2_iccid;\n            delete system_modlist.laser;\n            delete system_modlist.footcan_info;\n            delete system_modlist.lamp1_info;\n            delete system_modlist.lamp2_info;\n        }\n        // Non E models that do not have gateway enabled in software should not have it\n        if (ticket.system_type.length === 7 && edhr.software_options && edhr.software_options.gateway_enabled && edhr.software_options.gateway_enabled === \"disabled\") {\n            delete system_modlist.gateway_info\n            delete system_modlist.sim1_iccid;\n        }\n        var mod_list = [];\n        var name_list = [];\n        for(var propertyName in edhr.modlist) {\n            var module_text = \"\";\n            if (system_modlist.hasOwnProperty(propertyName) || edhr.modlist[propertyName].present === \"PRESENT\") {\n                module_text =  system_modlist[propertyName]; // add module Name\n                if (edhr.modlist[propertyName].present === \"PRESENT\") {\n                    module_text += \", \" + edhr.modlist[propertyName].SN; // add SN\n                } else {\n                    module_text += \", \" + edhr.modlist[propertyName].present; // add MISSING\n                }\n            }\n            // Add SW and HW if it has a name and a SW version\n            if (edhr.modlist[propertyName].present === \"PRESENT\"  && edhr.modlist[propertyName].SW_version !== \"\") {\n                module_text += \", SW v\" + edhr.modlist[propertyName].SW_version + \", HW v\" + edhr.modlist[propertyName].HW_version; // add SW, HW\n            }\n            if (module_text !== \"\" ) {\n                mod_list.push(module_text);\n                name_list.push(propertyName);\n            } // print if not empty\n        }\n        if (mod_list.length > 0) { // Sort and Join if array not empty\n            var order_list = new Array(mod_list.length);\n            var idx = 0;\n            for(var propertyName in full_modlist) {\n                var i = name_list.indexOf(propertyName);\n                if (i >= 0) {\n                    order_list[idx] = mod_list[i];\n                    ++idx;\n                }\n            }\n            mod_string = order_list.join(\"\\n<br />\\n\")\n        } \n    }\n    if (edhr.hasOwnProperty(\"software_options\")) {\n        // Software Option Names\n        var software_list = {\n            \"vitesse_enabled\" : \"Vitesse\",\n            \"gateway_enabled\" : \"Gateway\"\n        };\n        var settings_string = \"\";\n        for(var propertyName in edhr.software_options) {\n            settings_string += software_list[propertyName] + \": \" + edhr.software_options[propertyName] + \"\\n<br />\\n\";\n        }\n    }\n    if (edhr.hasOwnProperty(\"errors\")) {\n        var machine_errors = JSON.stringify(edhr.errors)\n    }\n}\nmsg.email.topic = \"[\" + ticket.ticket_status + \"] Get Me Help Ticket \" + ticket._id;\nmsg.email.fields = {\n    \"operation\": msg.email.operation,\n    \"ticket_id\": ticket._id,\n    \"system_type\": ticket.system_type,\n    \"device_id\": ticket.system_sn,\n    \"reason\": ticket.reason,\n    \"start_time\": Date(ticket.start_time),\n    \"user_id\": ticket.doctor_id,\n    \"contact_name\": ticket.contact_name,\n    \"contact_number\": ticket.contact_number,\n    \"address\": ticket.address,\n    \"system_config\": mod_string,\n    \"software_options\": settings_string,\n    \"machine_errors\": machine_errors\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3270,
        "y": 220,
        "wires": [
          [
            "6b45b347.5123fc"
          ]
        ]
      },
      {
        "id": "97de7ab6.1754f8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "SMS Setup",
        "func": "var ticket = msg.help_ticket[0];\nmsg.sms.template_type = \"help_ticket\";\nmsg.sms.fields = {\n    \"ticket_status\": ticket.ticket_status,\n    \"system_type\": ticket.system_type,\n    \"device_id\": ticket.system_sn,\n    \"reason\": ticket.reason,\n    \"start_time\": Date(ticket.start_time),\n    \"contact_name\": ticket.contact_name,\n    \"contact_number\": ticket.contact_number\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3270,
        "y": 260,
        "wires": [
          [
            "2a4e720f.02b92e"
          ]
        ]
      },
      {
        "id": "4477f43e.4e0d5c",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Get Linked Users",
        "func": "if(msg.hasOwnProperty(\"help_ticket\") && msg.help_ticket.length === 1 && (msg.help_ticket[0]._id === msg.inputs.ticket_id)){\n    if(msg.inputs.body.reason) {\n        msg.inputs.reason = msg.inputs.body.reason;\n    } else {\n        msg.inputs.reason = msg.help_ticket[0].reason;\n    }\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"bookmark_type\": \"payload\", //\"payload\", \"parameter\"\n        \"pagination\": false,\n        \"bookmark_use\": false,\n        \"object\": \"linked_user_ids\",\n        \"fields\": [\"user\"],\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"machine_link\"},\n                {\"device\": msg.help_ticket[0].system_sn},\n                {\"status\": \"active\"}\n            ]\n        }\n    };\n    return [msg,null]\n} else {\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1350,
        "y": 140,
        "wires": [
          [
            "a85bbe21.fe3d"
          ],
          [
            "269a407b.075bd"
          ]
        ],
        "outputLabels": [
          "Update",
          ""
        ]
      },
      {
        "id": "6b45b347.5123fc",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 3420,
        "y": 220,
        "wires": [
          []
        ]
      },
      {
        "id": "2a4e720f.02b92e",
        "type": "subflow:4f94cf29.53815",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 3420,
        "y": 260,
        "wires": [
          []
        ]
      },
      {
        "id": "a85bbe21.fe3d",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1550,
        "y": 120,
        "wires": [
          [
            "fecc8b70.269468"
          ]
        ]
      },
      {
        "id": "5ee146b0.46bd38",
        "type": "comment",
        "z": "a17d8665.50cb88",
        "name": "[CN] Ticket Update",
        "info": "",
        "x": 110,
        "y": 100,
        "wires": []
      },
      {
        "id": "c1185778.0c2658",
        "type": "subflow:3962857e.44abba",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 350,
        "y": 260,
        "wires": [
          [
            "51b4cb93.5d0b64"
          ]
        ]
      },
      {
        "id": "51b4cb93.5d0b64",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Ticket Info",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Ticket Info\",\n        \"path\": 1,\n        \"paths\": 1\n    });\nmsg.records = {\n    \"delete\": [\"_rev\"],\n    \"object\": \"help_ticket\",\n    \"format\": \"JSON\",\n    \"returns\": [\"help_ticket\"]\n};\nmsg.inputs = {\n    \"ticket_id\": msg.req.params.ticketID\n};\nmsg.cloudant = {\n    \"request\": \"/help_tickets/\" + msg.req.params.ticketID,\n    \"method\": \"GET\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 260,
        "wires": [
          [
            "4dedcca.23f8e34"
          ]
        ]
      },
      {
        "id": "3fdfb34f.76ec9c",
        "type": "http in",
        "z": "a17d8665.50cb88",
        "name": "",
        "url": "/tickets/ticket/:ticketID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 260,
        "wires": [
          [
            "c1185778.0c2658"
          ]
        ]
      },
      {
        "id": "4dedcca.23f8e34",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 710,
        "y": 260,
        "wires": [
          [
            "d1ddb3d3.52a3b"
          ]
        ]
      },
      {
        "id": "4e652ad8.755814",
        "type": "subflow:313bd1d3.01c06e",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1150,
        "y": 260,
        "wires": [
          [
            "cbddc4f4.72a2d8"
          ]
        ]
      },
      {
        "id": "cbddc4f4.72a2d8",
        "type": "subflow:bc6ff87.05a2908",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1330,
        "y": 260,
        "wires": []
      },
      {
        "id": "45294fb2.28f79",
        "type": "comment",
        "z": "a17d8665.50cb88",
        "name": "[CN] Ticket Info",
        "info": "",
        "x": 100,
        "y": 220,
        "wires": []
      },
      {
        "id": "6756de94.bd551",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs/case",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 120,
        "wires": [
          [
            "9256137b.9961d"
          ]
        ]
      },
      {
        "id": "c7a74f30.36065",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[Devices] Log New Case",
        "info": "",
        "x": 130,
        "y": 80,
        "wires": []
      },
      {
        "id": "9256137b.9961d",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 370,
        "y": 120,
        "wires": [
          [
            "936cde6b.71bbf"
          ]
        ]
      },
      {
        "id": "9f83f910.a243f8",
        "type": "subflow:71afa3f9.81defc",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1040,
        "y": 120,
        "wires": [
          [
            "dae23b4c.58a628"
          ]
        ]
      },
      {
        "id": "d81d6328.63bd8",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Log New Case",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Log Case New\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\", \"case_log\"],\n    \"doc_type\": \"case\",\n    \"format\": \"JSON\",\n    \"object\": \"case\",\n    \"returns\": [\"case\"],\n    \"models\": [\"case\"],\n    \"return_code\": 201\n};\nmsg.inputs = {\n    \"required\": [\"log_id\",\"system_sn\",\"system_type\",\"location\", \"start_time\",\"stop_time\",\"settings_file_name\",\"case_log\"], \n    \"allowed\": [\"user_id\",\"settings_file_id\"]\n};\nif (msg.payload.hasOwnProperty(\"log_id\")) { msg.records.log_id = msg.payload.log_id }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 880,
        "y": 120,
        "wires": [
          [
            "9f83f910.a243f8"
          ]
        ]
      },
      {
        "id": "14cd7b3d.923455",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs/edhr",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 460,
        "wires": [
          [
            "4772a05f.910e2"
          ]
        ]
      },
      {
        "id": "2d9e9457.e6c2bc",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[Devices] Log New EDHR",
        "info": "",
        "x": 130,
        "y": 420,
        "wires": []
      },
      {
        "id": "4772a05f.910e2",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 350,
        "y": 460,
        "wires": [
          [
            "b4af5a85.dd66b8"
          ]
        ]
      },
      {
        "id": "4e5cfcf7.b5d204",
        "type": "subflow:71afa3f9.81defc",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1040,
        "y": 460,
        "wires": [
          [
            "d3d9378b.b98a28"
          ]
        ]
      },
      {
        "id": "6e753d70.f649c4",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Log EDHR New",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Log New EDHR\",\n        \"path\": 1,\n        \"paths\": 3\n    });\nmsg.records = {\n    //\"delete\": [\"_rev\", \"doc_type\", \"status\", \"modlist\", \"software_options\", \"geo_location\"],\n    \"return_deletes\": {\n        \"edhr\": [\"_rev\", \"doc_type\"],\n        \"sims\": [\"__type\", \"requestStatus\", \"MSISDNOrMDN\", \"currentDataPlan\", \"currentSMSPlan\", \"futureDataPlan\", \"futureSMSPlan\", \"dailyDataThreshold\", \"dailySMSThreshold\", \"monthlyDataThreshold\", \"monthlySMSThreshold\", \"customField4\", \"customField5\", \"customField6\", \"lstHistoryOverLastYear\", \"lstFeatures\", \"staticIP\", \"voiceDispatchNumber\", \"mostRecentLocateId\", \"previousLocateId\", \"mostRecentLocateDate\", \"mostRecentLatitude\", \"mostRecentLongitude\", \"mostRecentAddress\", \"previousLocateDate\", \"previousLatitude\", \"previousLongitude\", \"previousAddress\", \"lstExtFeatures\"]\n    },\n    \"doc_type\": \"edhr\",\n    \"format\": \"JSON\",\n    \"object\": \"edhr\",\n    \"returns\": [\"edhr\",\"sims\"],\n    \"return_formats\": {\n        \"edhr\":\"JSON\",\n        \"sims\":\"array\"\n    },\n    \"models\": [\"edhr\"],\n    \"return_code\": 201\n};\nmsg.inputs = {\n    \"required\": [\"system_sn\", \"system_type\", \"modlist\", \"software_options\", \"timestamp\"], \n    \"allowed\": [\"location\", \"birth\", \"field_birth\"],\n    \"types\": {\n        \"timestamp\": \"number\"\n    }\n};\nif (msg.payload.hasOwnProperty(\"system_sn\")) {\n    msg.inputs.device_id = msg.payload.system_sn;\n} else {\n    msg.inputs.device_id = \"\";\n}\nif (msg.payload.birth) {\n    msg.inputs.birth = (msg.payload.birth === true); //to make copy\n    delete msg.payload.birth;\n} else {\n    msg.inputs.birth = false;\n}\nif (msg.payload.field_birth) {\n    msg.inputs.field_birth = (msg.payload.field_birth === true); //to make copy\n    delete msg.payload.field_birth;\n} else {\n    msg.inputs.field_birth = false;\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.inputs.device_id,\n    \"method\": \"GET\",\n    \"object\": \"device\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 860,
        "y": 460,
        "wires": [
          [
            "4e5cfcf7.b5d204"
          ]
        ]
      },
      {
        "id": "4eaa6578.efef4c",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs/machine_life",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 780,
        "wires": [
          [
            "59c9084e.ee4738"
          ]
        ]
      },
      {
        "id": "c84001c3.0e72e",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[Devices] Log New Machine Life",
        "info": "",
        "x": 150,
        "y": 740,
        "wires": []
      },
      {
        "id": "59c9084e.ee4738",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 350,
        "y": 780,
        "wires": [
          [
            "6af691a.8709e7"
          ]
        ]
      },
      {
        "id": "7970b698.d57dc8",
        "type": "subflow:71afa3f9.81defc",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1220,
        "y": 780,
        "wires": [
          [
            "bccb7190.ed50a"
          ]
        ]
      },
      {
        "id": "df25c52.2380638",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Log Machine Life New",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Log New Machine Life\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\", \"function_accumulator\"],\n    \"doc_type\": \"machine_life\",\n    \"format\": \"JSON\",\n    \"object\": \"machine_life\",\n    \"returns\": [\"machine_life\"],\n    \"models\": [\"machine_life\"],\n    \"return_code\": 201\n};\nmsg.inputs = {\n    \"required\": [\"system_sn\", \"function_accumulator\", \"power_on_time_stamp\", \"prev_power_off_time_stamp\"], \n    \"allowed\": []\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 880,
        "y": 780,
        "wires": [
          [
            "4aca654c.0f624c"
          ]
        ]
      },
      {
        "id": "7f117f38.e5dae",
        "type": "subflow:e0cd8199.1ad77",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1820,
        "y": 120,
        "wires": [
          [
            "557964cc.4ccf3c"
          ]
        ]
      },
      {
        "id": "e237bae3.862198",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "case",
        "func": "msg.records.case = {\n    \"doc_type\": \"case\",\n    \"status\": \"active\",\n    \"log_id\": \"\",\n    \"system_sn\": \"\",\n    \"system_type\": \"\",\n    \"location\": \"\",\n    \"geo_location\": \"\",\n    \"address\": \"\",\n    \"user_id\": \"\",\n    \"settings_file_id\": \"\",\n    \"settings_file_name\": \"\",\n    \"start_time\": 0,\n    \"stop_time\": 0,\n    \"case_log\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 620,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "9ed26faa.17224",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2190,
        "y": 120,
        "wires": []
      },
      {
        "id": "557964cc.4ccf3c",
        "type": "subflow:313bd1d3.01c06e",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2010,
        "y": 120,
        "wires": [
          [
            "9ed26faa.17224"
          ]
        ]
      },
      {
        "id": "47d467e8.16f018",
        "type": "http request",
        "z": "d1af1cc8.e0fda",
        "name": "Coordinates by Cell Info",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 430,
        "y": 100,
        "wires": [
          [
            "67a9b438.23fefc"
          ]
        ]
      },
      {
        "id": "9531b8f5.005c08",
        "type": "function",
        "z": "d1af1cc8.e0fda",
        "name": "Check Location",
        "func": "if(!msg.inputs.body.hasOwnProperty(\"location\") && !msg.inputs.body.hasOwnProperty(\"cell_tower_info\")) {\n    //node.warn({\"Google Loc Test\": !msg.inputs.body.hasOwnProperty(\"location\") && !msg.inputs.body.hasOwnProperty(\"cell_tower_info\")})\n    return [msg,null]\n}\nif (msg.inputs.body.hasOwnProperty(\"location\")) {\n    var carrier = msg.inputs.body.location.carrier;\n    var cellTowers = [{\n        \"cellId\": msg.inputs.body.location.cellId,\n        \"locationAreaCode\": msg.inputs.body.location.locationAreaCode,\n        \"mobileCountryCode\": msg.inputs.body.location.mobileCountryCode,\n        \"mobileNetworkCode\": msg.inputs.body.location.mobileNetworkCode\n    }];\n}\nif (msg.inputs.body.hasOwnProperty(\"cell_tower_info\")) {\n    var carrier = msg.inputs.body.cell_tower_info.Carrier;\n    var cellTowers = [{\n        \"cellId\": msg.inputs.body.cell_tower_info.CellID,\n        \"locationAreaCode\": msg.inputs.body.cell_tower_info.LAC,\n        \"mobileCountryCode\": msg.inputs.body.cell_tower_info.MCC,\n        \"mobileNetworkCode\": msg.inputs.body.cell_tower_info.MNC\n    }];\n}\nnode.warn({\"Google Loc Test\": cellTowers})\nif (cellTowers.cellId === 0) {\n    return [msg,null]\n}\nmsg.url = global.get(\"VCAP_GOOGLE\").credentials[\"Google_Geolocate_url\"] + \"?key=\" + global.get(\"VCAP_GOOGLE\").credentials.key;\nmsg.payload = {\n    \"carrier\" : carrier,\n    \"considerIP\" : false,\n    \"cellTowers\" : cellTowers\n};\nreturn [null,msg];  \n",
        "outputs": 2,
        "noerr": 0,
        "x": 200,
        "y": 60,
        "wires": [
          [
            "3bd74387.03639c"
          ],
          [
            "47d467e8.16f018"
          ]
        ],
        "outputLabels": [
          "no loc",
          "yes loc"
        ]
      },
      {
        "id": "67a9b438.23fefc",
        "type": "function",
        "z": "d1af1cc8.e0fda",
        "name": "Extract Lat & Lng",
        "func": "if (msg.payload.hasOwnProperty(\"location\") && msg.payload.location.hasOwnProperty(\"lat\") && msg.payload.location.hasOwnProperty(\"lng\"))\n{\n    msg.inputs.body.geo_location = [ msg.payload.location.lng, msg.payload.location.lat ];\n    msg.url = global.get(\"VCAP_GOOGLE\").credentials[\"Google_Geocoding_url\"] + \"?key=\" + global.get(\"VCAP_GOOGLE\").credentials.key + \"&latlng=\" + msg.payload.location.lat + \",\" + msg.payload.location.lng;\n    return [null,msg];\n}\nelse\n{\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 670,
        "y": 100,
        "wires": [
          [
            "e220d288.2368c"
          ],
          [
            "837f04ae.861f28"
          ]
        ],
        "outputLabels": [
          "no geo",
          "yes geo"
        ]
      },
      {
        "id": "837f04ae.861f28",
        "type": "http request",
        "z": "d1af1cc8.e0fda",
        "name": "Coordinates by Lat & Lng",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 910,
        "y": 140,
        "wires": [
          [
            "1140d829.f33a88"
          ]
        ]
      },
      {
        "id": "1140d829.f33a88",
        "type": "function",
        "z": "d1af1cc8.e0fda",
        "name": "Extract Address",
        "func": "if (msg.payload.hasOwnProperty(\"results\"))\n{\n    msg.inputs.body.address = msg.payload.results[0].formatted_address\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 140,
        "wires": [
          [
            "e220d288.2368c"
          ]
        ]
      },
      {
        "id": "3bd74387.03639c",
        "type": "function",
        "z": "d1af1cc8.e0fda",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug) {\n    node.warn({\"Google Location\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1530,
        "y": 20,
        "wires": [
          []
        ]
      },
      {
        "id": "dae23b4c.58a628",
        "type": "subflow:d1af1cc8.e0fda",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1220,
        "y": 120,
        "wires": [
          [
            "9904e65e.ae5fc8"
          ]
        ]
      },
      {
        "id": "e220d288.2368c",
        "type": "function",
        "z": "d1af1cc8.e0fda",
        "name": "clean up",
        "func": "delete msg.topic;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.statusCode;\ndelete msg.method;\ndelete msg.headers;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1340,
        "y": 100,
        "wires": [
          [
            "3bd74387.03639c"
          ]
        ]
      },
      {
        "id": "9904e65e.ae5fc8",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Check Zip",
        "func": "if( Array.isArray(msg.inputs.body.case_log)) {\n    msg.payload = msg.inputs.body.case_log;\n    return [null, msg];\n}\nif(!msg.inputs.body.case_log.includes(\"\\r\\n\") && msg.inputs.body.case_log.includes(\"\\n\")) {\n    msg.inputs.body.case_log = msg.inputs.body.case_log.replace(new RegExp(\"\\n\",\"g\"), \"\\r\\n\")\n}\nreturn [msg, null]\n",
        "outputs": 2,
        "noerr": 0,
        "x": 1420,
        "y": 120,
        "wires": [
          [
            "7f117f38.e5dae"
          ],
          [
            "4047cc95.c465f4"
          ]
        ],
        "outputLabels": [
          "no zip",
          "yes zip"
        ]
      },
      {
        "id": "4047cc95.c465f4",
        "type": "gzip",
        "z": "c13a158d.882c9",
        "name": "gzip",
        "x": 1550,
        "y": 160,
        "wires": [
          [
            "1709ce1d.cc3342"
          ]
        ]
      },
      {
        "id": "1709ce1d.cc3342",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Unzip",
        "func": "msg.inputs.body.case_log = msg.payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1670,
        "y": 160,
        "wires": [
          [
            "7f117f38.e5dae"
          ]
        ]
      },
      {
        "id": "16e08fbd.a31d5",
        "type": "json",
        "z": "c13a158d.882c9",
        "name": "json Parser",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 710,
        "y": 160,
        "wires": [
          [
            "d81d6328.63bd8"
          ]
        ]
      },
      {
        "id": "936cde6b.71bbf",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Check String",
        "func": "if (typeof msg.payload === \"string\") { return [null, msg] }\nreturn [msg, null]; \n",
        "outputs": 2,
        "noerr": 0,
        "x": 550,
        "y": 120,
        "wires": [
          [
            "d81d6328.63bd8"
          ],
          [
            "16e08fbd.a31d5"
          ]
        ],
        "outputLabels": [
          "no str",
          "yes str"
        ]
      },
      {
        "id": "16e45ddb.eb4f52",
        "type": "json",
        "z": "c13a158d.882c9",
        "name": "json Parser",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 690,
        "y": 500,
        "wires": [
          [
            "6e753d70.f649c4"
          ]
        ]
      },
      {
        "id": "b4af5a85.dd66b8",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Check String",
        "func": "if (typeof msg.payload === \"string\") { return [null, msg] }\nreturn [msg, null]; \n",
        "outputs": 2,
        "noerr": 0,
        "x": 530,
        "y": 460,
        "wires": [
          [
            "6e753d70.f649c4"
          ],
          [
            "16e45ddb.eb4f52"
          ]
        ],
        "outputLabels": [
          "no str",
          "yes str"
        ]
      },
      {
        "id": "34fde09c.48d09",
        "type": "json",
        "z": "c13a158d.882c9",
        "name": "json Parser",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 690,
        "y": 820,
        "wires": [
          [
            "df25c52.2380638"
          ]
        ]
      },
      {
        "id": "6af691a.8709e7",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Check String",
        "func": "if (typeof msg.payload === \"string\") { return [null, msg] }\nreturn [msg, null]; \n",
        "outputs": 2,
        "noerr": 0,
        "x": 530,
        "y": 780,
        "wires": [
          [
            "df25c52.2380638"
          ],
          [
            "34fde09c.48d09"
          ]
        ],
        "outputLabels": [
          "no str",
          "yes str"
        ]
      },
      {
        "id": "bccb7190.ed50a",
        "type": "subflow:e0cd8199.1ad77",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1380,
        "y": 780,
        "wires": [
          [
            "3db4fea3.8c93c2"
          ]
        ]
      },
      {
        "id": "b1728cc7.2155a",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1750,
        "y": 780,
        "wires": []
      },
      {
        "id": "3db4fea3.8c93c2",
        "type": "subflow:313bd1d3.01c06e",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1570,
        "y": 780,
        "wires": [
          [
            "b1728cc7.2155a"
          ]
        ]
      },
      {
        "id": "d3d9378b.b98a28",
        "type": "subflow:d1af1cc8.e0fda",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1220,
        "y": 460,
        "wires": [
          [
            "c66fda46.2bbc38"
          ]
        ]
      },
      {
        "id": "ff55fb19.447ac8",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Device Found",
        "func": "delete msg.inputs.body.birth;\ndelete msg.inputs.body.field_birth;\nif (msg.inputs.body.hasOwnProperty(\"location\")) { delete msg.inputs.body.location }\nif (!msg.hasOwnProperty(\"device\") || msg.device.length === 0 || msg.device[0].doc_type !== \"device\") {\n    return [null,msg]\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1620,
        "y": 460,
        "wires": [
          [
            "1de150bb.6b7c4f"
          ],
          [
            "6e7bfc80.952a44"
          ]
        ],
        "outputLabels": [
          "yes",
          "no"
        ]
      },
      {
        "id": "6e7bfc80.952a44",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Device with serial number: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1810,
        "y": 500,
        "wires": [
          [
            "b832460e.4625b8"
          ]
        ]
      },
      {
        "id": "b832460e.4625b8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2960,
        "y": 500,
        "wires": []
      },
      {
        "id": "c66fda46.2bbc38",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1430,
        "y": 460,
        "wires": [
          [
            "ff55fb19.447ac8"
          ]
        ]
      },
      {
        "id": "76ea0f8f.2a839",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Birth EDHR",
        "func": "if (msg.inputs.birth) {\n    return [msg,null]\n} else {\n    msg.cloudant = {\n        \"request\": \"/stellaris_logs/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"last_edhr\",\n        \"selector\": {\n            \"doc_type\": \"edhr\",\n            \"system_sn\": msg.inputs.device_id,\n        },\n        \"sort\": [{\"timestamp:number\": \"desc\"}],\n        \"limit\": 2\n    };\n    \n    msg.api.path = 2;\n    msg.records.returns.splice(msg.records.returns.indexOf(\"sims\"), 1)\n\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1970,
        "y": 420,
        "wires": [
          [
            "31ae35e1.daf33a",
            "ed6f43d3.45a1c"
          ],
          [
            "2c2f61c1.5814be",
            "45b0ab31.18db54"
          ]
        ],
        "outputLabels": [
          "yes birth",
          "no birth"
        ]
      },
      {
        "id": "1de150bb.6b7c4f",
        "type": "subflow:e0cd8199.1ad77",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1800,
        "y": 420,
        "wires": [
          [
            "76ea0f8f.2a839"
          ]
        ]
      },
      {
        "id": "fea2f747.faca78",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "EDHR Changes",
        "func": "if (!msg.hasOwnProperty(\"last_edhr\") || msg.last_edhr.length < 2) {\n    //no EDHR with no birth flag send error\n    return [null,msg];\n}\nmsg.last_edhr.splice(0,1); //remove the latest one of 2 retrieved\nvar new_modlist = msg.edhr[0].modlist;\nvar modlist = msg.last_edhr[0].modlist;\nvar new_software_options = msg.edhr[0].software_options;\nvar software_options = msg.last_edhr[0].software_options;\n// Do not trigger a change email on these items changing\nvar no_trigger_modlist =\n{\n    \"footrx_info\" : \"FC Receiver\",\n    \"footctrl_info\" : \"Foot Control\",\n    \"foottx_info\" : \"FC Transmitter\",\n    \"mmc_info\" : \"MMC\"\n}\n//compare\nvar mod_compare = objectsAreEqual(new_modlist, modlist);\nvar software_options_compare = objectsAreEqual(new_software_options, software_options);\nif(mod_compare[0] !== true)\n{\n    mod_compare[0] = true;\n    var diff = {};\n    for (var prop in mod_compare[1])\n    {\n        if (!no_trigger_modlist.hasOwnProperty(prop))\n        {\n            diff[prop] = mod_compare[1][prop];\n            mod_compare[0] = false;\n        }\n    }\n    if (mod_compare[0] !== false)\n    {\n        mod_compare[1] = diff;\n    }\n}\nif(!mod_compare[0] || !software_options_compare[0]) {\n    //change exists log edhr and send edhr change email\n    msg.diffs = {\n        \"module_diff\" : mod_compare[1],\n        \"software_diff\" : software_options_compare[1]\n    };\n    var propertyList = [\"service_area\",\"service_region\",\"service_territory\", \"sales_area\", \"sales_region\", \"sales_territory\"];\n    var filter = {};\n    var device = msg.device[0];\n    Object.keys(device).forEach(function(propertyName){\n        if(propertyList.indexOf(propertyName)>=0){\n            if(device[propertyName] === \"\"){\n                filter[propertyName] = \"ALL\"\n            }\n            else {\n                filter[propertyName] = {\"$or\": [device[propertyName], \"ALL\"]}\n            }\n        }\n    });\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"bookmark_type\": \"payload\", //\"payload\", \"parameter\"\n        \"fields\": [\"email\"],\n        \"object\": \"email_users\",\n        \"selector\": {\n    \t\t\"$and\": [\n    \t\t\t{\"doc_type\": \"user\"},\n    \t\t\t{\"status\": \"active\"},\n    \t\t\t{\"gets_change_email\": true},\n    \t\t\t{\"business_unit\": {\"$or\": [device.business_unit, \"ALL\"]}},\n        \t\t{ \"$or\": [\n        \t\t\t{\"$and\": [\n        \t\t\t\t{\"bart_sart\": \"sart\"},\n        \t\t\t\t{\"service_area\": filter.service_area},\n        \t\t\t\t{\"service_region\": filter.service_region},\n        \t\t\t\t{\"service_territory\": filter.service_territory}\n        \t\t\t\t]},\n        \t\t\t{\"$and\": [\n        \t\t\t\t{\"bart_sart\": \"bart\"},\n        \t\t\t\t{\"sales_area\": filter.sales_area},\n        \t\t\t\t{\"sales_region\": filter.sales_region},\n        \t\t\t\t{\"sales_territory\": filter.sales_territory}\n        \t\t\t\t]}\n        \t\t\t]}\n        \t\t]\n    \t}\n    }\n    return [msg,null];\n} else {\n    //no change log edhr do nothing\n}\n\n//function used to compare objects\nfunction objectsAreEqual(a, b) {\n  var diff = {};\n  var equal = true;\n  for (var prop in a) {\n    if (a.hasOwnProperty(prop)) {\n      if (b.hasOwnProperty(prop)) {\n        if (typeof a[prop] === 'object') {\n          if (!propertiesAreEqual(a[prop], b[prop])) {\n            diff[prop] = b[prop];\n            equal = false;\n          }\n        } else {\n          if (a[prop] !== b[prop]) {\n            diff[prop] = b[prop];\n            equal = false;\n          }\n        }\n      } else {\n      \tdiff[prop] = \"Item Missing\";\n        equal = false;\n      }\n    }\n  }\n  for (var propb in b) {\n    if (!a.hasOwnProperty(propb)) {\n      \tdiff[propb] = b[propb];\n        equal = false;\n      }\n    }\n  return [equal, diff];\n}\n\n//function used to compare properties (which may be objects or properties themselves)\nfunction propertiesAreEqual(a, b) {\n  var equal = true;\n  for (var prop in a) {\n    if (a.hasOwnProperty(prop)) {\n      if (b.hasOwnProperty(prop)) {\n        if (typeof a[prop] === 'object') {\n          if (!propertiesAreEqual(a[prop], b[prop])) {\n            equal = false;\n          }\n        } else {\n          if (a[prop] !== b[prop]) {\n            equal = false;\n          }\n        }\n      } else {\n        equal = false;\n      }\n    }\n  }\n  for (var propb in b) {\n    if (!a.hasOwnProperty(propb)) {\n       equal = false; \n    }\n  }\n  return equal;\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 2560,
        "y": 460,
        "wires": [
          [
            "face4fb3.a4bda"
          ],
          [
            "834ab15d.2f968"
          ]
        ],
        "outputLabels": [
          "yes last_edhr",
          "no last_edhr"
        ]
      },
      {
        "id": "9a2b83eb.4bddf",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 4070,
        "y": 280,
        "wires": []
      },
      {
        "id": "ed6f43d3.45a1c",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Update Device",
        "func": "msg.inputs.edhr_body = Object.assign({}, msg.inputs.body);\nmsg.inputs.body =  msg.device[0];\nmsg.inputs.body.edhr_birth_record_id = msg.edhr[0]._id;\nmsg.records.object = \"device\";\nmsg.records.doc_type = \"device\";\nmsg.records.id =  msg.device[0]._id;\ndelete msg.cloudant.object;\ndelete msg.cloudant.doc_type;\ndelete msg.device;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2000,
        "y": 280,
        "wires": [
          [
            "294a1eec.7dd4a2"
          ]
        ]
      },
      {
        "id": "294a1eec.7dd4a2",
        "type": "subflow:68197f61.7975",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2190,
        "y": 280,
        "wires": [
          [
            "fcbe3ce0.afe1e"
          ]
        ]
      },
      {
        "id": "e6bae4eb.61e7f8",
        "type": "link in",
        "z": "c13a158d.882c9",
        "name": "SIM Loop in",
        "links": [
          "df0facf9.de32f"
        ],
        "x": 2415,
        "y": 200,
        "wires": [
          [
            "547b5bc9.3f8334"
          ]
        ]
      },
      {
        "id": "df0facf9.de32f",
        "type": "link out",
        "z": "c13a158d.882c9",
        "name": "SIM Loop out",
        "links": [
          "e6bae4eb.61e7f8"
        ],
        "x": 3455,
        "y": 180,
        "wires": []
      },
      {
        "id": "31ae35e1.daf33a",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Birth Email",
        "func": "msg.email = msg.email || {};\nconst edhr = msg.edhr[0];\nconst device = msg.device[0];\n\n// Software Option Names\nconst software_list =\n{\n    vitesse_enabled: 'Vitesse',\n    gateway_enabled: 'Gateway',\n};\n\n// All possible modules\nconst anterior_info = 'Anterior',\n    compressor_info = 'Compressor',\n    fluidics_info = 'Fluidics',\n    footcan_info = 'FCIB',\n    footctrl_info = 'Foot Control',\n    footrx_info = 'FC Receiver', // remove for > v1\n    foottx_info = 'FC Transmitter', // remove for > v1\n    gateway_info = 'Gateway',\n    glm_info = 'Laser',\n    ivpole_info = 'IVPole',\n    lamp1_info = 'Lamp 1',\n    lamp2_info = 'Lamp 2',\n    mmc_info = 'MMC',\n    posterior_info = 'Illumination',\n    power_info = 'Power Supply',\n    remote_info = 'Remote',\n    sim1_iccid = 'SIM 1',\n    sim2_iccid = 'SIM 2',\n    uic_info = 'UIC';\n\nconst full_modlist =\n{\n    uic_info,\n    remote_info,\n    anterior_info,\n    ivpole_info,\n    footcan_info,\n    footctrl_info,\n    footrx_info,\n    foottx_info,\n    power_info,\n    fluidics_info,\n    compressor_info,\n    posterior_info,\n    glm_info,\n    lamp1_info,\n    lamp2_info,\n    mmc_info,\n    gateway_info,\n    sim1_iccid,\n    sim2_iccid\n};\n\n// Anterior System - HFM\nconst BL11145 =\n{\n    uic_info,\n    remote_info,\n    anterior_info,\n    ivpole_info,\n    footctrl_info,\n    footrx_info,\n    foottx_info,\n    power_info,\n    fluidics_info,\n    compressor_info,\n    gateway_info,\n    sim1_iccid\n};\n\n// Anterior System - VFM\nconst BL11115 = BL11145;\n\n// Anterior System - AFM\nconst BL11125 = BL11145;\n\n// Stellaris PC Combined System - 7.5K\nconst BL14455 = Object.assign({ footcan_info, lamp1_info, lamp2_info, posterior_info }, BL11145);\n\n// Stellaris PC Combined System - 5.0K\nconst BL14335 = BL14455;\n\n// Stellaris PC Laser System - 7.5K\nconst BL15455 = Object.assign({ glm_info }, BL14455);\n\n// Stellaris PC Laser System - 5.0K\nconst BL15335 = BL15455;\n\nconst modlistLookup = { 'BL15455': BL15455, 'BL15455E': BL15455, 'BL15335': BL15335, 'BL14455': BL14455, 'BL14335': BL14335, 'BL11145': BL11145, 'BL11115': BL11115, 'BL11125': BL11125 };\nconst defaultModlist = BL15455;\nconst system_modlist = modlistLookup[device.system_type] || defaultModlist;\n\nif (edhr.software_options.gateway_enabled == 'disabled') {\n    delete system_modlist.gateway_info;\n    delete system_modlist.sim1_iccid;\n}\n\n// Build message\nlet mod_string = '';\n\nif (msg.v1) {\n    for(var propertyName in edhr.modlist) {\n        var itemPrinted = false;\n        if (system_modlist.hasOwnProperty(propertyName))\n        {\n            mod_string += \n                full_modlist[propertyName] +\n                ', ' + edhr.modlist[propertyName].SN;\n            if (edhr.modlist[propertyName].present != 'PRESENT')\n            {\n                mod_string += ', ' + edhr.modlist[propertyName].present;\n            }\n            itemPrinted = true;\n        }\n        // Unexpected and present\n        else if (full_modlist.hasOwnProperty(propertyName) &&\n                 edhr.modlist[propertyName].present == 'PRESENT')\n        {\n            mod_string += \n                full_modlist[propertyName] +\n                ', ' + edhr.modlist[propertyName].SN;\n            itemPrinted = true;\n        }\n        // SW & HW\n        //expected or present with SW/HW\n        if ((system_modlist.hasOwnProperty(propertyName) || \n             edhr.modlist[propertyName].present == 'PRESENT') &&\n            edhr.modlist[propertyName].SW_version !== '')\n        {\n            mod_string +=\n                ', SW v' + edhr.modlist[propertyName].SW_version +\n                ', HW v' + edhr.modlist[propertyName].HW_version;\n            itemPrinted = true;\n        }\n        //expected or present without SW/HW\n        else if (system_modlist.hasOwnProperty(propertyName) || \n                 edhr.modlist[propertyName].present == 'PRESENT')\n        {\n            // end the string\n            // nothing to add here\n            itemPrinted = true;\n        }\n        //expected but missing\n        else if (system_modlist.hasOwnProperty(propertyName) &&\n                  edhr.modlist[propertyName].present !== 'PRESENT')\n        {\n            mod_string += ', ' + edhr.modlist[propertyName].present;\n            itemPrinted = true;\n        }\n        // end the line\n        if (itemPrinted === true)\n        {\n            mod_string += '\\n<br />\\n';\n        }\n    }\n} else {\n    const noPrintOnGatewaySNBlank = ['gateway_info', 'sim1_iccid', 'sim2_iccid'];\n\n    // strip foot rx/tx props\n    ['footrx_info', 'foottx_info'].forEach(x => {\n        if (full_modlist[x]) delete full_modlist[x];\n        if (system_modlist[x]) delete system_modlist[x];\n    });\n\n    for (let propertyName in edhr.modlist) {\n        let startMessageLength = mod_string.length; // TODO: Discuss: Could we not just do a before length and a check 'If now longer add newline?';\n        if (noPrintOnGatewaySNBlank.indexOf(propertyName) === -1 || \n            (noPrintOnGatewaySNBlank.indexOf(propertyName) >= 0 && edhr.modlist['gateway_info'].SN) || \n            /E$/.test(device.system_type)) {\n            if (system_modlist[propertyName]) {\n                mod_string +=\n                    full_modlist[propertyName] +\n                    ((propertyName !== 'remote_info') ? ', ' + edhr.modlist[propertyName].SN : '');\n                if (edhr.modlist[propertyName].present != 'PRESENT') {\n                    mod_string += ', ' + edhr.modlist[propertyName].present;\n                }\n            }\n            // Unexpected and present // ? Seems _this block is for SIMs only?\n            else if (full_modlist[propertyName] &&\n                edhr.modlist[propertyName].present == 'PRESENT') {\n                mod_string +=\n                    full_modlist[propertyName] +\n                    ', ' + edhr.modlist[propertyName].SN;\n            }\n            // SW & HW\n            //expected or present with SW/HW\n            if ((system_modlist[propertyName] ||\n                edhr.modlist[propertyName].present == 'PRESENT') &&\n                edhr.modlist[propertyName].SW_version !== '') {\n                mod_string +=\n                    ', SW v' + edhr.modlist[propertyName].SW_version +\n                    ', HW v' + edhr.modlist[propertyName].HW_version;\n            }\n            //expected but missing\n            else if (system_modlist[propertyName] &&\n                edhr.modlist[propertyName].present !== 'PRESENT') {\n                mod_string += ', ' + edhr.modlist[propertyName].present;\n            }\n            // end the line\n            if (mod_string.length > startMessageLength) {\n                mod_string += '\\n<br />\\n';\n            }\n        }\n    }\n}\n\n\nlet settings_string = '';\n\nfor (let propertyName in edhr.software_options) {\n    settings_string +=\n        software_list[propertyName] +\n        ': ' + edhr.software_options[propertyName] +\n        '\\n<br />\\n';\n}\n\nmsg.email.topic = 'Machine Birth Certificate for ' + device._id;\nmsg.email.to = global.get('BIRTH_EMAIL_DISTRIBUTION');\nmsg.email.template_type = 'device_birth';\nmsg.email.fields = {\n    system_type: device.system_type,\n    system_sn: device._id,\n    system_birth_date: new Date(edhr.timestamp),\n    system_config: mod_string,\n    software_options: settings_string,\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2930,
        "y": 400,
        "wires": [
          [
            "a7846b6a.8031c8"
          ]
        ]
      },
      {
        "id": "a7846b6a.8031c8",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 3100,
        "y": 400,
        "wires": [
          []
        ]
      },
      {
        "id": "d41b7ed3.80e1e",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Change Email",
        "func": "if (!msg.hasOwnProperty(\"email\")) { msg.email = {} }\nvar edhr = msg.edhr[0];\nvar device = msg.device[0];\nmsg.email.to = msg.email_users.map(a => a.email);\n\n//set up email\nvar mod_string = \"\";\nvar mod_changes_string = \"\";\nvar mod_changed = false;\nvar mult_mod_changed = false;\n\n// Software Option Names\nvar software_list =\n{\n    \"vitesse_enabled\" : \"Vitesse\",\n    \"gateway_enabled\" : \"Gateway\",\n};\n\n// All possible modules\nvar full_modlist =\n{\n    \"uic_info\" : \"UIC\",\n    \"remote_info\" : \"Remote\",\n    \"anterior_info\" : \"Anterior\",\n    \"ivpole_info\" : \"IVPole\",\n    \"footcan_info\" : \"FCIB\",\n    \"footrx_info\" : \"FC Receiver\",\n    \"footctrl_info\" : \"Foot Control\",\n    \"foottx_info\" : \"FC Transmitter\",\n    \"power_info\" : \"Power Supply\",\n    \"fluidics_info\" : \"Fluidics\",\n    \"compressor_info\" : \"Compressor\",\n    \"posterior_info\" : \"Illumination\",\n    \"glm_info\" : \"Laser\",\n    \"lamp1_info\" : \"Lamp 1\",\n    \"lamp2_info\" : \"Lamp 2\",\n    \"mmc_info\" : \"MMC\",\n    \"gateway_info\" : \"Gateway\",\n    \"sim1_iccid\" : \"SIM 1\",\n    \"sim2_iccid\" : \"SIM 2\"\n};\n\n// Stellaris PC Laser System - 7.5K\nvar BL15455 =\n{\n    \"uic_info\" : \"UIC\",\n    \"remote_info\" : \"Remote\",\n    \"anterior_info\" : \"Anterior\",\n    \"ivpole_info\" : \"IVPole\",\n    \"footcan_info\" : \"FCIB\",\n    \"footrx_info\" : \"FC Receiver\",\n    \"footctrl_info\" : \"Foot Control\",\n    \"foottx_info\" : \"FC Transmitter\",\n    \"power_info\" : \"Power Supply\",\n    \"fluidics_info\" : \"Fluidics\",\n    \"compressor_info\" : \"Compressor\",\n    \"posterior_info\" : \"Illumination\",\n    \"glm_info\" : \"Laser\",\n    \"lamp1_info\" : \"Lamp 1\",\n    \"lamp2_info\" : \"Lamp 2\",\n    \"gateway_info\" : \"Gateway\",\n    \"sim1_iccid\" : \"SIM 1\"\n};\n\n// Stellaris PC Laser System - 5.0K\nvar BL15335 = BL15455;\n\n// Stellaris PC Combined System - 7.5K\nvar BL14455 =\n{\n    \"uic_info\" : \"UIC\",\n    \"remote_info\" : \"Remote\",\n    \"anterior_info\" : \"Anterior\",\n    \"ivpole_info\" : \"IVPole\",\n    \"footcan_info\" : \"FCIB\",\n    \"footrx_info\" : \"FC Receiver\",\n    \"footctrl_info\" : \"Foot Control\",\n    \"foottx_info\" : \"FC Transmitter\",\n    \"power_info\" : \"Power Supply\",\n    \"fluidics_info\" : \"Fluidics\",\n    \"compressor_info\" : \"Compressor\",\n    \"posterior_info\" : \"Illumination\",\n    \"lamp1_info\" : \"Lamp 1\",\n    \"lamp2_info\" : \"Lamp 2\",\n    \"gateway_info\" : \"Gateway\",\n    \"sim1_iccid\" : \"SIM 1\"\n};\n\n// Stellaris PC Combined System - 5.0K\nvar BL14335 = BL14455;\n\n// Anterior System - HFM\nvar BL11145 =\n{\n    \"uic_info\" : \"UIC\",\n    \"remote_info\" : \"Remote\",\n    \"anterior_info\" : \"Anterior\",\n    \"ivpole_info\" : \"IVPole\",\n    \"footcan_info\" : \"FCIB\",\n    \"footrx_info\" : \"FC Receiver\",\n    \"footctrl_info\" : \"Foot Control\",\n    \"foottx_info\" : \"FC Transmitter\",\n    \"power_info\" : \"Power Supply\",\n    \"fluidics_info\" : \"Fluidics\",\n    \"compressor_info\" : \"Compressor\",\n    \"gateway_info\" : \"Gateway\",\n    \"sim1_iccid\" : \"SIM 1\"\n};\n\n// Anterior System - VFM\nvar BL11115 = BL11145;\n    \n// Anterior System - AFM\nvar BL11125 = BL11145;\n\nvar system_modlist;\nif (device.system_type == \"BL15455\")\n    system_modlist = BL15455;\nelse if (device.system_type == \"BL15335\")\n    system_modlist = BL15335;\nelse if (device.system_type == \"BL14455\")\n    system_modlist = BL14455;\nelse if (device.system_type == \"BL14335\")\n    system_modlist = BL14335;\nelse if (device.system_type == \"BL11145\")\n    system_modlist = BL11145;\nelse if (device.system_type == \"BL11115\")\n    system_modlist = BL11115;\nelse if (device.system_type == \"BL11125\")\n    system_modlist = BL11125;\nelse\n    system_modlist = BL15455;\n\nif (edhr.software_options.gateway_enabled == \"disabled\")\n{\n    delete system_modlist.gateway_info;\n    delete system_modlist.sim1_iccid;\n}\n\nfor(var propertyName in system_modlist) \n{\n    if (system_modlist.hasOwnProperty(propertyName))\n    {\n        if (edhr.modlist.hasOwnProperty(propertyName))\n        {\n            mod_string += \n                full_modlist[propertyName];\n            //expected and present\n            if (edhr.modlist[propertyName].present == \"PRESENT\")\n            {\n                mod_string += \", \" + edhr.modlist[propertyName].SN;\n            }\n            //expected but missing\n            else\n            {\n                mod_string += \", \" + edhr.modlist[propertyName].present;\n            }\n        }\n        //expected but missing\n        else\n        {\n            mod_string += full_modlist[propertyName] + \", MISSING\";\n        }\n    }\n\t// Unexpected and present\n    else if (full_modlist.hasOwnProperty(propertyName) &&\n             edhr.modlist.hasOwnProperty(propertyName) &&\n             edhr.modlist[propertyName].present == \"PRESENT\")\n    {\n        mod_string += \n            full_modlist[propertyName] +\n            \", \" + edhr.modlist[propertyName].SN;\n    }\n\t// SW & HW\n    //expected or present with SW/HW\n    if (edhr.modlist.hasOwnProperty(propertyName) &&\n        (system_modlist.hasOwnProperty(propertyName) || \n         edhr.modlist[propertyName].present == \"PRESENT\") &&\n        edhr.modlist[propertyName].SW_version !== \"\")\n    {\n        mod_string +=\n            \", SW v\" + edhr.modlist[propertyName].SW_version +\n            \", HW v\" + edhr.modlist[propertyName].HW_version;\n    }\n    //expected or present without SW/HW\n    else if (edhr.modlist.hasOwnProperty(propertyName) &&\n             (system_modlist.hasOwnProperty(propertyName) || \n              edhr.modlist[propertyName].present == \"PRESENT\"))\n    {\n        // end the string\n        // nothing to add here\n    }\n    // end the line\n    mod_string += \"\\n<br />\\n\"; \n}\nfor(var propertyName in msg.diffs.module_diff) \n{\n\tif (full_modlist.hasOwnProperty(propertyName))\n\t{\n\t\tmod_changes_string += full_modlist[propertyName];\n\t}\n\telse\n\t{\n\t\tmod_changes_string += propertyName;\n\t}\n\tmod_changes_string += \":\\n<br />\\n\" + \"From: \";\n    if (typeof msg.diffs.module_diff[propertyName] === 'object')\n    {\n\t\tif (msg.diffs.module_diff[propertyName].present == \"PRESENT\")\n\t\t{\n\t\t    mod_changes_string +=\n                msg.diffs.module_diff[propertyName].SN;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tmod_changes_string += msg.diffs.module_diff[propertyName].present;\n\t\t}\n\t\t// Present with SW/HW\n\t\tif ((msg.diffs.module_diff[propertyName].present == \"PRESENT\") &&\n\t\t\tmsg.diffs.module_diff[propertyName].SW_version !== \"\")\n\t\t{\n\t\t\tmod_changes_string +=\n\t\t\t\t\", SW v\" + msg.diffs.module_diff[propertyName].SW_version +\n\t\t\t\t\", HW v\" + msg.diffs.module_diff[propertyName].HW_version;\n\t\t}\n\t\t// Present without SW/HW\n\t\telse if (msg.diffs.module_diff[propertyName].present == \"PRESENT\")\n\t\t{\n\t\t\t// end the string\n\t\t\t// nothing to add here\n\t\t}\n\t\t// Missing\n\t\telse if (msg.diffs.module_diff[propertyName].present !== \"PRESENT\")\n\t\t{\n\t\t\tmod_string += \", \" + msg.diffs.module_diff[propertyName].present;\n\t\t}\n    }\n    else\n    {\n    \tmod_changes_string += msg.diffs.module_diff[propertyName];\n    }\n    if (edhr.modlist.hasOwnProperty(propertyName))\n    {\n        mod_changes_string += \"\\n<br />\\n\" + \"To:&emsp; \" +\n        edhr.modlist[propertyName].SN;\n\t\tif (edhr.modlist[propertyName].present != \"PRESENT\")\n\t\t{\n\t\t\tmod_changes_string += \", \" + edhr.modlist[propertyName].present;\n\t\t}\n\t\t// Present with SW/HW\n\t\tif ((edhr.modlist[propertyName].present == \"PRESENT\") &&\n\t\t\tedhr.modlist[propertyName].SW_version !== \"\")\n\t\t{\n\t\t\tmod_changes_string +=\n\t\t\t\t\", SW v\" + edhr.modlist[propertyName].SW_version +\n\t\t\t\t\", HW v\" + edhr.modlist[propertyName].HW_version;\n\t\t}\n\t\t// Present without SW/HW\n\t\telse if (edhr.modlist[propertyName].present == \"PRESENT\")\n\t\t{\n\t\t\t// end the string\n\t\t\t// nothing to add here\n\t\t}\n\t\t// Missing\n\t\telse if (edhr.modlist[propertyName].present !== \"PRESENT\")\n\t\t{\n\t\t\tmod_string += \", \" + edhr.modlist[propertyName].present;\n\t\t}\n    }\n    else\n    {\n        mod_changes_string += \"\\n<br />\\n\" + \"To:&emsp; Item Missing\";\n    }\n    mod_changes_string += \"\\n<br />\\n\";\n    if (mod_changed === true) mult_mod_changed = true;\n    else mod_changed = true;\n}\nvar mod_changed_text = \"\";\nif (mod_changed)\n{\n    mod_changed_text += \"The following module\";\n    if (mult_mod_changed) mod_changed_text += \"s\";\n    mod_changed_text += \" changed:\" +\n    \"\\n<br />\\n\" +\n    mod_changes_string +\n    \"\\n<br />\\n\";\n}\n\nvar settings_string = \"\";\nvar settings_changes_string = \"\";\nvar settings_changed = false;\nvar mult_settings_changed = false;\n\nfor(var propertyName in edhr.software_options) \n{\n    settings_string += \n        software_list[propertyName] + \n        \": \" + edhr.software_options[propertyName] + \n        \"\\n<br />\\n\";\n}\n\nfor(var propertyName in msg.diffs.software_diff) \n{\n    settings_changes_string += software_list[propertyName] + \": From \" +\n        msg.diffs.software_diff[propertyName];\n    if (edhr.software_options.hasOwnProperty(propertyName))\n    {\n        settings_changes_string += \" to \" +\n        edhr.software_options[propertyName];\n    }\n    settings_changes_string += \"\\n<br />\\n\";\n    if (settings_changed === true) mult_settings_changed = true;\n    else settings_changed = true;\n}\nvar settings_changed_text = \"\";\nif (settings_changed)\n{\n    settings_changed_text += \"The following setting\";\n    if (mult_settings_changed) settings_changed_text += \"s\";\n    settings_changed_text += \" changed:\" +\n    \"\\n<br />\\n\" +\n    settings_changes_string +\n    \"\\n<br />\\n\";\n}\nmsg.email.topic = \"Machine Change Certificate for \" + device._id;\nmsg.email.template_type = \"device_change\";\nmsg.email.fields = {\n    \"system_type\": device.system_type,\n    \"system_sn\": device._id,\n    \"update_time_stamp\":  new Date(edhr.timestamp),\n    \"mode_changes\": mod_changed_text,\n    \"settings_changes\": settings_changed_text,\n    \"system_config\": mod_string,\n    \"software_options\": settings_string,\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2940,
        "y": 440,
        "wires": [
          [
            "a7846b6a.8031c8"
          ]
        ]
      },
      {
        "id": "face4fb3.a4bda",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2750,
        "y": 440,
        "wires": [
          [
            "d41b7ed3.80e1e"
          ]
        ]
      },
      {
        "id": "834ab15d.2f968",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Last EDHR Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"There are no EDHR records for \" + msg.inputs.device_id + \". Please set birth flag if birthing.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2760,
        "y": 480,
        "wires": [
          [
            "b832460e.4625b8"
          ]
        ]
      },
      {
        "id": "2c2f61c1.5814be",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2370,
        "y": 460,
        "wires": [
          [
            "fea2f747.faca78"
          ]
        ]
      },
      {
        "id": "3b954974.1484e6",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 430,
        "y": 1000,
        "wires": [
          [
            "281bd196.6135ce"
          ]
        ]
      },
      {
        "id": "281bd196.6135ce",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Log EDHR",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Log EDHR\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\"],\n    \"object\": \"edhr\",\n    \"format\": \"JSON\",\n    \"returns\": [\"edhr\"]\n};\nmsg.inputs = {};\nmsg.filters = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/\" + msg.req.params.edhrID,\n    \"method\": \"GET\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 1000,
        "wires": [
          [
            "cb138a3b.4a5498"
          ]
        ]
      },
      {
        "id": "af176d8c.7bff5",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs/edhr/:edhrID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 1000,
        "wires": [
          [
            "3b954974.1484e6"
          ]
        ]
      },
      {
        "id": "cb138a3b.4a5498",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 850,
        "y": 920,
        "wires": [
          [
            "9f6e0906.b01d68"
          ]
        ]
      },
      {
        "id": "9f6e0906.b01d68",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Check Doc_Type & Found?",
        "func": "if(msg.hasOwnProperty(msg.records.object) && msg[msg.records.object][0].doc_type === msg.records.object ){\n    return [msg,null]\n    node.warn({\"Doc Type Match\": msg[msg.records.object][0].doc_type, msg});\n} else {\n    //error message\n    node.warn({\"Doc Type Does NOT Match\": msg[msg.records.object][0].doc_type, msg});\n    msg[msg.records.object] = [{}];\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1080,
        "y": 920,
        "wires": [
          [
            "8be210b3.c39db"
          ],
          [
            "44e94690.e0c348"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "728e2f44.71ddf",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Log Machine Life",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Log Machine Life\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\"],\n    \"object\": \"machine_life\",\n    \"format\": \"JSON\",\n    \"returns\": [\"machine_life\"]\n};\nmsg.inputs = {};\nmsg.filters = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/\" + msg.req.params.machine_lifeID,\n    \"method\": \"GET\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 920,
        "wires": [
          [
            "cb138a3b.4a5498"
          ]
        ]
      },
      {
        "id": "54d2c108.2f69",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Log Case",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Log Case\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\"],\n    \"object\": \"case\",\n    \"format\": \"JSON\",\n    \"returns\": [\"case\"]\n};\nmsg.inputs = {};\nmsg.filters = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/\" + msg.req.params.caseID,\n    \"method\": \"GET\",\n    \"return_obj\": \"\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 1080,
        "wires": [
          [
            "cb138a3b.4a5498"
          ]
        ]
      },
      {
        "id": "8be210b3.c39db",
        "type": "subflow:313bd1d3.01c06e",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1310,
        "y": 900,
        "wires": [
          [
            "df945697.3a0d88"
          ]
        ]
      },
      {
        "id": "26694e23.686142",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 430,
        "y": 920,
        "wires": [
          [
            "728e2f44.71ddf"
          ]
        ]
      },
      {
        "id": "2cc8cae9.633576",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 430,
        "y": 1080,
        "wires": [
          [
            "54d2c108.2f69"
          ]
        ]
      },
      {
        "id": "df945697.3a0d88",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1490,
        "y": 900,
        "wires": []
      },
      {
        "id": "5f1f858.6f20d7c",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs/machine_life/:machine_lifeID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 920,
        "wires": [
          [
            "26694e23.686142"
          ]
        ]
      },
      {
        "id": "f73ba262.d5b9b",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs/cases/:caseID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 1080,
        "wires": [
          [
            "2cc8cae9.633576"
          ]
        ]
      },
      {
        "id": "cab40ca4.51738",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[CN] Log EDHR",
        "info": "",
        "x": 100,
        "y": 960,
        "wires": []
      },
      {
        "id": "1fa7e252.0b1b6e",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[CN] Log Machine Life",
        "info": "",
        "x": 120,
        "y": 880,
        "wires": []
      },
      {
        "id": "e7bcaed2.c98ef",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[CN] Log Case",
        "info": "",
        "x": 100,
        "y": 1040,
        "wires": []
      },
      {
        "id": "691abd3f.b624b4",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/images/:filename",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 600,
        "wires": [
          [
            "986af045.2f9b5"
          ]
        ]
      },
      {
        "id": "bcbd04d6.dd9898",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Get Email Images",
        "func": "msg.api = {\n        \"name\": \"Email Image\",\n        \"version\": 2.0\n    };\nmsg.cos = {\n    \"method\": \"GET\",\n    \"filename\": \"machin_img.jpg\",\n    \"container\": \"email-images\" }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 640,
        "wires": [
          [
            "96b475e9.662688"
          ]
        ]
      },
      {
        "id": "ebfc8e3f.ff38c",
        "type": "http response",
        "z": "57a5a054.9dfd3",
        "name": "Return Image",
        "statusCode": "",
        "headers": {},
        "x": 1010,
        "y": 600,
        "wires": []
      },
      {
        "id": "7ee37e0c.262d9",
        "type": "inject",
        "z": "57a5a054.9dfd3",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "x": 160,
        "y": 640,
        "wires": [
          [
            "bcbd04d6.dd9898"
          ]
        ]
      },
      {
        "id": "cad137ba.8d04e8",
        "type": "comment",
        "z": "57a5a054.9dfd3",
        "name": "[EMAILS] [EULA}  Email Image",
        "info": "",
        "x": 140,
        "y": 560,
        "wires": []
      },
      {
        "id": "951b9520.93d548",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Surgeon Verify",
        "func": "var genPwd = global.get(\"genpwd\");\nmsg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Surgeon Verify\"\n    });\nmsg.records = {\n    \"doc_type\": \"user\",\n    \"object\": \"user\",\n    \"password\": genPwd.generate(global.get(\"PWD_GEN\"))\n};\nmsg.inputs = {\n    \"key\": msg.req.params.key\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 140,
        "wires": [
          [
            "8c80fe37.7909a"
          ]
        ]
      },
      {
        "id": "8c80fe37.7909a",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Check Key",
        "func": "if(msg.inputs.hasOwnProperty(\"key\") && (typeof msg.inputs.key === \"string\") && msg.inputs.key !== \"\") {\n    msg.inputs.body = JSON.parse(Buffer.from(msg.inputs.key, 'base64').toString())\n    if (msg.inputs.body.hasOwnProperty(\"first_name\") && msg.inputs.body.hasOwnProperty(\"last_name\") && msg.inputs.body.hasOwnProperty(\"email\") && msg.inputs.body.hasOwnProperty(\"id\")) {\n        msg.records.id = msg.inputs.body.id;\n        delete msg.inputs.body.id;\n        msg.cloudant = {\n            \"request\": \"/stellaris_documents/\" + msg.records.id,\n            \"method\": \"GET\",\n            \"return_obj\": \"\"\n        };\n        return [msg,null];\n    }\n}\nif(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The information in the request is invalid.\",\n})\nreturn [null,msg]\n\n//encode var key = Buffer.from(JSON.stringify(msg.inputs.body)).toString('base64')",
        "outputs": 2,
        "noerr": 0,
        "x": 830,
        "y": 140,
        "wires": [
          [
            "da8afa3c.d70d28"
          ],
          [
            "589ff27c.df7a9c"
          ]
        ],
        "outputLabels": [
          "yes key",
          "no key"
        ]
      },
      {
        "id": "da8afa3c.d70d28",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1010,
        "y": 120,
        "wires": [
          [
            "d88de838.8324c8"
          ]
        ]
      },
      {
        "id": "5d4be690.7e2678",
        "type": "subflow:68197f61.7975",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1370,
        "y": 100,
        "wires": [
          [
            "b7ac4c51.d02d7",
            "46ac8988.510c48"
          ]
        ]
      },
      {
        "id": "12ead310.043cdd",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1730,
        "y": 80,
        "wires": [
          [
            "160fa73c.a2f439"
          ]
        ]
      },
      {
        "id": "46ac8988.510c48",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Sales User",
        "func": "msg.cloudant.request = \"/stellaris_documents/\" + msg.user[0].created_by;\nmsg.cloudant.object = \"sales_user\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 80,
        "wires": [
          [
            "12ead310.043cdd"
          ]
        ]
      },
      {
        "id": "d88de838.8324c8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Check EULA",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].doc_type === \"user\") {\n    var surgeon = msg.user[0];\n    if (surgeon.hasOwnProperty(\"eula_accept_status\")) {\n        if (surgeon.eula_accept_status === \"accepted\") {\n            //already accepted EULA confirmation no email\n            return [null,msg,null];\n        } else {\n            if (msg.payload.eula_create_date + 86400000 < Date.now()) {\n                // time expired error\n                if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n                    msg.errors.push({\n                        \"code\": 400,\n                        \"message\": \"The request has expired.\",\n                    })\n                return [null,null,msg];\n            } else {\n                // accept EULA\n                msg.inputs.body.status = \"active\";\n                msg.inputs.body.eula_accept_status = \"accepted\";\n                msg.inputs.body.eula_accept_date = Date.now();\n                msg.inputs.body.role = \"Surgeon\";\n                return [msg,null,null]\n            }\n        }\n    }\n} else {\n    // user does not exist error\n    if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\n    msg.errors.push({\n        \"code\": 400,\n        \"message\": \"The request is for an invalid user.\",\n    })\n    return [null,null,msg];\n}\n\n",
        "outputs": 3,
        "noerr": 0,
        "x": 1190,
        "y": 120,
        "wires": [
          [
            "5d4be690.7e2678"
          ],
          [
            "b7ac4c51.d02d7"
          ],
          [
            "589ff27c.df7a9c"
          ]
        ],
        "outputLabels": [
          "no EULA",
          "yes EULA",
          "Error"
        ]
      },
      {
        "id": "589ff27c.df7a9c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1360,
        "y": 160,
        "wires": []
      },
      {
        "id": "891726ae.68c7b8",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Debug Send",
        "func": "if(msg.hasOwnProperty(\"to\")) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2290,
        "y": 120,
        "wires": [
          [
            "b5f8e84c.b5b468"
          ]
        ]
      },
      {
        "id": "7f3a67a2.38a2a8",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 840,
        "y": 1020,
        "wires": [
          [
            "3966126d.1d1fce"
          ]
        ]
      },
      {
        "id": "99270dcc.02d",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User New Surgeon",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User New Surgeon\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\", \"password\"],\n    \"doc_type\": \"user\",\n    \"object\": \"user\",\n    \"format\": \"JSON\",\n    \"models\": [\"user\"],\n    \"returns\": [\"message\",\"user\"],\n    \"error_on_found\": false,\n    \"first_name\": msg.payload.first_name,\n    \"last_name\": msg.payload.last_name,\n    \"created_by\": msg.payload.created_by,\n    \"return_code\": 201\n};\nmsg.message = \"A record for \" + msg.records.first_name + \" \" + msg.records.last_name + \" has been created.\"\nmsg.inputs = {\n    \"required\": [\"first_name\",\"last_name\",\"email\",\"created_by\"],\n    \"allowed\": []\n};\nif(msg.payload.hasOwnProperty(\"email\")) {\n    msg.records.email = msg.payload.email.toLowerCase();\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.created_by,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"creator\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 1020,
        "wires": [
          [
            "7f3a67a2.38a2a8"
          ]
        ]
      },
      {
        "id": "eaa135a5.e53a88",
        "type": "subflow:e0cd8199.1ad77",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1380,
        "y": 1020,
        "wires": [
          [
            "d588fe08.7a40a"
          ]
        ]
      },
      {
        "id": "3966126d.1d1fce",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1010,
        "y": 1020,
        "wires": [
          [
            "e1e78464.a4cfd8"
          ]
        ]
      },
      {
        "id": "e1e78464.a4cfd8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Check Creator",
        "func": "if (msg.hasOwnProperty(\"creator\") && msg.creator.length > 0 && msg.creator[0].doc_type === \"user\") {\n    msg.inputs.body = {\n        \"gets_change_email\": false,\n        \"created_by\": msg.creator[0]._id,\n        \"eula_create_date\": Date.now(),\n        \"eula_accept_status\": \"not accepted\",\n        \"remote_access_allowed\": false\n    };\n    return [msg,null];\n} else {\n    return [null,msg];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1200,
        "y": 1020,
        "wires": [
          [
            "eaa135a5.e53a88"
          ],
          [
            "82265dc1.d9cbb"
          ]
        ],
        "outputLabels": [
          "yes creator",
          "no creator"
        ]
      },
      {
        "id": "82265dc1.d9cbb",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Creator Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id: \" + msg.records.created_by + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1390,
        "y": 1060,
        "wires": [
          [
            "342063b9.03e4fc"
          ]
        ]
      },
      {
        "id": "342063b9.03e4fc",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1580,
        "y": 1060,
        "wires": []
      },
      {
        "id": "be06b71e.e733a8",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1720,
        "y": 1020,
        "wires": [
          [
            "32d59540.45c0fa"
          ]
        ]
      },
      {
        "id": "d588fe08.7a40a",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Welcome Email",
        "func": "var user = msg.user[0];\nvar sales = msg.creator[0];\nvar key_body = {\n        \"first_name\": msg.records.first_name,\n        \"last_name\": msg.records.last_name,\n        \"email\": msg.records.email,\n        \"id\": user._id\n    };\nmsg.records.key = Buffer.from(JSON.stringify(key_body)).toString('base64');\nmsg.email = {\n    \"template_type\": \"welcome\",\n    \"to\": msg.records.email,\n    \"key\": msg.records.key,\n    \"fields\": {\n        \"surgeon_first_name\": msg.records.first_name,\n        \"surgeon_last_name\": msg.records.last_name,\n        \"sales_first_name\": sales.first_name,\n        \"sales_last_name\": sales.last_name\n    },\n    \"return\": true\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1560,
        "y": 1020,
        "wires": [
          [
            "be06b71e.e733a8"
          ]
        ]
      },
      {
        "id": "d282c995.5aa328",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 2070,
        "y": 1020,
        "wires": []
      },
      {
        "id": "32d59540.45c0fa",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1890,
        "y": 1020,
        "wires": [
          [
            "d282c995.5aa328"
          ]
        ]
      },
      {
        "id": "8bc261aa.d6ad2",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Check Input Values",
        "func": "var errors = [];\nif(msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"body\") && msg.inputs.hasOwnProperty(\"values\")) { \n    Object.keys(msg.inputs.values).forEach(function(key) {\n        if (msg.inputs.body.hasOwnProperty(key)) {\n            if (Array.isArray(msg.inputs.body[key])) {\n                msg.inputs.body[key].forEach(function(value) {\n                     if(msg.inputs.values[key].indexOf(value) < 0) {\n                         var error_key = {};\n                         error_key[key] = value;\n                         errors.push(error_key);\n                    }\n                })\n            } else {\n                if(msg.inputs.values[key].indexOf(msg.inputs.body[key]) < 0) {\n                    var error_key = {};\n                    error_key[key] = msg.inputs.body[key];\n                    errors.push(error_key);\n                }\n            }\n        }\n    })\n}\nif (errors.length > 0) {\n    msg.error_keys = errors;\n    return [null,msg];\n} else {\n    return [msg,null];   \n}",
        "outputs": 2,
        "noerr": 0,
        "x": 950,
        "y": 120,
        "wires": [
          [
            "c541bab7.920618"
          ],
          [
            "399b8cd0.d0e8f4"
          ]
        ]
      },
      {
        "id": "399b8cd0.d0e8f4",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Invalid Input Value",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 412,\n    \"message\": \"Invalid key values.\",\n    \"returns\": [\"error_keys\"]\n});\nmsg.records.format = \"array\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1650,
        "y": 240,
        "wires": [
          [
            "44304eec.b88b6"
          ]
        ]
      },
      {
        "id": "ea8d6a75.315508",
        "type": "function",
        "z": "e08f785c.844a68",
        "name": "Check support_users",
        "func": "if (msg.hasOwnProperty(\"support_users\") && msg.support_users.length > 0) {\n    return [msg,null]\n}\nmsg.records.returns.push(\"warning\");\nmsg.warning = [\"No associated support person was found. Admin users have been contacted.\"]\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"support_users\",\n    \"selector\": {\n        \"$and\": [\n            {\"doc_type\": \"user\"},\n            {\"status\": \"active\"},\n            {\"sub_roles\": {\n                \"$or\": [{\"$elemMatch\": { \"$eq\": \"Admin\" }}]\n                }\n            }]\n    }\n};\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 280,
        "y": 120,
        "wires": [
          [],
          [
            "6eed9503.cb2ebc"
          ]
        ],
        "outputLabels": [
          "ignore",
          "find admin"
        ]
      },
      {
        "id": "6eed9503.cb2ebc",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "e08f785c.844a68",
        "name": "",
        "x": 530,
        "y": 160,
        "wires": [
          [
            "7dbf778a.7d5328"
          ]
        ]
      },
      {
        "id": "7dbf778a.7d5328",
        "type": "function",
        "z": "e08f785c.844a68",
        "name": "Clean Up",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 160,
        "wires": [
          [
            "1c822c95.90be83"
          ]
        ]
      },
      {
        "id": "1c822c95.90be83",
        "type": "function",
        "z": "e08f785c.844a68",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Support Users \": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "ee549912.b7f8f8",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/tickets_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 1320,
        "wires": [
          [
            "7d48b133.23bdb"
          ]
        ]
      },
      {
        "id": "7d48b133.23bdb",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 1320,
        "wires": [
          [
            "3a3e94b2.488a4c"
          ]
        ]
      },
      {
        "id": "3a3e94b2.488a4c",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Query Tickets",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Query Tickets\"\n    });\nmsg.records = {\n    \"doc_type\": \"help_ticket\",\n    \"format\": \"array\",\n    \"object\": \"help_tickets\",\n    \"returns\": [\"help_tickets\"],\n    \"fields\": [ \"_id\",\n                \"system_sn\",\n                \"system_type\",\n                \"doctor_id\",\n                \"cell_tower_info\",\n                \"geo_location\",\n                \"start_time\",\n                \"close_time\",\n                \"ticket_status\",\n                \"reason\",\n                \"contact_name\",\n                \"contact_number\",\n                \"assigned_id\",\n                \"responder_id\",\n                \"surgeon_settings_file_id\",\n                \"surgeon_settings_name\",\n                \"device_ip\"\n               ],\n    \"sort\": [{\"start_time:number\": \"desc\"}]\n};\nif(msg.req.body.hasOwnProperty(\"return_assigned_users\") && msg.req.body.return_assigned_users === true) {\n    msg.records.returns.push(\"assigned_users\");\n}\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\", \"return_assigned_users\"]\n};\nmsg.filters = {\n    \"allowed\": [\"start_time_range_begin\" , \"start_time_range_end\" , \"assigned_id\" , \"ticket_status\" , \"reason\"],\n    \"required\": []\n};\nmsg.cloudant = {\n    \"request\": \"/help_tickets/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": true\n};\nmsg.filters.params = {\n    \"system_sn\": msg.req.params.deviceID\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 1320,
        "wires": [
          [
            "1811562c.c85b9a"
          ]
        ]
      },
      {
        "id": "1811562c.c85b9a",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 920,
        "y": 1320,
        "wires": [
          [
            "49417ace.763364"
          ]
        ]
      },
      {
        "id": "49417ace.763364",
        "type": "subflow:f83a5f50.ef8e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1090,
        "y": 1320,
        "wires": [
          [
            "9bc70e9b.67173"
          ]
        ]
      },
      {
        "id": "9bc70e9b.67173",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1290,
        "y": 1320,
        "wires": [
          [
            "ff934ee3.307fd"
          ]
        ]
      },
      {
        "id": "ff934ee3.307fd",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "assigned_users Query",
        "func": "//node.warn({\"assigned_id Query\": \"Find Unique\", \"unique_assigned_ids\": unique_assigned_ids});\nif(msg.help_tickets.length > 0 && msg.inputs.body.hasOwnProperty(\"return_assigned_users\") && msg.inputs.body.return_assigned_users === true){\n    msg.cloudant.request = \"/help_tickets/_find\";\n    msg.cloudant.method = \"POST\";\n    msg.cloudant.selector.$and.push({\"assigned_id\": { \"$ne\": [] }});\n    msg.cloudant.fields = [\"assigned_id\"];\n    if(msg.cloudant.hasOwnProperty(\"sort\")) {delete msg.cloudant.sort}\n    if(msg.cloudant.hasOwnProperty(\"limit\")) {delete msg.cloudant.limit}\n    if(msg.cloudant.hasOwnProperty(\"skip\")) {delete msg.cloudant.skip}\n    msg.cloudant.object = \"assigned_id\";\n    msg.cloudant.pagination = false;\n    msg.cloudant.bookmark_use = false;\n    msg.cloudant.bookmark_save = false;\n    return [msg, null];\n}\nmsg.assigned_users = [];\nmsg.api.path = 2;\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1500,
        "y": 1320,
        "wires": [
          [
            "41004440.3be51c"
          ],
          [
            "c623d4fb.0a4738"
          ]
        ]
      },
      {
        "id": "41004440.3be51c",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1710,
        "y": 1280,
        "wires": [
          [
            "fba912f6.de0bf"
          ]
        ]
      },
      {
        "id": "c623d4fb.0a4738",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 2250,
        "y": 1320,
        "wires": []
      },
      {
        "id": "fba912f6.de0bf",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Distinct List",
        "func": "if(msg.help_tickets.length > 0 && msg.inputs.body.hasOwnProperty(\"return_assigned_users\") && msg.inputs.body.return_assigned_users === true){\n    var unique_assigned_ids = [];\n    if(msg.assigned_id.length > 0) {\n        msg.assigned_id.forEach(function(record) {\n            record.assigned_id.forEach(function(id){\n                if(unique_assigned_ids.indexOf(id) < 0){\n                    unique_assigned_ids.push(id);\n                }\n            });\n        });\n    }\n    msg.help_tickets.forEach(function(record){\n        if(record.hasOwnProperty(\"assigned_id\")){\n            record.assigned_id.forEach(function(id){\n                if(unique_assigned_ids.indexOf(id) < 0){\n                    unique_assigned_ids.push(id);\n                }\n            });\n        }\n    });\n    msg.assigned_id = unique_assigned_ids;\n    if(unique_assigned_ids.length > 0){\n        msg.cloudant.request = \"/stellaris_documents/_find\";\n        msg.cloudant.method = \"POST\";\n        msg.cloudant.selector = { \"_id\":  { \"$in\": msg.assigned_id  }};\n        msg.cloudant.fields = [\"_id\", \"first_name\", \"last_name\"];\n        msg.cloudant.sort= [{ \"last_name:string\": \"asc\"}];\n        msg.cloudant.object = \"assigned_users\";\n        msg.cloudant.pagination = false;\n        msg.cloudant.bookmark_use = false;\n        msg.cloudant.bookmark_save = false;\n        return [msg, null];\n    }\n    msg.assigned_users = [];\n}\nmsg.api.path = 3;\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1890,
        "y": 1280,
        "wires": [
          [
            "a872711c.5669e"
          ],
          [
            "c623d4fb.0a4738"
          ]
        ]
      },
      {
        "id": "a872711c.5669e",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 2070,
        "y": 1260,
        "wires": [
          [
            "c623d4fb.0a4738"
          ]
        ]
      },
      {
        "id": "1984aca0.7e32c3",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Query Tickets",
        "info": "",
        "x": 130,
        "y": 1280,
        "wires": []
      },
      {
        "id": "99ed5a41.876fc8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Delete",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Delete\",\n    });\nmsg.records = {\n    \"format\": \"array\",\n    \"returns\": [\"message\"]\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.message = \"User with id: \" + msg.inputs.user_id + \" and all its files have been deleted.\"\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_type\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\": msg.inputs.user_id}]},\n                {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"user\": msg.inputs.user_id}]},\n                {\"$and\": [{\"doc_type\": \"settings_file\"},{\"status\": \"active\"},{\"user_id\": msg.inputs.user_id}]}]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 380,
        "wires": [
          [
            "fa1ad66f.5664b8"
          ]
        ]
      },
      {
        "id": "fa1ad66f.5664b8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 830,
        "y": 380,
        "wires": [
          [
            "8774750c.4a77d8"
          ]
        ]
      },
      {
        "id": "c0d89227.6149b",
        "type": "comment",
        "z": "a17d8665.50cb88",
        "name": "[DEVICES] Device Get Me Help",
        "info": "Flow for Get Me Help tickets:\n\nListens for any/all events of type GetMeHelp and processes accordingly:\n-TODO: Is there an API to open a ticket?\n-Question: Where does some of the data come from - is it all in our MQTT snapshot?\n-Insert resulting combination doc into cloudant\n-TODO: Email with details: to who?",
        "x": 150,
        "y": 360,
        "wires": []
      },
      {
        "id": "8193ed92.7344b",
        "type": "comment",
        "z": "a17d8665.50cb88",
        "name": "[DEVICES] Device Init Rem Conn",
        "info": "Listens to all inputs of type InitRemoteConn\n-TODO: Format email response.\n-Do we even need anything else here?",
        "x": 150,
        "y": 580,
        "wires": []
      },
      {
        "id": "26f9b12a.24edae",
        "type": "http in",
        "z": "a17d8665.50cb88",
        "name": "",
        "url": "/devices/device/:deviceID/getMeHelp",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 400,
        "wires": [
          [
            "2decf932.f86e36"
          ]
        ]
      },
      {
        "id": "c38cc044.96e36",
        "type": "http in",
        "z": "a17d8665.50cb88",
        "name": "",
        "url": "/devices/device/:deviceID/initRemConn",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 620,
        "wires": [
          [
            "5283662a.eb1968"
          ]
        ]
      },
      {
        "id": "2decf932.f86e36",
        "type": "subflow:3962857e.44abba",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 450,
        "y": 400,
        "wires": [
          [
            "7209a37.a818b5c"
          ]
        ]
      },
      {
        "id": "5283662a.eb1968",
        "type": "subflow:3962857e.44abba",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 470,
        "y": 620,
        "wires": [
          [
            "5d03988e.7e7bc8"
          ]
        ]
      },
      {
        "id": "5d03988e.7e7bc8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Init Rem Conn",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Init Rem Conn\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"help_ticket\",\n    \"object\": \"help_ticket\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\",\"help_ticket\"],\n    \"models\": [\"help_ticket\"],\n    \"return_code\": 201\n};\nmsg.inputs = {\n    \"required\": [\"device_ip\"],\n    \"allowed\": [\"doctor_id\", \"cell_tower_info\", \"contact_number\", \"machine_state\"],\n    \"device_id\": msg.req.params.deviceID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_type\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": msg.inputs.device_id}]},\n                {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"device\": msg.inputs.device_id}]}]\n    }\n};\nif (msg.req.body.hasOwnProperty(\"doctor_id\") && msg.req.body.doctor_id !== \"\") {\n    msg.cloudant.selector[\"$or\"].push({\"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\": msg.req.body.doctor_id}]})\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 620,
        "wires": [
          [
            "3dddfca0.690f34"
          ]
        ]
      },
      {
        "id": "3dddfca0.690f34",
        "type": "subflow:71afa3f9.81defc",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 860,
        "y": 620,
        "wires": [
          [
            "b8846f2c.1175d"
          ]
        ]
      },
      {
        "id": "b8846f2c.1175d",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1030,
        "y": 620,
        "wires": [
          [
            "a4f8ed8.7cdac1"
          ]
        ]
      },
      {
        "id": "a4f8ed8.7cdac1",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Found",
        "func": "if (msg.hasOwnProperty(\"device\") && msg.device.length > 0 && msg.device[0].doc_type === \"device\") {\n    msg.inputs.body.system_sn = msg.inputs.device_id;\n    msg.inputs.body.system_type = msg.device[0].system_type;\n    msg.inputs.body.reason = \"RemConn\";\n    if (msg.hasOwnProperty(\"user\") && msg.user.length > 0) {\n        msg.inputs.body.contact_name = msg.user[0].first_name + \" \" + msg.user[0].last_name\n    }\n    if (msg.hasOwnProperty(\"machine_link\") && msg.machine_link.length > 0) {\n        var linked_user_ids = msg.machine_link.map(a => a.user);\n        msg.cloudant = {\n            \"request\": \"/stellaris_documents/_find\",\n            \"method\": \"POST\",\n            \"return_obj\": \"docs\",\n            \"object\": \"support_users\",\n            \"selector\": {\n                \"$and\": [\n                    {\"doc_type\": \"user\"},\n                    {\"status\": \"active\"},\n                    {\"_id\": {\"$in\": linked_user_ids}},\n                    //{\"role\": \"Service\"},\n                    {\"sub_roles\": {\n                        \"$or\": [{\"$elemMatch\": { \"$eq\": \"Applications\" }},\n                                {\"$elemMatch\": { \"$eq\": \"Field Sales\" }},\n                                {\"$elemMatch\": { \"$eq\": \"Technical Support\" }}]\n                        }\n                    }]\n            }\n        }\n    } else {\n        var linked_user_ids = [];\n        delete msg.cloudant;\n    }\n    return [msg,null];\n} else {\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1220,
        "y": 620,
        "wires": [
          [
            "fc46be67.b4961"
          ],
          [
            "98ea0bb4.0ebdf8"
          ]
        ],
        "outputLabels": [
          "yes found",
          "no found"
        ]
      },
      {
        "id": "fc46be67.b4961",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1410,
        "y": 620,
        "wires": [
          [
            "d8325fdb.9cb34"
          ]
        ]
      },
      {
        "id": "72e300f7.c5072",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1600,
        "y": 660,
        "wires": []
      },
      {
        "id": "98ea0bb4.0ebdf8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The device record for \" + msg.inputs.device_id + \" was not found.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1410,
        "y": 660,
        "wires": [
          [
            "72e300f7.c5072"
          ]
        ]
      },
      {
        "id": "ce9a1759.9a9cc8",
        "type": "subflow:e0cd8199.1ad77",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2240,
        "y": 620,
        "wires": [
          [
            "7fe55e1f.27f52"
          ]
        ]
      },
      {
        "id": "d6aa4528.4adaa8",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2560,
        "y": 580,
        "wires": [
          []
        ]
      },
      {
        "id": "3d9b1954.c4a866",
        "type": "subflow:bc6ff87.05a2908",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2770,
        "y": 620,
        "wires": []
      },
      {
        "id": "e4a8dcfe.671d1",
        "type": "subflow:313bd1d3.01c06e",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2590,
        "y": 620,
        "wires": [
          [
            "3d9b1954.c4a866"
          ]
        ]
      },
      {
        "id": "d8325fdb.9cb34",
        "type": "subflow:d1af1cc8.e0fda",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1620,
        "y": 620,
        "wires": [
          [
            "4bd68bac.e89c74"
          ]
        ]
      },
      {
        "id": "7209a37.a818b5c",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Get Me Help",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Get Me Help\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"help_ticket\",\n    \"object\": \"help_ticket\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\",\"help_ticket\"],\n    \"models\": [\"help_ticket\"],\n    \"return_code\": 201\n};\nmsg.inputs = {\n    \"required\": [\"system_type\", \"cell_tower_info\", \"reason\", \"contact_name\", \"contact_number\", \"machine_state\"],\n    \"allowed\": [\"doctor_id\", \"surgeon_settings_file_id\", \"surgeon_settings_name\"],\n    \"values\": {\n        \"reason\": [\"Setup\", \"Order Packs\", \"Another Issue\", \"Technical Support\"]\n    },\n    \"device_id\": msg.req.params.deviceID,\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_type\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": msg.inputs.device_id}]},\n                {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"device\": msg.inputs.device_id}]}\n               ]\n    }\n};\nif (msg.req.body.hasOwnProperty(\"doctor_id\") && msg.req.body.doctor_id !== \"\") {\n    msg.inputs.user_id = msg.req.body.doctor_id;\n    msg.cloudant.selector[\"$or\"].push( {\"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\": msg.inputs.user_id}]})\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 400,
        "wires": [
          [
            "524c7d4e.14cb74"
          ]
        ]
      },
      {
        "id": "524c7d4e.14cb74",
        "type": "subflow:71afa3f9.81defc",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 840,
        "y": 400,
        "wires": [
          [
            "c3e1544.2852da8"
          ]
        ]
      },
      {
        "id": "c3b78aea.e6b008",
        "type": "switch",
        "z": "a17d8665.50cb88",
        "name": "Reason",
        "property": "inputs.body.reason",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "Setup",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "Technical Support",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "Another Issue",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1340,
        "y": 380,
        "wires": [
          [
            "8af5db10.5366e8"
          ],
          [
            "4c2e2a57.658fc4"
          ],
          [
            "15c724d0.a828fb"
          ],
          [
            "a528e2e.be8642"
          ]
        ]
      },
      {
        "id": "c3e1544.2852da8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1010,
        "y": 400,
        "wires": [
          [
            "c26da446.803ea8"
          ]
        ]
      },
      {
        "id": "eba1bc79.4683c",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1810,
        "y": 380,
        "wires": [
          [
            "9610dac3.83e198"
          ]
        ]
      },
      {
        "id": "c26da446.803ea8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "ID Found",
        "func": "if (!msg.hasOwnProperty(\"device\") || msg.device.length === 0 || msg.device[0].doc_type !== \"device\") {\n    return [null,msg,null]\n}\nif (msg.inputs.hasOwnProperty(\"user_id\") && msg.inputs.user_id !== \"\") {\n    if(!msg.hasOwnProperty(\"user\") || msg.user.length === 0 || msg.user[0].doc_type !== \"user\") {\n        return [null,null,msg]\n    }\n}\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1180,
        "y": 400,
        "wires": [
          [
            "c3b78aea.e6b008"
          ],
          [
            "afee6342.5e629"
          ],
          [
            "49c8012b.5bf5b"
          ]
        ],
        "outputLabels": [
          "yes all",
          "no device",
          "no user"
        ]
      },
      {
        "id": "afee6342.5e629",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The device record for \" + msg.inputs.device_id + \" was not found.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1370,
        "y": 520,
        "wires": [
          [
            "6488c519.92f40c"
          ]
        ]
      },
      {
        "id": "6488c519.92f40c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1560,
        "y": 540,
        "wires": []
      },
      {
        "id": "49c8012b.5bf5b",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The user record for \" + msg.inputs.user_id + \" was not found.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 560,
        "wires": [
          [
            "6488c519.92f40c"
          ]
        ]
      },
      {
        "id": "4c2e2a57.658fc4",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Technical Support",
        "func": "if (msg.hasOwnProperty(\"machine_link\") && msg.machine_link.length > 0) {\n    var linked_user_ids = msg.machine_link.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Technical Support\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 380,
        "wires": [
          [
            "eba1bc79.4683c"
          ]
        ]
      },
      {
        "id": "8af5db10.5366e8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Application Field Sales",
        "func": "if (msg.hasOwnProperty(\"machine_link\") && msg.machine_link.length > 0) {\n    var linked_user_ids = msg.machine_link.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Applications\" }},\n                            {\"$elemMatch\": { \"$eq\": \"Field Sales\" }},\n                            {\"$elemMatch\": { \"$eq\": \"Sales Manager\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1570,
        "y": 340,
        "wires": [
          [
            "eba1bc79.4683c"
          ]
        ]
      },
      {
        "id": "a528e2e.be8642",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Customer Service",
        "func": "if (msg.hasOwnProperty(\"machine_link\") && msg.machine_link.length > 0) {\n    var linked_user_ids = msg.machine_link.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Customer Service\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 460,
        "wires": [
          [
            "eba1bc79.4683c"
          ]
        ]
      },
      {
        "id": "9610dac3.83e198",
        "type": "subflow:d1af1cc8.e0fda",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2020,
        "y": 380,
        "wires": [
          [
            "d6b9a65f.f06158"
          ]
        ]
      },
      {
        "id": "b734a9d1.b331c8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Create Ticket",
        "func": "var support_user_ids = msg.support_users.map(a => a._id)\nmsg.inputs.body = Object.assign(msg.inputs.body, {\n    \"system_sn\": msg.device[0]._id,\n    \"system_type\": msg.device[0].system_type,\n    \"assigned_id\": support_user_ids,\n    \n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2410,
        "y": 380,
        "wires": [
          [
            "bf2baa36.afc668"
          ]
        ]
      },
      {
        "id": "bf2baa36.afc668",
        "type": "subflow:e0cd8199.1ad77",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2580,
        "y": 380,
        "wires": [
          [
            "4988d27a.99200c",
            "7a7665d2.fb81dc"
          ]
        ]
      },
      {
        "id": "4988d27a.99200c",
        "type": "subflow:313bd1d3.01c06e",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2790,
        "y": 380,
        "wires": [
          [
            "7d0072df.c800bc"
          ]
        ]
      },
      {
        "id": "7d0072df.c800bc",
        "type": "subflow:bc6ff87.05a2908",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2970,
        "y": 380,
        "wires": []
      },
      {
        "id": "d6b9a65f.f06158",
        "type": "subflow:e08f785c.844a68",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2230,
        "y": 380,
        "wires": [
          [
            "b734a9d1.b331c8"
          ]
        ]
      },
      {
        "id": "4bd68bac.e89c74",
        "type": "subflow:e08f785c.844a68",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1830,
        "y": 620,
        "wires": [
          [
            "e3c619dc.89ed38"
          ]
        ]
      },
      {
        "id": "93554a1b.195518",
        "type": "http in",
        "z": "a17d8665.50cb88",
        "name": "",
        "url": "/devices/device/:deviceID/expire_remconn",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 760,
        "wires": [
          [
            "725e686.462fd98"
          ]
        ]
      },
      {
        "id": "725e686.462fd98",
        "type": "subflow:3962857e.44abba",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 490,
        "y": 760,
        "wires": [
          [
            "38a79a81.3d4e76"
          ]
        ]
      },
      {
        "id": "38a79a81.3d4e76",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Expire RemConn",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Expire RemConn\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\"],\n    \"doc_type\": \"help_ticket\",\n    \"object\": \"help_ticket\",\n    \"format\": \"JSON\",\n    \"returns\": [\"help_ticket\"]\n};\nmsg.inputs = {\n    \"device_id\": msg.req.params.deviceID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.inputs.device_id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"device\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 760,
        "wires": [
          [
            "8377fb1e.c743c8"
          ]
        ]
      },
      {
        "id": "77a06453.a257fc",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1310,
        "y": 740,
        "wires": [
          [
            "4fc569de.d37ce8"
          ]
        ]
      },
      {
        "id": "4fc569de.d37ce8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Ticket Found?",
        "func": "if (!msg.hasOwnProperty(\"ticket_list\") || msg.ticket_list.length === 0) {\n    if (!msg.hasOwnProperty(\"help_ticket\")) {msg.help_ticket = []}\n    return [msg,null];\n}\nvar ticket = msg.ticket_list.pop();\nvar time = Date.now();\nmsg.inputs.body = {\n    \"ticket_status\": \"Expired\",\n    \"close_time\": time,\n    \"ticket_notes\": new Date(time).toLocaleString() + \" - \" + msg.inputs.device_id + \" - Rebooted!   /  Remote session expired.\"\n};\nmsg.records.id = ticket._id;\ndelete msg.cloudant.id;\ndelete msg.cloudant.object;\nnode.warn({\"pop ticket\": msg});\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1560,
        "y": 740,
        "wires": [
          [
            "3e59d903.da99c6"
          ],
          [
            "af5673d4.9e85b"
          ]
        ],
        "outputLabels": [
          "no",
          "yes"
        ]
      },
      {
        "id": "af5673d4.9e85b",
        "type": "subflow:68197f61.7975",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1750,
        "y": 760,
        "wires": [
          [
            "5331778e.bd6318"
          ]
        ]
      },
      {
        "id": "6f928faa.3a42e",
        "type": "subflow:bc6ff87.05a2908",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1930,
        "y": 720,
        "wires": []
      },
      {
        "id": "3e59d903.da99c6",
        "type": "subflow:313bd1d3.01c06e",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1750,
        "y": 720,
        "wires": [
          [
            "6f928faa.3a42e"
          ]
        ]
      },
      {
        "id": "7c41b3a3.c7f85c",
        "type": "comment",
        "z": "a17d8665.50cb88",
        "name": "[DEVICES] Device Expire RemConn",
        "info": "Checks for existing Remconn ticket. If exists ->\nchanges ticket status to expired and adds log to\nticket notes in following format:\nDate & Time / {deviceID} - Rebooted!   /  Remote session expired.",
        "x": 160,
        "y": 720,
        "wires": []
      },
      {
        "id": "8774750c.4a77d8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Set Inactive",
        "func": "function setInactive(item, index) {\n    item.status = \"inactive\";\n    return item;\n}\nif (!msg.hasOwnProperty(\"user\") || msg.user.length === 0) {\n    return [null,msg]\n}\nmsg.update_files = msg.user\nif (msg.hasOwnProperty(\"machine_link\") && msg.machine_link.length !== 0) { msg.update_files = msg.update_files.concat(msg.machine_link) }\nif (msg.hasOwnProperty(\"settings_file\") && msg.settings_file.length !== 0)  {msg.update_files = msg.update_files.concat(msg.settings_file) }\nmsg.update_files.map(setInactive);\nmsg.appid = {\n    \"id\": msg.user[0].idp_id\n}\nmsg.payload.docs = msg.update_files;\nmsg.url = global.get(\"VCAP_CLOUDANT\").credentials.url + \"/stellaris_documents/_bulk_docs\";\nnode.warn({\"Ready to Update\": msg})\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1010,
        "y": 380,
        "wires": [
          [
            "b8f35b28.898e18"
          ],
          [
            "11975d56.3e3ac3"
          ]
        ],
        "outputLabels": [
          "yes user",
          "no user"
        ]
      },
      {
        "id": "d065780b.078158",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1750,
        "y": 380,
        "wires": []
      },
      {
        "id": "b8f35b28.898e18",
        "type": "http request",
        "z": "1dff07f1.603c08",
        "name": "Bulk Update",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1170,
        "y": 380,
        "wires": [
          [
            "2aab8d5a.6bcb62"
          ]
        ]
      },
      {
        "id": "2aab8d5a.6bcb62",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Bulk Update Returns",
        "func": "if (Array.isArray(msg.payload)) {\n    msg.bulk_update = msg.payload;\n    msg.deleted_ids = msg.payload.map(a => a.id);\n}\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nnode.warn({\"Bulk Returns\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 380,
        "wires": [
          [
            "cd63132a.22867"
          ]
        ]
      },
      {
        "id": "6812e456.db8e8c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1360,
        "y": 420,
        "wires": []
      },
      {
        "id": "11975d56.3e3ac3",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active user with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 420,
        "wires": [
          [
            "6812e456.db8e8c"
          ]
        ]
      },
      {
        "id": "70a6c339.a33ffc",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 280,
        "wires": [
          [
            "1604ec79.d75484"
          ]
        ]
      },
      {
        "id": "9622f892.ea1278",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/authentication",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 280,
        "wires": [
          [
            "c365d482.561be8"
          ]
        ]
      },
      {
        "id": "3fd9a5b6.d740fa",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Email Format and input",
        "func": "if (!msg.hasOwnProperty(\"email\")) { msg.email = {} }\nmsg.email.to = msg.support_users.map(a => a.email);\nmsg.email.topic = \"User \" + msg.users[0]._id + \" Max Login Attempts\";\nvar tab = '<span style=\"padding-left: 1.8em\"></span>';\nmsg.email.template = \"\" +\n\"Hello Bausch & Lomb Support,\" +\n\"\\n<br />\" +\n\"\\n<br />\" +\n\"\\n<br />\" +\n\"\\n<br />\" + tab + \"User \" +  msg.users[0].first_name + \" \" + msg.users[0].last_name + \" has attempted and failed multiple logins.\" +\n\"\\n<br />\" +\n\"\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1990,
        "y": 320,
        "wires": [
          [
            "2c1af94a.703936"
          ]
        ]
      },
      {
        "id": "7c4b3bfe.930c74",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[v1] [DEVICES] User Authentication",
        "info": "Checks user ID and password on cloudant if user \nexists.",
        "x": 162,
        "y": 237,
        "wires": []
      },
      {
        "id": "a2a10c47.415ea",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Authentication",
        "func": "msg.api = Object.assign(\n    {\n        \"name\": \"User Authentication\",\n    }, msg.api);\nmsg.records = {\n    \"delete\": [\"_rev\", \"password\", \"doc_type\", \"status\"],\n    \"doc_type\": \"user\",\n    \"returns\": [\"message\"]\n};\nmsg.inputs = {\n    \"required\": [\"password\"],\n    \"allowed\": [\"user_id\", \"email\"]\n};\nif (msg.payload.hasOwnProperty(\"user_id\")) {\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/\" + msg.payload.user_id,\n        \"method\": \"GET\",\n        \"return_obj\": \"\",\n        \"object\": \"users\"\n    }\n} else\nif (msg.payload.hasOwnProperty(\"email\")) {\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"users\",\n        \"selector\": {\n            \"$and\": [{\"email\": msg.payload.email},\n                     {\"status\": \"active\"}]\n        }\n    }\n} else {\n    msg.inputs.required.push(\"user_id\")\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 280,
        "wires": [
          [
            "36bdfd54.ed5562"
          ]
        ]
      },
      {
        "id": "36bdfd54.ed5562",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 980,
        "y": 280,
        "wires": [
          [
            "a8991dec.34ea7"
          ]
        ]
      },
      {
        "id": "a8991dec.34ea7",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1150,
        "y": 280,
        "wires": [
          [
            "2492a8e2.b23e68"
          ]
        ]
      },
      {
        "id": "2492a8e2.b23e68",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Check for valid user",
        "func": "\nif (msg.hasOwnProperty(\"users\") && msg.users.length === 1 ) {\n    var user = msg.users[0];\n    if (user.doc_type === 'user' && user.status === 'active' && user.hasOwnProperty(\"password\") && user.hasOwnProperty(\"email\") && user.password === msg.inputs.body.password) {\n        return [msg, null]\n    }\n}\nreturn [null, msg];",
        "outputs": "2",
        "noerr": 0,
        "x": 1360,
        "y": 280,
        "wires": [
          [
            "a7ad127f.b8415"
          ],
          [
            "4c90ea09.bc5ac4"
          ]
        ],
        "outputLabels": [
          "Authenticated",
          "Failed"
        ]
      },
      {
        "id": "142a3246.60a09e",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1790,
        "y": 240,
        "wires": []
      },
      {
        "id": "625542f7.b8bb1c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1900,
        "y": 280,
        "wires": []
      },
      {
        "id": "4c90ea09.bc5ac4",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Athentication Failed",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nvar error = {\n    \"code\": 400,\n    \"message\": \"Authentication failed.\"\n}\nif (msg.hasOwnProperty(\"users\") && msg.users.length > 1) {\n    error.message = \"More than one user with the same email \" + msg.inputs.body.email + \" was found.\"\n    msg.errors.push(error);\n    return [msg, null];\n} else\nif (!msg.users || msg.users.length === 0 || !msg.users[0].doc_type) {\n    if (msg.inputs.body.hasOwnProperty(\"email\")) {\n        error.message = \"User with email: \" + msg.inputs.body.email + \" was not found.\"    \n    } else {\n        error.message = \"User with ID: \" +  msg.inputs.body.user_id + \" was not found.\"    \n    }\n    msg.errors.push(error);\n    return [msg, null];\n}\n// Authentication Failed\nmsg.errors.push(error);\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"support_users\",\n    \"selector\": {\n        \"doc_type\": \"user\",\n        \"status\": \"active\",\n        \"$or\": [{\"sub_roles\": {\"$elemMatch\": {\"$eq\": \"Admin\"}}}]\n    },\n    \"fields\": [\"email\"],\n\t\"sort\": [{ \"email:string\": \"asc\"}]\n}\nif (msg.users[0].hasOwnProperty(\"created_by\") && msg.users[0].created_by !== \"\"){\n    msg.cloudant.selector[\"$or\"].push({\"_id\": msg.users[0].created_by})\n}\nvar attempts = global.get(\"user_authentications\");\nif (typeof attempts !== \"undefined\" && Array.isArray(attempts)) {\n    var index = -1;\n    var attempt_found = attempts.some(function(attempt,i) {\n        if(msg.users[0]._id === attempt.id)\n        {\n            attempt.tries++;\n            attempt.timestamp = Date.now();\n            global.set(\"user_authentications\", attempts);\n            index = i;\n            return true;\n        }\n    });\n    if (attempt_found && attempts[index].tries >= 5) {\n        node.warn({\"User Auth Attempts\":attempts})\n        return [msg, msg]; //send emails too\n    } else \n    if (!attempt_found) {\n        attempts.push({\"id\": msg.users[0]._id, \"tries\": 1, \"timestamp\": Date.now()});\n        global.set(\"user_authentications\", attempts);\n    }\n    node.warn({\"User Auth Attempts\":attempts})\n}\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1570,
        "y": 300,
        "wires": [
          [
            "490b4ef.93ca3b"
          ],
          [
            "b7561f41.e2926"
          ]
        ],
        "outputLabels": [
          "Error",
          "Email Admin"
        ]
      },
      {
        "id": "a7ad127f.b8415",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Authentication Success",
        "func": "msg.message = \"Authentication success.\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1590,
        "y": 240,
        "wires": [
          [
            "142a3246.60a09e"
          ]
        ]
      },
      {
        "id": "b7561f41.e2926",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1770,
        "y": 320,
        "wires": [
          [
            "3fd9a5b6.d740fa"
          ]
        ]
      },
      {
        "id": "55edbef.09e114",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Query Cases",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Query Cases\"\n    });\nmsg.records = {\n    \"doc_type\": \"case\",\n    \"format\": \"array\",\n    \"object\": \"cases\",\n    \"returns\": [\"cases\"],\n    \"fields\": [ \"_id\",\n                \"log_id\",\n                \"system_sn\",\n                \"system_type\",\n                \"location\",\n                \"geo_location\",\n                \"address\",\n                \"user_id\",\n                \"settings_file_name\",\n                \"start_time\",\n                \"stop_time\"\n               ],\n    \"sort\": [{\"stop_time:number\": \"desc\"}]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]\n};\nmsg.filters = {\n    \"allowed\": [\"stop_time_range_begin\" , \"stop_time_range_end\" , \"system_sn\"],\n    \"required\": []\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_logs/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true\n};\nmsg.filters.params = {\n    \"user_id\": msg.req.params.userID\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 1160,
        "wires": [
          [
            "adc8c6e2.750618"
          ]
        ]
      },
      {
        "id": "467070d9.a759d",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 1160,
        "wires": [
          [
            "55edbef.09e114"
          ]
        ]
      },
      {
        "id": "adc8c6e2.750618",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 840,
        "y": 1160,
        "wires": [
          [
            "17fd34ff.c30cdb"
          ]
        ]
      },
      {
        "id": "5400805.2f99d8",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID/logs/cases_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 1160,
        "wires": [
          [
            "467070d9.a759d"
          ]
        ]
      },
      {
        "id": "17fd34ff.c30cdb",
        "type": "subflow:f83a5f50.ef8e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1010,
        "y": 1160,
        "wires": [
          [
            "39b6e31e.6bea3c"
          ]
        ]
      },
      {
        "id": "39b6e31e.6bea3c",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1210,
        "y": 1160,
        "wires": [
          [
            "58eb3885.6ed9d8"
          ]
        ]
      },
      {
        "id": "58eb3885.6ed9d8",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1390,
        "y": 1160,
        "wires": []
      },
      {
        "id": "2a6e900f.ed1ae",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] User Query Cases",
        "info": "",
        "x": 120,
        "y": 1120,
        "wires": []
      },
      {
        "id": "2a3158bf.3a0838",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 500,
        "wires": [
          [
            "ec6841de.69337"
          ]
        ]
      },
      {
        "id": "ec6841de.69337",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Devices",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Devices\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\"],\n    \"doc_type\": \"device\",\n    \"format\": \"array\",\n    \"object\": \"devices\",\n    \"returns\": [\"devices\"]\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\": msg.inputs.user_id}]},\n                {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"user\": msg.inputs.user_id}]}]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 500,
        "wires": [
          [
            "1bb98b8e.87fff4"
          ]
        ]
      },
      {
        "id": "5606368b.0f5fc8",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID/devices",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 500,
        "wires": [
          [
            "2a3158bf.3a0838"
          ]
        ]
      },
      {
        "id": "1bb98b8e.87fff4",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 830,
        "y": 500,
        "wires": [
          [
            "fe4a0fcb.7a45a"
          ]
        ]
      },
      {
        "id": "fe4a0fcb.7a45a",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Paired Device Ids",
        "func": "if (!msg.hasOwnProperty(\"users\") || msg.users.length === 0) {\n    return [null,null,msg];\n}\nif (msg.hasOwnProperty(\"machine_links\") && msg.machine_links.length > 0) {\n    msg.paired_device_ids = msg.machine_links.map(a => a.device);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"selector\": {\n            \"$and\": [{\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": {\"$in\": msg.paired_device_ids}}]\n        },\n        \"sort\": [{ \"_id:string\": \"asc\"}],\n        \"object\": \"devices\"\n    };\n    if(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n        if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n        if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n    }\n    return [msg,null,null];\n}\nmsg.devices = [];\nmsg.api.path = 2;\nreturn [null,msg,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1030,
        "y": 500,
        "wires": [
          [
            "df075575.8e95b8"
          ],
          [
            "5ff613b0.735a8c"
          ],
          [
            "7beac8b7.062f98"
          ]
        ],
        "outputLabels": [
          "yes paired",
          "no paired",
          "no user"
        ]
      },
      {
        "id": "5ff613b0.735a8c",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1610,
        "y": 500,
        "wires": []
      },
      {
        "id": "df075575.8e95b8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1230,
        "y": 480,
        "wires": [
          [
            "bdeca7d1.149ac8"
          ]
        ]
      },
      {
        "id": "a7a8ac21.e3b32",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] User Devices",
        "info": "This returns an array of documents of machines \npaired to a user\n",
        "x": 110,
        "y": 460,
        "wires": []
      },
      {
        "id": "a1a4f440.9c5a18",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 680,
        "wires": [
          [
            "ab2fdab9.55c3b8"
          ]
        ]
      },
      {
        "id": "1c01fc1f.ebd9a4",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Users Files",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users Files\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\",\"doc_type\",\"status\"],\n    \"doc_type\": \"settings_file\",\n    \"format\": \"array\",\n    \"object\": \"settings_files\",\n    \"returns\": [\"settings_files\"]\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.inputs.user_id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 680,
        "wires": [
          [
            "1371888f.402167"
          ]
        ]
      },
      {
        "id": "3ecf6780.25ca88",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID/files",
        "method": "get",
        "upload": true,
        "swaggerDoc": "",
        "x": 140,
        "y": 680,
        "wires": [
          [
            "a1a4f440.9c5a18"
          ]
        ]
      },
      {
        "id": "a7501dbe.358ae",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1510,
        "y": 660,
        "wires": [
          [
            "ed7272f5.93f2e"
          ]
        ]
      },
      {
        "id": "41969339.8e8e1c",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1890,
        "y": 660,
        "wires": []
      },
      {
        "id": "9245f14a.d349f",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] [DEVICES] User Files",
        "info": "This gets every File for a User",
        "x": 130,
        "y": 640,
        "wires": []
      },
      {
        "id": "fcb3a021.f5d13",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 820,
        "wires": [
          [
            "c87739c6.50c3f8"
          ]
        ]
      },
      {
        "id": "c87739c6.50c3f8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Info",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Info\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"password\", \"doc_type\", \"status\"],\n    \"doc_type\": \"user\",\n    \"object\": \"user\",\n    \"format\": \"JSON\",\n    \"returns\": [\"user\"],\n    \"id\": msg.req.params.userID\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.filters = {};\nmsg.filters.params = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 820,
        "wires": [
          [
            "b7f3968c.58ebd8"
          ]
        ]
      },
      {
        "id": "362ba31b.7435ac",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 820,
        "wires": [
          [
            "54e2ee12.45f6f"
          ]
        ]
      },
      {
        "id": "b7f3968c.58ebd8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 810,
        "y": 820,
        "wires": [
          [
            "eb579346.ac809"
          ]
        ]
      },
      {
        "id": "899f840c.74d418",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1210,
        "y": 800,
        "wires": [
          [
            "f59277d1.f57878"
          ]
        ]
      },
      {
        "id": "f59277d1.f57878",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1390,
        "y": 800,
        "wires": []
      },
      {
        "id": "ca821547.849ad8",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] [DEVICES] User Info",
        "info": "Checks and returns user info if it exists",
        "x": 130,
        "y": 780,
        "wires": []
      },
      {
        "id": "afbb8311.d2f1e",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 920,
        "wires": [
          [
            "7d4c1fc4.026b8"
          ]
        ]
      },
      {
        "id": "5d63391a.f22528",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 920,
        "wires": [
          [
            "9d966eb7.76ee9"
          ]
        ]
      },
      {
        "id": "bfebfa68.2c8e58",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] User New",
        "info": "This flow first checks that fields password, role,\nand email in the payload. If the UID is included\nthan we check if we have that registered. If it is\nregistered we reactivate it or return that user is\nalready registered. If we don't have that UID or \nit wasn't included we create a User document.",
        "x": 100,
        "y": 880,
        "wires": []
      },
      {
        "id": "7d4c1fc4.026b8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User New",
        "func": "var genPwd = global.get(\"genpwd\");\nmsg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User New\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\", \"password\"],\n    \"doc_type\": \"user\",\n    \"object\": \"user\",\n    \"format\": \"JSON\",\n    \"models\": [\"user\"],\n    \"returns\": [\"user\"],\n    \"return_code\": 201\n};\nif(!msg.payload.password || msg.payload.password === \"\") {\n    msg.records.password = genPwd.generate(global.get(\"PWD_GEN\"))\n}\nmsg.inputs = {\n    \"required\": [\"role\",\"email\"],\n    \"allowed\": [\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"mobile_phone\",\"password\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"remote_access_allowed\"]\n};\nif(msg.payload.hasOwnProperty(\"email\")) {\n    msg.records.email = msg.payload.email.toLowerCase();\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 920,
        "wires": [
          [
            "f5c36594.30df18"
          ]
        ]
      },
      {
        "id": "f5c36594.30df18",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 780,
        "y": 920,
        "wires": [
          [
            "134c7500.1c7cab"
          ]
        ]
      },
      {
        "id": "134c7500.1c7cab",
        "type": "subflow:e0cd8199.1ad77",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 940,
        "y": 920,
        "wires": [
          [
            "334ee051.206e8"
          ]
        ]
      },
      {
        "id": "334ee051.206e8",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1130,
        "y": 920,
        "wires": [
          [
            "cb82516b.87be9"
          ]
        ]
      },
      {
        "id": "cb82516b.87be9",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1310,
        "y": 920,
        "wires": []
      },
      {
        "id": "3fafa365.afae5c",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 1380,
        "wires": [
          [
            "2df6949b.7911bc"
          ]
        ]
      },
      {
        "id": "2df6949b.7911bc",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Query Tickets",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Query Tickets\"\n    });\nmsg.records = {\n    \"doc_type\": \"help_ticket\",\n    \"format\": \"array\",\n    \"object\": \"help_tickets\",\n    \"returns\": [\"help_tickets\"],\n    \"fields\": [ \"_id\",\n                \"system_sn\",\n                \"system_type\",\n                \"doctor_id\",\n                \"cell_tower_info\",\n                \"geo_location\",\n                \"start_time\",\n                \"close_time\",\n                \"ticket_status\",\n                \"reason\",\n                \"contact_name\",\n                \"contact_number\",\n                \"assigned_id\",\n                \"responder_id\",\n                \"surgeon_settings_file_id\",\n                \"surgeon_settings_name\",\n                \"device_ip\"\n               ],\n    \"sort\": [{\"start_time:number\": \"desc\"}]\n};\nif(msg.req.body.hasOwnProperty(\"return_assigned_users\") && msg.req.body.return_assigned_users === true) {\n    msg.records.returns.push(\"assigned_users\");\n}\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\", \"return_assigned_users\"]\n};\nmsg.filters = {\n    \"allowed\": [\"start_time_range_begin\" , \"start_time_range_end\" , \"ticket_status\" , \"reason\"],\n    \"required\": []\n};\nmsg.inputs.assigned_id = msg.req.params.assignedID;\nmsg.cloudant = {\n    \"request\": \"/help_tickets/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\", //\"payload\", \"parameter\"\n    \"pagination\": true\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 1380,
        "wires": [
          [
            "7e685dba.ed6804"
          ]
        ]
      },
      {
        "id": "8ce9c141.2b96f",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:assignedID/tickets_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 1380,
        "wires": [
          [
            "3fafa365.afae5c"
          ]
        ]
      },
      {
        "id": "7e685dba.ed6804",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 840,
        "y": 1380,
        "wires": [
          [
            "2b9a116b.1b0a6e"
          ]
        ]
      },
      {
        "id": "1b347920.fd6e87",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1430,
        "y": 1380,
        "wires": [
          [
            "ed4fc18d.d9efd"
          ]
        ]
      },
      {
        "id": "77536a3c.542ee4",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 2010,
        "y": 1380,
        "wires": []
      },
      {
        "id": "ed4fc18d.d9efd",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Distinct List",
        "func": "if(msg.help_tickets.length > 0 && msg.inputs.body.hasOwnProperty(\"return_assigned_users\") && msg.inputs.body.return_assigned_users === true){\n    var unique_assigned_ids = [];\n    msg.help_tickets.forEach(function(record){\n        if(record.hasOwnProperty(\"assigned_id\")){\n            record.assigned_id.forEach(function(id){\n                if(unique_assigned_ids.indexOf(id) < 0){\n                    unique_assigned_ids.push(id);\n                }\n            });\n        }\n    });\n    msg.assigned_id = unique_assigned_ids;\n    if(unique_assigned_ids.length > 0){\n        msg.cloudant.request = \"/stellaris_documents/_find\";\n        msg.cloudant.method = \"POST\";\n        msg.cloudant.selector = { \"_id\":  { \"$in\": msg.assigned_id  }};\n        msg.cloudant.fields = [\"_id\", \"first_name\", \"last_name\"];\n        msg.cloudant.sort= [{ \"last_name:string\": \"asc\"}];\n        msg.cloudant.object = \"assigned_users\";\n        msg.cloudant.pagination = false;\n        msg.cloudant.bookmark_use = false;\n        msg.cloudant.bookmark_save = false;\n        return [msg, null];\n    }\n    msg.assigned_users = [];\n}\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1610,
        "y": 1380,
        "wires": [
          [
            "1ac0f15b.6652af"
          ],
          [
            "77536a3c.542ee4"
          ]
        ]
      },
      {
        "id": "1ac0f15b.6652af",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1810,
        "y": 1340,
        "wires": [
          [
            "77536a3c.542ee4"
          ]
        ]
      },
      {
        "id": "79583195.f6388",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN]  User Query Tickets",
        "info": "",
        "x": 130,
        "y": 1340,
        "wires": []
      },
      {
        "id": "2497d9af.ade676",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 1520,
        "wires": [
          [
            "f3cdcfcf.e819"
          ]
        ]
      },
      {
        "id": "f3cdcfcf.e819",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Update",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Update\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"password\"],\n    \"doc_type\": \"user\", \n    \"object\": \"user\",\n    \"format\": \"JSON\",\n    \"returns\": [\"user\"],\n    \"id\": msg.req.params.userID\n};\nmsg.inputs = {\n    \"allowed\": [\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"remote_access_allowed\",\"password\"],\n    \"required\": [],\n    \"user_id\": msg.req.params.userID\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 1520,
        "wires": [
          [
            "232bc5db.bf823a"
          ]
        ]
      },
      {
        "id": "2fe2c77.339a938",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 1520,
        "wires": [
          [
            "cebdcba9.dfac18"
          ]
        ]
      },
      {
        "id": "232bc5db.bf823a",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 800,
        "y": 1520,
        "wires": [
          [
            "563daded.823b64"
          ]
        ]
      },
      {
        "id": "563daded.823b64",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Email Update?",
        "func": "if(Object.keys(msg.inputs.body).length >0) {\n    if(msg.inputs.body.hasOwnProperty(\"email\")) {\n        msg.cloudant = {\n            \"request\": \"/stellaris_documents/_find\",\n            \"method\": \"POST\",\n            \"return_obj\": \"docs\",\n            \"bookmark_type\": \"payload\", //\"payload\", \"parameter\"\n            \"object\": \"users_email\",\n            \"selector\": {\n                \"doc_type\": \"user\",\n                \"email\": msg.inputs.body.email.toLowerCase(),\n            },\n            \"fields\": [\"_id\", \"email\"]\n        }\n        return [msg, null,null]\n        \n    } else {\n        msg.api.path = 2;\n        return [null, msg,null]\n    }\n} else {\n    return [null,null,msg]\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 960,
        "y": 1520,
        "wires": [
          [
            "9d480bc5.b40dd8"
          ],
          [
            "9be60157.ab452"
          ],
          [
            "a51390d8.bb56f"
          ]
        ],
        "outputLabels": [
          "Yes",
          "No",
          "No body"
        ]
      },
      {
        "id": "9d480bc5.b40dd8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1150,
        "y": 1480,
        "wires": [
          [
            "966aa5d.7c14a58"
          ]
        ]
      },
      {
        "id": "9be60157.ab452",
        "type": "subflow:68197f61.7975",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1550,
        "y": 1520,
        "wires": [
          [
            "41964e86.c80ec"
          ]
        ]
      },
      {
        "id": "966aa5d.7c14a58",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Email Exist?",
        "func": "if(msg.hasOwnProperty(\"users_email\") && (msg.users_email.length === 0 || (msg.users_email.length === 1 && msg.users_email[0]._id === msg.records.id))) {\n    msg.api.path = 3;\n    return [msg,null]\n} else {\n    return [null,msg]\n} ",
        "outputs": 2,
        "noerr": 0,
        "x": 1330,
        "y": 1480,
        "wires": [
          [
            "9be60157.ab452"
          ],
          [
            "a814cf22.a3b0a"
          ]
        ],
        "outputLabels": [
          "Update Record",
          "Wrong or Multiple"
        ]
      },
      {
        "id": "41964e86.c80ec",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1750,
        "y": 1520,
        "wires": [
          [
            "366859e5.634b36"
          ]
        ]
      },
      {
        "id": "a814cf22.a3b0a",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Email Already in Use",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The email address (\" + msg.inputs.body.email + \") is already associated with another user.\",\n    \"return\": [\"users_email\"]\n})\nmsg.records.format = \"array\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1540,
        "y": 1560,
        "wires": [
          [
            "3de299d9.5af206"
          ]
        ]
      },
      {
        "id": "366859e5.634b36",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1930,
        "y": 1520,
        "wires": []
      },
      {
        "id": "3de299d9.5af206",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1760,
        "y": 1600,
        "wires": []
      },
      {
        "id": "ed50483c.f97fc8",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] User Update",
        "info": "Checks for user and then updates. Any fields \nother than cloudant/logic ones can be updated",
        "x": 110,
        "y": 1480,
        "wires": []
      },
      {
        "id": "bc9631a5.eebb9",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Users by Region",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users by Region\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"fields\": [\"_id\",\"status\",\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"eula_create_date\",\"eula_accept_status\",\"eula_accept_date\",\"remote_access_allowed\"],\n    \"sort\": [{\"last_name:string\": \"asc\"}],\n    \"returns\": [\"users\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"allowed\": [\"gets_change_email\", \"sub_roles\", \"role\"],\n    \"required\": []};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.filters.params = {\n    \"doc_type\": msg.records.doc_type,\n    \"status\": \"active\",\n    \"bart_sart\": msg.req.params.bart_sart\n}\nif(msg.req.params.bart_sart === \"bart\"){\n        var area = \"sales_area\";\n        var region = \"sales_region\";\n        var territory = \"sales_territory\";\n}\nelse {\n        var area = \"service_area\";\n        var region = \"service_region\";\n        var territory = \"service_territory\";\n}\nif(msg.req.params.business_unit.trim() != \"ALL\"){\n    msg.filters.params.business_unit =  msg.req.params.business_unit\n\tif(msg.req.params.area.trim() != \"ALL\"){\n\t    msg.filters.params[area] = msg.req.params.area;\n\t    if(msg.req.params.region.trim() != \"ALL\"){\n\t        msg.filters.params[region] = msg.req.params.region;\n\t        if(msg.req.params.territory.trim() != \"ALL\"){\n\t            msg.filters.params[territory] = msg.req.params.territory;\n\t        }\n\t    }\n\t}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 1660,
        "wires": [
          [
            "8765f60c.c804f8"
          ]
        ]
      },
      {
        "id": "8765f60c.c804f8",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1140,
        "y": 1660,
        "wires": [
          [
            "520762ca.ba423c"
          ]
        ]
      },
      {
        "id": "3bcd4b75.f94e44",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 790,
        "y": 1660,
        "wires": [
          [
            "bc9631a5.eebb9"
          ]
        ]
      },
      {
        "id": "520762ca.ba423c",
        "type": "subflow:f83a5f50.ef8e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1310,
        "y": 1660,
        "wires": [
          [
            "aeb139d4.c23978"
          ]
        ]
      },
      {
        "id": "a2703c4d.00e93",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user_query/region/:bart_sart/:business_unit/:area/:region/:territory",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 290,
        "y": 1660,
        "wires": [
          [
            "20efb05e.928c8"
          ]
        ]
      },
      {
        "id": "aeb139d4.c23978",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Add Or ALL",
        "func": "var addList = [\"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\"];\nmsg.cloudant.selector.$and.forEach(function(andObj, index){\n    andObjKey = Object.keys(andObj)[0];\n    andObjValue = andObj[andObjKey];if(addList.includes(andObjKey)){\n        msg.cloudant.selector.$and[index][andObjKey] = { \"$or\": [andObjValue, \"ALL\"]};\n    }\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1490,
        "y": 1660,
        "wires": [
          [
            "f56eae86.65d97"
          ]
        ]
      },
      {
        "id": "f56eae86.65d97",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1670,
        "y": 1660,
        "wires": [
          [
            "e67eeb3d.179488"
          ]
        ]
      },
      {
        "id": "e67eeb3d.179488",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1850,
        "y": 1660,
        "wires": []
      },
      {
        "id": "685584e9.e28ebc",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] Users by Region",
        "info": "",
        "x": 120,
        "y": 1620,
        "wires": []
      },
      {
        "id": "77408e62.94768",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 1840,
        "wires": [
          [
            "6a62633a.206c4c"
          ]
        ]
      },
      {
        "id": "c7915b17.1d84e8",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/filter_by",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 1840,
        "wires": [
          [
            "9bdecbf1.62b788"
          ]
        ]
      },
      {
        "id": "97fee292.78b22",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] [DEVICES] Users Filter By",
        "info": "Filters by field and value",
        "x": 150,
        "y": 1803,
        "wires": []
      },
      {
        "id": "6a62633a.206c4c",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Users Filter By",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users Filter By\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"fields\": [\"_id\",\"status\",\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"eula_create_date\",\"eula_accept_status\",\"eula_accept_date\",\"remote_access_allowed\"],\n    \"sort\": [{\"last_name:string\": \"asc\"}],\n    \"returns\": [\"users\"]\n};\nmsg.inputs = {};\nmsg.filters = {};\nmsg.filters.params = {\n    \"doc_type\": \"user\",\n    \"status\": \"active\"\n}\nvar allowedFields = [\"_id\",\"status\",\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"eula_create_date\",\"eula_accept_status\",\"eula_accept_date\",\"remote_access_allowed\"]\nif(msg.req.query.field && msg.req.query.value && allowedFields.indexOf(msg.req.query.field) >= 0)\n{\n    msg.req.query.value = msg.req.query.value.replace(/\\\"/g,\"\") //remove quotes from value\n    if(msg.req.query.field === \"email\")\n    {\n        msg.filters.params[msg.req.query.field] = msg.req.query.value.toLowerCase();\n    } else {\n        msg.filters.params[msg.req.query.field] = msg.req.query.value\n    }\n} else {\n    msg.inputs.allowed = [\"field\", \"value\"];\n    msg.inputs.required = [\"field\", \"value\"];\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.payload = {};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 1840,
        "wires": [
          [
            "344a4abb.ad3e26"
          ]
        ]
      },
      {
        "id": "344a4abb.ad3e26",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 820,
        "y": 1840,
        "wires": [
          [
            "b40e020e.c1fa8"
          ]
        ]
      },
      {
        "id": "a09146a6.a383c8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1190,
        "y": 1840,
        "wires": [
          [
            "4a9a92bc.fd559c"
          ]
        ]
      },
      {
        "id": "4a9a92bc.fd559c",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1370,
        "y": 1840,
        "wires": []
      },
      {
        "id": "b40e020e.c1fa8",
        "type": "subflow:f83a5f50.ef8e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 990,
        "y": 1840,
        "wires": [
          [
            "a09146a6.a383c8"
          ]
        ]
      },
      {
        "id": "e87ec0f4.0009",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 710,
        "y": 1940,
        "wires": [
          [
            "88626675.95df08"
          ]
        ]
      },
      {
        "id": "f5931e7e.e23e5",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/partial_user_last_name/:partial_last_name",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 240,
        "y": 1940,
        "wires": [
          [
            "dfea7251.479c6"
          ]
        ]
      },
      {
        "id": "16fd541a.6a361c",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] Users Partial Last Name",
        "info": "Get Users Last Name With Incomplete Input",
        "x": 140,
        "y": 1900,
        "wires": []
      },
      {
        "id": "88626675.95df08",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Users Partial Last Name",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users Partial Last Name\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"fields\": [\"_id\",\"status\",\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"eula_create_date\",\"eula_accept_status\",\"eula_accept_date\",\"remote_access_allowed\"],\n    \"sort\": [{\"last_name:string\": \"asc\"}],\n    \"returns\": [\"users\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"],\n    \"partial_last_name\": msg.req.params.partial_last_name};\nmsg.filters = {\n    \"allowed\": [\"role\"],\n    \"required\": []};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.filters.params = {\n    \"doc_type\": msg.records.doc_type,\n    \"status\": \"active\",\n    \"last_name\": {\"$regex\": \"(?i)^\" + msg.inputs.partial_last_name}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 930,
        "y": 1940,
        "wires": [
          [
            "cba52518.e54a98"
          ]
        ]
      },
      {
        "id": "cba52518.e54a98",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1120,
        "y": 1940,
        "wires": [
          [
            "96ff9a16.4952d8"
          ]
        ]
      },
      {
        "id": "5798ec25.1f5b14",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1490,
        "y": 1940,
        "wires": [
          [
            "f1e0148c.34a9d8"
          ]
        ]
      },
      {
        "id": "96ff9a16.4952d8",
        "type": "subflow:f83a5f50.ef8e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1290,
        "y": 1940,
        "wires": [
          [
            "5798ec25.1f5b14"
          ]
        ]
      },
      {
        "id": "8997b720.bd0518",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1870,
        "y": 1940,
        "wires": []
      },
      {
        "id": "bd0472cc.d443f",
        "type": "link in",
        "z": "57a5a054.9dfd3",
        "name": "Error Handling Input",
        "links": [
          "f13de6c9.f7bde",
          "bab60eaa.3a63e",
          "ca04b5ae.702578",
          "641578a9.80022",
          "fa18c32.a739e4",
          "3a34f75f.ce0b98",
          "cbb433fa.24b308",
          "f9f59051.f09818",
          "5aadbd7c.0eeec4",
          "1fa4868.ab22bfa",
          "ebdeebf3.7cb3c8",
          "9503b81a.b25318",
          "dbc254a8.7a13b8",
          "5968bcd6.ca7dc4",
          "c03eaf40.418d"
        ],
        "x": 1415,
        "y": 360,
        "wires": [
          [
            "c32462b0.dfae4",
            "b2c41e4a.81f31"
          ]
        ]
      },
      {
        "id": "e03de811.dbb6f8",
        "type": "debug",
        "z": "57a5a054.9dfd3",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "x": 1950,
        "y": 360,
        "wires": []
      },
      {
        "id": "1a8fd291.d51e7d",
        "type": "inject",
        "z": "57a5a054.9dfd3",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "",
        "x": 100,
        "y": 320,
        "wires": [
          [
            "a2f7f59d.720198"
          ]
        ]
      },
      {
        "id": "63a87f66.9ae6a",
        "type": "debug",
        "z": "57a5a054.9dfd3",
        "name": "Show me errors",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "nodered_errors",
        "x": 740,
        "y": 320,
        "wires": []
      },
      {
        "id": "c32462b0.dfae4",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Check for couch returned 404 and throw it away",
        "func": "var entire_msg = msg;\n\nmsg.payload = msg.error;\nmsg.payload.entire_msg = entire_msg;\nif(msg.error.message == \"couch returned 404\")\n{\n    return [ msg, null ];\n}\nelse\n{\n    msg.payload.timestamp = Date.now();\n    return [ null, msg ];\n}\nreturn msg;",
        "outputs": "2",
        "noerr": 0,
        "x": 1640,
        "y": 360,
        "wires": [
          [
            "e03de811.dbb6f8"
          ],
          [
            "e03de811.dbb6f8",
            "a7f81b63.732ff8"
          ]
        ]
      },
      {
        "id": "78aa26dd.8ea3f8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 2140,
        "y": 440,
        "wires": []
      },
      {
        "id": "b2c41e4a.81f31",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Node Red Error",
        "func": "node.warn({\"Error Handling\": msg})\nif(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": msg.error.message,\n    \"returns\": [\"source\"]\n});\nif(!msg.hasOwnProperty(\"records\")){msg.records = {}}\nmsg.records.format = \"array\";\nmsg.source = msg.error.source;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1960,
        "y": 440,
        "wires": [
          [
            "78aa26dd.8ea3f8"
          ]
        ]
      },
      {
        "id": "96b475e9.662688",
        "type": "subflow:f4989ebd.9314",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 630,
        "y": 600,
        "wires": [
          [
            "4634e03f.e740e"
          ]
        ]
      },
      {
        "id": "2c1af94a.703936",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 2180,
        "y": 320,
        "wires": [
          []
        ]
      },
      {
        "id": "a7f81b63.732ff8",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Insert Node Red Error",
        "func": "msg.url = global.get(\"VCAP_CLOUDANT\").credentials.url + \"/node-red_errors\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1980,
        "y": 400,
        "wires": [
          [
            "95cc38f4.d2d858"
          ]
        ]
      },
      {
        "id": "95cc38f4.d2d858",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "Node Red Error",
        "method": "POST",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 2190,
        "y": 400,
        "wires": [
          []
        ]
      },
      {
        "id": "a2f7f59d.720198",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Get Node Red Errors",
        "func": "msg.api = {\n    \"version\": global.get(\"API_VERSION\")\n}\nmsg.cloudant = {\n    \"request\": \"/node-red_errors/_all_docs?include_docs=true\",\n    \"method\": \"GET\",\n    \"return_obj\": \"rows\",\n    \"object\": \"nodered_errors\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 320,
        "wires": [
          [
            "dc1819a6.b842b8"
          ]
        ]
      },
      {
        "id": "dc1819a6.b842b8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 530,
        "y": 320,
        "wires": [
          [
            "63a87f66.9ae6a"
          ]
        ]
      },
      {
        "id": "dba65925.b3b1f8",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Devices Query",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Devices Query\"\n    });\nmsg.records = {\n    \"doc_type\": \"device\",\n    \"format\": \"array\",\n    \"object\": \"devices\",\n    \"fields\": [\"_id\", \"system_type\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\", \"customer_id\", \"facility_id\", \"facility_name\", \"facility_address\", \"sales_status\", \"status_date\", \"get_me_help_allowed\", \"placed_by\", \"birth_date\", \"idp_id\"],\n    \"sort\": [{\"_id:string\": \"asc\"}],\n    \"returns\": [\"devices\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"_id\", \"_id_partial\", \"_id_like\", \"facility_name\", \"system_type\", \"get_me_help_allowed\", \"sales_status\", \"status_date_range_begin\", \"status_date_range_end\", \"birth_date_range_begin\", \"birth_date_range_end\", \"business_unit\", \"sales_area\", \"sales_region\", \"sales_territory\", \"service_area\", \"service_region\", \"service_territory\",\"idp_id\"]};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.filters.params = {\n    \"doc_type\": msg.records.doc_type,\n    \"status\": \"active\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 2440,
        "wires": [
          [
            "c97fd359.cbbfc"
          ]
        ]
      },
      {
        "id": "c97fd359.cbbfc",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 880,
        "y": 2440,
        "wires": [
          [
            "468b8e37.cfc9c"
          ]
        ]
      },
      {
        "id": "702ce90b.ef4698",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 2440,
        "wires": [
          [
            "dba65925.b3b1f8"
          ]
        ]
      },
      {
        "id": "468b8e37.cfc9c",
        "type": "subflow:f83a5f50.ef8e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1050,
        "y": 2440,
        "wires": [
          [
            "6815816d.2097"
          ]
        ]
      },
      {
        "id": "53bf960b.8841b8",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 2440,
        "wires": [
          [
            "702ce90b.ef4698"
          ]
        ]
      },
      {
        "id": "6815816d.2097",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1250,
        "y": 2440,
        "wires": [
          [
            "1746f287.174b0d"
          ]
        ]
      },
      {
        "id": "1746f287.174b0d",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1430,
        "y": 2440,
        "wires": []
      },
      {
        "id": "29f90df6.5e9972",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Query",
        "info": "",
        "x": 110,
        "y": 2400,
        "wires": []
      },
      {
        "id": "80e18637.e25728",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1470,
        "y": 1740,
        "wires": [
          [
            "29eb87f5.122698"
          ]
        ]
      },
      {
        "id": "bdeca7d1.149ac8",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1430,
        "y": 480,
        "wires": [
          [
            "5ff613b0.735a8c"
          ]
        ]
      },
      {
        "id": "e9cbf636.9f3ff8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1400,
        "y": 520,
        "wires": []
      },
      {
        "id": "7beac8b7.062f98",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active user with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 520,
        "wires": [
          [
            "e9cbf636.9f3ff8"
          ]
        ]
      },
      {
        "id": "8f8127ce.9e2878",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1460,
        "y": 1780,
        "wires": []
      },
      {
        "id": "d66b9503.38cc28",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active device with id: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 1780,
        "wires": [
          [
            "8f8127ce.9e2878"
          ]
        ]
      },
      {
        "id": "ed7272f5.93f2e",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1710,
        "y": 660,
        "wires": [
          [
            "41969339.8e8e1c"
          ]
        ]
      },
      {
        "id": "7e29eb57.8ae134",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 2080,
        "wires": [
          [
            "117ec4cf.45508b"
          ]
        ]
      },
      {
        "id": "431d2b00.2f63d4",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[CN] [DEVICES] User Query",
        "info": "",
        "x": 140,
        "y": 2040,
        "wires": []
      },
      {
        "id": "432d2c2f.7f4814",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 2080,
        "wires": [
          [
            "70e9f908.9f3768"
          ]
        ]
      },
      {
        "id": "70e9f908.9f3768",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Users Query",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users Query\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\",\"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"sort\": [{\"last_name:string\": \"asc\"}],\n    \"returns\": [\"users\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"_id\",\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"last_name_partial\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"remote_access_allowed\"]};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.filters.params = {\n    \"doc_type\": msg.records.doc_type,\n    \"status\": \"active\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 2080,
        "wires": [
          [
            "1877668b.722379"
          ]
        ]
      },
      {
        "id": "1877668b.722379",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 800,
        "y": 2080,
        "wires": [
          [
            "dfd8736e.dbbc2"
          ]
        ]
      },
      {
        "id": "dfd8736e.dbbc2",
        "type": "subflow:f83a5f50.ef8e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 970,
        "y": 2080,
        "wires": [
          [
            "bb5b499e.93ca28"
          ]
        ]
      },
      {
        "id": "bb5b499e.93ca28",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1170,
        "y": 2080,
        "wires": [
          [
            "28fa5aa.f459fa6"
          ]
        ]
      },
      {
        "id": "3922b63e.0c665a",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1550,
        "y": 2080,
        "wires": []
      },
      {
        "id": "5d9fcfb4.b94d9",
        "type": "subflow:e08f785c.844a68",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2390,
        "y": 120,
        "wires": [
          [
            "907e0f31.64e57"
          ]
        ]
      },
      {
        "id": "51ac4809.4cea98",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/maintenance",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 700,
        "wires": [
          [
            "3e3e2224.0c5eae"
          ]
        ]
      },
      {
        "id": "aca5a392.3f18f",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Auth\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 20,
        "wires": [
          []
        ]
      },
      {
        "id": "28fa5aa.f459fa6",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1370,
        "y": 2080,
        "wires": [
          [
            "3922b63e.0c665a"
          ]
        ]
      },
      {
        "id": "f1e0148c.34a9d8",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1690,
        "y": 1940,
        "wires": [
          [
            "8997b720.bd0518"
          ]
        ]
      },
      {
        "id": "7296ac0b.83c144",
        "type": "function",
        "z": "b6210d1b.09e3a",
        "name": "Info",
        "func": "if (msg.api.info) {\n    msg.info = {\n        \"name\": msg.api.name,\n        \"version\": msg.api.version\n    };\n    if (msg.api.hasOwnProperty(\"path\") && msg.api.hasOwnProperty(\"paths\")) {\n        var path = {\n            \"path\": msg.api.path,\n            \"paths\": msg.api.paths\n        }\n    } else {\n        var path = {\n            \"path\": 1,\n            \"paths\": 1\n        }\n    }\n    msg.info = Object.assign(msg.info, path);\n    if (msg.api.hasOwnProperty(\"example\")) { msg.info.example = msg.api.example }\n    if (msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"required\") && msg.inputs.required.length > 0) { msg.info.inputs_required = msg.inputs.required }\n    if (msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"allowed\") && msg.inputs.allowed .length > 0) { msg.info.inputs_allowed = msg.inputs.allowed }\n    if (msg.hasOwnProperty(\"filters\") && msg.filters.hasOwnProperty(\"required\") && msg.filters.required.length > 0) { msg.info.filters_required = msg.filters.required }\n    if (msg.hasOwnProperty(\"filters\") && msg.filters.hasOwnProperty(\"allowed\") && msg.filters.allowed.length > 0) { msg.info.filters_allowed = msg.filters.allowed }\n\n    if (msg.records.hasOwnProperty(\"returns\")) {\n        if (msg.records.returns.indexOf(\"info\") < 0 ) { msg.records.returns.unshift(\"info\") }\n    } else {\n        msg.records.returns = [\"info\"]\n    }\n    if (msg.api.hasOwnProperty(\"apic\")){\n        msg.info.apic = msg.api.apic\n    }\n    var system = global.get(\"SYSTEM\")\n    if(system) {\n        msg.info.app = system.name;\n        msg.info.instance = system.instance;\n        msg.info.space = system.space;\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 180,
        "wires": [
          [
            "6b661b5.70e66e4"
          ]
        ]
      },
      {
        "id": "6b661b5.70e66e4",
        "type": "function",
        "z": "b6210d1b.09e3a",
        "name": "Stats",
        "func": "if (msg.api.stats) {\n    msg.stats = msg.api.statistics\n    \n    if (msg.records.hasOwnProperty(\"returns\")) {\n        if (msg.records.returns.indexOf(\"stats\") < 0 ) { msg.records.returns.push(\"stats\") }\n    } else {\n        msg.records.returns = [\"stats\"]\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 180,
        "wires": [
          [
            "6b8c0164.25435"
          ]
        ]
      },
      {
        "id": "838a5b09.936648",
        "type": "function",
        "z": "bc6ff87.05a2908",
        "name": "Combine Returns",
        "func": "if(msg.hasOwnProperty(\"records\")) {\n    if (msg.records.hasOwnProperty(\"returns\") && msg.records.returns.length > 0) {\n        // if msg.records.return is an array of object to return\n        msg.payload = {};\n        msg.records.returns.forEach(function(object){\n            if ([\"info\",\"stats\"].includes(object)){\n                if (msg.hasOwnProperty(object)) {\n                    msg.payload[object] = msg[object]\n                }\n            } else if (object === \"message\"){\n               if (msg.hasOwnProperty(object)){ msg.payload[object] = msg[object] }\n            } else if (object === \"file\"){\n               if (msg.hasOwnProperty(object)){ msg.payload = msg[object] }\n            } else {\n                if (msg.hasOwnProperty(object)){\n                    if (msg.records.hasOwnProperty(\"return_formats\") && msg.records.return_formats.hasOwnProperty(object)) {\n                        var format = msg.records.return_formats[object]\n                        node.warn({\"WARNING\": object})\n                        if (format === \"JSON\") {\n                            if(msg[object][0]) {\n                                msg.payload[object] = msg[object][0];\n                            } else {\n                                msg.payload[object] = {};\n                            }\n                        } else {\n                            msg.payload[object] = msg[object];\n                        }\n                    } else {\n                        if (msg.records.format === \"JSON\") {\n                            if(msg[object][0]) {\n                                msg.payload[object] = msg[object][0];\n                            } else {\n                                msg.payload[object] = {};\n                            }\n                        } else {\n                            msg.payload[object] = msg[object];\n                        }\n                    }\n                } else {\n                    node.warn({\"Returns\": \"Error\", \"Expected object not found in msg: \": object})\n                }\n            }\n        });\n    } else {\n        if (msg.records.hasOwnProperty(\"object\")) {\n            // return the one JSON or array of objects defined in records\n            if (msg.hasOwnProperty(msg.records.object)) {\n                if (msg.records.hasOwnProperty(\"format\") && msg.records.format === \"JSON\") { msg.payload = msg[msg.records.object][0]; }\n                else { msg.payload = msg[msg.records.object]; }\n            }\n            else {\n                node.warn({\"Returns\": \"Error\", \"Expected object not found in msg: \": msg.cloudant.object})\n            }\n        }\n    }\n    if (msg.records.hasOwnProperty(\"return_code\")) {msg.statusCode = msg.records.return_code}\n}\n// else return payload\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 200,
        "wires": [
          [
            "60d75440.bb3a6c"
          ]
        ]
      },
      {
        "id": "794affb4.5365",
        "type": "subflow:b6210d1b.09e3a",
        "z": "bc6ff87.05a2908",
        "name": "",
        "x": 420,
        "y": 200,
        "wires": [
          [
            "838a5b09.936648"
          ]
        ]
      },
      {
        "id": "9340a5fc.f0d5d8",
        "type": "subflow:b6210d1b.09e3a",
        "z": "2638fa4d.cb43e6",
        "name": "",
        "x": 400,
        "y": 160,
        "wires": [
          [
            "f86d4788.190438"
          ]
        ]
      },
      {
        "id": "f86d4788.190438",
        "type": "function",
        "z": "2638fa4d.cb43e6",
        "name": "Combine Returns",
        "func": "if (msg.api.info) {msg.payload.info = msg.info}\nif (msg.api.stats) {msg.payload.stats = msg.stats}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 160,
        "wires": [
          [
            "4394da9d.caf384",
            "fae978dd.b05238"
          ]
        ]
      },
      {
        "id": "e20763f5.33406",
        "type": "function",
        "z": "bc6ff87.05a2908",
        "name": "Setup Returns",
        "func": "if (msg.hasOwnProperty(\"api\")) {\n    msg.api.end_time = Date.now();\n    if (msg.api.hasOwnProperty(\"statistics\")) {msg.api.statistics.time_ms = msg.api.end_time - msg.api.start_time}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 200,
        "wires": [
          [
            "794affb4.5365"
          ]
        ]
      },
      {
        "id": "83d350cf.1e6e",
        "type": "subflow:313bd1d3.01c06e",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1170,
        "y": 380,
        "wires": [
          [
            "28e890af.5d066"
          ]
        ]
      },
      {
        "id": "c101df63.e161e",
        "type": "subflow:313bd1d3.01c06e",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1590,
        "y": 540,
        "wires": [
          [
            "ccd38f05.bc594"
          ]
        ]
      },
      {
        "id": "8474bcea.06e8e",
        "type": "subflow:313bd1d3.01c06e",
        "z": "fc9978cc.27301",
        "name": "",
        "x": 1370,
        "y": 460,
        "wires": [
          [
            "3cb69122.9642de"
          ]
        ]
      },
      {
        "id": "e3c619dc.89ed38",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Add Support Person",
        "func": "if(msg.hasOwnProperty(\"support_users\") && msg.support_users.length > 0){\n    msg.inputs.body.assigned_id = msg.support_users.map(a => a._id);\n} else {\n    msg.inputs.body.assigned_id = [];\n}\nreturn msg;  ",
        "outputs": 1,
        "noerr": 0,
        "x": 2040,
        "y": 620,
        "wires": [
          [
            "ce9a1759.9a9cc8"
          ]
        ]
      },
      {
        "id": "d8fbd789.fe3c88",
        "type": "link in",
        "z": "a17d8665.50cb88",
        "name": "Expire RemConn in",
        "links": [
          "5331778e.bd6318"
        ],
        "x": 1435,
        "y": 760,
        "wires": [
          [
            "4fc569de.d37ce8"
          ]
        ]
      },
      {
        "id": "5331778e.bd6318",
        "type": "link out",
        "z": "a17d8665.50cb88",
        "name": "Expire RemConn Loop out",
        "links": [
          "d8fbd789.fe3c88"
        ],
        "x": 1895,
        "y": 760,
        "wires": []
      },
      {
        "id": "27759584.8e7e7a",
        "type": "subflow:313bd1d3.01c06e",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 3870,
        "y": 280,
        "wires": [
          [
            "9a2b83eb.4bddf"
          ]
        ]
      },
      {
        "id": "4634e03f.e740e",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Set Content",
        "func": "var ext = msg.cos.filename.split('.').pop();\nmsg.payload = msg.cos.return;\nmsg.headers = {\n    \"Content-Type\": \"image/\" + ext\n};\n//node.warn({\"image extension\": ext});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 600,
        "wires": [
          [
            "ebfc8e3f.ff38c"
          ]
        ]
      },
      {
        "id": "986af045.2f9b5",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Email Image",
        "func": "msg.api = {\n        \"name\": \"Email Image\",\n        \"version\": global.get(\"API_VERSION\")\n    };\nmsg.cos = {\n    \"method\": \"GET\",\n    \"filename\": msg.req.params.filename,\n    \"container\": \"email-images\"\n}\nif (msg.hasOwnProperty(\"req\") && msg.req.hasOwnProperty(\"headers\")) {\n    if (msg.req.headers.hasOwnProperty(\"api_debug\")) {\n        msg.api.debug = (msg.req.headers.api_debug === \"true\");\n    } else {\n        msg.api.debug = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"apic\")) {\n        msg.api.apic = JSON.parse(msg.req.headers.apic)\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 600,
        "wires": [
          [
            "96b475e9.662688"
          ]
        ]
      },
      {
        "id": "d11807d.309b6f8",
        "type": "http request",
        "z": "f4989ebd.9314",
        "name": "Buffer",
        "method": "use",
        "ret": "bin",
        "url": "",
        "tls": "",
        "x": 910,
        "y": 180,
        "wires": [
          [
            "43f0142a.79e35c"
          ]
        ]
      },
      {
        "id": "2b3172ba.aeaa4e",
        "type": "http in",
        "z": "fc9978cc.27301",
        "name": "",
        "url": "/files/file/settings/:file_id",
        "method": "post",
        "upload": true,
        "swaggerDoc": "",
        "x": 140,
        "y": 140,
        "wires": [
          [
            "7b3d1734.bde8f8"
          ]
        ]
      },
      {
        "id": "f43d6fba.3663a",
        "type": "function",
        "z": "81f022a0.cad36",
        "name": "Setup",
        "func": "if (msg.hasOwnProperty(\"userMgmt\") && msg.userMgmt.hasOwnProperty(\"method\")){\n    if (global.get(\"userIds\").length > 0) {\n        return [null,msg,null];\n    } else {\n        return [null,null,msg]\n    }\n    if (msg.userMgmt.hasOwnProperty(\"fields\") && msg.userMgmt.fields.length > 0) {\n        var allowedFields = [\"first_name\", \"last_name\", \"email\", \"mobile_phone\"]; //list of allowed PII that can be added in a return\n        msg.userMgmt.forEach(function(field){\n            if (allowedFields.indexOf(field) < 0 ){\n                delete msg.userMgmt.fields[field];\n            }\n        })\n    }\n}\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 210,
        "y": 140,
        "wires": [
          [
            "48548ede.50f03"
          ],
          [
            "5fc9bcaf.f9e084"
          ],
          [
            "e4337144.2e964"
          ]
        ],
        "outputLabels": [
          "skip",
          "execute",
          "no users"
        ]
      },
      {
        "id": "48548ede.50f03",
        "type": "function",
        "z": "81f022a0.cad36",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"User Mgmt\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1170,
        "y": 60,
        "wires": [
          []
        ]
      },
      {
        "id": "5fc9bcaf.f9e084",
        "type": "switch",
        "z": "81f022a0.cad36",
        "name": "Method",
        "property": "userMgmt.method",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "Add PII",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 180,
        "wires": [
          [
            "207026df.2c3b6a"
          ],
          [
            "98820bb3.984f78"
          ]
        ]
      },
      {
        "id": "207026df.2c3b6a",
        "type": "function",
        "z": "81f022a0.cad36",
        "name": "Add PII",
        "func": "var users = global.get(\"users\");\nvar userIds = global.get(\"userIds\");\nif (msg.userMgmt.hasOwnProperty(\"object\")){\n    var object = msg.userMgmt.object;\n} else {\n    var object = payload;\n}\nif (Array.isArray(msg[object])){\n    msg[object].forEach(function(obj)\n    {\n        var userIdx = userIds.indexOf(obj._id);\n        addPii(obj,users[userIdx]);\n        \n    });    \n} else {\n    var userIdx = userIds.indexOf(msg[object]._id);\n    addPii(obj,users[userIdx]); \n}\nreturn msg;\n\n//Add PII information\nfunction addPii(userData,userPii) {\n    userEmpty = {\n            \"first_name\": \"\",\n            \"last_name\": \"\",\n            \"email\": \"\",\n            \"mobile_phone\": \"\",\n            \"PII\": true\n    }\n    if (userPii !== null) {\n        userPii = Object.assign({}, userEmpty, userPii); //needed to add PII debug field\n    } else {\n        userPii = userEmpty;\n    }\n    if (msg.userMgmt.hasOwnProperty(\"fields\") && msg.userMgmt.fields.length > 0) {\n        Object.keys(userPii).forEach(function(field) {\n            if (msg.userMgmt.fields.indexOf(field) < 0 && field !== \"PII\") {\n                delete userPii[field];\n            }\n        })\n    }\n    userData = Object.assign(userData, userPii);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 140,
        "wires": [
          [
            "e72b0ed8.94d46"
          ]
        ]
      },
      {
        "id": "98820bb3.984f78",
        "type": "function",
        "z": "81f022a0.cad36",
        "name": "Method Not Supported",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User Mgmt: Method not supported\"\n})",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 280,
        "wires": [
          [
            "5bc5d1d3.c4a37"
          ]
        ]
      },
      {
        "id": "5bc5d1d3.c4a37",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "81f022a0.cad36",
        "name": "",
        "x": 920,
        "y": 300,
        "wires": []
      },
      {
        "id": "e72b0ed8.94d46",
        "type": "function",
        "z": "81f022a0.cad36",
        "name": "Cleanup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 900,
        "y": 140,
        "wires": [
          [
            "48548ede.50f03"
          ]
        ]
      },
      {
        "id": "e4337144.2e964",
        "type": "function",
        "z": "81f022a0.cad36",
        "name": "Users Not Available",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User Mgmt: Users Not Available\"\n})",
        "outputs": 1,
        "noerr": 0,
        "x": 390,
        "y": 320,
        "wires": [
          [
            "5bc5d1d3.c4a37"
          ]
        ]
      },
      {
        "id": "f89a1dc6.bd65e",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 990,
        "y": 1860,
        "wires": [
          [
            "dc666e86.cb48d"
          ]
        ]
      },
      {
        "id": "d7ddbf7b.cd38f",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Users",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Users by Role\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"users\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"returns\": [\"users\"],\n};\nmsg.inputs = {\n    \"device_id\": msg.req.params.deviceID,\n    \"role\": msg.req.params.role\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"device\"},{\"status\": \"active\"},{\"_id\": msg.inputs.device_id}]},\n                {\"$and\": [{\"doc_type\": \"machine_link\"},{\"status\": \"active\"},{\"device\": msg.inputs.device_id}]}]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 1860,
        "wires": [
          [
            "f89a1dc6.bd65e"
          ]
        ]
      },
      {
        "id": "d7221038.0502",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1370,
        "y": 1840,
        "wires": [
          [
            "d01cec89.0a404"
          ]
        ]
      },
      {
        "id": "4817e69c.dc4b78",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1750,
        "y": 1860,
        "wires": []
      },
      {
        "id": "dc666e86.cb48d",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Paired User Ids",
        "func": "if (!msg.hasOwnProperty(\"devices\") || msg.devices.length === 0) {\n    return [null,null,msg];\n}\nif (msg.hasOwnProperty(\"machine_links\") && msg.machine_links.length > 0) {\n    msg.paired_user_ids = msg.machine_links.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"selector\": { \"$and\": [\n            {\"_id\":  { \"$in\": msg.paired_user_ids  }},\n            {\"role\": msg.inputs.role}\n            ]},\n        \"sort\": [{ \"last_name:string\": \"asc\"}],\n        \"object\": \"users\"\n    };\n    if(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n        if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n        if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n    }\n    return [msg,null,null];\n}\nmsg.users = [];\nmsg.api.path = 2;\nreturn [null,msg,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1180,
        "y": 1860,
        "wires": [
          [
            "d7221038.0502"
          ],
          [
            "4817e69c.dc4b78"
          ],
          [
            "56bf3276.2d53dc"
          ]
        ],
        "outputLabels": [
          "yes paired",
          "no paired",
          "no device"
        ]
      },
      {
        "id": "d01cec89.0a404",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1570,
        "y": 1840,
        "wires": [
          [
            "4817e69c.dc4b78"
          ]
        ]
      },
      {
        "id": "bc61e160.7a68e",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1560,
        "y": 1880,
        "wires": []
      },
      {
        "id": "56bf3276.2d53dc",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active device with id: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1370,
        "y": 1880,
        "wires": [
          [
            "bc61e160.7a68e"
          ]
        ]
      },
      {
        "id": "99d23d5.28567c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1440,
        "y": 400,
        "wires": []
      },
      {
        "id": "462cf092.5a01d",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active device with id: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 400,
        "wires": [
          [
            "99d23d5.28567c"
          ]
        ]
      },
      {
        "id": "a51390d8.bb56f",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "No Body",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The request must have at least one allowed field in the body.\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1120,
        "y": 1600,
        "wires": [
          [
            "3de299d9.5af206"
          ]
        ]
      },
      {
        "id": "682f4640.de4a58",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1380,
        "y": 840,
        "wires": []
      },
      {
        "id": "20331d15.b21c72",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1200,
        "y": 840,
        "wires": [
          [
            "682f4640.de4a58"
          ]
        ]
      },
      {
        "id": "eb579346.ac809",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 990,
        "y": 820,
        "wires": [
          [
            "899f840c.74d418"
          ],
          [
            "20331d15.b21c72"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "66e92ceb.8fbd24",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 1520,
        "y": 940,
        "wires": []
      },
      {
        "id": "44e94690.e0c348",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Doc_Type Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nswitch(msg.records.object) {\n    case \"case\":\n        var object_name = \"Case\"\n        break;\n    case \"machine_life\":\n        var object_name = \"Machine Life\"\n        break;\n    case \"edhr\":\n        var object_name = \"EDHR\"\n        break;\n}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": object_name + \" record with id: \" + msg.req.params[msg.records.object + \"ID\"] + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 940,
        "wires": [
          [
            "66e92ceb.8fbd24"
          ]
        ]
      },
      {
        "id": "2b9a116b.1b0a6e",
        "type": "subflow:f83a5f50.ef8e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1010,
        "y": 1380,
        "wires": [
          [
            "a9e40a42.47c7e8"
          ]
        ]
      },
      {
        "id": "a9e40a42.47c7e8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Filter by Assigned_ID",
        "func": "if (!msg.cloudant.hasOwnProperty(\"selector\")) { msg.cloudant.selector = {}}\nif (!msg.cloudant.selector.hasOwnProperty(\"$and\")) { msg.cloudant.selector[\"$and\"] = []}\nmsg.cloudant.selector[\"$and\"].push( {\"assigned_id\": {\"$elemMatch\": { \"$eq\": msg.inputs.assigned_id} } })\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 1380,
        "wires": [
          [
            "1b347920.fd6e87"
          ]
        ]
      },
      {
        "id": "269a407b.075bd",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Ticket Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Ticket with id: \" + msg.inputs.ticket_id + \" was not found.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 160,
        "wires": [
          [
            "713615fd.a07fbc"
          ]
        ]
      },
      {
        "id": "713615fd.a07fbc",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1900,
        "y": 240,
        "wires": []
      },
      {
        "id": "d1ddb3d3.52a3b",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Ticket Found?",
        "func": "if (msg.hasOwnProperty(\"help_ticket\") && msg.help_ticket.length === 1 && (msg.help_ticket[0]._id === msg.inputs.ticket_id)) {\n    return [msg,null];\n} else {\n    return [null,msg];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 920,
        "y": 260,
        "wires": [
          [
            "4e652ad8.755814"
          ],
          [
            "95ea631a.9d9c2"
          ]
        ],
        "outputLabels": [
          "no",
          "yes"
        ]
      },
      {
        "id": "95ea631a.9d9c2",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Ticket Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Ticket with id: \" + msg.inputs.ticket_id + \" was not found.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 300,
        "wires": [
          [
            "aa5c653.3143d98"
          ]
        ]
      },
      {
        "id": "aa5c653.3143d98",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1340,
        "y": 300,
        "wires": []
      },
      {
        "id": "9066da0d.905eb8",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "No Body",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The request must have at least one allowed field in the body.\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1120,
        "y": 180,
        "wires": [
          [
            "713615fd.a07fbc"
          ]
        ]
      },
      {
        "id": "934ce807.c2d068",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Loop and Combine",
        "func": "msg.cloudant.loop_count += 1;\nif(msg.payload.hasOwnProperty(\"bookmark\") && msg.cloudant.bookmark_save) {msg.bookmark = msg.payload.bookmark}\nif(msg.cloudant.return_obj === \"\"){\n    msg.cloudant.records = msg.cloudant.records.concat(msg.payload);\n    msg.payload = {};\n    msg.api.statistics.cloudant.req_loops.push(msg.cloudant.loop_count);\n    return [msg, null];\n} else {\n    if(msg.payload.hasOwnProperty(msg.cloudant.return_obj)) {\n        msg.cloudant.records = msg.cloudant.records.concat(msg.payload[msg.cloudant.return_obj]);\n        if(!msg.cloudant.hasOwnProperty(\"limit\") || (msg.cloudant.records.length < msg.cloudant.limit)) {\n            if(msg.payload.hasOwnProperty(\"bookmark\") && msg.payload[msg.cloudant.return_obj].length >= 200 && msg.cloudant.loop_count<msg.cloudant.loop_limit){\n                //Loop\n                if(msg.cloudant.bookmark_type === \"payload\" || msg.cloudant.method !== \"GET\"){\n                    msg.url = msg.cloudant.url;\n                    msg.headers = msg.cloudant.headers;\n                    msg.cloudant.body.bookmark = msg.payload.bookmark;\n                    msg.payload = msg.cloudant.body;\n                }\n                else {//bookmark_type = \"parameter\"\n                    msg.url = msg.cloudant.url + \"&bookmark=\" +  msg.payload.bookmark;\n                    msg.headers = msg.cloudant.headers;\n                }\n                msg.cloudant.start_time = Date.now()\n                //node.warn({\"Cloudant Loop\":msg})\n                return [null,msg];\n            }\n        }\n        //Exit Loop\n        //node.warn({\"Cloudant Loop End\":msg})\n        return [msg, null];\n    }\n    else {\n        //wrong cloudant return object\n        node.warn({\"Error\": \"Wrong return object in payload\", \"Expected\": msg.cloudant.return_obj, msg});\n    }\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1470,
        "y": 260,
        "wires": [
          [
            "d518bc91.dddcc"
          ],
          [
            "285a85d0.b2f51a"
          ]
        ]
      },
      {
        "id": "285a85d0.b2f51a",
        "type": "link out",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Loop out",
        "links": [
          "4dfc5bee.86dae4"
        ],
        "x": 1735,
        "y": 300,
        "wires": []
      },
      {
        "id": "4dfc5bee.86dae4",
        "type": "link in",
        "z": "d35dd8d5.3b2a88",
        "name": "Coudant Loop In",
        "links": [
          "285a85d0.b2f51a"
        ],
        "x": 515,
        "y": 360,
        "wires": [
          [
            "75d8150c.5acc6c"
          ]
        ]
      },
      {
        "id": "d03dd36b.66414",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Setup",
        "func": "if(!msg.cloudant.hasOwnProperty(\"loop_limit\")) {msg.cloudant.loop_limit = global.get(\"cloudant_query_limit\")}\nif(!msg.cloudant.hasOwnProperty(\"server\")) {\n    var cloudant = global.get(\"VCAP_CLOUDANT\");\n    msg.cloudant.server = \"https://\" + cloudant.credentials.host;\n    msg.cloudant.headers = {\n        \"Authorization\": \"Basic \" + Buffer.from(cloudant.credentials.username + ':' + cloudant.credentials.password).toString('base64')\n    }\n}\nmsg.cloudant.url = msg.cloudant.server + msg.cloudant.request;\nmsg.cloudant.records = [];\nmsg.cloudant.body = {};\nif(msg.cloudant.hasOwnProperty(\"method\")){msg.method = msg.cloudant.method} else {msg.method = \"POST\"}\nmsg.url = msg.cloudant.url;\n\nvar findBody = {};\nif(msg.cloudant.hasOwnProperty(\"selector\")) { findBody[\"selector\"] = msg.cloudant.selector }\nif(msg.cloudant.hasOwnProperty(\"fields\")) { findBody[\"fields\"] = msg.cloudant.fields }\nif(msg.cloudant.hasOwnProperty(\"sort\")) { findBody[\"sort\"] = msg.cloudant.sort }\nif(msg.cloudant.hasOwnProperty(\"limit\")) { findBody[\"limit\"] = msg.cloudant.limit }\nif(msg.cloudant.hasOwnProperty(\"skip\")) { findBody[\"skip\"] = msg.cloudant.skip }\nif(msg.cloudant.bookmark_use && msg.inputs.body.hasOwnProperty(\"bookmark\")) {\n    if(msg.cloudant.bookmark_type === \"payload\") {\n        findBody[\"bookmark\"] = msg.inputs.body.bookmark;\n    }\n    else {\n        msg.cloudant.url += \"&bookmark=\" +  msg.inputs.body.bookmark;\n    }\n}\n\nmsg.cloudant.body = findBody;\nmsg.payload = msg.cloudant.body;\nmsg.headers = msg.cloudant.headers;\nmsg.cloudant.start_time = Date.now();\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 460,
        "y": 280,
        "wires": [
          [
            "75d8150c.5acc6c"
          ]
        ]
      },
      {
        "id": "d518bc91.dddcc",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Object",
        "func": "delete msg.method; //necessary to avoid error on default nodes\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\n\nmsg.payload = {};\n\nif(msg.cloudant.return_obj === \"rows\"){ msg.cloudant.records = msg.cloudant.records.map(a => a.doc)}\nif(!msg.cloudant.hasOwnProperty(\"object\")){\n    if(!msg.records.hasOwnProperty(\"object\")){\n        if(msg.records.hasOwnProperty(\"doc_type\")){\n            msg.cloudant.object = msg.records.doc_type;\n            if(msg.records.hasOwnProperty(\"format\")){\n                if(msg.records.format === \"array\"){ msg.cloudant.object += \"s\" }\n            }\n        }\n        else {\n            msg.cloudant.object = \"payload\"\n        }\n    }\n    else {\n        msg.cloudant.object = msg.records.object\n    }\n}\n// if object is set to doc_type separate each record based on doc_type\nif ((msg.cloudant.object === \"doc_type\") || (msg.cloudant.object === \"doc_types\")) {\n    msg.cloudant.records.forEach(function(record){\n       if (record.hasOwnProperty(\"doc_type\")) {\n           var object = record.doc_type;\n           if (msg.cloudant.object === \"doc_types\") { object += \"s\" }\n           if (!msg.hasOwnProperty(object)) { msg[object] = [] }\n           msg[object].push(record);\n       }\n       else {\n           if (!msg.hasOwnProperty(\"document\")) { msg.document = [] }\n           msg.document.push(record);\n       }\n    }); \n}\nelse { \n    msg[msg.cloudant.object] = msg.cloudant.records;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1700,
        "y": 180,
        "wires": [
          [
            "57b9385d.9648d8"
          ]
        ]
      },
      {
        "id": "694368d9.62c798",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Cloudant Http\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2430,
        "y": 180,
        "wires": [
          []
        ]
      },
      {
        "id": "70c38799.bf5838",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": {\n        \"code\": msg.payload.error,\n        \"description\": msg.payload.reason,\n        \"service\": \"cloudant\"\n    }\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1460,
        "y": 440,
        "wires": [
          [
            "25a06cb8.5d6c44"
          ]
        ]
      },
      {
        "id": "285b3c64.8f64b4",
        "type": "switch",
        "z": "d35dd8d5.3b2a88",
        "name": "200, 404, 429",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "404",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "429",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1240,
        "y": 280,
        "wires": [
          [
            "934ce807.c2d068"
          ],
          [
            "61e2253e.31759c"
          ],
          [
            "5ab53c4.3cb1dc4"
          ],
          [
            "70c38799.bf5838"
          ]
        ]
      },
      {
        "id": "d770cd1f.f9447",
        "type": "http request",
        "z": "d35dd8d5.3b2a88",
        "name": "",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 890,
        "y": 280,
        "wires": [
          [
            "51e91443.e2ec4c"
          ]
        ]
      },
      {
        "id": "61e2253e.31759c",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Error 404 Not Found",
        "func": "msg.api.statistics.cloudant.req_time_ms.push(Date.now() - msg.cloudant.start_time);\nmsg.api.statistics.cloudant.req_total += msg.cloudant.loop_count;\nmsg.api.statistics.cloudant.req_loops.push(msg.cloudant.loop_count);\nif(!msg.cloudant.hasOwnProperty(\"object\")){\n    msg.cloudant.object = msg.records.object\n}\nif(msg.cloudant.hasOwnProperty(\"records\") && msg.records.format === \"array\"){\n    msg[msg.cloudant.object] = msg.cloudant.records;\n} else {\n    msg[msg.cloudant.object] = [{}];\n}\nmsg.cloudant.error = {\n    \"statusCode\": msg.statusCode,\n    \"response\": msg.payload\n}\n\ndelete msg.method; //necessary to avoid error on default nodes\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nmsg.payload = {};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 300,
        "wires": [
          [
            "2a03c952.1c9bc6"
          ]
        ]
      },
      {
        "id": "91d21a4e.ef8058",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Rate Limit Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": {\n        \"code\": msg.payload.error,\n        \"description\": msg.payload.reason,\n        \"service\": \"cloudant\"\n    }\n});\nnode.warn(\"Cloudant Rate Limit Reached\")\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1790,
        "y": 400,
        "wires": [
          [
            "25a06cb8.5d6c44"
          ]
        ]
      },
      {
        "id": "75d8150c.5acc6c",
        "type": "delay",
        "z": "d35dd8d5.3b2a88",
        "name": "Rate Limit 20msg/sec",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "20",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 680,
        "y": 280,
        "wires": [
          [
            "d770cd1f.f9447"
          ]
        ]
      },
      {
        "id": "5ab53c4.3cb1dc4",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Query Limit Retry",
        "func": "if (!msg.cloudant.hasOwnProperty(\"retry_count\")) {\n    msg.cloudant.retry_count = 1;\n} else {\n    msg.cloudant.retry_count ++;\n}\nif (msg.cloudant.retry_count > 50 ) {\n    //give up and return error\n    return [null,msg];\n} else {\n    //reformat request\n    msg.payload = msg.cloudant.body;\n    msg.headers = msg.cloudant.headers;\n    msg.cloudant.start_time = Date.now();\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1500,
        "y": 360,
        "wires": [
          [
            "285a85d0.b2f51a"
          ],
          [
            "91d21a4e.ef8058"
          ]
        ],
        "outputLabels": [
          "retry",
          "error"
        ]
      },
      {
        "id": "51e91443.e2ec4c",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Stats",
        "func": "msg.api.statistics.cloudant.req_time_ms.push(Date.now() - msg.cloudant.start_time);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 280,
        "wires": [
          [
            "285b3c64.8f64b4"
          ]
        ]
      },
      {
        "id": "2a03c952.1c9bc6",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Stats Total",
        "func": "if (msg.hasOwnProperty(\"cloudant\")) {\n    if (msg.cloudant.hasOwnProperty(\"loop_count\")) { \n        msg.api.statistics.cloudant.req_total += msg.cloudant.loop_count;\n        msg.api.statistics.cloudant.req_loops.push(msg.cloudant.loop_count);\n    }\n    if (msg.cloudant.hasOwnProperty(\"retry_count\")) { \n        msg.api.statistics.cloudant.retry_total += msg.cloudant.retry_count;\n        msg.api.statistics.cloudant.retry_loops.push(msg.cloudant.retry_count);\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2220,
        "y": 220,
        "wires": [
          [
            "694368d9.62c798"
          ]
        ]
      },
      {
        "id": "54621c9b.f201d4",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Stats Setup",
        "func": "if (!msg.hasOwnProperty(\"cloudant\")) {\n    return [msg,null]\n} else {\n    msg.cloudant.loop_count = 0;\n    msg.cloudant.retry_count = 0;\n    if (!msg.api.hasOwnProperty(\"statistics\")) { msg.api.statistics = {} }\n    if (!msg.api.statistics.hasOwnProperty(\"cloudant\")) { msg.api.statistics.cloudant = {\n        \"req_total\": 0,\n        \"retry_total\": 0,\n        \"req_loops\": [],\n        \"retry_loops\": [],\n        \"req_time_ms\": []\n    }}\n    return [null,msg];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 220,
        "y": 220,
        "wires": [
          [
            "2a03c952.1c9bc6"
          ],
          [
            "d03dd36b.66414"
          ]
        ],
        "outputLabels": [
          "ignore",
          "execute"
        ]
      },
      {
        "id": "25a06cb8.5d6c44",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Cloudant Stats Total",
        "func": "if (msg.cloudant.hasOwnProperty(\"loop_count\")) { \n    msg.api.statistics.cloudant.req_total += msg.cloudant.loop_count;\n    msg.api.statistics.cloudant.req_loops.push(msg.cloudant.loop_count);\n}\nif (msg.cloudant.hasOwnProperty(\"retry_count\")) { \n    msg.api.statistics.cloudant.retry_total += msg.cloudant.retry_count;\n    msg.api.statistics.cloudant.retry_loops.push(msg.cloudant.retry_count);\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2040,
        "y": 440,
        "wires": [
          [
            "7adea78f.8c4e18"
          ]
        ]
      },
      {
        "id": "7adea78f.8c4e18",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "d35dd8d5.3b2a88",
        "name": "",
        "x": 2260,
        "y": 440,
        "wires": []
      },
      {
        "id": "edc7b4f6.7c7e28",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Settings",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Settings\",\n        \"info\": false\n    });\nmsg.records = {\n    \"doc_type\": \"dapp_user\",\n    \"format\": \"JSON\",\n    \"object\": \"dapp_user\",\n    \"returns\": [\"content\"],\n    \"models\": [\"dapp_user\"],\n    \"id\": msg.req.params.userId,\n    \"error_on_exist\": false\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 160,
        "wires": [
          [
            "1432fdb2.3cb952"
          ]
        ]
      },
      {
        "id": "aa6a5d10.ef1f3",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Settings Update",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Settings Update\",\n        \"info\": false\n    });\nmsg.records = {\n    \"doc_type\": \"dapp_user\",\n    \"format\": \"JSON\",\n    \"object\": \"dapp_user\",\n    \"returns\": [\"content\"],\n    \"models\": [\"dapp_user\"],\n    \"id\": msg.req.params.userId\n};\nmsg.inputs = {\n    \"required\": [\"is_goal_visible\", \"is_lifetime_visible\", \"is_period_visible\", \"spotlight_metrics\", \"categories\",\"color_mapping\"],\n    \"allowed\": []\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 280,
        "wires": [
          [
            "573487f.600e878"
          ]
        ]
      },
      {
        "id": "d9039779.388578",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Filters",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Filters\",\n        \"info\": false\n    });\nmsg.records = {\n    \"doc_type\": \"dapp_user\",\n    \"format\": \"JSON\",\n    \"object\": \"dapp_user\",\n    \"returns\": [\"content\"],\n    \"models\": [\"dapp_user\"],\n    \"id\": msg.req.params.userId,\n    \"error_on_exist\": false\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 400,
        "wires": [
          [
            "218421ba.042dce"
          ]
        ]
      },
      {
        "id": "32d328ba.a713c8",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Filters Update",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Filters Update\",\n        \"info\": false\n    });\nmsg.records = {\n    \"doc_type\": \"dapp_user\",\n    \"format\": \"JSON\",\n    \"object\": \"dapp_user\",\n    \"returns\": [\"content\"],\n    \"models\": [\"dapp_user\"],\n    \"id\": msg.req.params.userId\n};\nmsg.inputs = {\n    \"required\": [\"data_user_id\", \"facility_id\", \"machine_id\", \"display_period\", \"date\", \"case_type\"],\n    \"allowed\": []\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 520,
        "wires": [
          [
            "43f65ec4.31949"
          ]
        ]
      },
      {
        "id": "74be17dd.ff9028",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 450,
        "y": 160,
        "wires": [
          [
            "edc7b4f6.7c7e28"
          ]
        ]
      },
      {
        "id": "1d0842a9.045ecd",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 450,
        "y": 280,
        "wires": [
          [
            "aa6a5d10.ef1f3"
          ]
        ]
      },
      {
        "id": "c20930c2.43e12",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 450,
        "y": 400,
        "wires": [
          [
            "d9039779.388578"
          ]
        ]
      },
      {
        "id": "fe124e2b.1d6f3",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 450,
        "y": 520,
        "wires": [
          [
            "32d328ba.a713c8"
          ]
        ]
      },
      {
        "id": "d8ae12c.efa12f",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Settings",
        "info": "",
        "x": 140,
        "y": 120,
        "wires": []
      },
      {
        "id": "ee5c9222.7f0b8",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Settings Update",
        "info": "",
        "x": 160,
        "y": 240,
        "wires": []
      },
      {
        "id": "a13dff2d.6a0f2",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Filters",
        "info": "",
        "x": 130,
        "y": 360,
        "wires": []
      },
      {
        "id": "4188e2a6.c7b04c",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Filters Update",
        "info": "",
        "x": 150,
        "y": 480,
        "wires": []
      },
      {
        "id": "573487f.600e878",
        "type": "subflow:71afa3f9.81defc",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 840,
        "y": 280,
        "wires": [
          [
            "98c132f6.1c39f"
          ]
        ]
      },
      {
        "id": "43f65ec4.31949",
        "type": "subflow:71afa3f9.81defc",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 840,
        "y": 520,
        "wires": [
          [
            "73fa4ced.b12834"
          ]
        ]
      },
      {
        "id": "1432fdb2.3cb952",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 870,
        "y": 160,
        "wires": [
          [
            "543212a0.0c75dc"
          ]
        ]
      },
      {
        "id": "32b21a69.465416",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1670,
        "y": 140,
        "wires": []
      },
      {
        "id": "b8224f3.2919cb",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1460,
        "y": 180,
        "wires": []
      },
      {
        "id": "10006853.509438",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": {\n        \"error\": {\n        \"code\": 400,\n        \"message\": \"User with id: \" + msg.records.id + \" was not found.\"\n        }\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1260,
        "y": 180,
        "wires": [
          [
            "b8224f3.2919cb"
          ]
        ]
      },
      {
        "id": "543212a0.0c75dc",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    \n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1070,
        "y": 160,
        "wires": [
          [
            "a3197ce3.635e3"
          ],
          [
            "10006853.509438"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "a3197ce3.635e3",
        "type": "subflow:e0cd8199.1ad77",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1260,
        "y": 140,
        "wires": [
          [
            "7022df11.737f5"
          ]
        ]
      },
      {
        "id": "7022df11.737f5",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Settings Content",
        "func": "var dapp_user = msg[msg.records.object][0]\nmsg.content = [dapp_user.settings]\nmsg.content[0].user_id = dapp_user._id\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1470,
        "y": 140,
        "wires": [
          [
            "32b21a69.465416"
          ]
        ]
      },
      {
        "id": "3be3718a.91923e",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "dapp_user",
        "func": "msg.records.dapp_user = {\n    \"_id\": \"\",\n    \"settings\": {\n        \"is_goal_visible\": true,\n        \"is_lifetime_visible\": true,\n        \"is_period_visible\": true,\n        \"spotlight_metrics\": [\n            {\n                \"metric_id\": \"time_in_case_first_fp_end\",\n                \"display_order\": 0,\n                \"is_hidden\": false,\n                \"goal_value\": 0\n            },\n            {\n                \"metric_id\": \"us_effective_time\",\n                \"display_order\": 1,\n                \"is_hidden\": false,\n                \"goal_value\": 10\n            }\n        ],\n        \"categories\": [\n            {\n                \"category_name\": \"Case Time\",\n                \"display_order\": 0,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"time_in_case_setup_end\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"time_in_case_first_fp_end\",\n                        \"display_order\": 1,\n                        \"is_hidden\": false,\n                        \"goal_value\": 1\n                    }\n                ]\n            },\n            {\n                \"category_name\": \"Case Fluid\",\n                \"display_order\": 1,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"fluid_level\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    }\n                ]\n            },\n            {\n                \"category_name\": \"Infusion\",\n                \"display_order\": 2,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"infusion_actual_time\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 25\n                    },\n                    {\n                        \"metric_id\": \"infusion_average_pressure_cmH2O\",\n                        \"display_order\": 1,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"infusion_average_pressure_mmHg\",\n                        \"display_order\": 2,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    }\n                ]\n            },\n            {\n                \"category_name\": \"Aspiration\",\n                \"display_order\": 3,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"aspiration_actual_time\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 25\n                    },\n                    {\n                        \"metric_id\": \"aspiration_average_vacuum\",\n                        \"display_order\": 1,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"aspiration_effective_vacuum_time\",\n                        \"display_order\": 2,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    }\n                ]\n            },\n            {\n                \"category_name\": \"Ultrasound\",\n                \"display_order\": 4,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"us_actual_time\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"us_average_power\",\n                        \"display_order\": 1,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"us_effective_time\",\n                        \"display_order\": 2,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    }\n                ]\n            },\n            {\n                \"category_name\": \"Coagulation\",\n                \"display_order\": 5,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"coagulation_actual_time\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"coagulation_average_power\",\n                        \"display_order\": 1,\n                        \"is_hidden\": false,\n                        \"goal_value\": 25\n                    },\n                    {\n                        \"metric_id\": \"coagulation_effective_time\",\n                        \"display_order\": 2,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    }\n                ]\n            },\n            {\n                \"category_name\": \"Vitrectomy\",\n                \"display_order\": 6,\n                \"metrics\": [\n                    {\n                        \"metric_id\": \"vitrectomy_actual_time\",\n                        \"display_order\": 0,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"vitrectomy_average_cut_rate\",\n                        \"display_order\": 1,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    },\n                    {\n                        \"metric_id\": \"vitrectomy_effective_time\",\n                        \"display_order\": 2,\n                        \"is_hidden\": false,\n                        \"goal_value\": 0\n                    }\n                ]\n            }\n        ],\n        \"color_mapping\": [\n            {\n                \"id\": \"mode_chop\",\n                \"color\": \"#CCFF99\"\n            },\n            {\n                \"id\": \"mode_debulk\", \n                \"color\": \"#33FF66\",\n            },\n            {\n                \"id\": \"mode_epi\", \n                \"color\": \"#33FF99\",\n            },\n            {\n                \"id\": \"mode_phaco\", \n                \"color\": \"#33CC33\",\n            },\n            {\n                \"id\": \"mode_scchop\", \n                \"color\": \"#99CC33\",\n            },\n            {\n                \"id\": \"mode_sculpt\", \n                \"color\": \"#00CC99\",\n            },\n            {\n                \"id\": \"mode_segment\", \n                \"color\": \"#99FFCC\",\n            },\n            {\n                \"id\": \"Ultrasound\", \n                \"color\": \"#CCFF66\",\n            },\n            {\n                \"id\": \"mode_frag\", \n                \"color\": \"#199919\",\n            },\n            {\n                \"id\": \"Frag\", \n                \"color\": \"#7BCC7B\",\n            },\n            {\n                \"id\": \"mode_ia\", \n                \"color\": \"#0033CC\",\n            },\n            {\n                \"id\": \"mode_polish\", \n                \"color\": \"#0066CC\",\n            },\n            {\n                \"id\": \"mode_visco\", \n                \"color\": \"#0099CC\",\n            },\n            {\n                \"id\": \"IrrigationAspiration\", \n                \"color\": \"#6699FF\",\n            },\n            {\n                \"id\": \"mode_extrude\", \n                \"color\": \"#3399FF\",\n            },\n            {\n                \"id\": \"Extrude\", \n                \"color\": \"#33CCFF\",\n            },\n            {\n                \"id\": \"mode_irr\", \n                \"color\": \"#66CCFF\",\n            },\n            {\n                \"id\": \"Irrigation\", \n                \"color\": \"#CCECFF\",\n            },\n            {\n                \"id\": \"mode_coag\", \n                \"color\": \"#CC00CC\",\n            },\n            {\n                \"id\": \"Coagulation\", \n                \"color\": \"#FF99FF\",\n            },\n            {\n                \"id\": \"mode_avit\", \n                \"color\": \"#FFFF00\",\n            },\n            {\n                \"id\": \"AnteriorVit\", \n                \"color\": \"#CCCC00\",\n            },\n            {\n                \"id\": \"mode_vit\", \n                \"color\": \"#FFFF99\",\n            },\n            {\n                \"id\": \"PosteriorVit\", \n                \"color\": \"#FFFF66\",\n            },\n            {\n                \"id\": \"mode_vitesse_core\", \n                \"color\": \"#CCFF33\",\n            },\n            {\n                \"id\": \"mode_vitesse_low\", \n                \"color\": \"#CCFF66\",\n            },\n            {\n                \"id\": \"Vitesse\", \n                \"color\": \"#CCFF99\",\n            },\n            {\n                \"id\": \"mode_laser\", \n                \"color\": \"#00FF00\",\n            },\n            {\n                \"id\": \"Laser\", \n                \"color\": \"#66FF66\",\n            },\n            {\n                \"id\": \"mode_vfi\", \n                \"color\": \"#996633\",\n            },\n            {\n                \"id\": \"ViscousFluidControl\", \n                \"color\": \"#CC9966\",\n            },\n            {\n                \"id\": \"Setup\", \n                \"color\": \"#808080\",\n            },\n            {\n                \"id\": \"Other\", \n                \"color\": \"#C0C0C0\"\n            }\n        ]\n    },\n    \"filters\": {\n        \"data_user_id\": null,\n        \"facility_id\": null,\n        \"machine_id\": null,\n        \"display_period\": \"monthly\",\n        \"date\": Date.now(),\n        \"case_type\": \"cataract\"\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 660,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "218421ba.042dce",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 870,
        "y": 400,
        "wires": [
          [
            "97f21f53.5f8b4"
          ]
        ]
      },
      {
        "id": "4139bc7b.c8c164",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1690,
        "y": 380,
        "wires": []
      },
      {
        "id": "43001c48.386374",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1460,
        "y": 420,
        "wires": []
      },
      {
        "id": "7d89a2ff.e27dec",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": {\n        \"error\": {\n        \"code\": 400,\n        \"message\": \"User with id: \" + msg.records.id + \" was not found.\"\n        }\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1260,
        "y": 420,
        "wires": [
          [
            "43001c48.386374"
          ]
        ]
      },
      {
        "id": "97f21f53.5f8b4",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    \n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1070,
        "y": 400,
        "wires": [
          [
            "4b49db43.18de04"
          ],
          [
            "7d89a2ff.e27dec"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "4b49db43.18de04",
        "type": "subflow:e0cd8199.1ad77",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1260,
        "y": 380,
        "wires": [
          [
            "168d2b95.567664"
          ]
        ]
      },
      {
        "id": "168d2b95.567664",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Filters Content",
        "func": "var dapp_user = msg[msg.records.object][0];\nvar utcSeconds = dapp_user.filters.date/1000;\nvar date = new Date(0);\ndate.setUTCSeconds(utcSeconds);\nvar year = date.getFullYear();\nvar month = (\"0\" + (date.getMonth()+1))\nvar day = (\"0\" + date.getUTCDate())\ndapp_user.filters.date = year + \"-\" + month.substring(month.length-2) + \"-\" + day.substring(day.length-2);\nif(dapp_user.filters.facility_id) {\n    dapp_user.filters.facility_id= dapp_user.filters.facility_id.toString();\n}\nif(dapp_user.filters.machine_id) {\n    dapp_user.filters.machine_id = dapp_user.filters.machine_id.toString();\n}\nmsg.content = [dapp_user.filters]\nmsg.content[0].user_id = dapp_user._id\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 380,
        "wires": [
          [
            "4139bc7b.c8c164"
          ]
        ]
      },
      {
        "id": "98c132f6.1c39f",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1030,
        "y": 280,
        "wires": [
          [
            "9a86be8f.79b83"
          ]
        ]
      },
      {
        "id": "a130101a.c4d3c",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1850,
        "y": 260,
        "wires": []
      },
      {
        "id": "fbadcf84.be35a",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1620,
        "y": 300,
        "wires": []
      },
      {
        "id": "26a100f9.53432",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": {\n        \"error\": {\n        \"code\": 400,\n        \"message\": \"User with id: \" + msg.records.id + \" was not found.\"\n        }\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 300,
        "wires": [
          [
            "fbadcf84.be35a"
          ]
        ]
      },
      {
        "id": "9a86be8f.79b83",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    msg.inputs.body = {\n        \"settings\": msg.inputs.body\n    };\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1230,
        "y": 280,
        "wires": [
          [
            "a9b6f336.62509"
          ],
          [
            "26a100f9.53432"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "8f8e0124.7e687",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Settings Content",
        "func": "var dapp_user = msg[msg.records.object][0]\nmsg.content = [dapp_user.settings]\nmsg.content[0].user_id = dapp_user._id\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1650,
        "y": 260,
        "wires": [
          [
            "a130101a.c4d3c"
          ]
        ]
      },
      {
        "id": "a9b6f336.62509",
        "type": "subflow:68197f61.7975",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1430,
        "y": 260,
        "wires": [
          [
            "8f8e0124.7e687"
          ]
        ]
      },
      {
        "id": "73fa4ced.b12834",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1030,
        "y": 520,
        "wires": [
          [
            "3b91c1f7.270d8e"
          ]
        ]
      },
      {
        "id": "f4f49efe.d7fd6",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1850,
        "y": 500,
        "wires": []
      },
      {
        "id": "aec20053.ea61f",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1620,
        "y": 540,
        "wires": []
      },
      {
        "id": "d41d52e7.7adbb",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": {\n        \"error\": {\n        \"code\": 400,\n        \"message\": \"User with id: \" + msg.records.id + \" was not found.\"\n        }\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 540,
        "wires": [
          [
            "aec20053.ea61f"
          ]
        ]
      },
      {
        "id": "3b91c1f7.270d8e",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    var filters = msg.inputs.body;\n    filters.date = Date.parse(filters.date);\n    msg.inputs.body = {\n        \"filters\": filters\n    };\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1230,
        "y": 520,
        "wires": [
          [
            "5e121eb7.34f66"
          ],
          [
            "d41d52e7.7adbb"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "5e121eb7.34f66",
        "type": "subflow:68197f61.7975",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1430,
        "y": 500,
        "wires": [
          [
            "e082fa7e.fc1648"
          ]
        ]
      },
      {
        "id": "e082fa7e.fc1648",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Filters Content",
        "func": "var dapp_user = msg[msg.records.object][0];\nvar utcSeconds = dapp_user.filters.date/1000;\nvar date = new Date(0);\ndate.setUTCSeconds(utcSeconds);\nvar year = date.getFullYear();\nvar month = (\"0\" + (date.getMonth()+1))\nvar day = (\"0\" + date.getUTCDate())\ndapp_user.filters.date = year + \"-\" + month.substring(month.length-2) + \"-\" + day.substring(day.length-2);\nif(dapp_user.filters.facility_id) {\n    dapp_user.filters.facility_id= dapp_user.filters.facility_id.toString();\n}\nif(dapp_user.filters.machine_id) {\n    dapp_user.filters.machine_id = dapp_user.filters.machine_id.toString();\n}\nmsg.content = [dapp_user.filters]\nmsg.content[0].user_id = dapp_user._id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1660,
        "y": 500,
        "wires": [
          [
            "f4f49efe.d7fd6"
          ]
        ]
      },
      {
        "id": "2f28790c.953f86",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userId/settings",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 160,
        "wires": [
          [
            "74be17dd.ff9028"
          ]
        ]
      },
      {
        "id": "5f76466f.7506a8",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userId/settings",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 280,
        "wires": [
          [
            "1d0842a9.045ecd"
          ]
        ]
      },
      {
        "id": "3cd91299.d1526e",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userId/filters",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 400,
        "wires": [
          [
            "c20930c2.43e12"
          ]
        ]
      },
      {
        "id": "ea37a713.474cc8",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userId/filters",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 520,
        "wires": [
          [
            "fe124e2b.1d6f3"
          ]
        ]
      },
      {
        "id": "e30f497b.7b4468",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userID",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 640,
        "wires": [
          [
            "601d3844.78ecc8"
          ]
        ]
      },
      {
        "id": "39745f59.4415b",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Info (dapp)",
        "info": "",
        "x": 150,
        "y": 600,
        "wires": []
      },
      {
        "id": "a6dca1b4.61f1",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 720,
        "wires": [
          [
            "aec2e944.65c2e8"
          ]
        ]
      },
      {
        "id": "15a9156.1a44beb",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Query (dapp)",
        "info": "",
        "x": 150,
        "y": 680,
        "wires": []
      },
      {
        "id": "974c4af0.275628",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Info (dapp)",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Info (dapp)\",\n        \"info\": false\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"password\", \"doc_type\", \"status\"],\n    \"doc_type\": \"user\",\n    \"object\": \"user\",\n    \"format\": \"JSON\",\n    \"returns\": [\"content\"],\n    \"id\": msg.req.params.userID\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.filters = {};\nmsg.filters.params = {};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/\" + msg.records.id,\n    \"method\": \"GET\",\n    \"return_obj\": \"\",\n    \"object\": \"user\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 640,
        "wires": [
          [
            "9db8f4e2.b26ef8"
          ]
        ]
      },
      {
        "id": "9db8f4e2.b26ef8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 910,
        "y": 640,
        "wires": [
          [
            "661b9b3a.d9a684"
          ]
        ]
      },
      {
        "id": "978b733b.68056",
        "type": "subflow:313bd1d3.01c06e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1290,
        "y": 620,
        "wires": [
          [
            "67333aa2.9ea5d4"
          ]
        ]
      },
      {
        "id": "10e08e36.953912",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1690,
        "y": 620,
        "wires": []
      },
      {
        "id": "b134446d.0ec158",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1460,
        "y": 660,
        "wires": []
      },
      {
        "id": "4a3043d8.7f824c",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1280,
        "y": 660,
        "wires": [
          [
            "b134446d.0ec158"
          ]
        ]
      },
      {
        "id": "661b9b3a.d9a684",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1090,
        "y": 640,
        "wires": [
          [
            "978b733b.68056"
          ],
          [
            "4a3043d8.7f824c"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "f12b7dba.103b3",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 510,
        "y": 640,
        "wires": [
          [
            "974c4af0.275628"
          ]
        ]
      },
      {
        "id": "67333aa2.9ea5d4",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create User Content",
        "func": "var dapp_user = msg[msg.records.object]\nmsg.content = dapp_user\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1500,
        "y": 620,
        "wires": [
          [
            "10e08e36.953912"
          ]
        ]
      },
      {
        "id": "3afa4234.b1696e",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1850,
        "y": 720,
        "wires": []
      },
      {
        "id": "ccb0488e.4a4858",
        "type": "subflow:313bd1d3.01c06e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1450,
        "y": 720,
        "wires": [
          [
            "c95b98a7.478388"
          ]
        ]
      },
      {
        "id": "12051fc9.8cd7a",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1250,
        "y": 720,
        "wires": [
          [
            "ccb0488e.4a4858"
          ]
        ]
      },
      {
        "id": "25470ff8.bf28c",
        "type": "subflow:f83a5f50.ef8e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1050,
        "y": 720,
        "wires": [
          [
            "12051fc9.8cd7a"
          ]
        ]
      },
      {
        "id": "207c962f.5cbeda",
        "type": "subflow:71afa3f9.81defc",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 880,
        "y": 720,
        "wires": [
          [
            "25470ff8.bf28c"
          ]
        ]
      },
      {
        "id": "639230cd.efc4d",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Users Query (dapp)",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users Query (dapp)\",\n        \"info\": false\n    });\nmsg.records = {\n    \"delete\": [\"_rev\",\"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"sort\": [{\"last_name:string\": \"asc\"}],\n    \"returns\": [\"content\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"_id\",\"role\",\"sub_roles\",\"uid\",\"first_name\",\"last_name\",\"last_name_partial\",\"mobile_phone\",\"email\",\"gets_change_email\",\"bart_sart\",\"business_unit\",\"sales_area\",\"sales_region\",\"sales_territory\",\"service_area\",\"service_region\",\"service_territory\",\"created_by\",\"remote_access_allowed\"]};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"bookmark_type\": \"payload\",\n    \"pagination\": true,\n    \"bookmark_use\": false\n}\nmsg.filters.params = {\n    \"doc_type\": msg.records.doc_type,\n    \"status\": \"active\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 720,
        "wires": [
          [
            "207c962f.5cbeda"
          ]
        ]
      },
      {
        "id": "4476740f.ed6f8c",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 510,
        "y": 720,
        "wires": [
          [
            "639230cd.efc4d"
          ]
        ]
      },
      {
        "id": "c95b98a7.478388",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Users Content",
        "func": "var dapp_user = msg[msg.records.object]\nmsg.content = dapp_user\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1660,
        "y": 720,
        "wires": [
          [
            "3afa4234.b1696e"
          ]
        ]
      },
      {
        "id": "2bb9e170.65b55e",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1580,
        "y": 720,
        "wires": []
      },
      {
        "id": "60a33077.686ee",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active device with id: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1390,
        "y": 720,
        "wires": [
          [
            "2bb9e170.65b55e"
          ]
        ]
      },
      {
        "id": "dbcced9a.03622",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"selector\": {\n            \"doc_type\": \"settings_file\",\n            \"status\": \"active\",\n            \"user_id\": msg.inputs.user_id\n        },\n        \"sort\": [{\"file_id:string\": \"desc\"}]\n    };\n    if(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n        if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n        if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n    }\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1310,
        "y": 680,
        "wires": [
          [
            "a7501dbe.358ae"
          ],
          [
            "1421da2f.848706"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "d8a16247.bbced",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1680,
        "y": 700,
        "wires": []
      },
      {
        "id": "1421da2f.848706",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1500,
        "y": 700,
        "wires": [
          [
            "d8a16247.bbced"
          ]
        ]
      },
      {
        "id": "c24a421d.d2ee2",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1130,
        "y": 680,
        "wires": [
          [
            "dbcced9a.03622"
          ]
        ]
      },
      {
        "id": "db808349.0ea59",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 1500,
        "y": 800,
        "wires": []
      },
      {
        "id": "52554231.a6839c",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The device record for \" + msg.inputs.device_id + \" was not found.\"\n});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 800,
        "wires": [
          [
            "db808349.0ea59"
          ]
        ]
      },
      {
        "id": "cf67a4b4.8a7358",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Device Found",
        "func": "if (msg.hasOwnProperty(\"device\") && msg.device.length > 0 && msg.device[0].doc_type === \"device\") {\n    msg.cloudant = {\n        \"request\": \"/help_tickets/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"ticket_list\",\n        \"selector\": {\n            \"system_sn\": msg.inputs.device_id,\n            \"reason\": \"RemConn\",\n            \"ticket_status\": \"New\"        \n        },\n    \t\"sort\": [{\"start_time:number\": \"desc\"}]\n    };\n    return [msg,null];\n} else {\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1120,
        "y": 760,
        "wires": [
          [
            "77a06453.a257fc"
          ],
          [
            "52554231.a6839c"
          ]
        ],
        "outputLabels": [
          "yes found",
          "no found"
        ]
      },
      {
        "id": "8377fb1e.c743c8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 930,
        "y": 760,
        "wires": [
          [
            "cf67a4b4.8a7358"
          ]
        ]
      },
      {
        "id": "6849de07.4be1",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/system/user_profile_urls",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 800,
        "wires": [
          [
            "851918ee.31a918"
          ]
        ]
      },
      {
        "id": "aa322532.c19a18",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "[DAPP] User Profile Urls",
        "info": "",
        "x": 150,
        "y": 760,
        "wires": []
      },
      {
        "id": "851918ee.31a918",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 450,
        "y": 800,
        "wires": [
          [
            "79d34d4a.fa6a34"
          ]
        ]
      },
      {
        "id": "79d34d4a.fa6a34",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Profile URLs (dapp)",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Profile URLs (dapp)\",\n        \"info\": false\n    });\nmsg.records = {\n    \"object\": \"payload\",\n    \"returns\": [\"payload\"]\n};\nmsg.payload = {\n    \"content\":{\n    \"create_user_page\": \"www.google.com\",\n    \"forgot_password_page\": \"www.google.com\",\n    \"user_profile_page\": \"www.google.com\"\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 800,
        "wires": [
          [
            "c152c927.89e088"
          ]
        ]
      },
      {
        "id": "c152c927.89e088",
        "type": "http response",
        "z": "429bd64.63fc828",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 850,
        "y": 800,
        "wires": []
      },
      {
        "id": "db97d81e.7388b8",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/utilities/xmls",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 700,
        "wires": [
          [
            "9ce2945e.33ba08"
          ]
        ]
      },
      {
        "id": "9ce2945e.33ba08",
        "type": "subflow:3962857e.44abba",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 330,
        "y": 700,
        "wires": [
          [
            "d4387111.70451"
          ]
        ]
      },
      {
        "id": "d4387111.70451",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Get XMLs",
        "func": "msg.api = {\n        \"name\": \"Get XMLs\"\n};\nmsg.records = {\n    \"format\": \"array\",\n    \"returns\": [\"xmls\"]\n};\nmsg.xmls = global.get(\"XMLs\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 700,
        "wires": [
          [
            "7aafa9f.d8cc158"
          ]
        ]
      },
      {
        "id": "7aafa9f.d8cc158",
        "type": "subflow:bc6ff87.05a2908",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 650,
        "y": 700,
        "wires": []
      },
      {
        "id": "1d301bf7.08d524",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Get XML List",
        "func": "msg.api = {\n        \"name\": \"Get XMLs\",\n        \"version\": 10.0\n    };\nvar COS = global.get(\"VCAP_COS\")\nglobal.set(\"XMLs\", undefined)\nif(msg.cos && msg.cos.authorization) {\n    msg.cos.method = \"GET\";\n    msg.cos.container = \"xmls\";\n    msg.cos.server = COS.url;\n    msg.cos.id = COS.credentials.resource_instance_id;\n    if (!msg.cos.base_path && COS.base_path !== \"\") { msg.cos.base_path = COS.base_path }\n    msg.cos.headers = {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": msg.cos.authorization\n    }\n    msg.cos.url = msg.cos.server + \"/\" + msg.cos.base_path + \".\" + msg.cos.container + \"?list-type=2\";\n    msg.method = msg.cos.method\n    msg.url = msg.cos.url;\n    msg.headers = msg.cos.headers\n    msg.payload = {};\n    return [msg,null];\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1430,
        "y": 100,
        "wires": [
          [
            "40cd77ce.911f58"
          ]
        ]
      },
      {
        "id": "40cd77ce.911f58",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "File List",
        "method": "use",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 1580,
        "y": 100,
        "wires": [
          [
            "12f885c1.449e7a"
          ]
        ]
      },
      {
        "id": "d8981bcf.720878",
        "type": "xml",
        "z": "57a5a054.9dfd3",
        "name": "XML => JSON",
        "property": "payload",
        "attr": "",
        "chr": "",
        "x": 1900,
        "y": 100,
        "wires": [
          [
            "696fb9e8.b7c3e8"
          ]
        ]
      },
      {
        "id": "696fb9e8.b7c3e8",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Create File List",
        "func": "msg.file_list = msg.payload.ListBucketResult.Contents.map(a => a.Key)\n//node.warn({\"XMLs File list\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2080,
        "y": 100,
        "wires": [
          [
            "585cb5d3.fe416c"
          ]
        ]
      },
      {
        "id": "585cb5d3.fe416c",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Get XML File",
        "func": "if(msg.file_list.length > 0) {\n    msg.cos.filename = msg.file_list.pop();\n    msg.cos.url = msg.cos.server + \"/\" + msg.cos.base_path + \".\" + msg.cos.container + \"/\" + msg.cos.filename;\n    msg.url = msg.cos.url;\n    msg.headers = msg.cos.headers;\n    return [msg,msg]\n}\nnode.warn({\"XML List Done\": msg})",
        "outputs": 2,
        "noerr": 0,
        "x": 2270,
        "y": 100,
        "wires": [
          [
            "c968f9f0.ee7188"
          ],
          [
            "14275b0b.1297a5"
          ]
        ]
      },
      {
        "id": "c968f9f0.ee7188",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "XML File",
        "method": "use",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 2440,
        "y": 80,
        "wires": [
          [
            "ca63e68a.0baf98"
          ]
        ]
      },
      {
        "id": "14275b0b.1297a5",
        "type": "link out",
        "z": "57a5a054.9dfd3",
        "name": "XML Loop in",
        "links": [
          "2ce043e4.323f2c"
        ],
        "x": 2375,
        "y": 140,
        "wires": []
      },
      {
        "id": "2ce043e4.323f2c",
        "type": "link in",
        "z": "57a5a054.9dfd3",
        "name": "XML Loop out",
        "links": [
          "14275b0b.1297a5"
        ],
        "x": 2155,
        "y": 140,
        "wires": [
          [
            "585cb5d3.fe416c"
          ]
        ]
      },
      {
        "id": "ba3441ec.11fe5",
        "type": "xml",
        "z": "57a5a054.9dfd3",
        "name": "",
        "property": "xml",
        "attr": "",
        "chr": "",
        "x": 2730,
        "y": 80,
        "wires": [
          [
            "b74644dc.c96408"
          ]
        ]
      },
      {
        "id": "b74644dc.c96408",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Store XML",
        "func": "var file = Object.keys(msg.xml)[0];\n//node.warn({\"XML File\": {\"name\": file, \"xml\": msg.xml[file], \"msg\": msg}})\nvar xmls = global.get(\"XMLs\");\nvar delete_keys = [\"xmlns:xsi\", \"xmlns:xsd\"]\nObject.keys(msg.xml[file]).forEach(function(key){\n    if(key === \"filter\"){\n        var ver = msg.xml[file][key].version;\n        delete msg.xml[file][key];\n        msg.xml[file].version = ver;\n    }\n    if(delete_keys.indexOf(key) >= 0) {\n        delete msg.xml[file][key];\n    }\n})\nif(file === \"permissions\"){\n    msg.xml[file].role.forEach(function(role,idx){\n        if(typeof role === \"string\") {\n           msg.xml[file].role[idx] = {\n               \"role\": role,\n               \"sub_roles\": []\n           } \n        } else {\n            msg.xml[file].role[idx] = {\n               \"role\": role._,\n               \"sub_roles\": role.sub_roles\n           }\n        }\n        msg.xml[file].role[idx].sub_roles.forEach(function(sub,sub_idx){\n            var subrole = sub._;\n            delete sub._;\n            var permissions = sub;\n            msg.xml[file].role[idx].sub_roles[sub_idx] = {};\n            msg.xml[file].role[idx].sub_roles[sub_idx][subrole] = permissions;\n        })\n    })\n}\nif(file === \"user_roles\"){\n    msg.xml[file].role.forEach(function(role,idx){\n        if(typeof role === \"string\") {\n           msg.xml[file].role[idx] = {\n               \"role\": role,\n               \"sub_roles\": []\n           } \n        } else {\n            msg.xml[file].role[idx] = {\n               \"role\": role._,\n               \"sub_roles\": role.sub_roles\n           }\n        }\n    })\n}\nif(file === \"kore_info\"){\n    msg.xml[file].sim_iccid_prefix.forEach(function(sim,idx){\n        j_sim = {\n            \"prefix\": sim._,\n            \"partnumber\": sim.sim_partnumber,\n            \"apn\": {\n                \"code\": sim.sim_apn._,\n                \"display\": sim.sim_apn.display\n            },\n            \"plans\": sim.plan.code\n        }\n        if(!Array.isArray(j_sim.plans)) {j_sim.plans = [j_sim.plans]}\n        j_sim.plans.forEach(function(plan,p_idx){\n            j_sim.plans[p_idx] = {};\n            j_sim.plans[p_idx][plan._] = {\n                \"eap\": plan.eap,\n                \"display\": plan.display,\n                \"description\": plan.desc\n            }\n        })\n        msg.xml[file].sim_iccid_prefix[idx] = j_sim;\n    })\n}\nfunction processBartSartArray(array, name) {\n    var new_array = [];\n    array.forEach(function(elm,idx){\n        var object = {}\n        Object.keys(elm).forEach(function(field){\n            if(field ===\"_\") { object[name] = elm[field]}\n            else if(field === \"id\") { object.id = elm[field] }\n            else if(Array.isArray(elm[field])) {\n                var names = field+\"s\"\n                if(field === \"sales_territory\") { names = \"sales_territories\" }\n                if(field === \"service_territory\") { names = \"service_territories\" }\n                object[names] = processBartSartArray(elm[field], field)\n            }\n        })\n        new_array.push(object)\n    })\n    return new_array;\n}\nif(file === \"bart_sart\"){\n    msg.xml[file].business_units = processBartSartArray(msg.xml[file].business_unit, \"business_unit\")\n    delete msg.xml[file].business_unit\n}\nif(!xmls){ xmls = {} }\nxmls[file] = msg.xml[file];\nglobal.set(\"XMLs\", xmls)",
        "outputs": 1,
        "noerr": 0,
        "x": 2870,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "2cc5b368.a146ac",
        "type": "http request",
        "z": "4f94cf29.53815",
        "name": "AT&T SMS",
        "method": "POST",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 2630,
        "y": 80,
        "wires": [
          [
            "f817388b.ecb6c8"
          ]
        ]
      },
      {
        "id": "4250e36d.1e3c0c",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "ATT SMS Setup",
        "func": "if(msg.hasOwnProperty(\"sms_list\") && msg.sms_list.length > 0 ) {\n    var att = msg.sms.provider.att;\n    var destination = msg.sms_list.join(',').replace(/[+]/g,''); // replacing + in the phone number\n    msg.url = att.credentials.sms_url + \"?destination=\" + destination  +\"&text=\" + msg.sms.message;\n    msg.headers = {\n           \"content-type\": \"application/x-www-form-urlencoded\",\n           \"authorization\": \"Basic \" + Buffer.from(att.credentials.username + \":\" + att.credentials.password).toString('base64')\n    };\n    node.warn({\"ATT SMS sent to: \": msg.sms_list})\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2400,
        "y": 80,
        "wires": [
          [
            "2cc5b368.a146ac"
          ]
        ]
      },
      {
        "id": "eccdac94.14b49",
        "type": "http request",
        "z": "4f94cf29.53815",
        "name": "AT&T Voice",
        "method": "POST",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 2630,
        "y": 120,
        "wires": [
          [
            "f817388b.ecb6c8"
          ]
        ]
      },
      {
        "id": "36e8c931.b4baa6",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "ATT Voice Setup",
        "func": "if(msg.hasOwnProperty(\"sms_voice_list\") && msg.sms_voice_list.length > 0 ) {\n    var att = msg.sms.provider.att;\n    var destination = msg.sms_voice_list.join('&destination=').replace(/[+]/g,'');\n    msg.url = att.credentials.voice_url + \"?subAction=20\" + \"&destination=\"+ destination + \"&text=\" + msg.sms.message + \"&loop=\" + att.loop;\n    msg.headers = {\n           \"content-type\": \"application/x-www-form-urlencoded\",\n           \"authorization\": \"Basic \" + Buffer.from(att.credentials.username + \":\" + att.credentials.password).toString('base64')\n    };\n    node.warn({\"ATT Voice sent to: \": msg.sms_voice_list})\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2410,
        "y": 120,
        "wires": [
          [
            "eccdac94.14b49"
          ]
        ]
      },
      {
        "id": "13885be8.270ac4",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "Check Provider",
        "func": "msg.sms.provider = global.get(\"VCAP_SMS\");\nif(msg.sms.hasOwnProperty(\"provider\")) {\n    if(msg.sms.provider.hasOwnProperty(\"att\")) {\n        node.warn(\"ATT\");\n        return [msg,null];\n    }\n    if(msg.sms.provider.hasOwnProperty(\"twilio\")) {\n        node.warn(\"TWILIO\");\n        return [null, msg];\n    }\n}\n// No provider available do nothing\nnode.warn(\"WARNING: SMS Provider NOT available\");",
        "outputs": 2,
        "noerr": 0,
        "x": 2160,
        "y": 180,
        "wires": [
          [
            "4250e36d.1e3c0c",
            "36e8c931.b4baa6"
          ],
          [
            "410a31fd.1f91e"
          ]
        ],
        "outputLabels": [
          "twilio",
          "att"
        ]
      },
      {
        "id": "41619fef.427f2",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "Twilio Setup",
        "func": "tw = msg.sms.provider.twilio.credentials;\nmsg.url = tw.twilio_api_base_url + \"2010-04-01/Accounts/\" + tw.twilio_account_sid + \"/Messages.json\";\nmsg.sms.headers = {\n       \"content-type\": \"application/x-www-form-urlencoded\",\n       \"authorization\": \"Basic \" + Buffer.from(tw.twilio_account_sid + \":\" + tw.twilio_auth_token).toString('base64')\n};\nmsg.sms.body = { \"From\": tw.twilio_phone_number, \"To\": msg.topic, \"Body\": msg.sms.message};\nmsg.payload = msg.sms.body;\nmsg.headers = msg.sms.headers;\nnode.warn({\"Twilio SMS sent to: \": msg.topic});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2670,
        "y": 180,
        "wires": [
          [
            "ede39252.d15c7"
          ]
        ]
      },
      {
        "id": "ede39252.d15c7",
        "type": "http request",
        "z": "4f94cf29.53815",
        "name": "Twilio SMS",
        "method": "POST",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 2850,
        "y": 180,
        "wires": [
          []
        ]
      },
      {
        "id": "5ccb4407.36faec",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Rem Conn",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Rem_Conn_00.html",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 440,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "7a7665d2.fb81dc",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "EMAIL & SMS",
        "func": "if(msg.hasOwnProperty(\"support_users\") && msg.support_users.length > 0){\n    msg.email = {\n        \"to\": msg.support_users.map(a => a.email),\n        \"operation\": \"created\"\n    };\n    msg.sms = {\n        \"to\": msg.support_users.map(a => a.mobile_phone),\n        \"to_voice\": msg.support_users.map(a => a.voice_phone),\n        \"operation\": \"updated\"\n    }\n} else {\n    //do nothing\n    msg.email = {};\n    msg.sms = {};\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2780,
        "y": 340,
        "wires": [
          [
            "a04840d5.e19e6",
            "97de7ab6.1754f8"
          ]
        ]
      },
      {
        "id": "f817388b.ecb6c8",
        "type": "function",
        "z": "4f94cf29.53815",
        "name": "ATT Debug",
        "func": "if (msg.statusCode !== 200) {\n    node.warn({\"WARNING ATT Send Error\": msg.payload});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2810,
        "y": 100,
        "wires": [
          []
        ]
      },
      {
        "id": "995dac1d.9d569",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    msg.v1 = true;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 160,
        "wires": [
          [
            "571417f.b82ade8"
          ]
        ]
      },
      {
        "id": "a83e2e96.a3ec7",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "v1 Outputs",
        "func": "if(msg.hasOwnProperty(\"v1\") && msg.v1){\n    delete msg.records.returns;\n    msg.records.delete = [];\n    delete msg.api.info;\n    delete msg.api.starts;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 160,
        "wires": [
          [
            "2d2eb37c.8ee20c"
          ]
        ]
      },
      {
        "id": "7188c7c5.f89e28",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "v1 Outputs",
        "func": "if(msg.v1){\n    delete msg.records.returns;\n    msg.records.delete = [];\n    delete msg.api.info;\n    delete msg.api.starts;\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"machine_link\",\n        \"selector\": {\n            \"doc_type\": \"machine_link\",\n            \"device\": msg.inputs.device_id,\n            \"user\": msg.inputs.user_id\n        }\n    };\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 360,
        "wires": [
          [
            "fca2ce1e.60d5c"
          ]
        ]
      },
      {
        "id": "4fda7ec5.191eb",
        "type": "http in",
        "z": "c13a158d.882c9",
        "name": "",
        "url": "/logs",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 80,
        "y": 380,
        "wires": [
          [
            "5969198a.623db8"
          ]
        ]
      },
      {
        "id": "442f624a.f0465c",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "v1 Inputs",
        "func": "msg.v1 = true;\nif(msg.payload.hasOwnProperty(\"type\")){\n    if(msg.payload.type === \"case\") {\n        //manipulate case inputs\n        delete msg.payload.type\n        return [msg,null,null];\n    }\n    if(msg.payload.type === \"startup_log\"){\n        delete msg.payload.type\n        msg.payload.modlist = msg.payload.edhr;\n        delete msg.payload.edhr;\n        msg.payload.function_accumulator = msg.payload.machine_life_data;\n        delete msg.payload.machine_life_data;\n        msg.payload.timestamp = new Date().getTime();\n        msg.payload.power_on_time_stamp = msg.payload.power_on_event.timestamp\n        delete msg.payload.power_on_event.timestamp;\n        msg.payload.prev_power_off_time_stamp = msg.payload.power_off_event.timestamp\n        delete msg.payload.power_off_event;\n        if (msg.req.headers.birth === \"true\") {\n            msg.payload.birth = true;\n        } else {\n            msg.payload.birth = false;\n        }\n        //split in edhr and machine_life\n        return [null,msg,msg]\n    }\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 760,
        "y": 380,
        "wires": [
          [
            "d81d6328.63bd8"
          ],
          [
            "6e753d70.f649c4"
          ],
          [
            "df25c52.2380638"
          ]
        ],
        "outputLabels": [
          "case",
          "edhr",
          "machine_life"
        ]
      },
      {
        "id": "8c571c39.404c4",
        "type": "json",
        "z": "c13a158d.882c9",
        "name": "json Parser",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 590,
        "y": 420,
        "wires": [
          [
            "442f624a.f0465c"
          ]
        ]
      },
      {
        "id": "11e39807.b03018",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Check String",
        "func": "if (typeof msg.payload === \"string\") { return [null, msg] }\nreturn [msg, null]; \n",
        "outputs": 2,
        "noerr": 0,
        "x": 430,
        "y": 380,
        "wires": [
          [
            "442f624a.f0465c"
          ],
          [
            "8c571c39.404c4"
          ]
        ],
        "outputLabels": [
          "no str",
          "yes str"
        ]
      },
      {
        "id": "5969198a.623db8",
        "type": "subflow:3962857e.44abba",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 250,
        "y": 380,
        "wires": [
          [
            "11e39807.b03018"
          ]
        ]
      },
      {
        "id": "af895f57.d2f71",
        "type": "comment",
        "z": "c13a158d.882c9",
        "name": "[v1][Devices] Log New",
        "info": "",
        "x": 120,
        "y": 340,
        "wires": []
      },
      {
        "id": "387c1ac1.6cfc06",
        "type": "comment",
        "z": "c012d9b9.f1e028",
        "name": "[v1][DEVICES] Device User Unpair",
        "info": "API paths:\n1. Missing Inputs\n2. Active Link record not found\n7. Active Link record found",
        "x": 160,
        "y": 400,
        "wires": []
      },
      {
        "id": "b64e16f2.9df7a8",
        "type": "comment",
        "z": "c012d9b9.f1e028",
        "name": "[v1] [DEVICES] Device User Pair",
        "info": "API paths:\n1. Missing Inputs\n2. Fake user_id\n3. Fake email\n4. Fake device_id\n5. New link record\n6. Existing inactive link record\n7. Existing active link record",
        "x": 150,
        "y": 200,
        "wires": []
      },
      {
        "id": "45b0ab31.18db54",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "v1 Outputs",
        "func": "if(msg.v1){\n    delete msg.records.returns;\n    msg.records.delete = [\"_id\", \"_rev\", \"status\", \"address\"]\n    delete msg.api.info;\n    delete msg.api.stats;\n    delete msg.records.return_code;\n    msg.edhr[0].geo_location = msg.req.body.location;\n    msg.records.object = \"edhr\"\n    msg.records.doc_type = \"edhr\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3690,
        "y": 280,
        "wires": [
          [
            "27759584.8e7e7a"
          ]
        ]
      },
      {
        "id": "4aca654c.0f624c",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "v1 Outputs",
        "func": "if(msg.v1) {\n    delete msg.res // disable responding\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1070,
        "y": 780,
        "wires": [
          [
            "7970b698.d57dc8"
          ]
        ]
      },
      {
        "id": "4d22178.8609fe8",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "COS Endpoint",
        "func": "msg.url = global.get(\"VCAP_COS\").credentials.endpoints\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 100,
        "wires": [
          [
            "648a0f22.9fbd6"
          ]
        ]
      },
      {
        "id": "ed90d453.615ab8",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Key Store",
        "func": "var KEYPROTECT = global.get(\"VCAP_KEYPROTECT\").credentials\nmsg.url = KEYPROTECT.url  + \"/\" + KEYPROTECT.com_key_id ;\nmsg.method = \"GET\";\nmsg.headers = {\n    \"authorization\": msg.keyprotect.authorization,\n    \"bluemix-instance\": KEYPROTECT.instance_id,\n    \"accept\": \"application/vnd.ibm.kms.key+json\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 160,
        "wires": [
          [
            "379324f3.bb6e6c"
          ]
        ]
      },
      {
        "id": "379324f3.bb6e6c",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "Key Store",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1200,
        "y": 160,
        "wires": [
          [
            "156670a7.30b9ff"
          ]
        ]
      },
      {
        "id": "71d66758.3a1f88",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "IAM KeyProtect",
        "func": "msg.iam = { \"type\": \"keyprotect\" }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 160,
        "wires": [
          [
            "f3d10722.d9c558"
          ]
        ]
      },
      {
        "id": "156670a7.30b9ff",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Save Crypto Key com",
        "func": "var KEYS = global.get(\"CRYPTO_KEYS\");\nif(KEYS){\n    KEYS.com = msg.payload.resources[0];\n} else {\n    KEYS = {\n        \"com\": msg.payload.resources[0]\n    };\n}\nglobal.set(\"CRYPTO_KEYS\", KEYS)\nvar KEYPROTECT = global.get(\"VCAP_KEYPROTECT\").credentials\nmsg.url = KEYPROTECT.url  + \"/\" + KEYPROTECT.cloudant_key_id ;\nmsg.method = \"GET\";\nmsg.headers = {\n    \"authorization\": msg.keyprotect.authorization,\n    \"bluemix-instance\": KEYPROTECT.instance_id,\n    \"accept\": \"application/vnd.ibm.kms.key+json\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1380,
        "y": 160,
        "wires": [
          [
            "59986608.a8b058"
          ]
        ]
      },
      {
        "id": "7fb9763a.bffa58",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Set Env Variables",
        "func": "var VCAP = global.get(\"VCAP\").services;\n//***** Legacy Override with Global Variables\n//***** KORE\nvar kore = global.get(\"VCAP_KORE\");\nif(!kore) {\n    if(context.global.process.env[\"KORE_url\"]) {\n        kore = {\n            \"name\": \"global_variables\",\n            \"credentials\": {\n                \"apikey\": \"QmF1c2NoQVBJOnV3VXVNc3Iz\",\n                \"iccid_prefixs\": [\"89014\",\"89302\",\"89314\"],\n                \"type\": \"Basic\",\n                \"url\": context.global.process.env[\"KORE_url\"]\n            }\n        }\n        global.set(\"VCAP_KORE\", kore)\n    } else {\n        node.warn(\"WARNING: No Kore configuration found.\")\n    }\n}\nvar google = global.get(\"VCAP_GOOGLE\");\nif(!google) {\n    if(context.global.process.env[\"Google_Geocoding_url\"] && context.global.process.env[\"Google_Geolocate_url\"]) {\n        google = {\n            \"name\": \"global_variables\",\n            \"credentials\": {\n                \"key\": context.global.process.env[\"Google_Geocoding_url\"].split(\"?\")[1].substring(4),\n                \"Google_Geocoding_url\": context.global.process.env[\"Google_Geocoding_url\"].split(\"?\")[0],\n                \"Google_Geolocate_url\": context.global.process.env[\"Google_Geolocate_url\"].split(\"?\")[0]\n            }\n        }\n        global.set(\"VCAP_GOOGLE\", google)\n    } else {\n        node.warn(\"WARNING: No Google configuration found.\")\n    }\n}\nglobal.set(\"FLOW_FILE\", context.global.process.env[\"NODE_RED_FLOW_NAME\"]);\nif(context.global.process.env[\"EULA_CATALOG\"]) {\n    global.set(\"EULA_CATALOG\", context.global.process.env[\"EULA_CATALOG\"]);\n} else {\n    global.set(\"EULA_CATALOG\", global.get(\"VCAP_CONFIG\").credentials.EULA_CATALOG);\n}\nif(context.global.process.env[\"Birth_Email_Distribution\"]) {\n    global.set(\"BIRTH_EMAIL_DISTRIBUTION\", context.global.process.env[\"Birth_Email_Distribution\"]);\n} else {\n    global.set(\"BIRTH_EMAIL_DISTRIBUTION\", global.get(\"VCAP_CONFIG\").credentials.Birth_Email_Distribution);\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 100,
        "wires": [
          [
            "71d66758.3a1f88",
            "4d22178.8609fe8",
            "22770158.30f6fe",
            "f7214467.2dd8f8"
          ]
        ]
      },
      {
        "id": "22770158.30f6fe",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "App ID Public Key",
        "func": "var oauth_credentials = global.get(\"VCAP_APPID\").credentials;\nmsg.method = \"GET\";\noauth_credentials.oauthServerUrl = oauth_credentials.oauthServerUrl.replace(\"v4\",\"v3\"); //necessary for EU where this address is configured wrong\nmsg.url = oauth_credentials.oauthServerUrl + \"/publickey\";\nmsg.headers = {\n    \"authorization\": \"Basic \" +  Buffer.from(oauth_credentials.clientId + \":\" + oauth_credentials.secret).toString('base64')\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 220,
        "wires": [
          [
            "84649a50.b813c8"
          ]
        ]
      },
      {
        "id": "84649a50.b813c8",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "APP ID Request",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 900,
        "y": 220,
        "wires": [
          [
            "7f529bb3.035494"
          ]
        ]
      },
      {
        "id": "7f529bb3.035494",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Store Public Key",
        "func": "if (msg.payload.hasOwnProperty(\"kty\")) {\n    var jsr = global.get('jsrsasign');\n    var appid_pub = {}\n    appid_pub.key = msg.payload;\n    appid_pub.key_jsr = jsr.KEYUTIL.getKey(msg.payload);\n    global.set(\"APPID_PUB\", appid_pub);\n}\nnode.warn({\"APP ID Public Key Done\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1090,
        "y": 220,
        "wires": [
          []
        ]
      },
      {
        "id": "f795cb6f.150988",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "3962857e.44abba",
        "name": "",
        "x": 1240,
        "y": 220,
        "wires": []
      },
      {
        "id": "b7b890fe.b54a6",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Basic Auth",
        "func": "if(global.get(\"VCAP_AUTH\")) {\n    var auth = global.get(\"VCAP_AUTH\").credentials.type + \" \" + global.get(\"VCAP_AUTH\").auth_key;\n    if(msg.req.headers && msg.req.headers.authorization){\n        if (msg.req.headers.authorization === auth) {\n            if(msg.api && msg.api.debug) {\n                msg.api.auth = { \"type\": \"basic\" }\n            }\n            return [null,msg,null]\n        }\n    }\n    return [null,null,msg];\n}\nreturn [msg,null,null]",
        "outputs": 3,
        "noerr": 0,
        "x": 590,
        "y": 100,
        "wires": [
          [
            "ed1d24e.f4bc6d8"
          ],
          [
            "c4a24f6a.37c1b"
          ],
          [
            "c3e26155.669ab"
          ]
        ],
        "outputLabels": [
          "legacy",
          "authorized",
          "unauthorized"
        ]
      },
      {
        "id": "bfe490a.2c4cf7",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Start Time",
        "func": "msg.api = {\n    \"start_time\": Date.now(),\n    \"version\": global.get(\"API_VERSION\"),\n    \"statistics\": {}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 130,
        "y": 160,
        "wires": [
          [
            "514b425d.eea37c"
          ]
        ]
      },
      {
        "id": "b8c36493.e64ac8",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Auth Type",
        "func": "if(msg.req.headers && msg.req.headers.authorization){\n    var auth_type = msg.req.headers.authorization.split(\" \")[0];\n    if(msg.api && msg.api.apic && msg.api.apic.version && [\"v4\",\"ve\"].indexOf(msg.api.apic.version) >= 0) {\n        //v4 only supporst bearer token\n        if(auth_type === \"Bearer\") {\n            return [null,msg,null];\n        } else {\n            return [null,null,msg];\n        }\n    } else {\n        // node red direct and any other version apic support both\n        if(auth_type === \"Bearer\") {\n            return [null,msg,null];\n        }\n        if(auth_type === \"Basic\") {\n            return [msg,null,null];\n        }\n    }\n}\nreturn [null,null,msg];",
        "outputs": 3,
        "noerr": 0,
        "x": 420,
        "y": 160,
        "wires": [
          [
            "b7b890fe.b54a6"
          ],
          [
            "e4adfe3d.c3c6b"
          ],
          [
            "6a141388.c3e46c"
          ]
        ],
        "outputLabels": [
          "Basic",
          "Bearer",
          "no auth"
        ]
      },
      {
        "id": "c3e26155.669ab",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Unauthorized Basic",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 401,\n    \"message\": {\n        \"code\": \"invalid_auth\",\n        \"description\":\"Unauthorized - Wrong Basic Auth Credentials\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 180,
        "wires": [
          [
            "f795cb6f.150988"
          ]
        ]
      },
      {
        "id": "99d252f4.5b4ed",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Unauthorized - Invalid Token",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 401,\n    \"message\": {\n        \"code\": \"invalid_token\",\n        \"description\": \"Unauthorized - Invalid Token\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 220,
        "wires": [
          [
            "f795cb6f.150988"
          ]
        ]
      },
      {
        "id": "d3e04f7d.e76fb",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Unauthorized - Token Not Supported",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 401,\n    \"message\": {\n        \"code\": \"unsupported_auth\",\n        \"description\": \"Unauthorized - Token Auth Not Supported\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 260,
        "wires": [
          [
            "f795cb6f.150988"
          ]
        ]
      },
      {
        "id": "6a141388.c3e46c",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Unauthorized",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 401,\n    \"message\": {\n        \"code\": \"invalid_auth\",\n        \"description\": \"Unauthorized - No valid Credentials\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 320,
        "wires": [
          [
            "f795cb6f.150988"
          ]
        ]
      },
      {
        "id": "e4adfe3d.c3c6b",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Bearer Auth",
        "func": "if(global.get('jsrsasign') && global.get(\"VCAP_APPID\") && global.get(\"APPID_PUB\")) {\n    var jsr = global.get('jsrsasign');\n    var public_key = global.get('APPID_PUB').key_jsr;\n    if (msg.req.headers.authorization && msg.req.headers.authorization.split(\" \")[0] === \"Bearer\") {\n        msg.authorization = {\n            \"access_token\": msg.req.headers.authorization.split(\" \")[1]\n        };\n        try {\n            msg.authorization.token_header = jsr.KJUR.jws.JWS.readSafeJSONString(jsr.b64utoutf8(msg.authorization.access_token.split(\".\")[0]));\n            msg.authorization.token_payload = jsr.KJUR.jws.JWS.readSafeJSONString(jsr.b64utoutf8(msg.authorization.access_token.split(\".\")[1]));\n            msg.authorization.token_isValid = jsr.KJUR.jws.JWS.verifyJWT(msg.authorization.access_token, public_key, {alg: ['RS256'], verifyAt: Math.round(Date.now()/1000)})\n        }\n        catch(err) {\n            return [null,msg,null];\n        }\n        if(msg.api && msg.api.debug) {\n            msg.api.auth = { \"type\": \"bearer\" }\n        }\n        if (msg.authorization.token_isValid) {\n            return [msg,null,null];\n        } else {\n            return [null,msg,null];\n        }\n    }\n}\nreturn [null,null,msg];",
        "outputs": 3,
        "noerr": 0,
        "x": 590,
        "y": 160,
        "wires": [
          [
            "c4a24f6a.37c1b"
          ],
          [
            "99d252f4.5b4ed"
          ],
          [
            "d3e04f7d.e76fb"
          ]
        ],
        "outputLabels": [
          "authorized",
          "unauthorized",
          "not supported"
        ]
      },
      {
        "id": "4e42e061.1bfdd",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/token",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 780,
        "wires": [
          [
            "178ef45f.00a64c"
          ]
        ]
      },
      {
        "id": "178ef45f.00a64c",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Access Token",
        "func": "msg.api = {\n    \"start_time\": Date.now(),\n    \"version\": global.get(\"API_VERSION\"),\n    \"name\": \"Access Token\",\n    \"statistics\": {}\n}\nmsg.inputs = {\n    \"required\": [\"grant_type\", \"scope\"],\n    \"allowed\": []\n}\nif(msg.payload.grant_type) {\n    if(msg.payload.grant_type === \"password\") {\n        msg.inputs.required = [\"grant_type\", \"username\", \"password\", \"scope\"]\n    } else if(msg.payload.grant_type === \"refresh_token\") {\n        msg.inputs.required = [\"grant_type\", \"refresh_token\", \"scope\"]\n    }\n}\nmsg.records = {};\nif(global.get(\"VCAP_APPID\")) {\n    msg.appid = {\n        \"server\": global.get(\"VCAP_APPID\").credentials.oauthServerUrl\n    }\n    return [msg,null];\n}\nreturn [null,msg]\n//Modification for rebirth\n//if APPID returns an error, check the username if it is a system_sn, check if in cloudant.\n//If there, add a record in appid with a random password and return the new password.",
        "outputs": 2,
        "noerr": 0,
        "x": 300,
        "y": 780,
        "wires": [
          [
            "bd0f7250.6f7f8"
          ],
          [
            "60ddcf4a.6c8f7"
          ]
        ]
      },
      {
        "id": "bde75af7.2d5698",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "APP ID Token",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 960,
        "y": 760,
        "wires": [
          [
            "7b43a735.8abdd8"
          ]
        ]
      },
      {
        "id": "38d932.6d8546ce",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Add c_id",
        "func": "var jsr = global.get('jsrsasign');\nif (!msg.hasOwnProperty(\"authorization\")) {msg.authorization = {}; }\nif (msg.payload.hasOwnProperty(\"access_token\")) {\n    msg.authorization.access_token = msg.payload.access_token;\n    msg.authorization.token_header = jsr.KJUR.jws.JWS.readSafeJSONString(jsr.b64utoutf8(msg.authorization.access_token.split(\".\")[0]))\n    //node.warn({\"token_header\":  msg.authorization.token_header})\n    msg.authorization.token_payload = jsr.KJUR.jws.JWS.readSafeJSONString(jsr.b64utoutf8(msg.authorization.access_token.split(\".\")[1]))\n    //node.warn({\"token_payload\":  msg.authorization.token_payload})\n}\nif (msg.payload.hasOwnProperty(\"id_token\")) {\n    msg.authorization.id_token = msg.payload.id_token;\n    msg.authorization.id_token_header = jsr.KJUR.jws.JWS.readSafeJSONString(jsr.b64utoutf8(msg.authorization.id_token.split(\".\")[0]))\n    //node.warn({\"id_token_header\":  msg.authorization.id_token_header})\n    msg.authorization.id_token_payload = jsr.KJUR.jws.JWS.readSafeJSONString(jsr.b64utoutf8(msg.authorization.id_token.split(\".\")[1]))\n    //node.warn({\"id_token_payload\":  msg.authorization.id_token_payload})\n    msg.authorization.appid_id = msg.authorization.id_token_payload.sub;\n    msg.authorization.id_token_payload.identities.forEach(function(idp){\n        if (idp.provider === \"cloud_directory\") {\n            msg.authorization.idp_id = idp.id;        \n        }\n    })\n    if(msg.authorization.id_token_payload.oauth_client) {\n        msg.authorization.requesting_app = msg.authorization.id_token_payload.oauth_client.name;\n    }\n}\nvar users = global.get(\"APPID\").users;\nvar devices = global.get(\"APPID\").devices\nvar user_idx = users.idp_ids.indexOf(msg.authorization.idp_id)\nif (user_idx >= 0 && ('null' != users.idp_ids[user_idx]) && users.idp_ids[user_idx] !== \"\") {\n    msg.authorization.c_id = users.c_ids[user_idx]\n} else {\n    var device_idx = users.idp_ids.indexOf(msg.authorization.idp_id)\n    if ( device_idx >= 0  && ('null' != devices.idp_ids[device_idx]) && devices.idp_ids[device_idx] !== \"\") {\n        msg.authorization.c_id = devices.c_ids[device_idx]\n    }\n}\nif (msg.authorization.hasOwnProperty(\"appid_id\")) { msg.payload.appid_id = msg.authorization.appid_id }\nif (msg.authorization.hasOwnProperty(\"idp_id\")) { msg.payload.idp_id = msg.authorization.idp_id }\nif (msg.authorization.hasOwnProperty(\"c_id\")) { msg.payload.c_id = msg.authorization.c_id }\n//node.warn({\"Token Info\": msg});\nmsg.api.info = false;\nmsg.api.stats = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1260,
        "y": 740,
        "wires": [
          [
            "692bef4.d6f061"
          ]
        ]
      },
      {
        "id": "60ddcf4a.6c8f7",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "APP ID Not Configured",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": {\n        \"code\": \"appid_missing\",\n        \"description\": \"APP ID is not configured on this CF APP\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 820,
        "wires": [
          [
            "f37244ae.346dd8"
          ]
        ]
      },
      {
        "id": "f37244ae.346dd8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 1540,
        "y": 800,
        "wires": []
      },
      {
        "id": "9bd877f1.986f88",
        "type": "subflow:3962857e.44abba",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 330,
        "y": 860,
        "wires": [
          [
            "a37abe75.f5eab"
          ]
        ]
      },
      {
        "id": "26c89df2.e75ce2",
        "type": "subflow:bc6ff87.05a2908",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 670,
        "y": 860,
        "wires": []
      },
      {
        "id": "80de317f.7ca5f",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/crypto_key",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 860,
        "wires": [
          [
            "9bd877f1.986f88"
          ]
        ]
      },
      {
        "id": "a37abe75.f5eab",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Crypto Key",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Crypto Key\",\n        \"encrypt\": false\n    });\nmsg.records = {\n    \"format\": \"array\",\n    \"returns\": [\"key\"]\n};\nmsg.key = global.get(\"CRYPTO_KEYS\").com.payload\nnode.warn({\"Crypto Key\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 510,
        "y": 860,
        "wires": [
          [
            "26c89df2.e75ce2"
          ]
        ]
      },
      {
        "id": "7fe55e1f.27f52",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Email Setup",
        "func": "var device = msg.device[0];\nvar ticket = msg.help_ticket[0];\nvar users_email = msg.support_users.map(a => a.email).join(\",\")\nmsg.message = device.system_type + \" \" + device._id + \" has had Remote Connect enabled. Ticket # \"+ ticket._id + \" created at \" + Date(ticket.timestamp) + \" has been escalated. Connect to KORE VPN and point VNC Client to \" + ticket.device_ip + \" to initiate Remote Connect.\"\nif (!msg.hasOwnProperty(\"email\")) { msg.email = {} }\nmsg.email.fields = \n{\n    \"ticket_id\": ticket._id,\n    \"system_type\": device.system_type,\n    \"device_id\": device._id,\n    \"start_time\": Date(ticket.start_time),\n    \"device_ip\": ticket.device_ip,\n};\nmsg.email.topic = \"Remote Connect enabled: \" + ticket._id ;\nmsg.email.to = users_email;\n\nmsg.email.template_type = \"rem_conn\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2410,
        "y": 620,
        "wires": [
          [
            "e4a8dcfe.671d1",
            "d6aa4528.4adaa8"
          ]
        ]
      },
      {
        "id": "8e78e591.f1a9e8",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "Link Already Inactive",
        "func": "if(msg.records.returns) {\n    msg.records.returns.push(\"message\");\n}\nelse {\n    msg.records.returns = [\"message\"];\n}\nmsg.message = \"Link between Device: \" + msg.inputs.body.device_id + \" and User: \" + msg.inputs.body.user_id + \" was already delinked.\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1520,
        "y": 420,
        "wires": [
          [
            "1e092205.03841e"
          ]
        ]
      },
      {
        "id": "29b16398.3bde7c",
        "type": "function",
        "z": "c012d9b9.f1e028",
        "name": "v1 Errors",
        "func": "if(msg.v1){\n    msg.errors[0].message = msg.errors[0].message.replace(\" was not found\",\" does not exist\");\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1740,
        "y": 380,
        "wires": [
          [
            "bcabe882.080058"
          ]
        ]
      },
      {
        "id": "59986608.a8b058",
        "type": "http request",
        "z": "57a5a054.9dfd3",
        "name": "Key Store",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1560,
        "y": 160,
        "wires": [
          [
            "6d0a21fb.2bdab"
          ]
        ]
      },
      {
        "id": "6d0a21fb.2bdab",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Save Crypto Key cloudant",
        "func": "var KEYS = global.get(\"CRYPTO_KEYS\");\nif(KEYS){\n    KEYS.cloudant = msg.payload.resources[0];\n} else {\n    KEYS = {\n        \"cloudant\": msg.payload.resources[0]\n    };\n}\nglobal.set(\"CRYPTO_KEYS\", KEYS)\nnode.warn({\"Crypto Keys Done\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1750,
        "y": 160,
        "wires": [
          []
        ]
      },
      {
        "id": "60d75440.bb3a6c",
        "type": "function",
        "z": "bc6ff87.05a2908",
        "name": "Decrypt Cloudant Fields",
        "func": "var cryptojs = global.get('cryptojs');\nvar encryption_available = global.get('CRYPTO_KEYS');\nif(encryption_available && encryption_available.cloudant) {\n    var key = encryption_available.cloudant.payload;\n    var field_list = [];\n    var types = [\"help_tickets\",\"help_ticket\",\"settings_files\",\"settings_file\"];\n    if(msg.payload && msg.payload !== {}) {\n        Object.keys(msg.payload).forEach(function(type) {\n            if(types.indexOf(type) >= 0) {\n                if([\"help_tickets\",\"help_ticket\"].indexOf(type) >= 0) { field_list = [\"contact_name\", \"contact_number\", \"surgeon_settings_name\"]; }\n                if([\"settings_files\",\"settings_file\"].indexOf(type) >= 0) { field_list = [\"file_name\"]; }\n                if(Array.isArray(msg.payload[type])) {\n                    msg.payload[type].forEach(function(record,idx){\n                        field_list.forEach(function(field){\n                            var efield = \"e_\" + field;\n                            if(record[efield]) {\n                                if(record[efield] !== \"\") {\n                                    try {\n                                        record[field] = JSON.parse(cryptojs.AES.decrypt(record[efield],key).toString(cryptojs.enc.Utf8));\n                                    }\n                                    catch(e){ node.warn({\"Decrypt ERROR\": e}) }\n                                } else {\n                                    record[field] = \"\";\n                                }\n                                delete record[efield];\n                            }\n                        });\n                    });\n                } else {\n                    field_list.forEach(function(field){\n                        //node.warn(field)\n                        var efield = \"e_\" + field;\n                        if(msg.payload[type][efield]) {\n                            if(msg.payload[type][efield] !== \"\") {\n                                try {\n                                    msg.payload[type][field] = JSON.parse(cryptojs.AES.decrypt(msg.payload[type][efield],key).toString(cryptojs.enc.Utf8));\n                                }\n                                catch(e){ node.warn( {\"Decrypt ERROR\": e}) }\n                            } else {\n                                msg.payload[type][field] = \"\";\n                            }\n                            delete msg.payload[type][efield];\n                        }\n                    });\n                }\n            }\n        });\n    }\n} else {\n    node.warn(\"WARNING [cloudant Encryption]: On this setup Cloudant Encrytpion is NOT available\")\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 870,
        "y": 200,
        "wires": [
          [
            "471373d5.3cd54c"
          ]
        ]
      },
      {
        "id": "be86d379.943a6",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Skip",
        "func": "if(msg.iam && msg.iam.type && (!msg[msg.iam.type] || !msg[msg.iam.type].authorization)) {\n    return [null,msg];\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 170,
        "y": 180,
        "wires": [
          [],
          [
            "5268805f.92bc5"
          ]
        ],
        "outputLabels": [
          "skip",
          "execute"
        ]
      },
      {
        "id": "ad489be8.83b808",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug === true && msg.api.version) {\n    node.warn({\"IAM Manager\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1750,
        "y": 120,
        "wires": [
          []
        ]
      },
      {
        "id": "5268805f.92bc5",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Check Token",
        "func": "var tokens = global.get(\"TOKENS\");\nvar type = msg.iam.type;\nvar mgmt = msg.iam.mgmt;\nif(!msg.iam.url) { msg.iam.url = \"https://iam.bluemix.net/identity/token\"; } //find a better place to get this url\nif(!msg.iam.headers) {\n     msg.iam.headers = {\n        \"accept\": \"application/json\",\n        \"content-type\": \"application/x-www-form-urlencoded\"\n    }\n}\nif(tokens && tokens[type]) {\n    msg.iam.token = tokens[type];\n    if(msg.iam.token.expiration > (Date.now()/1000) + 60) {\n        return [msg,null,null,null]; // return token\n    }\n}\nmsg.iam.credentials = global.get(\"VCAP_\" + type.toUpperCase()).credentials;\nif(!msg.iam.credentials) {\n    return [null,null,null,msg] // error\n}\nmsg.iam.body = \"grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey=\" + msg.iam.credentials.apikey + \"&response_type=cloud_iam\";\nnode.warn(\"New Api Key Token for \" + msg.iam.type);\nif(type === \"dashdb\") {\n    return [null,null,msg,null]; // new DashDB token\n}\nif(type === \"appid\" && mgmt) {\n    msg.iam.url = \"https://iam.cloud.ibm.com/oidc/token\";\n    msg.iam.headers.Authorization = \"Basic \" + Buffer.from(msg.iam.credentials.clientId + ':' + msg.iam.credentials.secret).toString('base64')\n    if(msg.iam.token && msg.iam.token.refresh_token) {\n        msg.iam.body = \"grant_type=refresh_token&refresh_token=\" + msg.iam.token.refresh_token + \"&response_type=cloud_iam\";\n        node.warn(\"Refresh Token for \" + msg.iam.type);\n    } else {\n        msg.iam.body = \"grant_type=client_credentials&scope=openid&response_type=cloud_iam\";\n        node.warn(\"New Token for \" + msg.iam.type);\n    }\n}\nreturn [null,msg,null,null]; // new token",
        "outputs": 4,
        "noerr": 0,
        "x": 350,
        "y": 260,
        "wires": [
          [
            "5440f228.63411c"
          ],
          [
            "718667fc.df6078"
          ],
          [
            "ee07c62.23f4238"
          ],
          [
            "14b4a1fc.79f63e"
          ]
        ],
        "outputLabels": [
          "valid",
          "new-refresh",
          "error",
          ""
        ]
      },
      {
        "id": "5440f228.63411c",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Return Authorization",
        "func": "var authorization = msg.iam.token.token_type + \" \" + msg.iam.token.access_token;\nif(msg[msg.iam.type]) {\n    msg[msg.iam.type].authorization = authorization;\n} else {\n    msg[msg.iam.type] = {\n        \"authorization\": authorization\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1410,
        "y": 200,
        "wires": [
          [
            "ad489be8.83b808"
          ]
        ]
      },
      {
        "id": "718667fc.df6078",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Setup",
        "func": "msg.url = msg.iam.url;\nmsg.headers = msg.iam.headers;\nmsg.payload = msg.iam.body;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 260,
        "wires": [
          [
            "ddaa190d.17c168"
          ]
        ],
        "outputLabels": [
          "error",
          "ok"
        ]
      },
      {
        "id": "ddaa190d.17c168",
        "type": "http request",
        "z": "ab306e30.d0cc3",
        "name": "POST",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 770,
        "y": 260,
        "wires": [
          [
            "34d99932.b68a26"
          ]
        ]
      },
      {
        "id": "34d99932.b68a26",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Auth Token",
        "func": "if (msg.statusCode === 200) {\n    msg.iam.token = msg.payload\n    msg.payload = {};\n    delete msg.headers;\n    delete msg.url;\n    delete msg.statusCode;\n    delete msg.responseUrl;\n    delete msg.responseCookies;\n    delete msg.topic;\n    return [msg,null];\n} else {\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 920,
        "y": 260,
        "wires": [
          [
            "666acb09.36f164"
          ],
          [
            "1f349275.1d59ce"
          ]
        ],
        "outputLabels": [
          "ok",
          "error"
        ]
      },
      {
        "id": "319e6624.b4ff4a",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "ab306e30.d0cc3",
        "name": "",
        "x": 1380,
        "y": 340,
        "wires": []
      },
      {
        "id": "1f349275.1d59ce",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Auth Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": msg.payload\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 280,
        "wires": [
          [
            "319e6624.b4ff4a"
          ]
        ]
      },
      {
        "id": "666acb09.36f164",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "Save Token",
        "func": "var tokens = global.get(\"TOKENS\");\nif(!tokens) { tokens = {} }\ntokens[msg.iam.type] = msg.iam.token;\nglobal.set(\"TOKENS\", tokens)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1170,
        "y": 240,
        "wires": [
          [
            "5440f228.63411c"
          ]
        ]
      },
      {
        "id": "14b4a1fc.79f63e",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "IAM Credentials Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"IAM credentials for \" + msg.iam.type + \" are not configured.\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 340,
        "wires": [
          [
            "319e6624.b4ff4a"
          ]
        ]
      },
      {
        "id": "72dc701a.d7ecf",
        "type": "subflow:ab306e30.d0cc3",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 1260,
        "y": 100,
        "wires": [
          [
            "1d301bf7.08d524"
          ]
        ]
      },
      {
        "id": "e8efde41.fb3c3",
        "type": "subflow:ab306e30.d0cc3",
        "z": "f4989ebd.9314",
        "name": "",
        "x": 540,
        "y": 180,
        "wires": [
          [
            "dcfa8b29.377188"
          ]
        ]
      },
      {
        "id": "f3d10722.d9c558",
        "type": "subflow:ab306e30.d0cc3",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 890,
        "y": 160,
        "wires": [
          [
            "ed90d453.615ab8"
          ]
        ]
      },
      {
        "id": "6b8c0164.25435",
        "type": "function",
        "z": "b6210d1b.09e3a",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug && (msg.api.info || msg.api.stats)) {\n    node.warn({\"Info & Stats\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 140,
        "wires": [
          []
        ]
      },
      {
        "id": "19ed28b8.769907",
        "type": "function",
        "z": "3cbceae5.45c156",
        "name": "AppID New Device Setup",
        "func": "if (msg.records && msg.records.device) {\n    if(!msg.iam) { msg.iam = {} }\n    msg.iam.type = \"appid\";\n    if(!msg.appid) { msg.appid = {} }\n    var config = global.set(\"VCAP_CONFIG\");\n    if(config && config.Birth_Email_Distribution) {\n        msg.records.device.email = config.Birth_Email_Distribution;\n    } else {\n        msg.records.device.email = global.get(\"BIRTH_EMAIL_DISTRIBUTION\");\n    }\n    return [null,msg]\n} else {\n    return [msg,null]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 210,
        "y": 120,
        "wires": [
          [],
          [
            "df645591.6cfba8"
          ]
        ],
        "outputLabels": [
          "error",
          "ok"
        ]
      },
      {
        "id": "da807d9a.f69fc",
        "type": "function",
        "z": "3cbceae5.45c156",
        "name": "AppID New Device Cleanup",
        "func": "msg.appid.device = msg.payload;\nmsg.records.idp_id = msg.payload.id;\n\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1280,
        "y": 120,
        "wires": [
          [
            "7cf8c37f.aef6dc"
          ]
        ]
      },
      {
        "id": "7cf8c37f.aef6dc",
        "type": "function",
        "z": "3cbceae5.45c156",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug) {\n    node.warn({\"AppId New Device\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1510,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "fb170db6.d6631",
        "type": "function",
        "z": "3cbceae5.45c156",
        "name": "AppID Device Template",
        "func": "var device = msg.records.device;\nmsg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.managementUrl;\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.appid.device = {\n  \"displayName\": device._id,\n  \"userName\": device._id,\n  \"password\": msg.records.password,\n  \"emails\": [\n    {\n      \"value\": device.email,\n      \"primary\": true\n    }\n  ],\n  \"name\": {\n    \"givenName\": device._id,\n    \"familyName\": device.system_type,\n    \"formatted\": device._id + \"(\" + device.system_type + \")\"\n  },\n  \"active\": true,\n  \"status\": \"CONFIRMED\",\n  \"entitlements\": [\n                {\n                    \"bl_cloud\": {\n                        \"c_id\": device._id,\n                        \"doc_type\": \"device\",\n                        \"system_type\": device.system_type\n                    }\n                }\n            ]\n}\nmsg.method = \"POST\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users\";\nmsg.payload = msg.appid.device;\nmsg.headers = msg.appid.headers;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 140,
        "wires": [
          [
            "8b70c25a.368f1"
          ]
        ]
      },
      {
        "id": "8b70c25a.368f1",
        "type": "http request",
        "z": "3cbceae5.45c156",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 900,
        "y": 140,
        "wires": [
          [
            "106d52c1.04dd1d"
          ]
        ]
      },
      {
        "id": "106d52c1.04dd1d",
        "type": "switch",
        "z": "3cbceae5.45c156",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "201",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1070,
        "y": 140,
        "wires": [
          [
            "da807d9a.f69fc"
          ],
          [
            "33aa6952.3bbe16"
          ]
        ]
      },
      {
        "id": "33aa6952.3bbe16",
        "type": "function",
        "z": "3cbceae5.45c156",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nif(msg.payload.schemas) {\n    msg.errors.push({\n        \"code\": 412,\n        \"message\": {\n            \"code\": msg.payload.status,\n            \"description\": msg.payload.detail,\n            \"service\": \"appid\"\n        }\n    });\n} else {\n    msg.payload.service = \"appid\";\n    msg.errors.push({\n        \"code\": msg.statusCode,\n        \"message\": msg.payload\n    });\n}\nif (msg.hasOwnProperty(\"req\")) {\n    return msg;\n} else {\n    node.warn({\"AppID New Device Error\": msg.errors[0]})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1230,
        "y": 180,
        "wires": [
          [
            "6ece93d8.19f22c"
          ]
        ]
      },
      {
        "id": "df645591.6cfba8",
        "type": "subflow:ab306e30.d0cc3",
        "z": "3cbceae5.45c156",
        "name": "",
        "x": 440,
        "y": 140,
        "wires": [
          [
            "fb170db6.d6631"
          ]
        ]
      },
      {
        "id": "6ece93d8.19f22c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "3cbceae5.45c156",
        "name": "",
        "x": 1400,
        "y": 180,
        "wires": []
      },
      {
        "id": "f10e4ede.450cb",
        "type": "switch",
        "z": "e0cd8199.1ad77",
        "name": "doc_type",
        "property": "records.doc_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "user",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 3,
        "x": 1240,
        "y": 140,
        "wires": [
          [
            "3cd3ca14.eae3d6"
          ],
          [
            "897afc99.9645d"
          ],
          [
            "7f36f4fa.4c3d1c"
          ]
        ]
      },
      {
        "id": "897afc99.9645d",
        "type": "subflow:3cbceae5.45c156",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 1450,
        "y": 120,
        "wires": [
          [
            "a5ba9d3d.b7007"
          ]
        ]
      },
      {
        "id": "a5ba9d3d.b7007",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "Device idp_id",
        "func": "if (msg.appid.hasOwnProperty(\"device\") && msg.appid.device.hasOwnProperty(\"id\")) {\n    msg.records[msg.records.object].idp_id = msg.records.idp_id;\n    msg.records[msg.records.object].password = msg.records.password;\n}\nnode.warn({\"New Rec Device APPID\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1640,
        "y": 120,
        "wires": [
          [
            "7f36f4fa.4c3d1c"
          ]
        ]
      },
      {
        "id": "c5bb6e36.b66",
        "type": "function",
        "z": "11fa1bee.eb6984",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug) {\n    node.warn({\"AppId Update Device\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2030,
        "y": 160,
        "wires": [
          []
        ]
      },
      {
        "id": "b47984e9.c2c9b8",
        "type": "subflow:ab306e30.d0cc3",
        "z": "11fa1bee.eb6984",
        "name": "",
        "x": 420,
        "y": 280,
        "wires": [
          [
            "d4c7f6fb.dbdcf8"
          ]
        ]
      },
      {
        "id": "f19f8fbb.0a107",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "11fa1bee.eb6984",
        "name": "",
        "x": 1940,
        "y": 340,
        "wires": []
      },
      {
        "id": "bb709a71.dcf858",
        "type": "function",
        "z": "11fa1bee.eb6984",
        "name": "AppID Find Device",
        "func": "if (!msg.appid.hasOwnProperty(\"id\")) {\n    if (msg.appid.hasOwnProperty(\"device\") && msg.appid.device.hasOwnProperty(\"id\")) {\n        //update an already available AppID record.\n        msg.appid.id = msg.appid.device.id;\n    } else if (msg.hasOwnProperty(\"device\") && msg.device.length === 1 && msg.device[0].hasOwnProperty(\"idp_id\")) {\n        msg.appid.id = msg.device[0].idp_id;\n    } else if (msg.hasOwnProperty(\"device\") && msg.device.length === 1 && msg.device[0].hasOwnProperty(\"_id\")) {\n        var appID = global.get(\"APPID\");\n        var device_idx = appID.devices.c_ids.indexOf(msg.device[0]._id);\n        if (device_idx >= 0) {\n            msg.appid.id = appid.devices.idp_id[device_idx];\n        }\n    } else if (msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"id\")){\n        var appID = global.get(\"APPID\");\n        var device_idx = appID.devices.c_ids.indexOf(msg.records.id);\n        if (device_idx >= 0) {\n            msg.appid.id = appid.devices.idp_id[device_idx];\n        }\n    }\n}\nif (msg.appid.hasOwnProperty(\"id\")) {\n    if(!msg.iam) { msg.iam = {} }\n    msg.iam.type = \"appid\";\n    return [null,msg];\n} else {\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 190,
        "y": 260,
        "wires": [
          [],
          [
            "b47984e9.c2c9b8"
          ]
        ],
        "outputLabels": [
          "skip",
          "ok"
        ]
      },
      {
        "id": "d4c7f6fb.dbdcf8",
        "type": "function",
        "z": "11fa1bee.eb6984",
        "name": "Get Device",
        "func": "msg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.managementUrl;\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.method = \"GET\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.headers = msg.appid.headers;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 610,
        "y": 280,
        "wires": [
          [
            "c7d28003.2d2d4"
          ]
        ]
      },
      {
        "id": "c7d28003.2d2d4",
        "type": "http request",
        "z": "11fa1bee.eb6984",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 800,
        "y": 280,
        "wires": [
          [
            "3f635259.acf6de"
          ]
        ]
      },
      {
        "id": "3f635259.acf6de",
        "type": "switch",
        "z": "11fa1bee.eb6984",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 950,
        "y": 280,
        "wires": [
          [
            "48515f9.64f2ca"
          ],
          [
            "764552a6.91ff7c"
          ]
        ]
      },
      {
        "id": "48515f9.64f2ca",
        "type": "function",
        "z": "11fa1bee.eb6984",
        "name": "AppID Update Device",
        "func": "msg.appid.device = msg.payload;\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nif (msg.appid.device.hasOwnProperty(\"entitlements\")) {\n    msg.appid.device.entitlements.forEach(function (ent,idx) {\n        if (ent.hasOwnProperty(\"bl_cloud\")) {\n            msg.appid.bl_cloud = msg.appid.device.entitlements.splice(idx,1)[0].bl_cloud\n            //node.warn({\"Found bl_cloud\": idx})\n        }\n    })\n}\nif (!msg.appid.hasOwnProperty(\"bl_cloud\")) {\n    msg.appid.bl_cloud = {\n        \"doc_type\": \"device\"\n    }\n}\nnode.warn({\"AppID Update Device\": msg})\nObject.keys(msg.appid.updates).forEach(function (key) {\n    if (key === \"c_id\") {\n        msg.appid.bl_cloud.c_id = msg.appid.updates[key];\n    }\n    if (key === \"system_type\") {\n        msg.appid.bl_cloud.system_type = msg.appid.updates[key];\n    }\n    if (key === \"email\") {\n        msg.appid.device.emails = [\n            {\n              \"value\": msg.appid.updates[key],\n              \"primary\": true\n            }\n        ];\n    }\n    if (key === \"status\" && [\"CONFIRMED\"].indexOf(msg.appid.updates[key].toUpperCase()) >= 0) {\n        msg.appid.device.status = msg.appid.updates[key]\n    }\n})\nif(!msg.appid.device.entitlements) { msg.appid.device.entitlements = []}\nmsg.appid.device.entitlements.push({\"bl_cloud\": msg.appid.bl_cloud});\nif(msg.records && msg.records.password) {\n    msg.appid.device.password = msg.records.password;\n}\nmsg.method = \"PUT\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.payload = msg.appid.device;\nmsg.headers = msg.appid.headers;\ndelete msg.payload.meta;\ndelete msg.payload.schemas;\ndelete msg.payload.mfaContext;\ndelete msg.payload.id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 260,
        "wires": [
          [
            "6bc2faa0.dd7ee4"
          ]
        ]
      },
      {
        "id": "6bc2faa0.dd7ee4",
        "type": "http request",
        "z": "11fa1bee.eb6984",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1380,
        "y": 260,
        "wires": [
          [
            "119d24fe.a45b0b"
          ]
        ]
      },
      {
        "id": "119d24fe.a45b0b",
        "type": "switch",
        "z": "11fa1bee.eb6984",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1550,
        "y": 260,
        "wires": [
          [
            "34dc469d.d26f8a"
          ],
          [
            "764552a6.91ff7c"
          ]
        ]
      },
      {
        "id": "34dc469d.d26f8a",
        "type": "function",
        "z": "11fa1bee.eb6984",
        "name": "AppID Update Device Cleanup",
        "func": "msg.appid.device = msg.payload;\n\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nmsg.payload = {};\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1790,
        "y": 240,
        "wires": [
          [
            "c5bb6e36.b66"
          ]
        ]
      },
      {
        "id": "764552a6.91ff7c",
        "type": "function",
        "z": "11fa1bee.eb6984",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nif(msg.payload.schemas) {\n    msg.errors.push({\n        \"code\": 412,\n        \"message\": {\n            \"code\": msg.payload.status,\n            \"description\": msg.payload.detail,\n            \"service\": \"appid\"\n        }\n    });\n} else {\n    msg.payload.service = \"appid\";\n    msg.errors.push({\n        \"code\": msg.statusCode,\n        \"message\": msg.payload\n    });\n}\nmsg.payload = {};\nif (msg.hasOwnProperty(\"req\")) {\n    return msg;\n} else {\n    node.warn({\"AppID Update Device Error\": msg.errors[0]})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1750,
        "y": 340,
        "wires": [
          [
            "f19f8fbb.0a107"
          ]
        ]
      },
      {
        "id": "6f3869a9.e36078",
        "type": "subflow:11fa1bee.eb6984",
        "z": "68197f61.7975",
        "name": "",
        "x": 1220,
        "y": 160,
        "wires": [
          [
            "f5704060.0564c"
          ]
        ]
      },
      {
        "id": "1604ec79.d75484",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    msg.v1 = true\n    if(msg.payload.userId) {\n        msg.payload.user_id = msg.payload.userId;\n        delete msg.payload.userId;\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 280,
        "wires": [
          [
            "a2a10c47.415ea"
          ]
        ]
      },
      {
        "id": "8eef34d3.fedb98",
        "type": "http in",
        "z": "fc9978cc.27301",
        "name": "",
        "url": "/users/user/:doctor_id/files/file/settings/:file_id",
        "method": "post",
        "upload": true,
        "swaggerDoc": "",
        "x": 210,
        "y": 240,
        "wires": [
          [
            "5425dc39.566a54"
          ]
        ]
      },
      {
        "id": "5425dc39.566a54",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "v1 Inputs",
        "func": "msg.v1 = true;\nmsg.payload.user_id = msg.req.params.doctor_id\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 240,
        "wires": [
          [
            "7b3d1734.bde8f8"
          ]
        ]
      },
      {
        "id": "ab2fdab9.55c3b8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 680,
        "wires": [
          [
            "1c01fc1f.ebd9a4"
          ]
        ]
      },
      {
        "id": "1371888f.402167",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "v1 Outputs",
        "func": "if(msg.v1) {\n    msg.records.delete = [\"_rev\",\"doc_type\"]\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 680,
        "wires": [
          [
            "c24a421d.d2ee2"
          ]
        ]
      },
      {
        "id": "6f85db50.5efd64",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "v1 Outputs",
        "func": "if(msg.v1){\n    delete msg.records.returns;\n    delete msg.api.info;\n    delete msg.api.starts;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 880,
        "wires": [
          [
            "4e07670a.ba2538"
          ]
        ]
      },
      {
        "id": "28717099.edb24",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    msg.v1 = true;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 880,
        "wires": [
          [
            "74272503.f6446c"
          ]
        ]
      },
      {
        "id": "57b9385d.9648d8",
        "type": "function",
        "z": "d35dd8d5.3b2a88",
        "name": "Decrypt Cloudant Objects",
        "func": "var types = [\"help_tickets\",\"help_ticket\",\"settings_files\",\"settings_file\"];\nvar objects = Object.keys(msg);\nvar process = types.filter(value => objects.includes(value))\nif(process && process.length >= 0) {\n    var cryptojs = global.get('cryptojs');\n    var key = global.get('CRYPTO_KEYS').cloudant.payload;\n    var field_list = [];\n    process.forEach(function(type) {\n        if([\"help_tickets\",\"help_ticket\"].indexOf(type) >= 0) { field_list = [\"contact_name\", \"contact_number\", \"surgeon_settings_name\"]; }\n        if([\"settings_files\",\"settings_file\"].indexOf(type) >= 0) { field_list = [\"file_name\"]; }\n        if(Array.isArray(msg[type])) {\n            msg[type].forEach(function(record,idx){\n                field_list.forEach(function(field){\n                    var efield = \"e_\" + field;\n                    if(record[efield]) {\n                        if(record[efield] !== \"\") {\n                            try {\n                                record[field] = JSON.parse(cryptojs.AES.decrypt(record[efield],key).toString(cryptojs.enc.Utf8));\n                            }\n                            catch(e){ node.warn({\"Decrypt ERROR\": e}) }\n                        } else {\n                            record[field] = \"\";\n                        }\n                        delete record[efield];\n                    }\n                });\n            });\n        } else {\n            field_list.forEach(function(field){\n                //node.warn(field)\n                var efield = \"e_\" + field;\n                if(msg[type][efield]) {\n                    if(msg[type][efield] !== \"\") {\n                        try {\n                            msg[type][field] = JSON.parse(cryptojs.AES.decrypt(msg[type][efield],key).toString(cryptojs.enc.Utf8));\n                        }\n                        catch(e){ node.warn( {\"Decrypt ERROR\": e}) }\n                    } else {\n                        msg[type][field] = \"\";\n                    }\n                    delete msg[type][efield];\n                }\n            });\n        }\n    });\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1930,
        "y": 180,
        "wires": [
          [
            "2a03c952.1c9bc6"
          ]
        ]
      },
      {
        "id": "490b4ef.93ca3b",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "v1 Errors",
        "func": "if(msg.v1){\n    msg.errors[0].message = msg.errors[0].message.replace(\" was not found\",\" does not exist\");\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1740,
        "y": 280,
        "wires": [
          [
            "625542f7.b8bb1c"
          ]
        ]
      },
      {
        "id": "2dbaa227.50f91e",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "v1 Outputs",
        "func": "if(msg.hasOwnProperty(\"v1\") && msg.v1){\n    delete msg.records.returns;\n    msg.records.delete = [\"_rev\", \"doc_type\"];\n    delete msg.api.info;\n    delete msg.api.starts;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 140,
        "wires": [
          [
            "c6fde4a7.09f7c8"
          ]
        ]
      },
      {
        "id": "57d0e6f5.67b918",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "v1 Update",
        "func": "if(msg.v1){\n    delete msg.errors;\n    msg.payload = msg.req.body;\n    msg.payload.user_id = msg.req.params.doctor_id;\n    return [null,msg];\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 1600,
        "y": 160,
        "wires": [
          [
            "a061b3d1.5281a"
          ],
          [
            "2bf2afcb.87bdf"
          ]
        ],
        "outputLabels": [
          "error",
          "v1"
        ]
      },
      {
        "id": "362649ac.68f486",
        "type": "comment",
        "z": "fc9978cc.27301",
        "name": "[v1][DEVICES] Settings File New & Update",
        "info": "",
        "x": 180,
        "y": 200,
        "wires": []
      },
      {
        "id": "4d823372.5cde6c",
        "type": "function",
        "z": "fc9978cc.27301",
        "name": "v1 Outputs",
        "func": "if(msg.hasOwnProperty(\"v1\") && msg.v1){\n    delete msg.records.returns;\n    msg.records.delete = [\"_rev\", \"doc_type\"];\n    delete msg.api.info;\n    delete msg.api.starts;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 320,
        "wires": [
          [
            "8df95eb8.f7ae3"
          ]
        ]
      },
      {
        "id": "99a47d77.27874",
        "type": "comment",
        "z": "92b74b12.836b78",
        "name": "Cloudant User Maintenance",
        "info": "",
        "x": 140,
        "y": 40,
        "wires": []
      },
      {
        "id": "865d7102.734ed",
        "type": "comment",
        "z": "92b74b12.836b78",
        "name": "Cloudant Device Maintenance",
        "info": "",
        "x": 140,
        "y": 660,
        "wires": []
      },
      {
        "id": "6ae58aaf.e170d4",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Get Lists Setup",
        "func": "delete msg.appid.records;\nmsg.appid.headers = {\n    \"Authorization\": msg.appid.authorization\n}\nmsg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.managementUrl;\nmsg.method = \"GET\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users\";\nmsg.headers = msg.appid.headers;\nreturn [msg];",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 140,
        "wires": [
          [
            "e034be20.f790e"
          ]
        ]
      },
      {
        "id": "e034be20.f790e",
        "type": "http request",
        "z": "16e7afc8.9866e",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 960,
        "y": 140,
        "wires": [
          [
            "1b6fd1bd.1d66fe"
          ]
        ]
      },
      {
        "id": "90649835.db6f38",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "debug",
        "func": "if(msg.hasOwnProperty(\"api\") && msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"APPID Get Users & Devices\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1990,
        "y": 120,
        "wires": [
          []
        ]
      },
      {
        "id": "5517404b.39a56",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Get Lists Cleanup",
        "func": "var raw_users = msg.appid.records;\nvar users = [];\nvar user_c_ids = [];\nvar user_idp_ids = [];\nvar user_emails = [];\nvar user_phones = [];\nvar devices = [];\nvar device_c_ids = [];\nvar device_idp_ids = [];\nraw_users.forEach(function(user){\n    if (user.hasOwnProperty(\"entitlements\")) {\n        var index = user.entitlements.findIndex(function(obj, idx){ if(obj.hasOwnProperty(\"bl_cloud\")) { return true }})\n        if (index >= 0 && user.entitlements[index].hasOwnProperty(\"bl_cloud\") && user.entitlements[index].bl_cloud.hasOwnProperty(\"doc_type\")) {\n            var ent = user.entitlements[index].bl_cloud;\n            var mobile = null;\n            var voice = null;\n            if (user.hasOwnProperty(\"phoneNumbers\")) {\n                var mobile_list = user.phoneNumbers.filter(function(phone) {\n                    if (phone.type === \"mobile\") {\n                        return true\n                    }\n                })\n                if(mobile_list.length > 0) { mobile = mobile_list[0].value }\n                var voice_list = user.phoneNumbers.filter(function(phone) {\n                    if (phone.type === \"voice\") {\n                        return true\n                    }\n                })\n                if(voice_list.length > 0) { voice = voice_list[0].value }\n            }\n            if (ent.doc_type === \"user\") {\n                bl_user = {\n                   \"idp_id\": user.id,\n                   \"c_id\": ent.c_id,\n                   \"last_name\": user.name.familyName,\n                   \"first_name\": user.name.givenName,\n                   \"email\": user.emails[0].value,\n                   \"role\": ent.role\n                   //\"sub_roles\": ent.sub_roles\n               };\n               if(mobile || mobile === \"\")(bl_user.mobile_phone = mobile);\n               if(voice)(bl_user.voice_phone = voice);\n               users.push(bl_user);\n            } else if (ent.doc_type === \"device\") {\n                bl_device = {\n                   \"idp_id\": user.id,\n                   \"c_id\": ent.c_id,\n                   \"system_type\": ent.system_type,\n                   \"email\": user.emails[0].value\n               };\n               devices.push(bl_device);\n            }\n        }\n    } else {\n        if (user.userName.search(\"@\") >= 0) {\n           bl_user = {\n               \"idp_id\": user.id,\n               \"c_id\": null,\n               \"last_name\": user.name.familyName,\n               \"first_name\": user.name.givenName,\n               \"email\": user.userName\n           };\n           users.push(bl_user);\n        } else {\n            bl_device = {\n               \"idp_id\": user.id,\n               \"c_id\": user.userName\n           };\n           devices.push(bl_device);\n        }\n    }\n});\nvar sorted_users = users.sort(sortUsers);\nvar sorted_devices = devices.sort(sortDevices);\nglobal.set(\"APPID\", {\n    \"users\": {\n        \"c_ids\": sorted_users.map(a => a.c_id), //user_c_ids,\n        \"idp_ids\": sorted_users.map(a => a.idp_id), //user_idp_ids,\n        \"emails\": sorted_users.map(a => a.email), //user_emails,\n        \"phones\": sorted_users.map(a => a.mobile_phone), //user_phones,\n        \"records\": sorted_users //users\n    },\n    \"devices\": {\n        \"c_ids\": sorted_devices.map(a => a.c_id), //device_c_ids,\n        \"idp_ids\": sorted_devices.map(a => a.idp_id), //device_idp_ids,\n        \"records\": sorted_devices //devices\n    }\n})\ndelete msg.appid.records;\ndelete msg.url;\ndelete msg.method;\ndelete msg.responseUrl;\ndelete msg.statusCode;\nmsg.payload = {};\nreturn msg;\n\nfunction sortUsers(a,b) {\n    if(a.last_name<b.last_name && a.first_name<b.first_name) { return -1 } else { return 1 }\n}\nfunction sortDevices(a,b) {\n    if(a.c_id<b.c_id) { return -1 } else { return 1 }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1530,
        "y": 140,
        "wires": [
          [
            "8aa34922.d66d78"
          ]
        ]
      },
      {
        "id": "1b6fd1bd.1d66fe",
        "type": "switch",
        "z": "16e7afc8.9866e",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1130,
        "y": 140,
        "wires": [
          [
            "ac57e76.bfb4b18"
          ],
          [
            "2b4f8acb.432876"
          ]
        ]
      },
      {
        "id": "2b4f8acb.432876",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": msg.payload\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1290,
        "y": 180,
        "wires": [
          [
            "b8b0e4a9.4b31c8"
          ]
        ]
      },
      {
        "id": "ac57e76.bfb4b18",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "More Results",
        "func": "if (msg.payload.hasOwnProperty(\"totalResults\") && msg.payload.hasOwnProperty(\"itemsPerPage\")) {\n    msg.appid.totalResults = msg.payload.totalResults;\n    msg.appid.itemsPerPage = msg.payload.itemsPerPage;\n    if (!msg.appid.hasOwnProperty(\"records\")) {\n        msg.appid.records = msg.payload.Resources;\n        //node.warn({\"Creating records\": msg.appid.records});\n    } else {\n        msg.appid.records = msg.appid.records.concat(msg.payload.Resources);\n        //node.warn({\"Appending records\": msg.appid.records});\n    }\n    msg.appid.totalRecords = msg.appid.records.length;\n    if (msg.appid.totalResults > msg.appid.totalRecords) {\n        msg.method = \"GET\";\n        msg.url = msg.appid.mgmt_url + \"/cloud_directory/Users?startIndex=\" + msg.appid.totalRecords;\n        msg.headers = msg.appid.headers;\n        return [null,msg];\n    } else {\n        return [msg,null];\n    }\n} else {\n    msg.appid.records = msg.payload.Resources;\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1290,
        "y": 60,
        "wires": [
          [
            "5517404b.39a56"
          ],
          [
            "e034be20.f790e"
          ]
        ],
        "outputLabels": [
          "exit",
          "loop"
        ]
      },
      {
        "id": "7992d4b0.b6cebc",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Get Cloudant Users",
        "func": "msg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\"$and\": [{\"doc_type\":\"user\"},{\"status\":\"active\"}]},\n    \"sort\": [{\"last_name:string\":\"asc\"},{\"first_name:string\":\"asc\"}]\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 570,
        "y": 220,
        "wires": [
          [
            "65db318c.fa416"
          ]
        ]
      },
      {
        "id": "62011823.4b1588",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Get Cloudant Users Cleanup",
        "func": "global.set(\"CLOUDANT.users\",  {\n    \"c_ids\": msg.users.map(a => a._id),\n    \"idp_ids\": msg.users.map(a => a.idp_id),\n    \"emails\": msg.users.map(a => a.email),\n    \"phones\": msg.users.map(a => a.mobile_phone),\n    \"records\": msg.users\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1500,
        "y": 220,
        "wires": [
          [
            "8aa34922.d66d78"
          ]
        ]
      },
      {
        "id": "8aa34922.d66d78",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Combine Databases",
        "func": "if (msg.hasOwnProperty(\"appid\")) {\n    flow.set(\"appid\", true);\n}\nif (msg.hasOwnProperty(\"users\")) {\n    flow.set(\"users\", true);\n}\nif (msg.hasOwnProperty(\"devices\")) {\n    flow.set(\"devices\", true);\n}\nif (flow.get(\"appid\") && flow.get(\"users\") && flow.get(\"devices\")) {\n    msg.end_time = Date.now();\n    node.warn({\"Update List Time\": msg.end_time- msg.start_time })\n    return msg;   \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1780,
        "y": 180,
        "wires": [
          [
            "90649835.db6f38"
          ]
        ]
      },
      {
        "id": "3441d3ba.93abbc",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Start Time",
        "func": "if(!msg.api){msg.api = {}}\nmsg.start_time = Date.now();\nflow.set(\"appid\",false);\nflow.set(\"users\",false);\nflow.set(\"devices\",false);\nif(!msg.iam) {msg.iam = {}}\nmsg.iam.type = \"appid\";\nmsg.iam.mgmt = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 180,
        "wires": [
          [
            "7992d4b0.b6cebc",
            "d98d78cf.05ecd8",
            "57faa6c2.bbd878"
          ]
        ]
      },
      {
        "id": "d98d78cf.05ecd8",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Get Cloudant Devices",
        "func": "msg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\"$and\": [{\"doc_type\":\"device\"},{\"status\":\"active\"}]},\n    \"sort\": [{\"_id:string\":\"asc\"}]\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 260,
        "wires": [
          [
            "883862e7.43d98"
          ]
        ]
      },
      {
        "id": "a1d59098.90c4e",
        "type": "function",
        "z": "16e7afc8.9866e",
        "name": "Get Cloudant Devices Cleanup",
        "func": "global.set(\"CLOUDANT.devices\", {\n    \"c_ids\": msg.devices.map(a => a._id),\n    \"idp_ids\": msg.devices.map(a => a.idp_id),\n    \"records\": msg.devices\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1490,
        "y": 260,
        "wires": [
          [
            "8aa34922.d66d78"
          ]
        ]
      },
      {
        "id": "65db318c.fa416",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "16e7afc8.9866e",
        "name": "",
        "x": 910,
        "y": 220,
        "wires": [
          [
            "62011823.4b1588"
          ]
        ]
      },
      {
        "id": "883862e7.43d98",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "16e7afc8.9866e",
        "name": "",
        "x": 910,
        "y": 260,
        "wires": [
          [
            "a1d59098.90c4e"
          ]
        ]
      },
      {
        "id": "b8b0e4a9.4b31c8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "16e7afc8.9866e",
        "name": "",
        "x": 1480,
        "y": 180,
        "wires": []
      },
      {
        "id": "57faa6c2.bbd878",
        "type": "subflow:ab306e30.d0cc3",
        "z": "16e7afc8.9866e",
        "name": "",
        "x": 560,
        "y": 140,
        "wires": [
          [
            "6ae58aaf.e170d4"
          ]
        ]
      },
      {
        "id": "f7214467.2dd8f8",
        "type": "subflow:16e7afc8.9866e",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 690,
        "y": 260,
        "wires": [
          []
        ]
      },
      {
        "id": "d2c0b09b.0605",
        "type": "inject",
        "z": "57a5a054.9dfd3",
        "name": "",
        "topic": "Update Periodically",
        "payload": "",
        "payloadType": "date",
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 510,
        "y": 260,
        "wires": [
          [
            "f7214467.2dd8f8"
          ]
        ]
      },
      {
        "id": "582c62cd.3bc4ac",
        "type": "switch",
        "z": "e0cd8199.1ad77",
        "name": "doc_type",
        "property": "records.doc_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "user",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device",
            "vt": "str"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 2800,
        "y": 240,
        "wires": [
          [
            "2cddf891.d4a998"
          ],
          [
            "25a03c33.80a984"
          ]
        ]
      },
      {
        "id": "25a03c33.80a984",
        "type": "subflow:16e7afc8.9866e",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 3330,
        "y": 260,
        "wires": [
          []
        ]
      },
      {
        "id": "5ded422f.342e1c",
        "type": "switch",
        "z": "68197f61.7975",
        "name": "doc_type",
        "property": "records.doc_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "user",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device",
            "vt": "str"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 2380,
        "y": 280,
        "wires": [
          [
            "c9c3c28.d7b2f4"
          ],
          [
            "c9c3c28.d7b2f4"
          ]
        ]
      },
      {
        "id": "c9c3c28.d7b2f4",
        "type": "subflow:16e7afc8.9866e",
        "z": "68197f61.7975",
        "name": "",
        "x": 2540,
        "y": 280,
        "wires": [
          []
        ]
      },
      {
        "id": "3b106f0f.72393",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/config_file",
        "method": "post",
        "upload": true,
        "swaggerDoc": "",
        "x": 180,
        "y": 2540,
        "wires": [
          [
            "5761c4cd.302f7c"
          ]
        ]
      },
      {
        "id": "a327bf7.05c104",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Configuration File New",
        "info": "",
        "x": 140,
        "y": 2500,
        "wires": []
      },
      {
        "id": "5761c4cd.302f7c",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 450,
        "y": 2540,
        "wires": [
          [
            "b09379db.d13d38"
          ]
        ]
      },
      {
        "id": "b09379db.d13d38",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Config File Send",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Config File Send\"\n    });\nmsg.records = {\n    \"format\": \"JSON\",\n    \"returns\": [\"message\"]\n};\nmsg.inputs = {\n    \"required\": [\"file_name\", \"user_id\"],\n    \"allowed\": [],\n    \"attach_num\": 1,\n    \"user_id\": msg.payload.user_id,\n    \"device_id\": msg.req.params.deviceID\n};\nmsg.email = {\n    //\"template_type\": \"config_file\", //Disabled because we can send either an email or an attachment currently\n    \"fields\":{\n        \"device_id\": msg.inputs.device_id\n    },\n    \"files\": []\n};\nif (msg.req.files && msg.req.files.length > 0) {\n    msg.email.files.push(msg.req.files[0])\n} else if (msg.payload.file && msg.payload.file !== \"\") {\n    msg.email.files.push({\n        \"fieldname\": \"file\",\n        \"originalname\": msg.payload.file_name,\n        \"encoding\":\"7bit\",\n        \"mimetype\": \"text/csv\",\n        \"buffer\": Buffer.from(msg.payload.file, 'ascii')\n    });\n}\nif (msg.inputs.user_id && msg.inputs.user_id !== \"\") {\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"doc_type\",\n        \"selector\": {\n            \"$or\": [\n                {\"$and\": [{\"doc_type\": \"device\"}, {\"_id\": msg.inputs.device_id}]},\n                {\"$and\": [{\"doc_type\": \"user\"}, {\"_id\": msg.inputs.user_id}]},\n                ]\n        }\n    };\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 2540,
        "wires": [
          [
            "2e8cb193.ce71ee"
          ]
        ]
      },
      {
        "id": "2e8cb193.ce71ee",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 820,
        "y": 2540,
        "wires": [
          [
            "4da1536.864adac"
          ]
        ]
      },
      {
        "id": "4da1536.864adac",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 990,
        "y": 2540,
        "wires": [
          [
            "c6fcf1ee.03f4d"
          ]
        ]
      },
      {
        "id": "88a63d46.58735",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1640,
        "y": 2560,
        "wires": []
      },
      {
        "id": "b8bfac69.cec45",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 2540,
        "wires": [
          [
            "88a63d46.58735"
          ]
        ]
      },
      {
        "id": "c6fcf1ee.03f4d",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "User & Device Found?",
        "func": "if (msg.user && msg.user.length > 0 && msg.user[0].doc_type && msg.user[0].doc_type === \"user\") {\n    var user = msg.user[0];\n    msg.message = \"Configuration File for \" + msg.inputs.device_id + \" has been emailed to \" + user.email\n    if(msg.device && msg.device.length > 0 && msg.device[0].doc_type && msg.device[0].doc_type === \"device\") {\n        var device = msg.device[0];\n        msg.email.to = user.email;\n        msg.email.topic = device._id + \" - Configuration File\";\n        msg.email.return = true;\n        msg.email.fields = Object.assign(msg.email.fields, {\n            \"first_name\": user.fist_name,\n            \"last_name\": user.last_name,\n            \"device_id\": device._id,\n            \"system_type\": device.system_type,\n        });\n        return [msg,null,null];\n    } else { return [null,null,msg] }\n} else { return [null,msg,null] }",
        "outputs": 3,
        "noerr": 0,
        "x": 1200,
        "y": 2540,
        "wires": [
          [
            "2283c1b2.9cf50e"
          ],
          [
            "b8bfac69.cec45"
          ],
          [
            "98f4dd17.dcb3d"
          ]
        ],
        "outputLabels": [
          "found",
          "not user found",
          "no device found"
        ]
      },
      {
        "id": "98f4dd17.dcb3d",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active device with id: \" + msg.inputs.device_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1430,
        "y": 2580,
        "wires": [
          [
            "88a63d46.58735"
          ]
        ]
      },
      {
        "id": "d733c2c8.29fd2",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1550,
        "y": 2500,
        "wires": []
      },
      {
        "id": "2283c1b2.9cf50e",
        "type": "subflow:5dbd57cc.fc9bb8",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1400,
        "y": 2500,
        "wires": [
          [
            "d733c2c8.29fd2"
          ]
        ]
      },
      {
        "id": "25c6e7df.230978",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Config File",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Config_File_00.html",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 480,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "b19df8b3.0b1828",
        "type": "function",
        "z": "2a17b7c7.4eaf08",
        "name": "DashDB Setup",
        "func": "if(msg.dashdb) {\n    if(!msg.iam) {\n        msg.iam = {\n            \"type\": \"dashdb\"\n        }\n    }\n    return [null,msg];\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 200,
        "y": 100,
        "wires": [
          [
            "7d6be2d6.b16bbc"
          ],
          [
            "3c0558a.1a4f1a8"
          ]
        ],
        "outputLabels": [
          "skip",
          "execute"
        ]
      },
      {
        "id": "3c0558a.1a4f1a8",
        "type": "subflow:ab306e30.d0cc3",
        "z": "2a17b7c7.4eaf08",
        "name": "",
        "x": 400,
        "y": 220,
        "wires": [
          [
            "d7abc96e.231908"
          ]
        ]
      },
      {
        "id": "9dc5a99.4e71c58",
        "type": "http request",
        "z": "2a17b7c7.4eaf08",
        "name": "DashDB http",
        "method": "use",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 770,
        "y": 220,
        "wires": [
          [
            "d285fa93.2552e8"
          ]
        ]
      },
      {
        "id": "d285fa93.2552e8",
        "type": "switch",
        "z": "2a17b7c7.4eaf08",
        "name": "200, 201",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "201",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 920,
        "y": 220,
        "wires": [
          [
            "3ccc46f8.57cdfa"
          ],
          [
            "3ccc46f8.57cdfa"
          ],
          [
            "492fc35d.43bd1c"
          ]
        ]
      },
      {
        "id": "3ccc46f8.57cdfa",
        "type": "function",
        "z": "2a17b7c7.4eaf08",
        "name": "DashDB Process Returns",
        "func": "msg.dashdb.results = JSON.parse(msg.payload);\nif(msg.dashdb.return_obj) {\n    if(msg.dashdb.results[msg.dashdb.return_obj]){\n        msg.dashdb[msg.dashdb.object] = msg.dashdb.results[msg.dashdb.return_obj];\n    } else {\n        node.warn(\"DashDB return_obj: \" + msg.dashdb.return_obj + \" was not found.\")\n    }\n}\nmsg.payload = {};\ndelete msg.headers;\ndelete msg.url;\ndelete msg.statusCode;\ndelete msg.responseUrl;\ndelete msg.responseCookies;\ndelete msg.topic;\ndelete msg.method;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 160,
        "wires": [
          [
            "7d6be2d6.b16bbc"
          ]
        ]
      },
      {
        "id": "d7abc96e.231908",
        "type": "function",
        "z": "2a17b7c7.4eaf08",
        "name": "DashDB Request",
        "func": "if(!msg.dashdb.server) {\n    msg.dashdb.credentials = global.get(\"VCAP_DASHDB\").credentials;\n    msg.dashdb.server = msg.dashdb.credentials.https_url;\n}\nmsg.dashdb.url = msg.dashdb.server + msg.dashdb.request;\nmsg.url = msg.dashdb.url;\nmsg.method = msg.dashdb.method;\nif(msg.method !== \"GET\" && msg.dashdb.body) { msg.payload = msg.dashdb.body; }\nif(!msg.headers){ msg.headers = {} }\nmsg.headers.Authorization = msg.dashdb.authorization;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 220,
        "wires": [
          [
            "9dc5a99.4e71c58"
          ]
        ]
      },
      {
        "id": "7d6be2d6.b16bbc",
        "type": "function",
        "z": "2a17b7c7.4eaf08",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"DashDB Http\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1470,
        "y": 60,
        "wires": [
          []
        ]
      },
      {
        "id": "3aeec3e9.68197c",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "2a17b7c7.4eaf08",
        "name": "",
        "x": 1420,
        "y": 240,
        "wires": []
      },
      {
        "id": "492fc35d.43bd1c",
        "type": "function",
        "z": "2a17b7c7.4eaf08",
        "name": "DashDBError",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": {\n        \"code\": msg.statusCode,\n        \"descritpion\": msg.payload,\n        \"service\": \"dashdb\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 240,
        "wires": [
          [
            "3aeec3e9.68197c"
          ]
        ]
      },
      {
        "id": "ee07c62.23f4238",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "DashDB Token Setup",
        "func": "msg.iam.url = msg.iam.credentials.https_url + \"/dbapi/v3/auth/tokens\";\nmsg.iam.headers = {};\nmsg.iam.body = {\n\t\"userid\": msg.iam.credentials.username,\n\t\"password\": msg.iam.credentials.password\n}\nmsg.headers = msg.iam.headers;\nmsg.url = msg.iam.url;\nmsg.payload = msg.iam.body;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 300,
        "wires": [
          [
            "66078a5b.0e1a14"
          ]
        ],
        "outputLabels": [
          "error"
        ]
      },
      {
        "id": "66078a5b.0e1a14",
        "type": "http request",
        "z": "ab306e30.d0cc3",
        "name": "POST",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 770,
        "y": 300,
        "wires": [
          [
            "81c91dd2.dbf5e"
          ]
        ]
      },
      {
        "id": "81c91dd2.dbf5e",
        "type": "function",
        "z": "ab306e30.d0cc3",
        "name": "DashDB Auth Token",
        "func": "if (msg.statusCode === 200) {\n    msg.iam.token = {\n        \"access_token\": msg.payload.token,\n        \"token_type\":\"Bearer\",\n        \"expires_in\":3600,\n        \"expiration\": Math.round(3600 + Date.now()/1000)\n    }\n    msg.payload = {};\n    delete msg.headers;\n    delete msg.url;\n    delete msg.statusCode;\n    delete msg.responseUrl;\n    delete msg.responseCookies;\n    delete msg.topic;\n    return [msg,null];\n} else {\n    return [null,msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 940,
        "y": 300,
        "wires": [
          [
            "666acb09.36f164"
          ],
          [
            "1f349275.1d59ce"
          ]
        ],
        "outputLabels": [
          "ok",
          "error"
        ]
      },
      {
        "id": "d6bea762.f55398",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "DashDB SQL Setup",
        "func": "msg.dashdb.request = \"/dbapi/v3/sql_jobs\";\nmsg.dashdb.method = \"POST\";\ndelete msg.dashdb.return_obj\nmsg.dashdb.body = {\n    \"commands\": msg.dashdb.commands,\n    \"limit\": msg.dashdb.limit,\n    \"separator\": \";\",\n\t\"stop_on_error\": false\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 460,
        "y": 120,
        "wires": [
          [
            "3ec16871.b58648"
          ]
        ]
      },
      {
        "id": "3ec16871.b58648",
        "type": "subflow:2a17b7c7.4eaf08",
        "z": "5b840ccd.bdbfc4",
        "name": "",
        "x": 670,
        "y": 120,
        "wires": [
          [
            "2f8e1b99.2fa454"
          ]
        ]
      },
      {
        "id": "85f0bdf0.833a2",
        "type": "subflow:2a17b7c7.4eaf08",
        "z": "5b840ccd.bdbfc4",
        "name": "",
        "x": 1290,
        "y": 120,
        "wires": [
          [
            "e3600962.e33318"
          ]
        ]
      },
      {
        "id": "796e77a.4747988",
        "type": "link in",
        "z": "5b840ccd.bdbfc4",
        "name": "SLQ Loop out",
        "links": [
          "4548938f.17c7cc"
        ],
        "x": 915,
        "y": 180,
        "wires": [
          [
            "35652eff.a95602"
          ]
        ]
      },
      {
        "id": "4548938f.17c7cc",
        "type": "link out",
        "z": "5b840ccd.bdbfc4",
        "name": "SQL Loop in",
        "links": [
          "796e77a.4747988"
        ],
        "x": 1695,
        "y": 180,
        "wires": []
      },
      {
        "id": "35652eff.a95602",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "DashDB SQL Setup",
        "func": "msg.dashdb.request = \"/dbapi/v3/sql_jobs/\" + msg.dashdb.job_id;\nmsg.dashdb.method = \"GET\";\ndelete msg.dashdb.results;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1100,
        "y": 120,
        "wires": [
          [
            "85f0bdf0.833a2"
          ]
        ]
      },
      {
        "id": "2f8e1b99.2fa454",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "DashDB Get job_id",
        "func": "msg.dashdb.job_id = msg.dashdb.results.id;\ndelete msg.dashdb.rows \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 870,
        "y": 120,
        "wires": [
          [
            "35652eff.a95602"
          ]
        ]
      },
      {
        "id": "e3600962.e33318",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "DashDB Get all Records",
        "func": "// only supports one SQL statement at the time for now.\nif(msg.dashdb.results && msg.dashdb.results.results && msg.dashdb.results.results.length > 0) {\n    var sql_req = msg.dashdb.results.results[0];\n    sql_req.records = [];\n    if(sql_req.rows) {\n        sql_req.rows.forEach(function(row) {\n            var record = {};\n            sql_req.columns.forEach(function(col,idx) {\n                var type = sql_req.columns_type[idx];\n                switch(type) {\n                    case \"number\":\n                        record[col] = parseInt(row[idx]);\n                        break;\n                    case \"time\":\n                        record[col] = Date.parse(row[idx] + \"GMT\");\n                        break;\n                    default:\n                        record[col] = row[idx].trim();\n                }\n            });\n            sql_req.records.push(record);\n        });\n        msg.dashdb.sql_req = sql_req;\n    } else {\n        msg.dashdb.error = {\n            \"message\": sql_req.error,\n            \"code\": 400\n        }\n        return [null,null,msg];\n    }\n}\nif(!msg.dashdb.records) {\n    if(!msg.dashdb.sql_req) {msg.dashdb.sql_req = {}}\n    msg.dashdb.records = msg.dashdb.sql_req.records;\n} else {\n    msg.dashdb.records = msg.dashdb.records.concat(msg.dashdb.sql_req.records);\n}\nif(msg.dashdb.results.status === \"completed\") {\n    return [msg,null,null];\n} else {\n    return [null,msg,null];\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 1490,
        "y": 120,
        "wires": [
          [
            "b3baa402.ee4498"
          ],
          [
            "4548938f.17c7cc"
          ],
          [
            "cfa6a12b.afef7"
          ]
        ],
        "outputLabels": [
          "done",
          "loop",
          "error"
        ]
      },
      {
        "id": "21a8fbbb.847ea4",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"DashDB SQL\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1970,
        "y": 60,
        "wires": [
          []
        ]
      },
      {
        "id": "b3baa402.ee4498",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "DashDB Object",
        "func": "if(msg.dashdb.object) {\n    msg[msg.dashdb.object] = msg.dashdb.records;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1760,
        "y": 100,
        "wires": [
          [
            "21a8fbbb.847ea4"
          ]
        ]
      },
      {
        "id": "bafd19b1.437e68",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "5b840ccd.bdbfc4",
        "name": "",
        "x": 1960,
        "y": 240,
        "wires": []
      },
      {
        "id": "cfa6a12b.afef7",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "DashDBError",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.dashdb.error.code,\n    \"message\": {\n        \"code\": msg.dashdb.error.code,\n        \"description\": msg.dashdb.error.message,\n        \"service\": \"dashdb\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1760,
        "y": 240,
        "wires": [
          [
            "bafd19b1.437e68"
          ]
        ]
      },
      {
        "id": "48c27508.d3388c",
        "type": "http in",
        "z": "61ffb71b.d286f",
        "name": "",
        "url": "/devices/device/:deviceID/change_password",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 2640,
        "wires": [
          [
            "d9d0d059.14d15"
          ]
        ]
      },
      {
        "id": "ed153f45.7aff",
        "type": "comment",
        "z": "61ffb71b.d286f",
        "name": "[CN] Device Change Password",
        "info": "",
        "x": 150,
        "y": 2600,
        "wires": []
      },
      {
        "id": "d9d0d059.14d15",
        "type": "subflow:3962857e.44abba",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 530,
        "y": 2640,
        "wires": [
          [
            "273cfd40.497202"
          ]
        ]
      },
      {
        "id": "273cfd40.497202",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Device Change Password",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Device Change Password\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"device\",\n    \"object\": \"device\",\n    \"format\": \"JSON\",\n    \"returns\": [\"device\"],\n    \"id\": msg.req.params.deviceID\n};\nmsg.inputs = {\n    \"allowed\": [\"password\"],\n    \"required\": [],\n    \"device_id\": msg.req.params.deviceID\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 2640,
        "wires": [
          [
            "3bab4bb6.9fa674"
          ]
        ]
      },
      {
        "id": "3bab4bb6.9fa674",
        "type": "subflow:71afa3f9.81defc",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 940,
        "y": 2640,
        "wires": [
          [
            "756f1ced.204254"
          ]
        ]
      },
      {
        "id": "80dedd39.11ed",
        "type": "subflow:68197f61.7975",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1330,
        "y": 2640,
        "wires": [
          [
            "9a9cd844.3789c8"
          ]
        ]
      },
      {
        "id": "9a9cd844.3789c8",
        "type": "subflow:313bd1d3.01c06e",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1530,
        "y": 2640,
        "wires": [
          [
            "6f074921.907c28"
          ]
        ]
      },
      {
        "id": "6dd17aef.b913a4",
        "type": "subflow:bc6ff87.05a2908",
        "z": "61ffb71b.d286f",
        "name": "",
        "x": 1950,
        "y": 2640,
        "wires": []
      },
      {
        "id": "756f1ced.204254",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Generate Password",
        "func": "if(!msg.inputs.password) {\n    var genPwd = global.get(\"genpwd\");\n    msg.records.password = genPwd.generate(global.get(\"PWD_GEN\"))\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 2640,
        "wires": [
          [
            "80dedd39.11ed"
          ]
        ]
      },
      {
        "id": "6f074921.907c28",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "add clientId & authToken",
        "func": "msg.device[0].mqtt_clientId = msg.device[0]._id;\nmsg.device[0].mqtt_authToken = msg.records.password;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1750,
        "y": 2640,
        "wires": [
          [
            "6dd17aef.b913a4"
          ]
        ]
      },
      {
        "id": "dc53ae32.cc78b",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 940,
        "wires": [
          [
            "95e1bc30.a8423"
          ]
        ]
      },
      {
        "id": "24b7e3ce.e41b4c",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Status",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Status\"\n    });\nmsg.records = {\n    \"object\": \"sim\",\n    \"format\": \"JSON\",\n    \"returns\": [\"sim\"]\n};\nmsg.inputs = {\n    \"allowed\": [],\n    \"required\": [\"sim_iccid\"]\n};\nmsg.sim_provider = {\n    \"req_type\": \"status\",\n    \"body\": msg.payload\n};\nif (msg.payload.sim_iccid) { msg.sim_provider.sim_iccid = msg.payload.sim_iccid }\nif(msg.payload.details && msg.payload.details) { msg.sim_provider.details = true }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 940,
        "wires": [
          [
            "6d0d2e62.f103f"
          ]
        ]
      },
      {
        "id": "22b7a3b5.846cbc",
        "type": "subflow:71afa3f9.81defc",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 1440,
        "y": 740,
        "wires": [
          [
            "a0a5577b.8dd158"
          ]
        ]
      },
      {
        "id": "761ba67.0445c58",
        "type": "subflow:bc6ff87.05a2908",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 1810,
        "y": 740,
        "wires": []
      },
      {
        "id": "6d0d2e62.f103f",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Outputs",
        "func": "if(msg.v1){\n    delete msg.records.returns;\n    delete msg.api.info;\n    delete msg.api.stats;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 940,
        "wires": [
          [
            "22b7a3b5.846cbc"
          ]
        ]
      },
      {
        "id": "5425652f.98238c",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Sim Setup",
        "func": "if(msg.sim_provider && msg.sim_provider.req_type) {\n    if(!msg.sim_provider.object) { msg.sim_provider.object = msg.records.object }\n    if(msg.sim_provider.req_type === \"plan_codes\") {\n        return [null,msg,null];\n    }\n    var found = false\n    var prefixs = global.get(\"VCAP_KORE\").credentials.iccid_prefixs\n    prefixs.forEach(function(prefix){\n        r_prefix = RegExp(\"^\" + prefix,\"g\")\n        if(r_prefix && r_prefix.test(msg.sim_provider.sim_iccid)) {\n            msg.sim_provider.provider = \"kore\";\n            found = true;\n        }\n    })\n    if(found) { return [null,msg,null]; } \n    var prefixs = global.get(\"VCAP_WEBBING\").credentials.iccid_prefixs\n    prefixs.forEach(function(prefix){\n        r_prefix = RegExp(\"^\" + prefix,\"g\")\n        if(r_prefix && r_prefix.test(msg.sim_provider.sim_iccid)) {\n            msg.sim_provider.provider = \"webbing\";\n            found = true;\n        }\n    })\n    if(found) {\n        return [null,msg,null];\n    } else {\n        return [null,null,msg];\n    }\n} else {\n    return [msg,null,null];\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 210,
        "y": 160,
        "wires": [
          [],
          [
            "9bd3da67.c0f8d8"
          ],
          [
            "7112174f.7e5398"
          ]
        ],
        "outputLabels": [
          "skip",
          "exec",
          "error"
        ]
      },
      {
        "id": "b8d8f269.e59ea",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Sim Cleanup",
        "func": "if(msg.sim_provider.hasOwnProperty(\"object\") && msg.sim_provider.hasOwnProperty(\"delete\")){\n    msg[msg.sim_provider.object].forEach(function(record) {\n        msg.sim_provider.delete.forEach(function(propertyName){\n            if(record.hasOwnProperty(propertyName)){\n                delete record[propertyName];\n            }\n        });\n    });\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2410,
        "y": 440,
        "wires": [
          [
            "c8864c49.7a1bc"
          ]
        ]
      },
      {
        "id": "c8864c49.7a1bc",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Sim Http\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2610,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "7530c7a9.0d0418",
        "type": "subflow:da740a9b.08ed88",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 1730,
        "y": 340,
        "wires": [
          [
            "b32e3a8f.3bed18"
          ]
        ]
      },
      {
        "id": "bd01393.d4388c8",
        "type": "switch",
        "z": "80a169dd.f18e78",
        "name": "Req Type",
        "property": "sim_provider.req_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "status",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "activate_to_state",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "reactivate",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "deactivate",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "update_plan_code",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "update_info",
            "vt": "str"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 6,
        "x": 900,
        "y": 420,
        "wires": [
          [
            "b8ce5be3.4265f8"
          ],
          [
            "c2fbf759.d3b4b8"
          ],
          [
            "89d6a683.9ddcb8"
          ],
          [
            "8f0826f5.8266b8"
          ],
          [
            "24c2f1e5.67744e"
          ],
          [
            "639c3142.77b7d"
          ]
        ]
      },
      {
        "id": "b8ce5be3.4265f8",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Sim Status",
        "func": "msg.kore = {\n    \"request\": \"queryDevice\",\n    \"return_obj\": \"d\",\n    \"object\": msg.sim_provider.object,\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid\n    }\n};\ndelete msg.kore_response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 340,
        "wires": [
          [
            "7530c7a9.0d0418"
          ]
        ]
      },
      {
        "id": "a440b346.1488c",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Plan Codes",
        "func": "msg.records.delete = [\"__type\"]\nmsg.kore = {\n    \"request\": \"queryPlanCodesForNextPeriod\",\n    \"return_obj\": \"items\",\n    \"object\": \"plan_codes\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 640,
        "wires": [
          [
            "1923b463.2eb3bc"
          ]
        ]
      },
      {
        "id": "e7a31a69.00cee8",
        "type": "link out",
        "z": "80a169dd.f18e78",
        "name": "KORE Status In",
        "links": [
          "c58e35ff.b158f8"
        ],
        "x": 1955,
        "y": 440,
        "wires": []
      },
      {
        "id": "c58e35ff.b158f8",
        "type": "link in",
        "z": "80a169dd.f18e78",
        "name": "KORE Status Out",
        "links": [
          "e7a31a69.00cee8"
        ],
        "x": 995,
        "y": 300,
        "wires": [
          [
            "b8ce5be3.4265f8"
          ]
        ]
      },
      {
        "id": "c2fbf759.d3b4b8",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Activate To State",
        "func": "msg.message = \"SIM Card \" + msg.sim_provider.sim_iccid + \" was successfully activated to \" + msg.sim_provider.body.status + \".\"\nmsg.kore = {\n    \"request\": \"activateToState\",\n    \"return_obj\": \"d\",\n    \"object\": \"kore_response\",\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid,\n        \"EAPCode\": msg.sim_provider.body.EAPCode || \"EAP039182036\",\n        \"toState\": msg.sim_provider.body.status\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 380,
        "wires": [
          [
            "5d8e2025.d091d"
          ]
        ]
      },
      {
        "id": "5d8e2025.d091d",
        "type": "subflow:da740a9b.08ed88",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 1830,
        "y": 440,
        "wires": [
          [
            "e7a31a69.00cee8"
          ]
        ]
      },
      {
        "id": "b09af5f4.8a19e8",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Setup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 420,
        "wires": [
          [
            "bd01393.d4388c8"
          ]
        ]
      },
      {
        "id": "89d6a683.9ddcb8",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Reactivate",
        "func": "msg.message = \"SIM Card \" + msg.sim_provider.sim_iccid + \" was successfully reactivated.\"\nmsg.kore = {\n    \"request\": \"reactivateDevice\",\n    \"return_obj\": \"d\",\n    \"object\": \"kore_response\",\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 420,
        "wires": [
          [
            "5d8e2025.d091d"
          ]
        ]
      },
      {
        "id": "639c3142.77b7d",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Update Custom Info",
        "func": "msg.message = \"Sim Card \" + msg.sim_provider.sim_iccid + \" custom information was successfully updated.\"\nmsg.kore = {\n    \"request\": \"queryDevice\",\n    \"return_obj\": \"d\",\n    \"object\": \"sim_kore\",\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid\n    }\n};\nmsg.sim_provider.allowed = [\"customField1\", \"customField2\", \"customField3\", \"customField4\", \"customField5\", \"customField6\"];\nmsg.sim_provider.details = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 540,
        "wires": [
          [
            "adf136ef.284758"
          ]
        ]
      },
      {
        "id": "8f0826f5.8266b8",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Deactivate",
        "func": "msg.message = \"SIM Card \" + msg.sim_provider.sim_iccid + \" was successfully deactivated.\"\nmsg.kore = {\n    \"request\": \"deactivateDevice\",\n    \"return_obj\": \"d\",\n    \"object\": \"kore_response\",\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid,\n        \"flagScrap\":\"false\"\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 460,
        "wires": [
          [
            "5d8e2025.d091d"
          ]
        ]
      },
      {
        "id": "af11c673.2b2728",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Update Custom Info",
        "func": "msg.kore = {\n    \"request\": \"modifyDeviceCustomInfo\",\n    \"return_obj\": \"d\",\n    \"object\": \"kore_response\",\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid\n    }\n};\nmsg.sim_provider.allowed.forEach(function(field){\n   if(msg.sim_kore[0].hasOwnProperty(field)){\n       msg.kore.body[field] = msg.sim_kore[0][field]\n   }\n});\nmsg.sim_provider.allowed.forEach(function(field){\n   if(msg.sim_provider.body.hasOwnProperty(field)){\n       msg.kore.body[field] = msg.sim_provider.body[field]\n   }\n});\ndelete msg.sim_kore;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1600,
        "y": 540,
        "wires": [
          [
            "5d8e2025.d091d"
          ]
        ]
      },
      {
        "id": "adf136ef.284758",
        "type": "subflow:da740a9b.08ed88",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 1390,
        "y": 540,
        "wires": [
          [
            "af11c673.2b2728"
          ]
        ]
      },
      {
        "id": "24c2f1e5.67744e",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Update Plan Code",
        "func": "msg.message = \"SIM Card \" +  msg.sim_provider.sim_iccid + \" was successfully updated to use plan code \" + msg.sim_provider.body.plan_code + \".\"\nmsg.kore = {\n    \"request\": \"modifyDevicePlanForNextPeriod\",\n    \"return_obj\": \"d\",\n    \"object\": \"kore_response\",\n    \"body\": {\n        \"deviceNumber\": msg.sim_provider.sim_iccid,\n        \"planCode\": msg.sim_provider.body.plan_code\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 500,
        "wires": [
          [
            "5d8e2025.d091d"
          ]
        ]
      },
      {
        "id": "9a71a509.52c068",
        "type": "switch",
        "z": "80a169dd.f18e78",
        "name": "Provider",
        "property": "sim_provider.provider",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "kore",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "webbing",
            "vt": "str"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 540,
        "y": 720,
        "wires": [
          [
            "b09af5f4.8a19e8"
          ],
          [
            "cf5c0d83.1b583"
          ]
        ]
      },
      {
        "id": "d941b76a.e36ed8",
        "type": "switch",
        "z": "80a169dd.f18e78",
        "name": "Req Type",
        "property": "sim_provider.req_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "status",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "activate_to_state",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "reactivate",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "deactivate",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "update_plan_code",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "update_info",
            "vt": "str"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 6,
        "x": 900,
        "y": 840,
        "wires": [
          [
            "51a47300.b44cac"
          ],
          [
            "4f92ddb3.e61014"
          ],
          [
            "7b3afde7.1218a4"
          ],
          [
            "c76cb1b2.b1fc1"
          ],
          [
            "494e0fcb.14775"
          ],
          [
            "5765c7fa.44a5b8"
          ]
        ]
      },
      {
        "id": "cf5c0d83.1b583",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Setup",
        "func": "//node.warn({\"Webbing Branch\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 840,
        "wires": [
          [
            "d941b76a.e36ed8"
          ]
        ]
      },
      {
        "id": "95e1bc30.a8423",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    if(msg.payload.hasOwnProperty(\"deviceNumber\")){\n        msg.payload.sim_iccid = msg.payload.deviceNumber;\n        msg.req.body.sim_iccid = msg.req.body.deviceNumber;\n        delete msg.payload.deviceNumber;\n        delete msg.req.body.deviceNumber;\n    }\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 940,
        "wires": [
          [
            "24b7e3ce.e41b4c"
          ]
        ]
      },
      {
        "id": "9bd3da67.c0f8d8",
        "type": "switch",
        "z": "80a169dd.f18e78",
        "name": "Req Type",
        "property": "sim_provider.req_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "plan_codes",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 380,
        "y": 660,
        "wires": [
          [
            "a440b346.1488c"
          ],
          [
            "9a71a509.52c068"
          ]
        ]
      },
      {
        "id": "1923b463.2eb3bc",
        "type": "subflow:da740a9b.08ed88",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 810,
        "y": 640,
        "wires": [
          [
            "9ab718a2.5c8d98"
          ]
        ]
      },
      {
        "id": "521ce329.1a21dc",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Device Birth",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Device_Birth_00.html",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 520,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "11c00066.cca8b",
        "type": "change",
        "z": "5dbd57cc.fc9bb8",
        "name": "Device Change",
        "rules": [
          {
            "t": "set",
            "p": "email.template_file",
            "pt": "msg",
            "to": "B+L_Eyetelligence_Device_Change_00.html",
            "tot": "str"
          }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 560,
        "wires": [
          [
            "2988c5c0.8b57aa"
          ]
        ]
      },
      {
        "id": "aed2ad76.87b3e",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "APP ID Setup",
        "func": "msg.url = msg.appid.server + \"/token\";\n//msg.payload = msg.inputs.body;\nif (msg.payload.hasOwnProperty(\"email\")) { msg.payload.email = msg.payload.email.toLowerCase() }\nmsg.headers = {\n    \"authorization\": msg.req.headers.authorization\n}\nmsg.method = \"POST\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 760,
        "wires": [
          [
            "bde75af7.2d5698"
          ]
        ]
      },
      {
        "id": "8c5f15d.8f4dce8",
        "type": "function",
        "z": "5b840ccd.bdbfc4",
        "name": "SQL SELECT Statement",
        "func": "if(msg.dashdb && msg.dashdb.select){\n    if(msg.hasOwnProperty(\"filters\") && msg.filters.hasOwnProperty(\"options\")){\n        if(msg.hasOwnProperty(\"dashdb\")) {\n            var andFilters = [];\n            var addFilter = \"\";\n            if(msg.filters.hasOwnProperty(\"values\")) {\n                Object.keys(msg.filters.values).forEach(function(propertyName){\n                    addFilter = propertyName + \" = \\'\" + msg.filters.values[propertyName] + \"\\'\";\n                    andFilters.push(addFilter);\n                });\n            }\n            if(msg.filters.hasOwnProperty(\"arrays\")) {\n                Object.keys(msg.filters.arrays).forEach(function(propertyName){\n                    addFilter = propertyName + \" IN (\\'\" + msg.filters.arrays[propertyName].join(\"\\',\\'\") +\"\\')\";\n                    andFilters.push(addFilter);\n                });\n            }\n            if(msg.filters.hasOwnProperty(\"dates\")) {\n                var date_columns = [];\n                var date_filters = [];\n                Object.keys(msg.filters.dates).forEach(function(rangePropertyName){\n                    var dateValue = new Date(parseInt(msg.filters.dates[rangePropertyName]));\n                    var dateString = dateValue.getFullYear() + \"-\" + ('0' + (dateValue.getMonth()+1)).slice(-2) + \"-\" + ('0' + dateValue.getDate()).slice(-2) + \" \" + ('0' + dateValue.getHours()).slice(-2) + \":\" + ('0' + dateValue.getMinutes()).slice(-2) + \":\" + ('0' + dateValue.getSeconds()).slice(-2) + \".\" + dateValue.getMilliseconds();\n                    var propertyName = rangePropertyName.substring(0,rangePropertyName.indexOf(\"_range\",0));\n                    if(rangePropertyName.includes(\"_range_begin\")){\n                         addFilter = \"(\" + propertyName + \" >= \\'\" + dateString + \"\\')\";\n                    } else{\n                        addFilter = \"(\" + propertyName + \" <= \\'\" + dateString + \"\\')\";\n                    }\n                    andFilters.push(addFilter);\n                });\n            }\n            if(msg.filters.hasOwnProperty(\"partial\")) {\n            Object.keys(msg.filters.partial).forEach(function(partialPropertyName){\n                    var partialValue = msg.filters.partial[partialPropertyName];\n                    var propertyName = partialPropertyName.substring(0,partialPropertyName.indexOf(\"_partial\",0));\n                    addFilter = propertyName + \" LIKE \" + partialValue + \"%\";\n                    andFilters.push(addFilter);\n                });\n            }\n            if(andFilters.length >0) {\n                msg.dashdb.where = \"WHERE \" + andFilters.join(\" AND \");\n            } else {\n                msg.dashdb.where = \"\";\n            }\n        }\n    }\n    msg.dashdb.commands = msg.dashdb.select;\n    if(msg.dashdb.where) { msg.dashdb.commands = msg.dashdb.commands + \" \" + msg.dashdb.where; }\n    if(msg.dashdb.sort) { msg.dashdb.commands = msg.dashdb.commands + \" \" + msg.dashdb.sort; }\n}\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 210,
        "y": 120,
        "wires": [
          [
            "d6bea762.f55398"
          ]
        ]
      },
      {
        "id": "af682a75.b6daf8",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Check Payload Encryption",
        "func": "if (msg.payload) {\n    if (msg.payload.ciphertext) {\n        if (IsJsonString(msg.payload.ciphertext)) {\n            node.warn({\"Expected Enc - Body - Not Encrypted\": msg})\n            msg.payload = {};\n            return [null,null,msg]\n        } else {\n            node.warn({\"Expected Enc - Body - Encrypted\": msg})\n            msg.encryption = {\n                \"ciphertext\": msg.payload\n            }\n            msg.payload = {};\n            return [null,msg,null]\n        }\n    } else {\n        if (Object.keys(msg.payload).length > 0) {\n            node.warn({\"Expected Enc - Body - Not Encrypted\": msg})\n            msg.payload = {};\n            return [null,null,msg]\n        }\n    }\n}\nreturn [msg,null,null]\n\nfunction IsJsonString(str) {\ntry {\n    return (str.indexOf('{') >= 0);\n  } catch (e) {\n    return false;\n  }\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 420,
        "y": 120,
        "wires": [
          [
            "ca46ff2a.7ec5e"
          ],
          [
            "eba1fe6d.2e37b"
          ],
          [
            "7dde1afa.d404f4"
          ]
        ],
        "outputLabels": [
          "skip",
          "encrypted",
          "not encrypted"
        ]
      },
      {
        "id": "eba1fe6d.2e37b",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Decrypt",
        "func": "if (msg.encryption && msg.encryptionciphertext) {\n    var cryptojs = global.get('cryptojs');\n    var encryption_available = global.get(\"CRYPTO_KEYS\");\n    if(encryption_available && encryption_available.com) {\n        if (!msg.encryption.key) {msg.encryption.key = global.get(\"CRYPTO_KEYS\").com.payload}\n        try {\n            msg.encryption.decrypted = JSON.parse(cryptojs.AES.decrypt(msg.encryption.ciphertext, msg.encryption.key).toString(cryptojs.enc.Utf8));\n            msg.payload = msg.encryption.decrypted\n            return [msg,null,null];\n        }\n        catch(error) {\n            return [null,msg,null]\n        }\n    } else {\n        node.warn(\"WARNING [Com Decryption]: On this setup Communication Decryption is NOT available\")\n        return [null,null,msg]\n    }\n}\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 700,
        "y": 140,
        "wires": [
          [
            "ca46ff2a.7ec5e"
          ],
          [
            "eb57155f.526f18"
          ],
          [
            "dc9c6289.c9cd5"
          ]
        ],
        "outputLabels": [
          "decrypted",
          "failed",
          "not available"
        ]
      },
      {
        "id": "eb57155f.526f18",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Decryption Failed",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 403,\n    \"message\": \"Decryption - Failed: cypertext could not be decrypted\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 930,
        "y": 200,
        "wires": [
          [
            "f50f5ea3.bbe9d"
          ]
        ]
      },
      {
        "id": "7dde1afa.d404f4",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Body Not Encrypted",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 403,\n    \"message\": \"Decryption - Failed: Body not encrypted\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 280,
        "wires": [
          [
            "f50f5ea3.bbe9d"
          ]
        ]
      },
      {
        "id": "d9096a9f.275358",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Decryption\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "f50f5ea3.bbe9d",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "f7b5cbff.598508",
        "name": "",
        "x": 1180,
        "y": 240,
        "wires": []
      },
      {
        "id": "e1900411.9c5ae8",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Check Encryption",
        "func": "msg.api.encrypt = false;\nif (msg.api.apic && [\"v4\",\"ve\"].indexOf(msg.api.apic.version) >= 0) { \n    if(!msg.force_encryption) {\n        if (msg.api.apic.catalog) { \n            var unencrypted_cat = [\"dapp\", \"erplx\", \"eula\"];\n            var encrypted = true;\n            unencrypted_cat.forEach(function(cat){\n                if(RegExp(\"^\"+ cat,\"g\").test(msg.api.apic.catalog)) {\n                    encrypted = false;\n                }\n            })\n            msg.api.encrypt = encrypted\n        }\n    } else {\n        msg.api.encrypt = true;\n    }\n}\nvar SPACE = global.get(\"SPACE\");\nif ([\"Development\", \"US Test\"].indexOf(SPACE) >= 0 && msg.api.hasOwnProperty(\"override_encrypt\")) {\n    msg.api.encrypt = msg.api.override_encrypt;\n}\nif(msg.api.encrypt) {\n    return [null,msg];\n} else {\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 170,
        "y": 80,
        "wires": [
          [
            "ca46ff2a.7ec5e"
          ],
          [
            "af682a75.b6daf8"
          ]
        ],
        "outputLabels": [
          "no encryption",
          "encryption"
        ]
      },
      {
        "id": "81dc9242.80e54",
        "type": "subflow:f7b5cbff.598508",
        "z": "3962857e.44abba",
        "name": "",
        "x": 1220,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "ca46ff2a.7ec5e",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Decrypt Cleanup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1090,
        "y": 80,
        "wires": [
          [
            "d9096a9f.275358"
          ]
        ]
      },
      {
        "id": "3953d8fd.d97d18",
        "type": "function",
        "z": "12505187.8b5d0e",
        "name": "AppID New User Setup",
        "func": "if (msg.records && msg.records.user) {\n    if(!msg.iam) { msg.iam = {} }\n    msg.iam.type = \"appid\";\n    if(!msg.appid) { msg.appid = {} }\n    return [null,msg]\n} else {\n    return [msg,null]\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 210,
        "y": 120,
        "wires": [
          [
            "d749acc8.9acb2"
          ],
          [
            "287ed895.91abd8"
          ]
        ],
        "outputLabels": [
          "ok",
          "error"
        ]
      },
      {
        "id": "79db8e2c.ed8df",
        "type": "function",
        "z": "12505187.8b5d0e",
        "name": "AppID New User Cleanup",
        "func": "//node.warn({\"AppID New User Returns\": msg})\nmsg.appid.user = msg.payload;\nmsg.records.idp_id = msg.payload.id;\n\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1250,
        "y": 120,
        "wires": [
          [
            "d749acc8.9acb2"
          ]
        ]
      },
      {
        "id": "a49a9003.00d0f",
        "type": "function",
        "z": "12505187.8b5d0e",
        "name": "AppID User Template",
        "func": "var user = msg.records.user;\nmsg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.managementUrl;\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.appid.user = {\n  \"displayName\": user.first_name + \", \" + user.last_name,\n  \"userName\": user.email,\n  \"password\": user.password,\n  \"emails\": [\n    {\n      \"value\": user.email,\n      \"primary\": true\n    }\n  ],\n  \"phoneNumbers\": [],\n  \"name\": {\n      \"givenName\": user.first_name,\n      \"familyName\": user.last_name,\n      \"formatted\": user.first_name + \", \" + user.last_name\n  },\n  \"active\": true,\n  \"status\": \"CONFIRMED\",\n  \"entitlements\": [\n                {\n                    \"bl_cloud\": {\n                        \"c_id\": user._id,\n                        \"doc_type\": \"user\",\n                        \"role\": user.role\n                        //\"sub_roles\": user.sub_roles\n                    }\n                }\n            ]\n}\nif (user.hasOwnProperty(\"mobile_phone\") || user.hasOwnProperty(\"voice_phone\")) {\n    if (user.hasOwnProperty(\"mobile_phone\") && user.mobile_phone !== \"\") {\n        msg.appid.user.phoneNumbers.push(\n            {\n                \"value\": user.mobile_phone,\n                \"type\": \"mobile\"\n            }\n        )\n    }\n    if (user.hasOwnProperty(\"voice_phone\") && user.voice_phone !== \"\") {\n        msg.appid.user.phoneNumbers.push(\n            {\n                \"value\": user.voice_phone,\n                \"type\": \"voice\"\n            }\n        )\n    }\n} else {\n    delete msg.appid.user.phoneNumbers;\n}\nmsg.method = \"POST\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users\";\nmsg.payload = msg.appid.user;\nmsg.headers = msg.appid.headers;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 140,
        "wires": [
          [
            "2b1568a8.0d6678"
          ]
        ]
      },
      {
        "id": "2b1568a8.0d6678",
        "type": "http request",
        "z": "12505187.8b5d0e",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 880,
        "y": 140,
        "wires": [
          [
            "f8bd9cd0.1bbb3"
          ]
        ]
      },
      {
        "id": "f8bd9cd0.1bbb3",
        "type": "switch",
        "z": "12505187.8b5d0e",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "201",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1050,
        "y": 140,
        "wires": [
          [
            "79db8e2c.ed8df"
          ],
          [
            "80548f87.17108"
          ]
        ]
      },
      {
        "id": "80548f87.17108",
        "type": "function",
        "z": "12505187.8b5d0e",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nif(msg.payload.schemas) {\n    msg.errors.push({\n        \"code\": 412,\n        \"message\": {\n            \"code\": msg.payload.status,\n            \"description\": msg.payload.detail,\n            \"service\": \"appid\"\n        }\n    });\n} else {\n    msg.payload.service = \"appid\";\n    msg.errors.push({\n        \"code\": msg.statusCode,\n        \"message\": msg.payload\n    });\n}\nmsg.payload = {};\nif (msg.hasOwnProperty(\"req\")) {\n    return msg;\n} else {\n    node.warn({\"AppID New User Error\": msg.errors[0]})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 180,
        "wires": [
          [
            "1b678f08.1410e1"
          ]
        ]
      },
      {
        "id": "d749acc8.9acb2",
        "type": "function",
        "z": "12505187.8b5d0e",
        "name": "debug",
        "func": "if(msg.hasOwnProperty(\"api\") && msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"AppID New User\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1510,
        "y": 60,
        "wires": [
          []
        ]
      },
      {
        "id": "287ed895.91abd8",
        "type": "subflow:ab306e30.d0cc3",
        "z": "12505187.8b5d0e",
        "name": "",
        "x": 440,
        "y": 140,
        "wires": [
          [
            "a49a9003.00d0f"
          ]
        ]
      },
      {
        "id": "1b678f08.1410e1",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "12505187.8b5d0e",
        "name": "",
        "x": 1400,
        "y": 180,
        "wires": []
      },
      {
        "id": "e59ad422.3f49f8",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Webbing Http\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1850,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "9d1d2a7b.4eaba8",
        "type": "http request",
        "z": "98ce8d35.4c824",
        "name": "Webbing http",
        "method": "POST",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 350,
        "y": 140,
        "wires": [
          [
            "b4dd2fd0.51266"
          ]
        ]
      },
      {
        "id": "d5efcd6a.a13f8",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "Webbing URL",
        "func": "if(msg.webbing && !msg.webbing.server){\n    var webbing = global.get(\"VCAP_WEBBING\");\n    if(webbing) {\n        msg.webbing.server = webbing.credentials.url;\n        msg.webbing.credentials = webbing.credentials;\n    }\n}\nif(!msg.webbing.fields) { msg.webbing.fields = {} }\nmsg.webbing.fields = Object.assign(msg.webbing.fields, {\n    \"username\": msg.webbing.credentials.username,\n    \"password\": msg.webbing.credentials.password,\n    \"key\": msg.webbing.credentials.key\n})\nmsg.webbing.body = msg.webbing.template;\nObject.keys(msg.webbing.fields).forEach(function(field) {\n    var tag = \"{{{\" + field + \"}}}\";\n    msg.webbing.body = msg.webbing.body.replace(RegExp(tag, 'g'), msg.webbing.fields[field])\n});\nmsg.payload = msg.webbing.body;\nmsg.headers = {\n    \"content-type\": \"text/xml\"\n    };\nmsg.url = msg.webbing.server + msg.webbing.request\n//node.warn({\"Webbing Send\": msg});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 160,
        "y": 140,
        "wires": [
          [
            "9d1d2a7b.4eaba8"
          ]
        ]
      },
      {
        "id": "b7fcf5d6.9a9428",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "Webbing Error",
        "func": "node.warn({\"Webbing Error\": msg})\nif(!msg.errors){msg.errors = []}\nvar message = msg.payload;\nmessage.code = msg.statusCode;\nmessage.source = \"webbing\";\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": message\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 180,
        "wires": [
          [
            "66c66e0a.4408b"
          ]
        ]
      },
      {
        "id": "66c66e0a.4408b",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "98ce8d35.4c824",
        "name": "",
        "x": 1800,
        "y": 180,
        "wires": []
      },
      {
        "id": "ffd58de0.27778",
        "type": "switch",
        "z": "98ce8d35.4c824",
        "name": "200",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 970,
        "y": 140,
        "wires": [
          [
            "7bf7f662.04e238"
          ],
          [
            "f0ae01ee.f87be"
          ]
        ]
      },
      {
        "id": "b4dd2fd0.51266",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "XML Options",
        "func": "//node.warn({\"Webbing RAW Returns\": msg})\nmsg.options = {\n    \"explicitArray\": false,\n    \"ignoreAttrs\": true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 140,
        "wires": [
          [
            "a3b42444.7b1dd8"
          ]
        ]
      },
      {
        "id": "a3b42444.7b1dd8",
        "type": "xml",
        "z": "98ce8d35.4c824",
        "name": "",
        "property": "payload",
        "attr": "",
        "chr": "",
        "x": 670,
        "y": 140,
        "wires": [
          [
            "d7b1951f.eb54e8"
          ]
        ]
      },
      {
        "id": "d7b1951f.eb54e8",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "SOAP Body",
        "func": "//node.warn({\"After XML with Options\": msg})\ndelete msg.options\nmsg.payload = msg.payload[\"soap:Envelope\"][\"soap:Body\"]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 140,
        "wires": [
          [
            "ffd58de0.27778"
          ]
        ]
      },
      {
        "id": "f0ae01ee.f87be",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "SOAP Fault",
        "func": "delete msg.options\nmsg.payload = msg.payload[\"soap:Fault\"]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 180,
        "wires": [
          [
            "b7fcf5d6.9a9428"
          ]
        ]
      },
      {
        "id": "85604e49.e1df5",
        "type": "subflow:98ce8d35.4c824",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 1660,
        "y": 740,
        "wires": [
          [
            "75accef1.0f037"
          ]
        ]
      },
      {
        "id": "51a47300.b44cac",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Sim Status",
        "func": "msg.webbing = {\n    \"base_return\": \"GetServiceDevicesResponse.GetServiceDevicesResult\",\n    \"return_obj\": \"ServiceDevices.ServiceDeviceRecord\",\n    \"object\": \"sim_webbing\",\n    \"request\": \"/devices/GetServiceDevices\",\n    \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><GetServiceDevices xmlns=\"http://wws.iamwebbing.com/\"><GetServiceDevicesRequest><DeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></DeviceIdentifier><PaginationRequest><PageSize>100</PageSize><PageNumber>1</PageNumber></PaginationRequest></GetServiceDevicesRequest></GetServiceDevices></soap12:Body></soap12:Envelope>',\n    \"fields\": {\n        \"sim_iccid\": msg.sim_provider.sim_iccid\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 760,
        "wires": [
          [
            "85604e49.e1df5"
          ]
        ]
      },
      {
        "id": "6225a63d.3ee3c8",
        "type": "link out",
        "z": "80a169dd.f18e78",
        "name": "KORE Status In",
        "links": [
          "6b20c87f.a7de98"
        ],
        "x": 2255,
        "y": 920,
        "wires": []
      },
      {
        "id": "6b20c87f.a7de98",
        "type": "link in",
        "z": "80a169dd.f18e78",
        "name": "Webbing Status Out",
        "links": [
          "6225a63d.3ee3c8"
        ],
        "x": 995,
        "y": 720,
        "wires": [
          [
            "51a47300.b44cac"
          ]
        ]
      },
      {
        "id": "8356c62a.cd3e58",
        "type": "subflow:98ce8d35.4c824",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 2120,
        "y": 860,
        "wires": [
          [
            "6225a63d.3ee3c8"
          ]
        ]
      },
      {
        "id": "75accef1.0f037",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Map to KORE Sim",
        "func": "var webbing = msg.sim_webbing;\nvar sim = {\n    MSISDNOrMDN: null,\n    IMSIOrMIN: null,\n    status: webbing.StatusName,\n    currentDataPlan: webbing.ProductName,\n    currentSMSPlan: null,\n    futureDataPlan: null,\n    futureSMSPlan: null,\n    dailyDataThreshold: null,\n    dailySMSThreshold: null,\n    monthlyDataThreshold: null,\n    monthlySMSThreshold: null,\n    customField1: \"\", \n    customField2: \"\",\n    customField3: \"\",\n    customField4: \"\",\n    customField5: \"\",\n    customField6: \"\",\n    lstHistoryOverLastYear:null, \n    lstFeatures: null,\n    costCenter: null\n};\nif(webbing.StatusName === \"Suspended\") {\n    sim.status = \"Deactivated\"\n}\nif(webbing.StatusName === \"Active\" && webbing.ProductID !== \"7136\") {\n    sim.status = \"Active\"\n}\nif(webbing.StatusName === \"Active\" && webbing.ProductID === \"7136\") {\n    sim.status = \"Test\"\n}\nif(webbing.StatusName === \"Inactive\") {\n    sim.status = \"Stock\"\n}\nmsg[msg.sim_provider.object] = [sim];\nif(msg.sim_provider.details) {\n    msg.sim_provider.delete = []\n} else {\n    msg.sim_provider.delete = [\"MSISDNOrMDN\", \"IMSIOrMIN\", \"currentDataPlan\", \"currentSMSPlan\", \"futureDataPlan\", \"futureSMSPlan\", \"dailyDataThreshold\", \"dailySMSThreshold\", \"monthlyDataThreshold\", \"monthlySMSThreshold\", \"customField1\", \"customField2\", \"customField3\", \"customField4\", \"customField5\", \"customField6\", \"lstHistoryOverLastYear\", \"lstFeatures\", \"costCenter\"];\n}\ndelete msg.sim_webbing;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1870,
        "y": 740,
        "wires": [
          [
            "b8d8f269.e59ea"
          ]
        ]
      },
      {
        "id": "ac2f644e.9dd8f8",
        "type": "function",
        "z": "86df012b.3eb7e",
        "name": "Check Encryption",
        "func": "if(msg.api.encrypt) {\n    var encryption_available = global.get(\"CRYPTO_KEYS\")\n    if(encryption_available && encryption_available.com) {\n        return [null,msg];\n    } else {\n        node.warn(\"WARNING [Com Encryption]: On this setup Communication Encrytpion is NOT available\")\n        return [msg,null];\n    }\n} else {\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 190,
        "y": 160,
        "wires": [
          [
            "64c933b6.4c341c"
          ],
          [
            "c1ff557a.425668"
          ]
        ],
        "outputLabels": [
          "no encryption",
          "encryption"
        ]
      },
      {
        "id": "b381842f.bf47d8",
        "type": "function",
        "z": "86df012b.3eb7e",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Encryption\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 120,
        "wires": [
          []
        ]
      },
      {
        "id": "64c933b6.4c341c",
        "type": "function",
        "z": "86df012b.3eb7e",
        "name": "Encryption Cleanup",
        "func": "return msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 160,
        "wires": [
          [
            "b381842f.bf47d8"
          ]
        ]
      },
      {
        "id": "c1ff557a.425668",
        "type": "function",
        "z": "86df012b.3eb7e",
        "name": "Encrypt Returns",
        "func": "if (!msg.encryption) { msg.encryption = {} }\nif (!msg.encryption.key) { msg.encryption.key = global.get(\"CRYPTO_KEYS\").com.payload }\nmsg.encryption.to_encrypt = {}\nvar clear_list = [\"info\", \"error\", \"stats\", \"error_fields\", \"reason\"]\nObject.keys(msg.payload).forEach(function(key) {\n    if (clear_list.indexOf(key) < 0) {\n        msg.encryption.to_encrypt[key] = msg.payload[key];\n        delete msg.payload[key];\n    }\n})\nif (Object.keys(msg.encryption.to_encrypt).length > 0) {\n    var cryptojs = global.get('cryptojs');\n    msg.encryption.ciphertext = cryptojs.AES.encrypt(JSON.stringify(msg.encryption.to_encrypt), msg.encryption.key).toString();\n    msg.payload.ciphertext =  msg.encryption.ciphertext;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 220,
        "wires": [
          [
            "64c933b6.4c341c"
          ]
        ]
      },
      {
        "id": "471373d5.3cd54c",
        "type": "subflow:86df012b.3eb7e",
        "z": "bc6ff87.05a2908",
        "name": "",
        "x": 1080,
        "y": 200,
        "wires": [
          [
            "53775c5.a4da7a4",
            "d85da47d.445228"
          ]
        ]
      },
      {
        "id": "2f7a1e81.4348b2",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 620,
        "y": 220,
        "wires": []
      },
      {
        "id": "7112174f.7e5398",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Sim Not Supported",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"The provided sim_iccid \" + msg.sim_provider.sim_iccid + \" is not supported\"\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 220,
        "wires": [
          [
            "2f7a1e81.4348b2"
          ]
        ]
      },
      {
        "id": "4f92ddb3.e61014",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Activate to State",
        "func": "msg.sim_provider.details = true;\nif((msg.sim_provider.body.status === \"Active\" && msg.sim_provider.body.EAPCode === \"7136\") || msg.sim_provider.body.status === \"Test\") {\n    msg.webbing = {\n        \"base_return\": \"ActivateServiceDeviceResponse.ActivateServiceDeviceResult\",\n        //\"return_obj\": \"\"\n        //\"object\": \"message\",\n        \"request\": \"/devices/ActivateServiceDevice\",\n        \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><ActivateServiceDevice xmlns=\"http://wws.iamwebbing.com/\"><ActivateServiceDeviceRequest><ServiceDeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></ServiceDeviceIdentifier></ActivateServiceDeviceRequest></ActivateServiceDevice></soap12:Body></soap12:Envelope>',\n        \"fields\": {\n            \"sim_iccid\": msg.sim_provider.sim_iccid\n        }\n    }\n    return [null,msg];\n} else {\n    msg.webbing = {\n        \"base_return\": \"ChangeServiceDeviceProductResponse.ChangeServiceDeviceProductResult\",\n        \"request\": \"/devices/ChangeServiceDeviceProduct\",\n        \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><ChangeServiceDeviceProduct xmlns=\"http://wws.iamwebbing.com/\"><ChangeServiceDeviceProductRequest><ServiceDeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></ServiceDeviceIdentifier><ProductID>{{{product_id}}}</ProductID></ChangeServiceDeviceProductRequest></ChangeServiceDeviceProduct></soap12:Body></soap12:Envelope>',\n        \"fields\": {\n            \"sim_iccid\": msg.sim_provider.sim_iccid,\n            \"product_id\": msg.sim_provider.body.EAPCode\n        }\n    }\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1150,
        "y": 800,
        "wires": [
          [
            "1c923840.e30008"
          ],
          [
            "8356c62a.cd3e58"
          ]
        ],
        "outputLabels": [
          "Plan & Activate",
          "Activate Only"
        ]
      },
      {
        "id": "7b3afde7.1218a4",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Reactivate",
        "func": "msg.webbing = {\n    \"base_return\": \"ActivateServiceDeviceResponse.ActivateServiceDeviceResult\",\n    \"request\": \"/devices/ActivateServiceDevice\",\n    \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><ActivateServiceDevice xmlns=\"http://wws.iamwebbing.com/\"><ActivateServiceDeviceRequest><ServiceDeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></ServiceDeviceIdentifier></ActivateServiceDeviceRequest></ActivateServiceDevice></soap12:Body></soap12:Envelope>',\n    \"fields\": {\n        \"sim_iccid\": msg.sim_provider.sim_iccid\n    }\n}\nmsg.sim_provider.details = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 840,
        "wires": [
          [
            "8356c62a.cd3e58"
          ]
        ]
      },
      {
        "id": "c76cb1b2.b1fc1",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Deactivate",
        "func": "msg.webbing = {\n    \"base_return\": \"SuspendServiceDeviceResponse.SuspendServiceDeviceResult\",\n    \"request\": \"/devices/SuspendServiceDevice\",\n    \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><SuspendServiceDevice xmlns=\"http://wws.iamwebbing.com/\"><SuspendServiceDeviceRequest><ServiceDeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></ServiceDeviceIdentifier></SuspendServiceDeviceRequest></SuspendServiceDevice></soap12:Body></soap12:Envelope>',\n    \"fields\": {\n        \"sim_iccid\": msg.sim_provider.sim_iccid\n    }\n}\nmsg.sim_provider.details = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1140,
        "y": 880,
        "wires": [
          [
            "8356c62a.cd3e58"
          ]
        ]
      },
      {
        "id": "494e0fcb.14775",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Update Plan Code",
        "func": "msg.webbing = {\n    \"base_return\": \"ChangeServiceDeviceProductResponse.ChangeServiceDeviceProductResult\",\n    \"request\": \"/devices/ChangeServiceDeviceProduct\",\n    \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><ChangeServiceDeviceProduct xmlns=\"http://wws.iamwebbing.com/\"><ChangeServiceDeviceProductRequest><ServiceDeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></ServiceDeviceIdentifier><ProductID>{{{product_id}}}</ProductID></ChangeServiceDeviceProductRequest></ChangeServiceDeviceProduct></soap12:Body></soap12:Envelope>',\n    \"fields\": {\n        \"sim_iccid\": msg.sim_provider.sim_iccid,\n        \"product_id\": msg.sim_provider.body.plan_code\n    }\n}\nmsg.sim_provider.details = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 920,
        "wires": [
          [
            "8356c62a.cd3e58"
          ]
        ]
      },
      {
        "id": "5765c7fa.44a5b8",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Update Custom Info",
        "func": "msg.sim_provider.details = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1170,
        "y": 960,
        "wires": [
          [
            "6225a63d.3ee3c8"
          ]
        ]
      },
      {
        "id": "3c66c7aa.d64418",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Webbing Activate to State",
        "func": "msg.webbing = {\n    \"base_return\": \"GetProductsListResponse.GetProductsListResult\",\n    \"return_obj\": \"Products.ProductRecord\",\n    \"object\": \"plan_codes_webbing\",\n    \"request\": \"/service/GetProductsList\",\n    \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><GetProductsList xmlns=\"http://wws.iamwebbing.com/\"><GetProductsRequest><PaginationRequest><PageSize>100</PageSize><PageNumber>1</PageNumber></PaginationRequest></GetProductsRequest></GetProductsList></soap12:Body></soap12:Envelope>',\n    \"fields\": {}\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1450,
        "y": 640,
        "wires": [
          [
            "45b75922.dac428"
          ]
        ]
      },
      {
        "id": "45b75922.dac428",
        "type": "subflow:98ce8d35.4c824",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 1670,
        "y": 640,
        "wires": [
          [
            "53b2f90a.9db858"
          ]
        ]
      },
      {
        "id": "37901336.961b1c",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Merge Plan Codes",
        "func": "msg[msg.records.object] = msg[msg.records.object].concat(msg.plan_codes_webbing);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2130,
        "y": 640,
        "wires": [
          [
            "b8d8f269.e59ea"
          ]
        ]
      },
      {
        "id": "b5c4a534.d50fa8",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 1080,
        "wires": [
          [
            "27ab0656.d57e7a"
          ]
        ]
      },
      {
        "id": "95572347.dd40a",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Plan Codes",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Plan Codes\"\n    });\nmsg.records = {\n    \"object\": \"plan_codes\",\n    \"returns\": [\"plan_codes\"]\n};\nmsg.sim_provider = {\n    \"req_type\": \"plan_codes\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 1080,
        "wires": [
          [
            "a0a5577b.8dd158"
          ]
        ]
      },
      {
        "id": "27ab0656.d57e7a",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 1080,
        "wires": [
          [
            "95572347.dd40a"
          ]
        ]
      },
      {
        "id": "9ab718a2.5c8d98",
        "type": "subflow:313bd1d3.01c06e",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 990,
        "y": 640,
        "wires": [
          [
            "14d84d61.e37593"
          ]
        ]
      },
      {
        "id": "53b2f90a.9db858",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Format Webbing Plan Codes",
        "func": "if(msg[msg.webbing.object]){\n    msg[msg.webbing.object].forEach(function(plan){\n        plan.code = plan.ID;\n        plan.name = plan.Name;\n        delete plan.ID;\n        delete plan.Name;\n    })\n    msg[msg.webbing.object].forEach(function(element) { element.provider = \"webbing\"; });\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1900,
        "y": 640,
        "wires": [
          [
            "37901336.961b1c"
          ]
        ]
      },
      {
        "id": "14d84d61.e37593",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Format Kore Plan Codes",
        "func": "msg[msg.kore.object].forEach(function(element) { element.provider = \"kore\"; });\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 640,
        "wires": [
          [
            "3c66c7aa.d64418"
          ]
        ]
      },
      {
        "id": "3ff0e8c.7279e18",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 1260,
        "wires": [
          [
            "85a02a72.2d6718"
          ]
        ]
      },
      {
        "id": "be86f9ca.2f2238",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Update Plan Code",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Modify Plan Code\"\n    });\nmsg.records = {\n    \"object\": \"sim\",\n    \"returns\": [\"message\",\"sim\"]\n};\nmsg.inputs = {\n    \"required\": [\"sim_iccid\", \"plan_code\"]\n};\nmsg.sim_provider = {\n    \"req_type\": \"update_plan_code\",\n    \"body\": msg.payload\n}\nif (msg.payload.plan_code && typeof msg.payload.plan_code !== \"string\") {\n    if (msg.payload.plan_code.code) {\n        msg.sim_provider.body.plan_code = msg.payload.plan_code.code;\n    } else {\n        delete msg.payload.plan_code;\n        delete msg.sim_provider.plan_code\n    }\n}\nif (msg.payload.sim_iccid) { msg.sim_provider.sim_iccid = msg.payload.sim_iccid }\nmsg.message = \"SIM Card \" +  msg.sim_provider.sim_iccid + \" was successfully updated to use plan code \" + msg.sim_provider.body.plan_code + \".\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 1260,
        "wires": [
          [
            "22b7a3b5.846cbc"
          ]
        ]
      },
      {
        "id": "85a02a72.2d6718",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    if(msg.payload.hasOwnProperty(\"deviceNumber\")){\n        msg.payload.sim_iccid = msg.payload.deviceNumber;\n        msg.req.body.sim_iccid = msg.req.body.deviceNumber;\n        delete msg.payload.deviceNumber;\n        delete msg.req.body.deviceNumber;\n    }\n    if(msg.payload.hasOwnProperty(\"planCode\")){\n        msg.payload.plan_code = msg.payload.planCode;\n        msg.req.body.plan_code = msg.req.body.planCode;\n        delete msg.payload.planCode;\n        delete msg.req.body.planCode;\n    }\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 1260,
        "wires": [
          [
            "be86f9ca.2f2238"
          ]
        ]
      },
      {
        "id": "7bf7f662.04e238",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "Webbing Response",
        "func": "msg.webbing.success = (eval(\"msg.payload.\" + msg.webbing.base_return + \".Success\") === \"true\")\nif(!msg.webbing.success) {\n    msg.webbing.error = {\n        \"code\": eval(\"msg.payload.\" + msg.webbing.base_return + \".ResponseCode\"),\n        \"description\": eval(\"msg.payload.\" + msg.webbing.base_return + \".ResponseDescription\")\n    }\n} else {\n    if(msg.webbing.return_obj) {\n        msg.webbing.response = eval(\"msg.payload.\" + msg.webbing.base_return + \".\" + msg.webbing.return_obj);\n    } else {\n        msg.webbing.response = eval(\"msg.payload.\" + msg.webbing.base_return);\n    }\n    if(msg.webbing.object) {\n        msg[msg.webbing.object] = msg.webbing.response\n    }\n    msg.payload = {};\n    delete msg.statusCode;\n    delete msg.url;\n    delete msg.responseUrl;\n    delete msg.headers;\n    delete msg.topic;\n    delete msg.responseCookies;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 100,
        "wires": [
          [
            "634242b2.d749bc"
          ]
        ]
      },
      {
        "id": "634242b2.d749bc",
        "type": "switch",
        "z": "98ce8d35.4c824",
        "name": "Success",
        "property": "webbing.success",
        "propertyType": "msg",
        "rules": [
          {
            "t": "true"
          },
          {
            "t": "false"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1340,
        "y": 100,
        "wires": [
          [
            "e59ad422.3f49f8"
          ],
          [
            "a6a3d1e6.9b9d5"
          ]
        ]
      },
      {
        "id": "a6a3d1e6.9b9d5",
        "type": "function",
        "z": "98ce8d35.4c824",
        "name": "Webbing Request Error",
        "func": "node.warn({\"Webbing Error\": msg})\nif(!msg.errors){msg.errors = []}\nvar message = msg.webbing.error\nmessage.source = \"webbing\";\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": message\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 140,
        "wires": [
          [
            "66c66e0a.4408b"
          ]
        ]
      },
      {
        "id": "6f3005b7.1b698c",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 240,
        "wires": [
          [
            "72d4978b.b46228"
          ]
        ]
      },
      {
        "id": "d87752cb.f9983",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Activate to State",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Activate To State\"\n    });\nmsg.records = {\n    \"object\": \"sim\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\", \"sim\"]\n};\nmsg.inputs = {\n    \"required\": [\"sim_iccid\", \"EAPCode\", \"status\"],\n    \"values\": {\n        \"status\": [\"Test\", \"Active\"]\n    }\n};\nmsg.sim_provider = {\n    \"req_type\": \"activate_to_state\",\n    \"body\": msg.payload\n};\nif (msg.payload.sim_iccid) { msg.sim_provider.sim_iccid = msg.payload.sim_iccid }\nmsg.message = \"SIM Card \" + msg.payload.sim_iccid + \" was successfully activated to \" + msg.payload.status + \".\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 980,
        "y": 240,
        "wires": [
          [
            "22b7a3b5.846cbc"
          ]
        ]
      },
      {
        "id": "72d4978b.b46228",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    if(msg.payload.hasOwnProperty(\"deviceNumber\")){\n        msg.payload.sim_iccid = msg.payload.deviceNumber;\n        msg.req.body.sim_iccid = msg.req.body.deviceNumber;\n        delete msg.payload.deviceNumber;\n        delete msg.req.body.deviceNumber;\n    }\n    if(msg.payload.hasOwnProperty(\"toState\")){\n        msg.payload.status = msg.payload.toState;\n        msg.req.body.status = msg.req.body.toState;\n        delete msg.payload.toState;\n        delete msg.req.body.toState;\n    }\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 240,
        "wires": [
          [
            "d87752cb.f9983"
          ]
        ]
      },
      {
        "id": "1c923840.e30008",
        "type": "subflow:98ce8d35.4c824",
        "z": "80a169dd.f18e78",
        "name": "",
        "x": 1670,
        "y": 800,
        "wires": [
          [
            "356c72db.3ce29e"
          ]
        ]
      },
      {
        "id": "356c72db.3ce29e",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "Activate Sim",
        "func": "msg.webbing = {\n    \"base_return\": \"ActivateServiceDeviceResponse.ActivateServiceDeviceResult\",\n    //\"return_obj\": \"\"\n    //\"object\": \"message\",\n    \"request\": \"/devices/ActivateServiceDevice\",\n    \"template\": '<?xml version=\"1.0\" encoding=\"utf-8\"?><soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\"><soap12:Header><Credentials xmlns=\"http://wws.iamwebbing.com/\"><Username>{{{username}}}</Username><Password>{{{password}}}</Password><WSKey>{{{key}}}</WSKey></Credentials></soap12:Header><soap12:Body><ActivateServiceDevice xmlns=\"http://wws.iamwebbing.com/\"><ActivateServiceDeviceRequest><ServiceDeviceIdentifier><ICCID>{{{sim_iccid}}}</ICCID></ServiceDeviceIdentifier></ActivateServiceDeviceRequest></ActivateServiceDevice></soap12:Body></soap12:Envelope>',\n    \"fields\": {\n        \"sim_iccid\": msg.sim_provider.sim_iccid\n    }\n}\nmsg.inputs.details = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1870,
        "y": 800,
        "wires": [
          [
            "8356c62a.cd3e58"
          ]
        ]
      },
      {
        "id": "c393c069.a7c09",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 740,
        "wires": [
          [
            "3a473fea.3e376"
          ]
        ]
      },
      {
        "id": "d68a7ab.71f5488",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Deactivate",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Deactivate\"\n    });\nmsg.records = {\n    \"object\": \"sim\",\n    \"returns\": [\"message\",\"sim\"]\n};\nmsg.inputs = {\n    \"required\": [\"sim_iccid\"]\n};\nmsg.sim_provider = {\n    \"req_type\": \"deactivate\",\n    \"body\": msg.payload\n};\nif (msg.payload.sim_iccid) { msg.sim_provider.sim_iccid = msg.payload.sim_iccid }\nmsg.message = \"SIM Card \" +  msg.payload.sim_iccid + \" was successfully deactivated.\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 740,
        "wires": [
          [
            "22b7a3b5.846cbc"
          ]
        ]
      },
      {
        "id": "3a473fea.3e376",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    if(msg.payload.hasOwnProperty(\"deviceNumber\")){\n        msg.payload.sim_iccid = msg.payload.deviceNumber;\n        msg.req.body.sim_iccid = msg.req.body.deviceNumber;\n        delete msg.payload.deviceNumber;\n        delete msg.req.body.deviceNumber;\n    }\n    if(msg.payload.hasOwnProperty(\"flagScrap\")){\n        delete msg.payload.flagScrap;\n        delete msg.req.body.flagScrap;\n    }\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 740,
        "wires": [
          [
            "d68a7ab.71f5488"
          ]
        ]
      },
      {
        "id": "dc9c6289.c9cd5",
        "type": "function",
        "z": "f7b5cbff.598508",
        "name": "Decryption Not Available",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 403,\n    \"message\": \"Decryption - Failed: cypertext could not be decrypted\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 910,
        "y": 240,
        "wires": [
          [
            "f50f5ea3.bbe9d"
          ]
        ]
      },
      {
        "id": "6cc5e7f5.857148",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "debug",
        "func": "if(msg.api.hasOwnProperty(\"debug\") && msg.api.debug === true) {\n    node.warn({\"Email\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2270,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "c541bab7.920618",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Check Input Data Type",
        "func": "var errors = [];\nif(msg.hasOwnProperty(\"inputs\") && msg.inputs.hasOwnProperty(\"body\") && msg.inputs.hasOwnProperty(\"types\")) { \n    Object.keys(msg.inputs.types).forEach(function(key) {\n        if (msg.inputs.body.hasOwnProperty(key)) {\n            if(typeof(msg.inputs.body[key]) !== msg.inputs.types[key]) {\n                     var error_key = {};\n                     error_key[key] = msg.inputs.types[key];\n                     errors.push(error_key);\n                }\n        }\n    })\n}\nif (errors.length > 0) {\n    msg.error_keys = errors;\n    return [null,msg];\n} else {\n    return [msg,null];   \n}",
        "outputs": 2,
        "noerr": 0,
        "x": 1200,
        "y": 120,
        "wires": [
          [
            "acdaf127.7ffc5"
          ],
          [
            "8220fc30.6bebf"
          ]
        ]
      },
      {
        "id": "8220fc30.6bebf",
        "type": "function",
        "z": "71afa3f9.81defc",
        "name": "Invalid Input Data Type",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 412,\n    \"message\": \"Invalid key data type.\",\n    \"returns\": [\"error_keys\"]\n});\nmsg.records.format = \"array\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1660,
        "y": 200,
        "wires": [
          [
            "44304eec.b88b6"
          ]
        ]
      },
      {
        "id": "7b43a735.8abdd8",
        "type": "switch",
        "z": "57a5a054.9dfd3",
        "name": "200",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1110,
        "y": 760,
        "wires": [
          [
            "38d932.6d8546ce"
          ],
          [
            "9531e771.713668"
          ]
        ]
      },
      {
        "id": "9531e771.713668",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "APP ID Wrong Credentials",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 401,\n    \"message\": {\n            \"code\": msg.payload.error,\n            \"description\": msg.payload.error_description,\n            \"service\": \"appid\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 780,
        "wires": [
          [
            "f37244ae.346dd8"
          ]
        ]
      },
      {
        "id": "bd0f7250.6f7f8",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Headers",
        "func": "if (msg.hasOwnProperty(\"req\") && msg.req.hasOwnProperty(\"headers\")) {\n    if (msg.req.headers.hasOwnProperty(\"api_info\")) {\n        msg.api.info = (msg.req.headers.api_info === \"true\");\n    } else {\n        msg.api.info = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_debug\")) {\n        msg.api.debug = (msg.req.headers.api_debug === \"true\");\n    } else {\n        msg.api.debug = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_stats\")) {\n        msg.api.stats = (msg.req.headers.api_stats === \"true\");\n    } else {\n        msg.api.stats = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"debug\")) {\n        msg.debug = JSON.parse(msg.req.headers.debug)\n    }\n    if (msg.req.headers.hasOwnProperty(\"apic\")) {\n        msg.api.apic = JSON.parse(msg.req.headers.apic)\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_encrypt\")) {\n        msg.api.encrypt = (msg.req.headers.api_encrypt === \"true\")\n    } else {\n        msg.api.encrypt = false\n    }\n}\n// override info flag here for vx environment\n//if (global.get(\"VCAP\").app.application_name.substr(-1) === \"x\"){ msg.api.info = true; }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 760,
        "wires": [
          [
            "aed2ad76.87b3e"
          ]
        ]
      },
      {
        "id": "114a461b.bf575a",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 250,
        "y": 440,
        "wires": [
          [
            "c4369d37.22b4c"
          ]
        ]
      },
      {
        "id": "4f9e1739.3ceb98",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 1760,
        "wires": [
          [
            "d8827839.727638"
          ]
        ]
      },
      {
        "id": "11e5486f.2c6b08",
        "type": "function",
        "z": "61ffb71b.d286f",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 1860,
        "wires": [
          [
            "e6a4d1f.c44fb3"
          ]
        ]
      },
      {
        "id": "c365d482.561be8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 280,
        "wires": [
          [
            "70a6c339.a33ffc"
          ]
        ]
      },
      {
        "id": "54e2ee12.45f6f",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 820,
        "wires": [
          [
            "fcb3a021.f5d13"
          ]
        ]
      },
      {
        "id": "9d966eb7.76ee9",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 920,
        "wires": [
          [
            "afbb8311.d2f1e"
          ]
        ]
      },
      {
        "id": "6dab3b10.8c28a4",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 1020,
        "wires": [
          [
            "1e2c5f61.780851"
          ]
        ]
      },
      {
        "id": "cebdcba9.dfac18",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 1520,
        "wires": [
          [
            "2497d9af.ade676"
          ]
        ]
      },
      {
        "id": "20efb05e.928c8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 1660,
        "wires": [
          [
            "3bcd4b75.f94e44"
          ]
        ]
      },
      {
        "id": "9bdecbf1.62b788",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 1840,
        "wires": [
          [
            "77408e62.94768"
          ]
        ]
      },
      {
        "id": "dfea7251.479c6",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 530,
        "y": 1940,
        "wires": [
          [
            "e87ec0f4.0009"
          ]
        ]
      },
      {
        "id": "117ec4cf.45508b",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 2080,
        "wires": [
          [
            "432d2c2f.7f4814"
          ]
        ]
      },
      {
        "id": "aec2e944.65c2e8",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 720,
        "wires": [
          [
            "4476740f.ed6f8c"
          ]
        ]
      },
      {
        "id": "601d3844.78ecc8",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 640,
        "wires": [
          [
            "f12b7dba.103b3"
          ]
        ]
      },
      {
        "id": "15c724d0.a828fb",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Lens Rep Service",
        "func": "if (msg.hasOwnProperty(\"machine_link\") && msg.machine_link.length > 0) {\n    var linked_user_ids = msg.machine_link.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Lens Rep\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1550,
        "y": 420,
        "wires": [
          [
            "eba1bc79.4683c"
          ]
        ]
      },
      {
        "id": "cd1e004d.8897d",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/encrypt/:data",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 920,
        "wires": [
          [
            "981f5629.ed25f8"
          ]
        ]
      },
      {
        "id": "233a5ea7.405a92",
        "type": "http in",
        "z": "57a5a054.9dfd3",
        "name": "",
        "url": "/decrypt",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 960,
        "wires": [
          [
            "d42463d1.45793"
          ]
        ]
      },
      {
        "id": "89860ecf.bac86",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Encrypt",
        "func": "var cryptojs = global.get('cryptojs');\nmsg.encrypt = {\n    \"key\": global.get(\"CRYPTO_KEYS\").com.payload\n}\nnode.warn(\"key: \"+ msg.encrypt.key)\nmsg.json_string = msg.req.params.data;\nnode.warn(\"E-json_string: \"+ msg.json_string)\nmsg.encrypted = cryptojs.AES.encrypt(msg.json_string, msg.encrypt.key);\nnode.warn({\"E-encrypted\": msg.encrypted});\nmsg.encrypted_string = msg.encrypted.toString();\nnode.warn({\"E-encrypted_string\": msg.encrypted_string});\nmsg.payload = msg.encrypted_string;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 920,
        "wires": [
          [
            "2cf230c5.f2f98"
          ]
        ]
      },
      {
        "id": "c7fbecda.c7d7a",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "Decrypt",
        "func": "if(msg.payload.ciphertext){ \n    var cryptojs = global.get('cryptojs');\n    msg.encrypt = {\n        \"key\": global.get(\"CRYPTO_KEYS\").com.payload\n    };\n    node.warn(\"D-encrypted_string: \"+ msg.payload.ciphertext);\n    msg.decrypt = cryptojs.AES.decrypt(msg.payload.ciphertext, msg.encrypt.key);\n    node.warn(\"D-decrypt: \"+ msg.decrypt);\n    msg.decrypt_string = msg.decrypt.toString(cryptojs.enc.Utf8);\n    node.warn(\"D-decrypt_string: \"+ msg.decrypt_string);\n    try {\n        msg.decrypt_json = JSON.parse(msg.decrypt_string);\n        node.warn({\"D-decrypt_json\": msg.decrypt_json});\n        msg.payload = msg.decrypt_json;\n    }\n    catch(error) {\n        msg.payload = msg.decrypt;\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 960,
        "wires": [
          [
            "286a5787.9f91c8"
          ]
        ]
      },
      {
        "id": "2cf230c5.f2f98",
        "type": "http response",
        "z": "57a5a054.9dfd3",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 650,
        "y": 920,
        "wires": []
      },
      {
        "id": "286a5787.9f91c8",
        "type": "http response",
        "z": "57a5a054.9dfd3",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 650,
        "y": 960,
        "wires": []
      },
      {
        "id": "981f5629.ed25f8",
        "type": "subflow:3962857e.44abba",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 330,
        "y": 920,
        "wires": [
          [
            "89860ecf.bac86"
          ]
        ]
      },
      {
        "id": "d42463d1.45793",
        "type": "subflow:3962857e.44abba",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 330,
        "y": 960,
        "wires": [
          [
            "c7fbecda.c7d7a"
          ]
        ]
      },
      {
        "id": "692bef4.d6f061",
        "type": "subflow:bc6ff87.05a2908",
        "z": "57a5a054.9dfd3",
        "name": "",
        "x": 1430,
        "y": 740,
        "wires": []
      },
      {
        "id": "ad4d16d7.a27ac8",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 600,
        "wires": [
          [
            "7aef97a2.b2b238"
          ]
        ]
      },
      {
        "id": "7aef97a2.b2b238",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    if(msg.payload.hasOwnProperty(\"deviceNumber\")){\n        msg.payload.sim_iccid = msg.payload.deviceNumber;\n        msg.req.body.sim_iccid = msg.req.body.deviceNumber;\n        delete msg.payload.deviceNumber;\n        delete msg.req.body.deviceNumber;\n    }\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 600,
        "wires": [
          [
            "231352bf.6eeb3e"
          ]
        ]
      },
      {
        "id": "231352bf.6eeb3e",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Update Custom Info",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Update Custom Info\"\n    });\nmsg.records = {\n    \"object\": \"sim\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\", \"sim\"]\n};\nmsg.inputs = {\n    \"required\": [\"sim_iccid\"],\n    \"allowed\": [\"customField1\", \"customField2\", \"customField3\", \"customField4\", \"customField5\", \"customField6\"]\n};\nmsg.sim_provider = {\n    \"req_type\": \"update_info\",\n    \"body\": msg.payload\n};\nif (msg.payload.sim_iccid) { msg.sim_provider.sim_iccid = msg.payload.sim_iccid }\nmsg.message = \"Sim Card \" + msg.payload.sim_iccid + \" custom information was successfully updated.\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 990,
        "y": 600,
        "wires": [
          [
            "22b7a3b5.846cbc"
          ]
        ]
      },
      {
        "id": "cc6048c0.ed4cf8",
        "type": "subflow:3962857e.44abba",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 630,
        "y": 420,
        "wires": [
          [
            "2cd1ac5e.1793e4"
          ]
        ]
      },
      {
        "id": "2cd1ac5e.1793e4",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "v1 Inputs",
        "func": "if(msg.api && msg.api.apic && msg.api.apic.version === \"v1\") {\n    if(msg.payload.hasOwnProperty(\"deviceNumber\")){\n        msg.payload.sim_iccid = msg.payload.deviceNumber;\n        msg.req.body.sim_iccid = msg.req.body.deviceNumber;\n        delete msg.payload.deviceNumber;\n        delete msg.req.body.deviceNumber;\n    }\n    msg.v1 = true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 420,
        "wires": [
          [
            "c682ec6e.e63d3"
          ]
        ]
      },
      {
        "id": "c682ec6e.e63d3",
        "type": "function",
        "z": "c1ec6ee7.981a18",
        "name": "Sim Reactivate",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Sim Reactivate\"\n    });\nmsg.records = {\n    \"object\": \"sim\",\n    \"format\": \"JSON\",\n    \"returns\": [\"message\", \"sim\"]\n};\nmsg.inputs = {\n    \"required\": [\"sim_iccid\"]\n};\nmsg.sim_provider = {\n    \"req_type\": \"reactivate\",\n    \"body\": msg.payload\n}\nif (msg.payload.sim_iccid) { msg.sim_provider.sim_iccid = msg.payload.sim_iccid }\nmsg.message = \"SIM Card \" + msg.payload.sim_iccid + \" was successfully reactivated.\"\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 960,
        "y": 420,
        "wires": [
          [
            "22b7a3b5.846cbc"
          ]
        ]
      },
      {
        "id": "514b425d.eea37c",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Headers",
        "func": "if (msg.hasOwnProperty(\"req\") && msg.req.hasOwnProperty(\"headers\")) {\n    if (msg.req.headers.hasOwnProperty(\"api_info\")) {\n        msg.api.info = (msg.req.headers.api_info === \"true\");\n    } else {\n        msg.api.info = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_debug\")) {\n        msg.api.debug = (msg.req.headers.api_debug === \"true\");\n    } else {\n        msg.api.debug = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_stats\")) {\n        msg.api.stats = (msg.req.headers.api_stats === \"true\");\n    } else {\n        msg.api.stats = false;\n    }\n    if (msg.req.headers.hasOwnProperty(\"debug\")) {\n        msg.debug = JSON.parse(msg.req.headers.debug)\n    }\n    if (msg.req.headers.hasOwnProperty(\"apic\")) {\n        msg.api.apic = JSON.parse(msg.req.headers.apic)\n    }\n    if (msg.req.headers.hasOwnProperty(\"api_encrypt\")) {\n        msg.api.override_encrypt = (msg.req.headers.api_encrypt === \"true\")\n    }\n}\n// override info flag here for vx environment\n//if (global.get(\"VCAP\").app.application_name.substr(-1) === \"x\"){ msg.api.info = true; }\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 280,
        "y": 160,
        "wires": [
          [
            "b8c36493.e64ac8"
          ]
        ]
      },
      {
        "id": "3a5edef0.6fda62",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "Provider Consumer Pair",
        "info": "API paths:\n1. Missing Inputs\n2. Fake user_id\n3. Fake email\n4. Fake device_id\n5. New link record\n6. Existing inactive link record\n7. Existing active link record",
        "x": 140,
        "y": 900,
        "wires": []
      },
      {
        "id": "52af7c99.8c4914",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/pairing/pair/provider_consumer",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 940,
        "wires": [
          [
            "2b35f87.3d49308"
          ]
        ]
      },
      {
        "id": "bb375fa7.d25c1",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Pair Provider and Consumer",
        "func": "\nmsg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Pair Provider and Consumer\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\"],\n    \"doc_type\": \"provider_link\",\n    \"object\": \"provider_link\",\n    \"format\": \"JSON\",\n    \"returns\": [\"content\"],\n    \"models\": [\"provider_link\"]\n};\nmsg.inputs = {\n    \"required\": [\"provider_id\",\"consumer_id\"],\n    \"provider_id\":msg.payload.provider_id,\n    \"consumer_id\":msg.payload.consumer_id\n    \n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"users\",\n    \"selector\": {\n        \"$and\": [   {\"doc_type\": \"user\"},\n                    {\"status\": \"active\"},\n                    {\"_id\": {\"$in\": [msg.inputs.provider_id, msg.inputs.consumer_id]}}\n                ]\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 940,
        "wires": [
          [
            "a78e3781.cc1708"
          ]
        ]
      },
      {
        "id": "b321feb5.c030d",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Povider  & Consmer Exists",
        "func": "if(msg.users && msg.users.length > 0) {\n    user_ids = msg.users.map(a => a._id)\n    var provider = user_ids.indexOf(msg.inputs.provider_id)\n    node.warn(provider)\n    var consumer = user_ids.indexOf(msg.inputs.consumer_id)\n    node.warn(consumer)\n    if (provider < 0 && msg.users[provider].role !== \"Surgeon\" ) { return [null,msg,null]; }\n    if (consumer < 0) { return [null,null,msg]; }\n} else {\n    return [null,msg,null];\n}\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"provider_link\",\n    \"selector\": {\n        \"$and\": [   {\"doc_type\": \"provider_link\"},\n                    {\"provider_id\": msg.inputs.provider_id},//{_id\": msg.inputs.provider_id},\n                    {\"consumer_id\": msg.inputs.consumer_id} //{_id\": msg.inputs.provider_id},\n                ]\n    }\n};\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1350,
        "y": 940,
        "wires": [
          [
            "4860fb68.bc9274"
          ],
          [
            "bf58f76e.dd4bb8"
          ],
          [
            "1095583a.c81a88"
          ]
        ],
        "outputLabels": [
          "yes",
          "no device",
          "no user"
        ]
      },
      {
        "id": "bf58f76e.dd4bb8",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Provider Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Provider user: \" + msg.inputs.provider_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1570,
        "y": 940,
        "wires": [
          [
            "fc0dabdf.071678"
          ]
        ]
      },
      {
        "id": "1095583a.c81a88",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Consumer Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Consumern user: \" + msg.inputs.consumer_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1580,
        "y": 980,
        "wires": [
          [
            "fc0dabdf.071678"
          ]
        ]
      },
      {
        "id": "10713b80.691655",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Link Exists",
        "func": "if(!msg.hasOwnProperty(\"provider_link\") || msg.provider_link.length === 0){\n    msg.records.id = \"\";\n    return [msg,null,null];\n}\nif (msg.provider_link[0].status === \"inactive\") {\n    msg.inputs.provider_link = msg.provider_link[0]._id;\n    msg.records.id = msg.provider_link[0]._id;\n    delete msg.provider_link;\n    msg.inputs.body = { \"status\": \"active\" }\n    return [null,null,msg];\n} else {\n    return [null,msg,null];\n}",
        "outputs": 3,
        "noerr": 0,
        "x": 1750,
        "y": 900,
        "wires": [
          [
            "6f94f387.cfd60c"
          ],
          [
            "16222a54.4ad966"
          ],
          [
            "5006bbc9.875c24"
          ]
        ],
        "outputLabels": [
          "no",
          "yes active",
          "yes inactive"
        ]
      },
      {
        "id": "a78e3781.cc1708",
        "type": "subflow:71afa3f9.81defc",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 960,
        "y": 940,
        "wires": [
          [
            "5beccb71.602304"
          ]
        ]
      },
      {
        "id": "5beccb71.602304",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1130,
        "y": 940,
        "wires": [
          [
            "b321feb5.c030d"
          ]
        ]
      },
      {
        "id": "4860fb68.bc9274",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1570,
        "y": 900,
        "wires": [
          [
            "10713b80.691655"
          ]
        ]
      },
      {
        "id": "fc0dabdf.071678",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1800,
        "y": 960,
        "wires": []
      },
      {
        "id": "5006bbc9.875c24",
        "type": "subflow:68197f61.7975",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1930,
        "y": 920,
        "wires": [
          [
            "16222a54.4ad966"
          ]
        ]
      },
      {
        "id": "6f94f387.cfd60c",
        "type": "subflow:e0cd8199.1ad77",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1920,
        "y": 880,
        "wires": [
          [
            "16222a54.4ad966"
          ]
        ]
      },
      {
        "id": "16222a54.4ad966",
        "type": "subflow:313bd1d3.01c06e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 2150,
        "y": 900,
        "wires": [
          [
            "f8d88d89.52923"
          ]
        ]
      },
      {
        "id": "2ae62aa7.76b926",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 2550,
        "y": 900,
        "wires": []
      },
      {
        "id": "2b35f87.3d49308",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 490,
        "y": 940,
        "wires": [
          [
            "bb375fa7.d25c1"
          ]
        ]
      },
      {
        "id": "5a919d33.852c44",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "Provider Consumer Unpair",
        "info": "API paths:\n1. Missing Inputs\n2. Active Link record not found\n7. Active Link record found",
        "x": 150,
        "y": 1020,
        "wires": []
      },
      {
        "id": "16109ee.b3e1b61",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/pairing/unpair/provider_consumer",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 209,
        "y": 1060,
        "wires": [
          [
            "ae33d23f.bc37b"
          ]
        ]
      },
      {
        "id": "701b6e58.67937",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Unpair Provider and Consumer",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Unpair Provider and Consumer\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\", \"status\"],\n    \"doc_type\": \"provider_link\",\n    \"object\": \"provider_link\",\n    \"format\": \"JSON\",\n    \"returns\": [\"content\"],\n};\nmsg.inputs = {\n    \"required\": [\"provider_id\", \"consumer_id\"],\n    \"provider_id\": msg.payload.provider_id,\n    \"consumer_id\": msg.payload.consumer_id\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"provider_link\",\n    \"selector\": {\n        \"$and\": [   {\"doc_type\": \"provider_link\"},\n                    {\"provider_id\": msg.inputs.provider_id},\n                    {\"consumer_id\": msg.inputs.consumer_id}\n                ]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 1060,
        "wires": [
          [
            "ac573156.095cc"
          ]
        ]
      },
      {
        "id": "7ba6c216.3d934c",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Link exists",
        "func": "if(!msg.hasOwnProperty(\"provider_link\") || msg.provider_link.length === 0){\n    return [null,msg,null]\n}\nif(msg.hasOwnProperty(\"provider_link\") && msg.provider_link[0].status === \"inactive\"){\n    return [null,null,msg]\n}\nmsg.inputs.provider_link = msg.provider_link[0]._id;\nmsg.records.id = msg.provider_link[0]._id;\ndelete msg.provider_link;\nmsg.inputs.body = { \"status\": \"inactive\" };\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1310,
        "y": 1060,
        "wires": [
          [
            "1995407f.ffd5c"
          ],
          [
            "9e96db2a.b84e78"
          ],
          [
            "4b243f5c.dd857"
          ]
        ],
        "outputLabels": [
          "yes",
          "no",
          ""
        ]
      },
      {
        "id": "9e96db2a.b84e78",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Link Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active Link between Provider: \" + msg.inputs.provider_id + \" and Consumer: \" + msg.inputs.consumer_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1480,
        "y": 1060,
        "wires": [
          [
            "c07af3dc.e58bc"
          ]
        ]
      },
      {
        "id": "4b243f5c.dd857",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Link Already Inactive",
        "func": "if(msg.records.returns) {\n    msg.records.returns.push(\"message\");\n}\nelse {\n    msg.records.returns = [\"message\"];\n}\nmsg.message = \"Link between Provider: \" + msg.inputs.provider_id + \" and Consumer: \" + msg.inputs.consumer_id + \" was already delinked.\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1500,
        "y": 1100,
        "wires": [
          [
            "981913cd.2e3b2"
          ]
        ]
      },
      {
        "id": "ae33d23f.bc37b",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 490,
        "y": 1060,
        "wires": [
          [
            "701b6e58.67937"
          ]
        ]
      },
      {
        "id": "ac573156.095cc",
        "type": "subflow:71afa3f9.81defc",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 960,
        "y": 1060,
        "wires": [
          [
            "25c04843.2cc518"
          ]
        ]
      },
      {
        "id": "25c04843.2cc518",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1130,
        "y": 1060,
        "wires": [
          [
            "7ba6c216.3d934c"
          ]
        ]
      },
      {
        "id": "c07af3dc.e58bc",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1740,
        "y": 1080,
        "wires": []
      },
      {
        "id": "be00f51e.4286d8",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 2170,
        "y": 1020,
        "wires": []
      },
      {
        "id": "981913cd.2e3b2",
        "type": "subflow:313bd1d3.01c06e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1770,
        "y": 1020,
        "wires": [
          [
            "164ffc81.9542f3"
          ]
        ]
      },
      {
        "id": "1995407f.ffd5c",
        "type": "subflow:68197f61.7975",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1490,
        "y": 1020,
        "wires": [
          [
            "981913cd.2e3b2"
          ]
        ]
      },
      {
        "id": "43efb967.640608",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 1160,
        "wires": [
          [
            "83a830c2.15ab"
          ]
        ]
      },
      {
        "id": "83a830c2.15ab",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 610,
        "y": 1160,
        "wires": [
          [
            "af9d0519.cd4e88"
          ]
        ]
      },
      {
        "id": "af9d0519.cd4e88",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Consumers",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Consumers\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"returns\": [\"content\"]\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\": msg.inputs.user_id}]},\n                {\"$and\": [{\"doc_type\": \"provider_link\"},{\"status\": \"active\"},{\"provider_id\": msg.inputs.user_id}]}]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 810,
        "y": 1160,
        "wires": [
          [
            "9179657b.0713b8"
          ]
        ]
      },
      {
        "id": "9179657b.0713b8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1010,
        "y": 1160,
        "wires": [
          [
            "edf86da6.4a2cb"
          ]
        ]
      },
      {
        "id": "edf86da6.4a2cb",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Paired Comsumer Ids",
        "func": "if(!msg.hasOwnProperty(\"users\") || msg.users.length === 0){\n    return [null,null,msg];\n}\nif(!msg.hasOwnProperty(\"provider_links\") || msg.provider_links.length === 0){\n    msg.users = [];\n    return [null,msg,null]\n}\nmsg.paired_user_ids = msg.provider_links.map(a => a.consumer_id);\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"users\",\n    \"selector\": {\n        \"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\":  { \"$in\": msg.paired_user_ids }}]\n    },\n    \"sort\": [{ \"last_name:string\": \"asc\"},{ \"first_name:string\": \"asc\"}],\n};\nif(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n    if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n    if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n}\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1220,
        "y": 1160,
        "wires": [
          [
            "1da746c3.2f3979"
          ],
          [
            "32d8be6e.52e7e2"
          ],
          [
            "a7ce1edb.62206"
          ]
        ],
        "outputLabels": [
          "yes paired",
          "no paired",
          "no device"
        ]
      },
      {
        "id": "1da746c3.2f3979",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1430,
        "y": 1140,
        "wires": [
          [
            "64396a28.d0d394"
          ]
        ]
      },
      {
        "id": "d7edca4f.8d4438",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 2070,
        "y": 1160,
        "wires": []
      },
      {
        "id": "a7ce1edb.62206",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active user with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 1180,
        "wires": [
          [
            "3fd78df9.015a42"
          ]
        ]
      },
      {
        "id": "64396a28.d0d394",
        "type": "subflow:313bd1d3.01c06e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1630,
        "y": 1140,
        "wires": [
          [
            "32d8be6e.52e7e2"
          ]
        ]
      },
      {
        "id": "3fd78df9.015a42",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1620,
        "y": 1180,
        "wires": []
      },
      {
        "id": "ba536fc3.c0f86",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "User Consumers",
        "info": "",
        "x": 120,
        "y": 1120,
        "wires": []
      },
      {
        "id": "32d8be6e.52e7e2",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Users Content",
        "func": "var offset = 0;\nvar next = 0;\nvar available = 0;\nif(msg.paired_user_ids) { available = msg.paired_user_ids.length }\nif(msg.cloudant.hasOwnProperty(\"skip\")) {\n    offset = (msg.cloudant.skip || 0);\n    next = offset + (msg[msg.records.object].length);\n}\nmsg.content = {\n    \"consumers\": msg[msg.records.object],\n    \"pagination\": {\n        \"available\": available,\n        \"count\": msg[msg.records.object].length,\n        \"offset\": offset,\n        \"next\": next\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1860,
        "y": 1160,
        "wires": [
          [
            "d7edca4f.8d4438"
          ]
        ]
      },
      {
        "id": "6c86ab14.d87224",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 1240,
        "wires": [
          [
            "c3575b75.ef2418"
          ]
        ]
      },
      {
        "id": "c3575b75.ef2418",
        "type": "subflow:3962857e.44abba",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 610,
        "y": 1240,
        "wires": [
          [
            "6b4fa77a.b57c68"
          ]
        ]
      },
      {
        "id": "6b4fa77a.b57c68",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Providers",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Providers\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\", \"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"array\",\n    \"object\": \"users\",\n    \"returns\": [\"content\"]\n};\nmsg.inputs = {\n    \"user_id\": msg.req.params.userID\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"doc_types\",\n    \"selector\": {\n        \"$or\": [{\"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\": msg.inputs.user_id}]},\n                {\"$and\": [{\"doc_type\": \"provider_link\"},{\"status\": \"active\"},{\"consumer_id\": msg.inputs.user_id}]}]\n    }\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 1240,
        "wires": [
          [
            "280a4100.fdc7ee"
          ]
        ]
      },
      {
        "id": "280a4100.fdc7ee",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1010,
        "y": 1240,
        "wires": [
          [
            "6f4cf458.a31a1c"
          ]
        ]
      },
      {
        "id": "6f4cf458.a31a1c",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Paired Provider Ids",
        "func": "if(!msg.hasOwnProperty(\"users\") || msg.users.length === 0){\n    return [null,null,msg];\n}\nif(!msg.hasOwnProperty(\"provider_links\") || msg.provider_links.length === 0){\n    msg.users = [];\n    return [null,msg,null]\n}\nmsg.paired_user_ids = msg.provider_links.map(a => a.provider_id);\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"users\",\n    \"selector\": {\n        \"$and\": [{\"doc_type\": \"user\"},{\"status\": \"active\"},{\"_id\":  { \"$in\": msg.paired_user_ids }}]\n    },\n    \"sort\": [{ \"last_name:string\": \"asc\"},{ \"first_name:string\": \"asc\"}]\n};\nif(msg.req.query.hasOwnProperty(\"limit\") || msg.req.query.hasOwnProperty(\"offset\")){\n    if(msg.req.query.hasOwnProperty(\"limit\")){msg.cloudant.limit = parseInt(msg.req.query.limit)}\n    if(msg.req.query.hasOwnProperty(\"offset\")){msg.cloudant.skip = parseInt(msg.req.query.offset)}\n}\nreturn [msg,null,null];",
        "outputs": 3,
        "noerr": 0,
        "x": 1210,
        "y": 1240,
        "wires": [
          [
            "2e8c2ad4.66ec36"
          ],
          [
            "fbfbcdbc.46365"
          ],
          [
            "b56ec96.20cef38"
          ]
        ],
        "outputLabels": [
          "yes paired",
          "no paired",
          "no device"
        ]
      },
      {
        "id": "2e8c2ad4.66ec36",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1430,
        "y": 1220,
        "wires": [
          [
            "5c663b5a.3a5df4"
          ]
        ]
      },
      {
        "id": "b56ec96.20cef38",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"Active user with id: \" + msg.inputs.user_id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 1260,
        "wires": [
          [
            "8900d65d.b1e5e8"
          ]
        ]
      },
      {
        "id": "fbfbcdbc.46365",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Providers Content",
        "func": "var offset = 0;\nvar next = 0;\nvar available = 0;\nif(msg.paired_user_ids) { available = msg.paired_user_ids.length }\nif(msg.cloudant.hasOwnProperty(\"skip\")) {\n    offset = (msg.cloudant.skip || 0);\n    next = offset + (msg[msg.records.object].length);\n}\nmsg.content = {\n    \"providers\": msg[msg.records.object],\n    \"pagination\": {\n        \"available\": available,\n        \"count\": msg[msg.records.object].length,\n        \"offset\": offset,\n        \"next\": next\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1870,
        "y": 1240,
        "wires": [
          [
            "735ea94c.fcff08"
          ]
        ]
      },
      {
        "id": "5c663b5a.3a5df4",
        "type": "subflow:313bd1d3.01c06e",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1630,
        "y": 1220,
        "wires": [
          [
            "fbfbcdbc.46365"
          ]
        ]
      },
      {
        "id": "8900d65d.b1e5e8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 1620,
        "y": 1260,
        "wires": []
      },
      {
        "id": "735ea94c.fcff08",
        "type": "subflow:bc6ff87.05a2908",
        "z": "429bd64.63fc828",
        "name": "",
        "x": 2070,
        "y": 1240,
        "wires": []
      },
      {
        "id": "f02a4214.f8562",
        "type": "comment",
        "z": "429bd64.63fc828",
        "name": "User Providers",
        "info": "",
        "x": 120,
        "y": 1200,
        "wires": []
      },
      {
        "id": "a7a55c7.6bdd3a",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userID/consumers",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1160,
        "wires": [
          [
            "43efb967.640608"
          ]
        ]
      },
      {
        "id": "15d08ab8.403e05",
        "type": "http in",
        "z": "429bd64.63fc828",
        "name": "",
        "url": "/dapp/users/user/:userID/providers",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 1240,
        "wires": [
          [
            "6c86ab14.d87224"
          ]
        ]
      },
      {
        "id": "7b3aa890.8ba488",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/password_reset",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 2180,
        "wires": [
          [
            "f3e272dd.d0c98"
          ]
        ]
      },
      {
        "id": "67cda737.c19d48",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "[ ] User Password Reset",
        "info": "",
        "x": 130,
        "y": 2140,
        "wires": []
      },
      {
        "id": "f3e272dd.d0c98",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 470,
        "y": 2180,
        "wires": [
          [
            "f17225ca.01f9c8"
          ]
        ]
      },
      {
        "id": "f17225ca.01f9c8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Users Password Reset",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"Users Password Reset\"\n    });\nmsg.records = {\n    \"delete\": [\"_rev\",\"doc_type\",\"status\",\"password\"],\n    \"doc_type\": \"user\",\n    \"format\": \"json\",\n    \"object\": \"user\",\n    \"returns\": [\"message\",\"user\"]\n};\nmsg.inputs = {\n    \"required\": [\"email\"],\n    \"allowed\": []\n};\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"user\",\n    \"selector\": {\n        \"$and\": [{\"email\": msg.payload.email},{\"status\": \"active\"}]\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 2180,
        "wires": [
          [
            "564122a.12cb3dc"
          ]
        ]
      },
      {
        "id": "564122a.12cb3dc",
        "type": "subflow:71afa3f9.81defc",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 860,
        "y": 2180,
        "wires": [
          [
            "5034b236.6829bc"
          ]
        ]
      },
      {
        "id": "545ffdf0.5ddfc4",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0 && msg.user[0].hasOwnProperty(\"doc_type\") && msg.user[0].doc_type === \"user\") {\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 1210,
        "y": 2180,
        "wires": [
          [
            "be8fad80.20d7b"
          ],
          [
            "51befd69.2916a4"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "be8fad80.20d7b",
        "type": "subflow:313bd1d3.01c06e",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1430,
        "y": 2160,
        "wires": [
          [
            "4512e03c.53bbd"
          ]
        ]
      },
      {
        "id": "51befd69.2916a4",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with provided email was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1420,
        "y": 2200,
        "wires": [
          [
            "38333690.40b41a"
          ]
        ]
      },
      {
        "id": "2e318782.d30ea8",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 2710,
        "y": 2120,
        "wires": []
      },
      {
        "id": "38333690.40b41a",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 2900,
        "y": 2200,
        "wires": []
      },
      {
        "id": "5034b236.6829bc",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1030,
        "y": 2180,
        "wires": [
          [
            "545ffdf0.5ddfc4"
          ]
        ]
      },
      {
        "id": "fea147ea.4d2f88",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "email confirmation",
        "func": "if(msg.statusCode !== 200) {\n    return [null,msg]\n}\n\ndelete msg.method; //necessary to avoid error on default nodes\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\n\nmsg.message = \"An email was sent to \" + msg.inputs.body.email + \" to reset the password.\"\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 2490,
        "y": 2140,
        "wires": [
          [
            "2e318782.d30ea8"
          ],
          [
            "344304a5.8b656c"
          ]
        ]
      },
      {
        "id": "4512e03c.53bbd",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "App ID Get Token",
        "func": "if(global.get(\"VCAP_APPID\")) {\n    msg.iam = {\n        \"type\": \"appid\",\n        \"mgmt\": true\n    }\n    return [msg,null];\n}\nreturn [null,msg]",
        "outputs": 2,
        "noerr": 0,
        "x": 1630,
        "y": 2160,
        "wires": [
          [
            "9511a2d2.41a42"
          ],
          [
            "2781d36b.71c89c"
          ]
        ],
        "outputLabels": [
          "execute",
          "no appid"
        ]
      },
      {
        "id": "ec42f2ba.c9f11",
        "type": "http request",
        "z": "1dff07f1.603c08",
        "name": "",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 2300,
        "y": 2140,
        "wires": [
          [
            "fea147ea.4d2f88"
          ]
        ]
      },
      {
        "id": "2781d36b.71c89c",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "APP ID Not Configured",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": {\n        \"code\": \"appid_missing\",\n        \"description\": \"APP ID is not configured on this CF APP\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1890,
        "y": 2180,
        "wires": [
          [
            "38333690.40b41a"
          ]
        ]
      },
      {
        "id": "9511a2d2.41a42",
        "type": "subflow:ab306e30.d0cc3",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1860,
        "y": 2140,
        "wires": [
          [
            "8c681569.2ec6e8"
          ]
        ]
      },
      {
        "id": "8c681569.2ec6e8",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "App ID Reset Password",
        "func": "var appid = global.get(\"VCAP_APPID\").credentials;\nmsg.method = \"POST\";\nmsg.url = appid.managementUrl + \"/cloud_directory/forgot_password\";\nmsg.headers = {\n    \"Authorization\": msg.appid.authorization\n}\nmsg.payload = {\n    \"tenantId\": appid.tenantId,\n    \"user\": msg.inputs.body.email,\n    \"language\": \"en\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2090,
        "y": 2140,
        "wires": [
          [
            "ec42f2ba.c9f11"
          ]
        ]
      },
      {
        "id": "344304a5.8b656c",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": msg.statusCode,\n    \"message\": msg.payload\n})\nmsg.payload = {};\nif (msg.hasOwnProperty(\"req\")) {\n    return msg;\n} else {\n    node.warn({\"AppID User Password Reset Error\": msg.errors[0]})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2710,
        "y": 2160,
        "wires": [
          [
            "38333690.40b41a"
          ]
        ]
      },
      {
        "id": "12f885c1.449e7a",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "XML Options",
        "func": "//node.warn({\"XMLs File list\": msg})\nmsg.options = {\n    \"explicitArray\": false,\n    \"ignoreAttrs\": true,\n    \"trim\": true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1730,
        "y": 100,
        "wires": [
          [
            "d8981bcf.720878"
          ]
        ]
      },
      {
        "id": "ca63e68a.0baf98",
        "type": "function",
        "z": "57a5a054.9dfd3",
        "name": "XML Options",
        "func": "msg.xml = msg.payload\nmsg.options = {\n    \"explicitArray\": false,\n    \"ignoreAttrs\": false,\n    \"mergeAttrs\": true,\n    \"trim\": true\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2590,
        "y": 80,
        "wires": [
          [
            "ba3441ec.11fe5"
          ]
        ]
      },
      {
        "id": "81677d22.f17a8",
        "type": "http in",
        "z": "c012d9b9.f1e028",
        "name": "",
        "url": "/pairing/pair/user_to_device",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 280,
        "wires": [
          [
            "543f09e7.6d93a8"
          ]
        ]
      },
      {
        "id": "3cd3ca14.eae3d6",
        "type": "subflow:12505187.8b5d0e",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 1450,
        "y": 80,
        "wires": [
          [
            "a11dd7ca.4a0b58"
          ]
        ]
      },
      {
        "id": "a11dd7ca.4a0b58",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "User idp_id",
        "func": "if (msg.appid.hasOwnProperty(\"user\") && msg.appid.user.hasOwnProperty(\"id\")) {\n    msg.records[msg.records.object].idp_id = msg.records.idp_id;\n    if(msg.records.password) {\n        msg.records[msg.records.object].password = msg.records.password;\n    }\n}\nnode.warn({\"New Rec User APPID\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1630,
        "y": 80,
        "wires": [
          [
            "7f36f4fa.4c3d1c"
          ]
        ]
      },
      {
        "id": "febc43f3.28b13",
        "type": "function",
        "z": "67ed0408.e2437c",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug) {\n    node.warn({\"AppID Update User\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2030,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "19afbd7b.6020f3",
        "type": "subflow:ab306e30.d0cc3",
        "z": "67ed0408.e2437c",
        "name": "",
        "x": 420,
        "y": 200,
        "wires": [
          [
            "1c8d8d2a.cb8233"
          ]
        ]
      },
      {
        "id": "1d92a5f5.e4bf3a",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "67ed0408.e2437c",
        "name": "",
        "x": 1940,
        "y": 260,
        "wires": []
      },
      {
        "id": "95eb6b24.16f7f8",
        "type": "function",
        "z": "67ed0408.e2437c",
        "name": "AppID Find User",
        "func": "if (!msg.appid.hasOwnProperty(\"id\")) {\n    if (msg.appid.hasOwnProperty(\"user\") && msg.appid.user.hasOwnProperty(\"id\")) {\n        //update an already available AppID record.\n        msg.appid.id = msg.appid.user.id;\n    } else if (msg.hasOwnProperty(\"user\") && msg.user.length === 1 && msg.user[0].hasOwnProperty(\"idp_id\")) {\n        msg.appid.id = msg.user[0].idp_id;\n    } else if (msg.hasOwnProperty(\"user\") && msg.user.length === 1 && msg.user[0].hasOwnProperty(\"_id\")) {\n        var appID = global.get(\"APPID\");\n        var user_idx = appID.users.c_ids.indexOf(msg.user[0]._id);\n        if (user_idx >= 0) {\n            msg.appid.id = appid.users.idp_id[user_idx];\n        }\n    } else if (msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"id\")){\n        var appID = global.get(\"APPID\");\n        var user_idx = appID.users.c_ids.indexOf(msg.records.id);\n        if (user_idx >= 0) {\n            msg.appid.id = appID.users.idp_id[user_idx];\n        }\n    }\n}\nif (msg.appid.hasOwnProperty(\"id\")) {\n    if(!msg.iam) { msg.iam = {} }\n    msg.iam.type = \"appid\";\n    return [null,msg];\n} else {\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 180,
        "y": 180,
        "wires": [
          [],
          [
            "19afbd7b.6020f3"
          ]
        ],
        "outputLabels": [
          "skip",
          "ok"
        ]
      },
      {
        "id": "1c8d8d2a.cb8233",
        "type": "function",
        "z": "67ed0408.e2437c",
        "name": "Get User",
        "func": "msg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.managementUrl;\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.method = \"GET\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.headers = msg.appid.headers;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 200,
        "wires": [
          [
            "ebda8ac5.8c7668"
          ]
        ]
      },
      {
        "id": "ebda8ac5.8c7668",
        "type": "http request",
        "z": "67ed0408.e2437c",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 800,
        "y": 200,
        "wires": [
          [
            "102f1dcf.e09442"
          ]
        ]
      },
      {
        "id": "102f1dcf.e09442",
        "type": "switch",
        "z": "67ed0408.e2437c",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 950,
        "y": 200,
        "wires": [
          [
            "17577dda.2dd6d2"
          ],
          [
            "819b0371.b7a78"
          ]
        ]
      },
      {
        "id": "17577dda.2dd6d2",
        "type": "function",
        "z": "67ed0408.e2437c",
        "name": "AppID Update User",
        "func": "msg.appid.user = msg.payload;\ndelete msg.appid.user.mfaContext;\ndelete msg.appid.user.meta;\ndelete msg.appid.user.schemas;\nvar c_user = msg.user[0];\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nif (msg.appid.user.hasOwnProperty(\"entitlements\")) {\n    msg.appid.user.entitlements.forEach(function (ent,idx) {\n        if (ent.hasOwnProperty(\"bl_cloud\")) {\n            msg.appid.bl_cloud = msg.appid.user.entitlements.splice(idx,1)[0].bl_cloud\n        }\n    })\n} else {\n    msg.appid.user.entitlements = [];\n}\nif (msg.appid.user.hasOwnProperty(\"phoneNumbers\")) {\n    msg.appid.user.phoneNumbers.forEach(function (phone,idx) {\n        if (phone.type === \"mobile\") {\n            msg.appid.mobile = phone;\n        }\n        if (phone.type === \"voice\") {\n            msg.appid.voice = phone;\n        }\n    })\n    msg.appid.user.phoneNumbers = [];\n}\n//Hack to enter voice_phone in AppID\nif(c_user.voice_phone) {\n    msg.appid.updates.voice_phone = c_user.voice_phone\n} else {\n    delete msg.appid.voice;\n}\nif (!msg.appid.hasOwnProperty(\"bl_cloud\")) {\n    msg.appid.bl_cloud = {\n        \"c_id\": c_user._id,\n        \"doc_type\": \"user\",\n        \"role\": c_user.role\n        //\"sub_roles\": c_user.sub_roles\n    }\n}\nif (!msg.appid.bl_cloud.c_id || msg.appid.bl_cloud.c_id === \"\") {\n    msg.appid.bl_cloud.c_id = c_user._id;\n}\n//node.warn({\"AppID Update user - Original\": msg})\nObject.keys(msg.appid.updates).forEach(function (key) {\n    if (key === \"last_name\") {\n        msg.appid.user.displayName = msg.appid.user.name.givenName + \", \" + msg.appid.updates[key];\n        msg.appid.user.name.familyName = msg.appid.updates[key];\n        msg.appid.user.name.formatted = msg.appid.user.name.givenName + \", \" + msg.appid.updates[key];\n    }\n    if (key === \"first_name\") {\n        msg.appid.user.displayName = msg.appid.updates[key] + \", \" + msg.appid.user.name.familyName;\n        msg.appid.user.name.givenName = msg.appid.updates[key];\n        msg.appid.user.name.formatted = msg.appid.updates[key] + \", \" + msg.appid.user.name.familyName;\n    }\n    if (key === \"email\") {\n        msg.appid.user.userName = msg.appid.updates[key];\n        msg.appid.user.emails = [\n            {\n              \"value\": msg.appid.updates[key],\n              \"primary\": true\n            }\n        ];\n    }\n    if (key === \"password\") {\n        msg.appid.user.password = msg.appid.updates[key];\n    }\n    if (key === \"mobile_phone\") {\n        if(msg.appid.updates[key] === \"\") {\n            delete msg.appid.mobile;\n        } else {\n            msg.appid.mobile = {\n                \"value\": msg.appid.updates[key],\n                \"type\": \"mobile\"\n            };\n        }\n    }\n    if (key === \"voice_phone\") {\n        if(msg.appid.updates[key] === \"\"){\n            delete msg.appid.voice;\n        } else {\n            msg.appid.voice = {\n                \"value\": msg.appid.updates[key],\n                \"type\": \"voice\"\n            };\n        }\n    }\n    if (key === \"role\") {\n        msg.appid.bl_cloud.role = msg.appid.updates[key];\n    }\n    if (key === \"sub_roles\") {\n        msg.appid.bl_cloud.sub_roles = msg.appid.updates[key];\n    }\n    if (key === \"c_id\") {\n        msg.appid.bl_cloud.c_id = msg.appid.updates[key];\n    }\n})\nmsg.appid.user.entitlements.push({\"bl_cloud\": msg.appid.bl_cloud});\nif(msg.appid.mobile) {msg.appid.user.phoneNumbers.push(msg.appid.mobile)}\nif(msg.appid.voice) {msg.appid.user.phoneNumbers.push(msg.appid.voice)}\nif(msg.records && msg.records.password) {\n    msg.appid.user.password = msg.records.password;\n}\nmsg.method = \"PUT\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.payload = msg.appid.user;\nmsg.headers = msg.appid.headers;\ndelete msg.payload.meta;\ndelete msg.payload.schemas;\ndelete msg.payload.mfaContext;\ndelete msg.payload.id;\n//node.warn({\"AppID Update user - Request\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 180,
        "wires": [
          [
            "8875d11e.92ef9"
          ]
        ]
      },
      {
        "id": "8875d11e.92ef9",
        "type": "http request",
        "z": "67ed0408.e2437c",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1380,
        "y": 180,
        "wires": [
          [
            "7cb661c7.ac4f"
          ]
        ]
      },
      {
        "id": "7cb661c7.ac4f",
        "type": "switch",
        "z": "67ed0408.e2437c",
        "name": "Error?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1550,
        "y": 180,
        "wires": [
          [
            "45b1df63.9e79a"
          ],
          [
            "819b0371.b7a78"
          ]
        ]
      },
      {
        "id": "45b1df63.9e79a",
        "type": "function",
        "z": "67ed0408.e2437c",
        "name": "AppID Update User Cleanup",
        "func": "msg.appid.user = msg.payload;\n\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nmsg.payload = {};\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1780,
        "y": 160,
        "wires": [
          [
            "febc43f3.28b13"
          ]
        ]
      },
      {
        "id": "819b0371.b7a78",
        "type": "function",
        "z": "67ed0408.e2437c",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nif(msg.payload.schemas) {\n    msg.errors.push({\n        \"code\": 412,\n        \"message\": {\n            \"code\": msg.payload.status,\n            \"description\": msg.payload.detail,\n            \"service\": \"appid\"\n        }\n    });\n} else {\n    msg.payload.service = \"appid\";\n    msg.errors.push({\n        \"code\": msg.statusCode,\n        \"message\": msg.payload\n    });\n}\nmsg.payload = {};\nif (msg.hasOwnProperty(\"req\")) {\n    return msg;\n} else {\n    node.warn({\"AppID Update User Error\": msg.errors[0]});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1750,
        "y": 260,
        "wires": [
          [
            "1d92a5f5.e4bf3a"
          ]
        ]
      },
      {
        "id": "120fbfbf.e3ce1",
        "type": "subflow:67ed0408.e2437c",
        "z": "68197f61.7975",
        "name": "",
        "x": 1210,
        "y": 120,
        "wires": [
          [
            "f5704060.0564c"
          ]
        ]
      },
      {
        "id": "7294442a.03530c",
        "type": "switch",
        "z": "68197f61.7975",
        "name": "doc_type",
        "property": "records.doc_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "user",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device",
            "vt": "str"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 1040,
        "y": 140,
        "wires": [
          [
            "120fbfbf.e3ce1"
          ],
          [
            "6f3869a9.e36078"
          ]
        ]
      },
      {
        "id": "1cc053ad.3cac6c",
        "type": "function",
        "z": "9791a478.8db8f8",
        "name": "debug",
        "func": "if(msg.api && msg.api.debug) {\n    node.warn({\"AppId Delete User\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2030,
        "y": 40,
        "wires": [
          []
        ]
      },
      {
        "id": "ba027845.9a4788",
        "type": "subflow:ab306e30.d0cc3",
        "z": "9791a478.8db8f8",
        "name": "",
        "x": 420,
        "y": 160,
        "wires": [
          [
            "8416becc.ffc55"
          ]
        ]
      },
      {
        "id": "14b60d65.d43573",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "9791a478.8db8f8",
        "name": "",
        "x": 1940,
        "y": 220,
        "wires": []
      },
      {
        "id": "f6e12cb0.b33c6",
        "type": "function",
        "z": "9791a478.8db8f8",
        "name": "AppID Find User",
        "func": "if (!msg.appid.hasOwnProperty(\"id\")) {\n    if (msg.appid.hasOwnProperty(\"user\") && msg.appid.user.hasOwnProperty(\"id\")) {\n        //update an already available AppID record.\n        msg.appid.id = msg.appid.user.id;\n    } else if (msg.hasOwnProperty(\"user\") && msg.user.length === 1 && msg.user[0].hasOwnProperty(\"idp_id\")) {\n        msg.appid.id = msg.user[0].idp_id;\n    } else if (msg.hasOwnProperty(\"user\") && msg.user.length === 1 && msg.user[0].hasOwnProperty(\"_id\")) {\n        var appID = global.get(\"APPID\");\n        var user_idx = appID.users.c_ids.indexOf(msg.user[0]._id);\n        if (user_idx >= 0) {\n            msg.appid.id = appid.users.idp_id[user_idx];\n        }\n    } else if (msg.hasOwnProperty(\"records\") && msg.records.hasOwnProperty(\"id\")){\n        var appID = global.get(\"APPID\");\n        var user_idx = appID.users.c_ids.indexOf(msg.records.id);\n        if (user_idx >= 0) {\n            msg.appid.id = appid.users.idp_id[user_idx];\n        }\n    }\n}\nif (msg.appid.hasOwnProperty(\"id\")) {\n    if(!msg.iam) { msg.iam = {} }\n    msg.iam.type = \"appid\";\n    return [null,msg];\n} else {\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 180,
        "y": 140,
        "wires": [
          [],
          [
            "ba027845.9a4788"
          ]
        ],
        "outputLabels": [
          "skip",
          "ok"
        ]
      },
      {
        "id": "8416becc.ffc55",
        "type": "function",
        "z": "9791a478.8db8f8",
        "name": "Get User",
        "func": "msg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.managementUrl;\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.method = \"GET\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.headers = msg.appid.headers;\nnode.warn({\"APP ID Get User To Delete\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 160,
        "wires": [
          [
            "b2015582.3bfbe8"
          ]
        ]
      },
      {
        "id": "b2015582.3bfbe8",
        "type": "http request",
        "z": "9791a478.8db8f8",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 800,
        "y": 160,
        "wires": [
          [
            "4d2890f7.3198a"
          ]
        ]
      },
      {
        "id": "4d2890f7.3198a",
        "type": "switch",
        "z": "9791a478.8db8f8",
        "name": "200?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "200",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 950,
        "y": 160,
        "wires": [
          [
            "957e0ad5.19e238"
          ],
          [
            "317e43aa.0b92dc"
          ]
        ]
      },
      {
        "id": "957e0ad5.19e238",
        "type": "function",
        "z": "9791a478.8db8f8",
        "name": "AppID Delete User",
        "func": "msg.appid.user = msg.payload;\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nmsg.payload = {};\nmsg.method = \"DELETE\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.headers = msg.appid.headers\nnode.warn({\"APP ID Delete User\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 140,
        "wires": [
          [
            "a1a1ecf4.4c93c"
          ]
        ]
      },
      {
        "id": "a1a1ecf4.4c93c",
        "type": "http request",
        "z": "9791a478.8db8f8",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 1380,
        "y": 140,
        "wires": [
          [
            "8fd82bbd.458fe8"
          ]
        ]
      },
      {
        "id": "8fd82bbd.458fe8",
        "type": "switch",
        "z": "9791a478.8db8f8",
        "name": "204?",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "204",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "404",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1550,
        "y": 140,
        "wires": [
          [
            "6a38926f.37894c"
          ],
          [
            "6a38926f.37894c"
          ],
          [
            "317e43aa.0b92dc"
          ]
        ]
      },
      {
        "id": "6a38926f.37894c",
        "type": "function",
        "z": "9791a478.8db8f8",
        "name": "AppID Delete User Cleanup",
        "func": "node.warn({\"APP ID User Deleted\": msg})\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nmsg.payload = {};\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1780,
        "y": 120,
        "wires": [
          [
            "1cc053ad.3cac6c",
            "e659294b.0af3d8"
          ]
        ]
      },
      {
        "id": "317e43aa.0b92dc",
        "type": "function",
        "z": "9791a478.8db8f8",
        "name": "AppID Error",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nif(msg.payload.schemas) {\n    msg.errors.push({\n        \"code\": 412,\n        \"message\": {\n            \"code\": msg.payload.status,\n            \"description\": msg.payload.detail,\n            \"service\": \"appid\"\n        }\n    });\n} else {\n    msg.payload.service = \"appid\";\n    msg.errors.push({\n        \"code\": msg.statusCode,\n        \"message\": msg.payload\n    });\n}\nmsg.payload = {};\nif (msg.hasOwnProperty(\"req\")) {\n    return msg;\n} else {\n    node.warn({\"AppID Delete User Error\": msg.errors[0]})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1750,
        "y": 220,
        "wires": [
          [
            "14b60d65.d43573"
          ]
        ]
      },
      {
        "id": "cd63132a.22867",
        "type": "subflow:9791a478.8db8f8",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1570,
        "y": 380,
        "wires": [
          [
            "d065780b.078158"
          ]
        ]
      },
      {
        "id": "e659294b.0af3d8",
        "type": "subflow:16e7afc8.9866e",
        "z": "9791a478.8db8f8",
        "name": "",
        "x": 2050,
        "y": 140,
        "wires": [
          []
        ]
      },
      {
        "id": "d75b2252.f82da",
        "type": "function",
        "z": "df6d98dd.00d378",
        "name": "provider_link",
        "func": "msg.records.provider_link = {\n    \"doc_type\": \"provider_link\",\n    \"status\": \"active\",\n    \"provider_id\": \"\",\n    \"consumer_id\": \"\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 580,
        "wires": [
          [
            "86fcedb.068ad1"
          ]
        ]
      },
      {
        "id": "fecc8b70.269468",
        "type": "switch",
        "z": "a17d8665.50cb88",
        "name": "Reason",
        "property": "inputs.reason",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "Setup",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "Technical Support",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "Another Issue",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1720,
        "y": 120,
        "wires": [
          [
            "3c679d5e.106a62"
          ],
          [
            "6aa306d8.afc768"
          ],
          [
            "d5884c06.42b66"
          ],
          [
            "eae3a578.634778"
          ]
        ]
      },
      {
        "id": "f862bbff.3874b8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "a17d8665.50cb88",
        "name": "",
        "x": 2190,
        "y": 120,
        "wires": [
          [
            "5d9fcfb4.b94d9"
          ]
        ]
      },
      {
        "id": "6aa306d8.afc768",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Technical Support",
        "func": "if (msg.hasOwnProperty(\"linked_user_ids\") && msg.linked_user_ids.length > 0) {\n    var linked_user_ids = msg.linked_user_ids.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Technical Support\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1930,
        "y": 120,
        "wires": [
          [
            "f862bbff.3874b8"
          ]
        ]
      },
      {
        "id": "3c679d5e.106a62",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Application Field Sales",
        "func": "if (msg.hasOwnProperty(\"linked_user_ids\") && msg.linked_user_ids.length > 0) {\n    var linked_user_ids = msg.linked_user_ids.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Applications\" }},\n                            {\"$elemMatch\": { \"$eq\": \"Field Sales\" }},\n                            {\"$elemMatch\": { \"$eq\": \"Sales Manager\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1950,
        "y": 80,
        "wires": [
          [
            "f862bbff.3874b8"
          ]
        ]
      },
      {
        "id": "eae3a578.634778",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Customer Service",
        "func": "if (msg.hasOwnProperty(\"linked_user_ids\") && msg.linked_user_ids.length > 0) {\n    var linked_user_ids = msg.linked_user_ids.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Customer Service\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1930,
        "y": 200,
        "wires": [
          [
            "f862bbff.3874b8"
          ]
        ]
      },
      {
        "id": "d5884c06.42b66",
        "type": "function",
        "z": "a17d8665.50cb88",
        "name": "Paired Lens Rep Service",
        "func": "if (msg.hasOwnProperty(\"linked_user_ids\") && msg.linked_user_ids.length > 0) {\n    var linked_user_ids = msg.linked_user_ids.map(a => a.user);\n    msg.cloudant = {\n        \"request\": \"/stellaris_documents/_find\",\n        \"method\": \"POST\",\n        \"return_obj\": \"docs\",\n        \"object\": \"support_users\",\n        \"selector\": {\n            \"$and\": [\n                {\"doc_type\": \"user\"},\n                {\"status\": \"active\"},\n                {\"_id\": {\"$in\": linked_user_ids}},\n                {\"sub_roles\": {\n                    \"$or\": [{\"$elemMatch\": { \"$eq\": \"Lens Rep\" }}]\n                    }\n                }]\n        }\n    };\n} else {\n    var linked_user_ids = [];\n    delete msg.cloudant;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1930,
        "y": 160,
        "wires": [
          [
            "f862bbff.3874b8"
          ]
        ]
      },
      {
        "id": "5b190553.9b57ec",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "APP ID Users",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 110,
        "y": 100,
        "wires": [
          [
            "c94de47d.6ad298"
          ]
        ]
      },
      {
        "id": "c94de47d.6ad298",
        "type": "subflow:16e7afc8.9866e",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 270,
        "y": 100,
        "wires": [
          [
            "96909685.696eb8"
          ]
        ]
      },
      {
        "id": "96909685.696eb8",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Cloudant vs APP ID",
        "func": "msg.api = {\n    debug: true\n}\nvar appid = global.get(\"APPID\").users;\nvar cloudant = global.get(\"CLOUDANT\").users;\nmsg.appid_update = [];\nvar update = null;\nmsg.appid_create = [];\nvar create = null;\nmsg.cloudant_update = [];\nvar c_update = null;\nvar appid_fields = [\"last_name\", \"first_name\", \"email\", \"mobile_phone\", \"voice_phone\", \"role\"]; //\"password\", \"sub_roles\" \ncloudant.c_ids.forEach(function(id,idx){\n    if(cloudant.records[idx].email !== \"\") {\n        var appid_u_idx = appid.c_ids.indexOf(id)\n        if(appid_u_idx === -1) { appid_u_idx = appid.emails.indexOf(cloudant.emails[idx])}\n        if(appid_u_idx >= 0) {\n            //node.warn(\"cloudant_u_idx: \" + idx)\n            //node.warn(\"appid_u_idx: \" + appid_u_idx)\n            var u_a = appid.records[appid_u_idx];\n            var u_c = cloudant.records[idx];\n            var updates = { };\n            var c_updates = { };\n            Object.keys(u_c).forEach(function(field){\n                if(appid_fields.indexOf(field) >= 0 || field === \"_id\"){\n                    if(Array.isArray(u_c[field])) {\n                        var equal = true;\n                        if(u_a[field]) {\n                            u_c[field].forEach(function(elm){\n                               equal = equal && (u_a[field].indexOf(elm) >= 0);\n                            })\n                            if(!equal) { updates[field] = u_c[field] }\n                        } else {\n                            updates[field] = u_c[field];\n                        }\n                    } else {\n                        if(field === \"_id\") {\n                            if(u_a.c_id !== u_c[field] && u_c[field] !== \"\") { updates.c_id = u_c[field] }\n                        } else {\n                            if(u_a[field] !== u_c[field] && u_c[field] !== \"\") { updates[field] = u_c[field] }\n                        }\n                    }\n                }\n            });\n            if(Object.keys(updates).length > 0) {\n                updates.c_id = u_c._id;\n                updates.idp_id = u_a.idp_id;\n                updates.c_idx = idx;\n                updates.a_idx = appid_u_idx;\n                msg.appid_update.push(updates);\n            }\n            if(!u_c.idp_id || u_c.idp_id === \"\") {\n                c_updates.c_id = u_c._id;\n                c_updates.idp_id = u_a.idp_id;\n                c_updates.c_idx = idx;\n                c_updates.a_idx = appid_u_idx;\n                c_updates.record = u_c;\n                c_updates.record.idp_id = u_a.idp_id;\n                msg.cloudant_update.push(c_updates);\n            }\n        } else {\n            var creates = { };\n            creates.id = cloudant.records[idx]._id;\n            creates.idx = idx;\n            creates.record = cloudant.records[idx];\n            msg.appid_create.push(creates);\n        }\n    }\n});\nvar cloudant = global.get(\"VCAP_CLOUDANT\");\nmsg.cloudant = {\n    \"db_table\": \"stellaris_documents\",\n    \"server\": \"https://\" + cloudant.credentials.host,\n    \"headers\": {\n        \"Authorization\": \"Basic \" + Buffer.from(cloudant.credentials.username + ':' + cloudant.credentials.password).toString('base64')\n    }\n};\nnode.warn(msg)\nif(msg.appid_create.length >= 0) {\n    create = msg;\n    create.records = {\n        \"doc_type\": \"user\", \n        \"object\": \"user\"\n    };\n    create.inputs = {\n        \"body\": {}\n    }\n}\nif(msg.appid_update.length >= 0) {\n    update = msg;\n    update.records = {\n        \"doc_type\": \"user\", \n        \"object\": \"user\"\n    };\n    update.inputs = {\n        \"body\": {}\n    }\n}\nif(msg.cloudant_update.length >= 0) {\n    c_update = msg;\n    c_update.records = {\n        \"doc_type\": \"user\", \n        \"object\": \"user\"\n    };\n    c_update.inputs = {\n        \"body\": {}\n    }\n}\nreturn [update, create, c_update];",
        "outputs": 3,
        "noerr": 0,
        "x": 460,
        "y": 100,
        "wires": [
          [
            "9e0759f.8c95ca8"
          ],
          [
            "7dab04eb.e9847c"
          ],
          [
            "ad030d05.9dc4d"
          ]
        ],
        "outputLabels": [
          "Update APP ID",
          "Create",
          "Update Cloudant"
        ]
      },
      {
        "id": "9e0759f.8c95ca8",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Update APP ID",
        "func": "var cloudant = global.get(\"CLOUDANT\").users.records;\nif(msg.appid_update.length > 0) {\n    user = msg.appid_update.pop();\n    msg.c_idx = user.c_idx;\n    msg.a_idx = user.a_idx;\n    delete user.c_idx;\n    delete user.a_idx;\n    msg.records.id = user.c_id;\n    //delete user.c_id;\n    msg.inputs.body = user;\n    msg.appid = {\n        \"id\": user.idp_id,\n    };\n    delete user.idp_id;\n    msg.appid.updates = user;\n    msg.user = [cloudant[msg.c_idx]]\n    //node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 80,
        "wires": [
          [
            "75d68f55.1dc85",
            "25e4b999.4eba86"
          ]
        ]
      },
      {
        "id": "75d68f55.1dc85",
        "type": "subflow:67ed0408.e2437c",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 950,
        "y": 80,
        "wires": [
          []
        ]
      },
      {
        "id": "7dab04eb.e9847c",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Create APP ID",
        "func": "var cloudant = global.get(\"CLOUDANT\").users.records;\nif(msg.appid_create.length > 0) {\n    user = msg.appid_create.pop();\n    msg.records.user = user.record;\n    if(msg.records.user.password === \"\") { msg.records.user.password = \"Not.1Pwd\"}\n    /*if(msg.records.user.hasOwnProperty(\"password\")){\n        var password_regex = new RegExp(global.get(\"REGEXP\").password,\"g\");\n        if(typeof msg.records.user.password !== 'string' || (!password_regex.test(msg.records.user.password))) {\n            msg.records.user.password = (msg.records.user.password + \".Bl123456\").substring(0,8);\n        }\n    }*/\n    node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 180,
        "wires": [
          [
            "cc7bdb50.999458",
            "8308b450.ee63e8"
          ]
        ]
      },
      {
        "id": "cc7bdb50.999458",
        "type": "subflow:12505187.8b5d0e",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 950,
        "y": 180,
        "wires": [
          [
            "65c55d25.526784"
          ]
        ]
      },
      {
        "id": "65c55d25.526784",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "User idp_id",
        "func": "if (msg.appid.hasOwnProperty(\"user\") && msg.appid.user.hasOwnProperty(\"id\")) {\n    msg.records[msg.records.object].idp_id = msg.records.idp_id;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 180,
        "wires": [
          [
            "af869e06.6928"
          ]
        ]
      },
      {
        "id": "af869e06.6928",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Setup Cloudant Insert",
        "func": "msg.url = msg.cloudant.server + \"/\" + msg.cloudant.db_table;\nmsg.headers = msg.cloudant.headers;\nmsg.cloudant.body = msg.records[msg.records.object]\nmsg.payload = msg.cloudant.body;\n//node.warn({\"cloudant Insert\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1320,
        "y": 180,
        "wires": [
          [
            "ba926487.28b428"
          ]
        ]
      },
      {
        "id": "bc207eed.0b91",
        "type": "http request",
        "z": "92b74b12.836b78",
        "name": "POST Request",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1740,
        "y": 180,
        "wires": [
          [
            "dc5c964.efa1b68"
          ]
        ]
      },
      {
        "id": "6a3e2cf3.c74d94",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Check and Warn",
        "func": "if(msg.payload.hasOwnProperty(\"ok\") && msg.payload.ok && msg.payload.hasOwnProperty(\"id\")) { \n    node.warn({\"Cloudant Link Created\": msg})\n} else {\n    node.warn({\"FAILED to Create to Update Cloudant\": msg})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2070,
        "y": 200,
        "wires": [
          []
        ]
      },
      {
        "id": "2d681fe.3cde1e",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Cloudant Query Limit Retry",
        "func": "msg.payload = msg.cloudant.body;\nmsg.headers = msg.cloudant.headers;",
        "outputs": 1,
        "noerr": 0,
        "x": 2100,
        "y": 160,
        "wires": [
          [
            "3a28752.8a4e28a"
          ]
        ],
        "outputLabels": [
          "retry"
        ]
      },
      {
        "id": "ba926487.28b428",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "Rate Limit 20msg/sec",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "20",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1540,
        "y": 180,
        "wires": [
          [
            "bc207eed.0b91"
          ]
        ]
      },
      {
        "id": "3330835f.8d9c4c",
        "type": "link in",
        "z": "92b74b12.836b78",
        "name": "Cloudant Update in",
        "links": [
          "3a28752.8a4e28a"
        ],
        "x": 1400,
        "y": 240,
        "wires": [
          [
            "ba926487.28b428"
          ]
        ]
      },
      {
        "id": "3a28752.8a4e28a",
        "type": "link out",
        "z": "92b74b12.836b78",
        "name": "Cloudant Update out",
        "links": [
          "3330835f.8d9c4c"
        ],
        "x": 2275,
        "y": 160,
        "wires": []
      },
      {
        "id": "dc5c964.efa1b68",
        "type": "switch",
        "z": "92b74b12.836b78",
        "name": "429",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "429",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1890,
        "y": 180,
        "wires": [
          [
            "2d681fe.3cde1e"
          ],
          [
            "6a3e2cf3.c74d94"
          ]
        ]
      },
      {
        "id": "ad030d05.9dc4d",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Update Cloudant idp_id",
        "func": "var cloudant = global.get(\"CLOUDANT\").users.records;\nif(msg.cloudant_update.length > 0) {\n    user = msg.cloudant_update.pop();\n    msg.records.user = user.record;\n    node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 280,
        "wires": [
          [
            "af869e06.6928",
            "6ad636a6.d56bf8"
          ]
        ]
      },
      {
        "id": "3bb8e474.ba6abc",
        "type": "switch",
        "z": "68197f61.7975",
        "name": "doc_type",
        "property": "records.doc_type",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "user",
            "vt": "str"
          },
          {
            "t": "eq",
            "v": "device",
            "vt": "str"
          }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 1040,
        "y": 240,
        "wires": [
          [
            "451fd57.ddc742c"
          ],
          [
            "5767abd4.2b63a4"
          ]
        ]
      },
      {
        "id": "451fd57.ddc742c",
        "type": "subflow:12505187.8b5d0e",
        "z": "68197f61.7975",
        "name": "",
        "x": 1210,
        "y": 220,
        "wires": [
          [
            "f5704060.0564c"
          ]
        ]
      },
      {
        "id": "5767abd4.2b63a4",
        "type": "subflow:3cbceae5.45c156",
        "z": "68197f61.7975",
        "name": "",
        "x": 1210,
        "y": 260,
        "wires": [
          [
            "f5704060.0564c"
          ]
        ]
      },
      {
        "id": "9dd93110.befca",
        "type": "subflow:67ed0408.e2437c",
        "z": "e0cd8199.1ad77",
        "name": "",
        "x": 3150,
        "y": 200,
        "wires": [
          [
            "25a03c33.80a984"
          ]
        ]
      },
      {
        "id": "2cddf891.d4a998",
        "type": "function",
        "z": "e0cd8199.1ad77",
        "name": "User _id",
        "func": "if(msg.appid) {\n    if (msg.appid[msg.records.object] && msg.appid[msg.records.object].entitlements && msg.appid[msg.records.object].entitlements.length > 0) {\n        var bl_cloud = msg.appid[msg.records.object].entitlements[0].bl_cloud\n        if(!bl_cloud.c_id || bl_cloud.c_id === \"\") {\n            msg.appid.updates = {\n                \"c_id\": msg.records.id\n            }\n        }\n        node.warn({\"Update _id in APPID\": msg})\n        return [msg,null];\n    }\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 2960,
        "y": 220,
        "wires": [
          [
            "9dd93110.befca"
          ],
          [
            "25a03c33.80a984"
          ]
        ],
        "outputLabels": [
          "update",
          "skip"
        ]
      },
      {
        "id": "78633f99.a1d35",
        "type": "subflow:16e7afc8.9866e",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 290,
        "y": 720,
        "wires": [
          [
            "7a6a50ca.ffcde"
          ]
        ]
      },
      {
        "id": "67347cf9.c14434",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "APP ID Devices",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 120,
        "y": 720,
        "wires": [
          [
            "78633f99.a1d35"
          ]
        ]
      },
      {
        "id": "7a6a50ca.ffcde",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Cloudant vs APP ID",
        "func": "msg.api = {\n    debug: true\n}\nvar appid = global.get(\"APPID\").devices;\nvar cloudant = global.get(\"CLOUDANT\").devices;\nmsg.appid_update = [];\nvar update = null;\nmsg.appid_create = [];\nvar create = null;\nmsg.cloudant_update = [];\nvar c_update = null;\nvar appid_fields = [\"idp_id\",\"c_id\",\"email\",\"system_type\"];\ncloudant.c_ids.forEach(function(id,idx){\n    if(cloudant.records[idx]._id !== \"\") {\n        var appid_d_idx = appid.c_ids.indexOf(id)\n        if(appid_d_idx >= 0) {\n            var d_a = appid.records[appid_d_idx];\n            var d_c = cloudant.records[idx];\n            var updates = { };\n            var c_updates = { };\n            Object.keys(d_c).forEach(function(field){\n                if(appid_fields.indexOf(field) >= 0 || field === \"_id\"){\n                    if(Array.isArray(d_c[field])) {\n                        var equal = true;\n                        if(d_a[field]) {\n                            d_c[field].forEach(function(elm){\n                               equal = equal && (d_a[field].indexOf(elm) >= 0);\n                            })\n                            if(!equal) { updates[field] = d_c[field] }\n                        } else {\n                            updates[field] = d_c[field];\n                        }\n                    } else {\n                        if(field === \"_id\") {\n                            if(d_a.c_id !== d_c[field] && d_c[field] !== \"\") { updates.c_id = d_c[field] }\n                        } else {\n                            if(d_a[field] !== d_c[field] && d_c[field] !== \"\") { updates[field] = d_c[field] }\n                        }\n                    }\n                }\n            });\n            if(Object.keys(updates).length > 0) {\n                updates.c_id = d_c._id;\n                updates.idp_id = d_a.idp_id;\n                updates.c_idx = idx;\n                updates.a_idx = appid_d_idx;\n                msg.appid_update.push(updates);\n            }\n            if(!d_c.idp_id || d_c.idp_id === \"\" || !d_c.email) {\n                c_updates.c_id = d_c._id;\n                c_updates.idp_id = d_a.idp_id;\n                c_updates.c_idx = idx;\n                c_updates.a_idx = appid_d_idx;\n                c_updates.record = d_c;\n                c_updates.record.idp_id = d_a.idp_id;\n                c_updates.record.email = d_a.email;\n                msg.cloudant_update.push(c_updates);\n            }\n        } else {\n            var creates = { };\n            creates.id = cloudant.records[idx]._id;\n            creates.idx = idx;\n            creates.record = cloudant.records[idx];\n            msg.appid_create.push(creates);\n        }\n    }\n});\nvar cloudant = global.get(\"VCAP_CLOUDANT\");\nmsg.cloudant = {\n    \"db_table\": \"stellaris_documents\",\n    \"server\": \"https://\" + cloudant.credentials.host,\n    \"headers\": {\n        \"Authorization\": \"Basic \" + Buffer.from(cloudant.credentials.username + ':' + cloudant.credentials.password).toString('base64')\n    }\n};\nnode.warn(msg)\nif(msg.appid_create.length >= 0) {\n    create = msg;\n    create.records = {\n        \"doc_type\": \"device\", \n        \"object\": \"device\"\n    };\n    create.inputs = {\n        \"body\": {}\n    }\n}\nif(msg.appid_update.length >= 0) {\n    update = msg;\n    update.records = {\n        \"doc_type\": \"device\", \n        \"object\": \"device\"\n    };\n    update.inputs = {\n        \"body\": {}\n    }\n}\nif(msg.cloudant_update.length >= 0) {\n    c_update = msg;\n    c_update.records = {\n        \"doc_type\": \"device\", \n        \"object\": \"device\"\n    };\n    c_update.inputs = {\n        \"body\": {}\n    }\n}\nreturn [update, create, c_update];",
        "outputs": 3,
        "noerr": 0,
        "x": 470,
        "y": 720,
        "wires": [
          [
            "296d6869.3d2868"
          ],
          [
            "40c4a028.469d7"
          ],
          [
            "b8ee31a2.d6ac2"
          ]
        ],
        "outputLabels": [
          "Update APP ID",
          "Create",
          "Update Cloudant"
        ]
      },
      {
        "id": "296d6869.3d2868",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Update APP ID",
        "func": "var cloudant = global.get(\"CLOUDANT\").users.records;\nif(msg.appid_update.length > 0) {\n    user = msg.appid_update.pop();\n    msg.c_idx = user.c_idx;\n    msg.a_idx = user.a_idx;\n    delete user.c_idx;\n    delete user.a_idx;\n    msg.records.id = user.c_id;\n    //delete user.c_id;\n    msg.inputs.body = user;\n    msg.appid = {\n        \"id\": user.idp_id,\n    };\n    delete user.idp_id;\n    msg.appid.updates = user;\n    msg.user = [cloudant[msg.c_idx]]\n    //node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 700,
        "wires": [
          [
            "c1e66121.603b7",
            "26cfad83.10e562"
          ]
        ]
      },
      {
        "id": "40c4a028.469d7",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Create APP ID",
        "func": "var genPwd = global.get(\"genpwd\");\nvar cloudant = global.get(\"CLOUDANT\").devices.records;\nif(msg.appid_create.length > 0) {\n    device = msg.appid_create.pop();\n    msg.records.device = device.record;\n    if(!msg.records.password || msg.records.device.password === \"\") {\n        msg.records.password = genPwd.generate(global.get(\"PWD_GEN\"));\n        msg.records.device.password = msg.records.password;\n    }\n    /*if(msg.records.device.hasOwnProperty(\"password\")){\n        var password_regex = new RegExp(global.get(\"REGEXP\").password,\"g\");\n        if(typeof msg.records.device.password !== 'string' || (!password_regex.test(msg.records.device.password))) {\n            msg.records.device.password = (msg.records.device.password + \".Bl123456\").substring(0,8);\n        }\n    }*/\n    node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 720,
        "y": 800,
        "wires": [
          [
            "f8106a50.4a9638",
            "27163815.04e0a8"
          ]
        ]
      },
      {
        "id": "b8ee31a2.d6ac2",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Update Cloudant idp_id",
        "func": "var cloudant = global.get(\"CLOUDANT\").devices.records;\nif(msg.cloudant_update.length > 0) {\n    device = msg.cloudant_update.pop();\n    msg.records.device = device.record;\n    node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 900,
        "wires": [
          [
            "271684f7.646f7c",
            "a967331c.b112"
          ]
        ]
      },
      {
        "id": "51720b16.1f9954",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "Rate Limit 20msg/sec",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "20",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1580,
        "y": 800,
        "wires": [
          [
            "3bed7796.a42fe8"
          ]
        ]
      },
      {
        "id": "3bed7796.a42fe8",
        "type": "http request",
        "z": "92b74b12.836b78",
        "name": "POST Request",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1780,
        "y": 800,
        "wires": [
          [
            "408b1367.2b750c"
          ]
        ]
      },
      {
        "id": "c8501d0a.e5d3c",
        "type": "link in",
        "z": "92b74b12.836b78",
        "name": "Cloudant Update in",
        "links": [
          "2314eb4f.de3e04"
        ],
        "x": 1420,
        "y": 860,
        "wires": [
          [
            "51720b16.1f9954"
          ]
        ]
      },
      {
        "id": "408b1367.2b750c",
        "type": "switch",
        "z": "92b74b12.836b78",
        "name": "429",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
          {
            "t": "eq",
            "v": "429",
            "vt": "str"
          },
          {
            "t": "else"
          }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1930,
        "y": 800,
        "wires": [
          [
            "6ccabdc8.b724f4"
          ],
          [
            "e85ebd88.55ab7"
          ]
        ]
      },
      {
        "id": "6ccabdc8.b724f4",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Cloudant Query Limit Retry",
        "func": "msg.payload = msg.cloudant.body;\nmsg.headers = msg.cloudant.headers;",
        "outputs": 1,
        "noerr": 0,
        "x": 2140,
        "y": 780,
        "wires": [
          [
            "2314eb4f.de3e04"
          ]
        ],
        "outputLabels": [
          "retry"
        ]
      },
      {
        "id": "e85ebd88.55ab7",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Check and Warn",
        "func": "if(msg.payload.hasOwnProperty(\"ok\") && msg.payload.ok && msg.payload.hasOwnProperty(\"id\")) { \n    node.warn({\"Cloudant Link Created\": msg})\n} else {\n    node.warn({\"FAILED to Create to Update Cloudant\": msg})\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 2110,
        "y": 820,
        "wires": [
          []
        ]
      },
      {
        "id": "2314eb4f.de3e04",
        "type": "link out",
        "z": "92b74b12.836b78",
        "name": "Cloudant Update out",
        "links": [
          "c8501d0a.e5d3c"
        ],
        "x": 2315,
        "y": 780,
        "wires": []
      },
      {
        "id": "26cfad83.10e562",
        "type": "subflow:11fa1bee.eb6984",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 980,
        "y": 700,
        "wires": [
          []
        ]
      },
      {
        "id": "27163815.04e0a8",
        "type": "subflow:3cbceae5.45c156",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 970,
        "y": 800,
        "wires": [
          [
            "fcdc6788.a96a38"
          ]
        ]
      },
      {
        "id": "271684f7.646f7c",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Setup Cloudant Insert",
        "func": "msg.url = msg.cloudant.server + \"/\" + msg.cloudant.db_table;\nmsg.headers = msg.cloudant.headers;\nmsg.cloudant.body = msg.records[msg.records.object]\nmsg.payload = msg.cloudant.body;\n//node.warn({\"cloudant Insert\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 800,
        "wires": [
          [
            "51720b16.1f9954"
          ]
        ]
      },
      {
        "id": "fcdc6788.a96a38",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Device idp_id",
        "func": "if (msg.appid.hasOwnProperty(\"device\") && msg.appid.device.hasOwnProperty(\"id\")) {\n    msg.records[msg.records.object].idp_id = msg.records.idp_id;\n    msg.records[msg.records.object].password = msg.records.password;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1160,
        "y": 800,
        "wires": [
          [
            "271684f7.646f7c"
          ]
        ]
      },
      {
        "id": "2918ce69.71ace2",
        "type": "subflow:16e7afc8.9866e",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 290,
        "y": 1160,
        "wires": [
          [
            "727cae6a.f8bd9"
          ]
        ]
      },
      {
        "id": "6e51de9c.8c5c8",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "APP ID Devices",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 120,
        "y": 1160,
        "wires": [
          [
            "2918ce69.71ace2"
          ]
        ]
      },
      {
        "id": "727cae6a.f8bd9",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "APP ID vs Cloudant",
        "func": "msg.api = {\n    debug: true\n}\nvar appid = global.get(\"APPID\").devices;\nvar cloudant = global.get(\"CLOUDANT\").devices;\nmsg.appid_delete = [];\nappid.c_ids.forEach(function(id,idx){\n    if(cloudant.c_ids.indexOf(id) < 0) {\n            msg.appid_delete.push(appid.idp_ids[idx]);\n    }\n})\nnode.warn(msg);\nif(msg.appid_delete.length >= 0) {\n    a_delete = msg;\n}\nreturn [a_delete];",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 1160,
        "wires": [
          [
            "f771aa48.27be58"
          ]
        ],
        "outputLabels": [
          "Update APP ID"
        ]
      },
      {
        "id": "f771aa48.27be58",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Delete APP ID",
        "func": "if(msg.appid_delete.length > 0) {\n    user = msg.appid_delete.pop();\n    msg.appid.id = user\n    node.warn(user)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 1160,
        "wires": [
          [
            "1ab84080.35e18",
            "e3a495c8.16ecd8"
          ]
        ]
      },
      {
        "id": "609f1982.3171a8",
        "type": "delay",
        "z": "16e7afc8.9866e",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "5",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 180,
        "y": 180,
        "wires": [
          [
            "3441d3ba.93abbc"
          ]
        ]
      },
      {
        "id": "79cd2c2f.4d0864",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Setup APP ID Delete",
        "func": "msg.method = \"DELETE\";\nmsg.url = msg.appid.mgmt_url + \"/cloud_directory/Users/\" + msg.appid.id;\nmsg.headers = msg.appid.headers;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1360,
        "y": 1160,
        "wires": [
          [
            "b68f6560.aad2b8"
          ]
        ]
      },
      {
        "id": "edb0de38.b1ce4",
        "type": "subflow:ab306e30.d0cc3",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 1160,
        "y": 1160,
        "wires": [
          [
            "79cd2c2f.4d0864"
          ]
        ]
      },
      {
        "id": "1ab84080.35e18",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "AppID Get Token",
        "func": "if (msg.appid.hasOwnProperty(\"id\")) {\n    if(!msg.iam) { msg.iam = {} }\n    msg.iam.type = \"appid\";\n    return msg\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 970,
        "y": 1160,
        "wires": [
          [
            "edb0de38.b1ce4"
          ]
        ],
        "outputLabels": [
          "skip"
        ]
      },
      {
        "id": "b68f6560.aad2b8",
        "type": "http request",
        "z": "92b74b12.836b78",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "txt",
        "url": "",
        "tls": "",
        "x": 1560,
        "y": 1160,
        "wires": [
          [
            "4201d651.b99128"
          ]
        ]
      },
      {
        "id": "4201d651.b99128",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "AppID User Deleted",
        "func": "if(msg.statusCode === 204 || msg.statusCode === 404 ){\n    node.warn(\"APP ID User Deleted: \" + msg.appid.id);\n} else {\n    node.warn(\"WARNING: Problem Deleting APP ID User: \" + msg.appid.id);\n}\n    ",
        "outputs": 1,
        "noerr": 0,
        "x": 1780,
        "y": 1160,
        "wires": [
          []
        ]
      },
      {
        "id": "a967331c.b112",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 740,
        "y": 940,
        "wires": [
          [
            "b8ee31a2.d6ac2"
          ]
        ]
      },
      {
        "id": "f8106a50.4a9638",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 720,
        "y": 840,
        "wires": [
          [
            "40c4a028.469d7"
          ]
        ]
      },
      {
        "id": "c1e66121.603b7",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 720,
        "y": 740,
        "wires": [
          [
            "296d6869.3d2868"
          ]
        ]
      },
      {
        "id": "6ad636a6.d56bf8",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 740,
        "y": 320,
        "wires": [
          [
            "ad030d05.9dc4d"
          ]
        ]
      },
      {
        "id": "8308b450.ee63e8",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 700.6666870117188,
        "y": 220,
        "wires": [
          [
            "7dab04eb.e9847c"
          ]
        ]
      },
      {
        "id": "25e4b999.4eba86",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 700,
        "y": 120,
        "wires": [
          [
            "9e0759f.8c95ca8"
          ]
        ]
      },
      {
        "id": "f8d88d89.52923",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Link Content",
        "func": "var dapp_user = msg[msg.records.object]\nmsg.content = dapp_user\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2360,
        "y": 900,
        "wires": [
          [
            "2ae62aa7.76b926"
          ]
        ]
      },
      {
        "id": "164ffc81.9542f3",
        "type": "function",
        "z": "429bd64.63fc828",
        "name": "Create Link Content",
        "func": "var dapp_user = msg[msg.records.object]\nmsg.content = dapp_user\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1980,
        "y": 1020,
        "wires": [
          [
            "be00f51e.4286d8"
          ]
        ]
      },
      {
        "id": "e3a495c8.16ecd8",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 740,
        "y": 1200,
        "wires": [
          [
            "f771aa48.27be58"
          ]
        ]
      },
      {
        "id": "e97a6c55.0cecc",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "Delete Empty EULA Users",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 150,
        "y": 400,
        "wires": [
          [
            "9cbe7c78.b28d1"
          ]
        ]
      },
      {
        "id": "9cbe7c78.b28d1",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Cloudant Users",
        "func": "if(!msg.api){msg.api = {}}\nmsg.start_time = Date.now();\nflow.set(\"appid\",false);\nflow.set(\"users\",false);\nflow.set(\"devices\",false);\nif(!msg.iam) {msg.iam = {}}\nmsg.iam.type = \"appid\";\nmsg.iam.mgmt = false;\nmsg.cloudant = {\n    \"request\": \"/stellaris_documents/_find\",\n    \"method\": \"POST\",\n    \"return_obj\": \"docs\",\n    \"object\": \"users\",\n    \"selector\": {\n        \"$and\": [\n        \t{ \"doc_type\": { \"$in\": [\"user\"] } },\n        \t{ \"eula_accept_status\": \"not accepted\" },\n        \t{ \"eula_create_date\": { \"$lt\": (Date.now() - 86400000) } },\n        \t{ \"eula_accept_date\": 0 },\n        \t{ \"idp_id\": { \"$exists\": false } }\n        \t]\n    },\n    \"fields\":  [\"_id\", \"_rev\"],\n    \"sort\": [{\"email:string\":\"asc\"}]\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 400,
        "wires": [
          [
            "4a497893.8b66e8"
          ]
        ]
      },
      {
        "id": "4a497893.8b66e8",
        "type": "subflow:d35dd8d5.3b2a88",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 570,
        "y": 400,
        "wires": [
          [
            "149f9d85.bd4462"
          ]
        ]
      },
      {
        "id": "149f9d85.bd4462",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Cloudant Users Cleanup",
        "func": "if(msg.users && msg.users.length >0 ){\n    msg.users.forEach(function(user){\n        user[\"_deleted\"] =  true;\n    })\n    msg.payload.docs = msg.users;\n    msg.headers = msg.cloudant.headers;\n    msg.url = msg.cloudant.server + \"/stellaris_documents/_bulk_docs\";\n    node.warn(msg)\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 400,
        "wires": [
          [
            "6e8ab9a2.394bc8"
          ]
        ]
      },
      {
        "id": "6e8ab9a2.394bc8",
        "type": "http request",
        "z": "92b74b12.836b78",
        "name": "Bulk Delete",
        "method": "POST",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1010,
        "y": 400,
        "wires": [
          [
            "7443fd98.33ccd4"
          ]
        ]
      },
      {
        "id": "7443fd98.33ccd4",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Bulk Update Returns",
        "func": "if (Array.isArray(msg.payload)) {\n    msg.bulk_update = msg.payload;\n    msg.deleted_ids = msg.payload.map(a => a.id);\n}\ndelete msg.method;\ndelete msg.url;\ndelete msg.responseUrl;\ndelete msg.headers;\ndelete msg.statusCode;\nnode.warn({\"WARNING: EULA User Bulk Deleted\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1200,
        "y": 400,
        "wires": [
          []
        ]
      },
      {
        "id": "c1daf3ae.7aca9",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "Cloudant vs AppID",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 130,
        "y": 480,
        "wires": [
          [
            "e0c97a1.8681488"
          ]
        ]
      },
      {
        "id": "e0c97a1.8681488",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Cloudant Users",
        "func": "var cloudant = global.get(\"CLOUDANT\").users;\nvar appid = global.get(\"APPID\").users;\nmsg.cloudant_missing = [];\nmsg.appid_missing = [];\ncloudant.idp_ids.forEach(function(idp_id,c_idx) {\n    var a_idx = appid.idp_ids.indexOf(idp_id);\n    if( a_idx < 0) {\n        msg.cloudant_missing.push(cloudant.records[c_idx])\n    }\n})\nappid.c_ids.forEach(function(c_id,a_idx) {\n    var c_idx = cloudant.c_ids.indexOf(c_id);\n    if( c_idx < 0) {\n        msg.appid_missing.push(appid.records[a_idx])\n    }\n})\n// find duplicates\nmsg.cloudant_dup = [];\ncloudant.idp_ids.forEach(function(idp_id,c_idx){\n    var dup_idx = cloudant.idp_ids.indexOf(idp_id,c_idx+1)\n    if(dup_idx >= 0) {\n        msg.cloudant_dup.push(cloudant.records[c_idx]);\n        msg.cloudant_dup.push(cloudant.records[dup_idx]);\n    }\n})\nmsg.appid_dup = [];\nappid.c_ids.forEach(function(c_id,a_idx){\n    var dup_idx = appid.c_ids.indexOf(c_id,a_idx+1)\n    if(dup_idx >= 0) {\n        msg.appid_dup.push(appid.records[c_idx]);\n        msg.appid_dup.push(appid.records[dup_idx]);\n    }\n})\nnode.warn({\"Cloudant vs AppID\": msg});\nif(msg.appid_missing.length > 0) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 480,
        "wires": [
          [
            "98c50352.40653"
          ]
        ]
      },
      {
        "id": "20c938ed.aaac68",
        "type": "subflow:9791a478.8db8f8",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 770,
        "y": 480,
        "wires": [
          []
        ]
      },
      {
        "id": "98c50352.40653",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Delete APP ID",
        "func": "if(msg.appid_missing.length > 0) {\n    if(!msg.appid) {msg.appid = {} }\n    msg.appid.id = msg.appid_missing.pop().idp_id;\n    node.warn({\"Deleting AppID user\": msg})\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 560,
        "y": 480,
        "wires": [
          [
            "cfe7f6.2abdd808",
            "20c938ed.aaac68"
          ]
        ]
      },
      {
        "id": "cfe7f6.2abdd808",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 560.6666870117188,
        "y": 520,
        "wires": [
          [
            "98c50352.40653"
          ]
        ]
      },
      {
        "id": "31c97bd0.51ccf4",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "Check Cloudant Users",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 140,
        "y": 580,
        "wires": [
          [
            "4e5eaec7.d952c"
          ]
        ]
      },
      {
        "id": "d723c97.f209b38",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Cloudant Users",
        "func": "var cloudant = global.get(\"CLOUDANT\").users;\nmsg.problems = {};\nmsg.total_users = cloudant.records.length;\ncloudant.records.forEach(function(user,idx){\n    user.bad = {};\n    var  model_keys = Object.keys(msg.records.user);\n    var user_keys = Object.keys(user);\n    model_keys.forEach(function(key){\n        if(user.hasOwnProperty(key)) {\n            switch (key) {\n                case \"status\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"role\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    if(user[key] !== \"\" && [\"Surgeon\",\"Sales\",\"Service\",\"R&D\",\"Data Analyst\"].indexOf(user[key]) < 0 ) { user.bad[key] = \"VALUE NOT SUPPORTED\" }\n                    break;\n                case \"sub_roles\":\n                    if(!Array.isArray(user[key])) { user.bad[key] = \"MUST BE AN ARRAY\" }\n                    if(Array.isArray(user[key]) && user[key].length === 0 && user.role !== \"Surgeon\") { user.bad[key] = \"MUST BE AN ARRAY OF 1 VALUE MIN\" }\n                    break;\n                case \"uid\":\n                    break;\n                case \"first_name\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"last_name\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"mobile_number\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"email\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"gets_change_email\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    if(typeof user[key] !== \"boolean\") { user.bad[key] = \"MUST BE BOOLEAN\" }\n                    break;\n                case \"bart_sart\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    if(user[key] !== \"\" && [\"bart\",\"sart\"].indexOf(user[key]) < 0 ) { user.bad[key] = \"VALUE NOT SUPPORTED\" }\n                    break;\n                case \"business_unit\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"sales_area\":\n                    if(user[key] === \"\" && (user.bart_sart === \"bart\" || user.bart_sart === \"\")) { user.bad[key] = \"EMPTY NOT ALLOWED for BART\" }\n                    break;\n                case \"sales_region\":\n                    if(user[key] === \"\" && (user.bart_sart === \"bart\" || user.bart_sart === \"\")) { user.bad[key] = \"EMPTY NOT ALLOWED for BART\" }\n                    break;\n                case \"sales_territory\":\n                    if(user[key] === \"\" && (user.bart_sart === \"bart\" || user.bart_sart === \"\")) { user.bad[key] = \"EMPTY NOT ALLOWED for BART\" }\n                    break;\n                case \"service_area\":\n                    if(user[key] === \"\" && (user.bart_sart === \"sart\" || user.bart_sart === \"\")) { user.bad[key] = \"EMPTY NOT ALLOWED for SART\" }\n                    break;\n                case \"service_region\":\n                    if(user[key] === \"\" && (user.bart_sart === \"sart\" || user.bart_sart === \"\")) { user.bad[key] = \"EMPTY NOT ALLOWED for SART\" }\n                    break;\n                case \"service_territory\":\n                    if(user[key] === \"\" && (user.bart_sart === \"sart\" || user.bart_sart === \"\")) { user.bad[key] = \"EMPTY NOT ALLOWED for SART\" }\n                    break;\n                case \"created_by\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"eula_create_date\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    if(user[key] === 0) { user.bad[key] = \"0 NOT ALLOWED\" }\n                    break;\n                case \"eula_accept_status\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n                case \"eula_accept_date\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    if(user[key] === 0) { user.bad[key] = \"0 NOT ALLOWED\" }\n                    break;\n                case \"remote_access_allowed\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    if(typeof user[key] !== \"boolean\") { user.bad[key] = \"MUST BE BOOLEAN\" }\n                    break;\n                case \"ipd_id\":\n                    if(user[key] === \"\") { user.bad[key] = \"EMPTY NOT ALLOWED\" }\n                    break;\n            }\n        } else {\n            user.bad[key] = \"MISSING\";\n        }\n    })\n    user_keys.forEach(function(key){\n        if(model_keys.indexOf(key) < 0 && [\"_id\",\"_rev\",\"voice_phone\",\"bad\"].indexOf(key) < 0){\n            user.bad[key] = \"FIELD NOT IN MODEL\"\n        }\n    })\n    var bad_keys = Object.keys(user.bad);\n    if(bad_keys.length > 0) {\n        if(!msg.bad_users) { msg.bad_users = [] }\n        msg.bad_users.push(user);\n        bad_keys.forEach(function(key){\n            if(!msg.problems[key]) { msg.problems[key] = [] }\n            msg.problems[key].push(user)\n        })\n    } else {\n        if(!msg.good_users) { msg.good_users = [] }\n        msg.good_users.push(user);\n    }\n})\nnode.warn({\"Bad Users\":msg})",
        "outputs": 1,
        "noerr": 0,
        "x": 730,
        "y": 580,
        "wires": [
          []
        ]
      },
      {
        "id": "91e60436.08bbc8",
        "type": "subflow:df6d98dd.00d378",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 530,
        "y": 580,
        "wires": [
          [
            "d723c97.f209b38"
          ]
        ]
      },
      {
        "id": "4e5eaec7.d952c",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get User Model",
        "func": "msg.records = {\n    \"models\": [\"user\"]\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 340,
        "y": 580,
        "wires": [
          [
            "91e60436.08bbc8"
          ]
        ]
      },
      {
        "id": "ad9c9a29.83de58",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "Cloudant vs AppID",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 130,
        "y": 1000,
        "wires": [
          [
            "c4cef156.e681b"
          ]
        ]
      },
      {
        "id": "c4cef156.e681b",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Cloudant Devices",
        "func": "var cloudant = global.get(\"CLOUDANT\").devices;\nvar appid = global.get(\"APPID\").devices;\nmsg.cloudant_missing = [];\nmsg.appid_missing = [];\ncloudant.idp_ids.forEach(function(idp_id,c_idx) {\n    var a_idx = appid.idp_ids.indexOf(idp_id);\n    if( a_idx < 0) {\n        msg.cloudant_missing.push(cloudant.records[c_idx])\n    }\n})\nappid.c_ids.forEach(function(c_id,a_idx) {\n    var c_idx = cloudant.c_ids.indexOf(c_id);\n    if( c_idx < 0) {\n        msg.appid_missing.push(appid.records[a_idx])\n    }\n})\n// find duplicates\nmsg.cloudant_dup = [];\ncloudant.idp_ids.forEach(function(idp_id,c_idx){\n    var dup_idx = cloudant.idp_ids.indexOf(idp_id,c_idx+1)\n    if(dup_idx >= 0) {\n        msg.cloudant_dup.push(cloudant.records[c_idx]);\n        msg.cloudant_dup.push(cloudant.records[dup_idx]);\n    }\n})\nmsg.appid_dup = [];\nappid.c_ids.forEach(function(c_id,a_idx){\n    var dup_idx = appid.c_ids.indexOf(c_id,a_idx+1)\n    if(dup_idx >= 0) {\n        msg.appid_dup.push(appid.records[c_idx]);\n        msg.appid_dup.push(appid.records[dup_idx]);\n    }\n})\nnode.warn({\"Cloudant vs AppID\": msg});\nif(msg.appid_missing.length > 0) {\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 1000,
        "wires": [
          [
            "8bc2dff6.1f88e"
          ]
        ]
      },
      {
        "id": "7ff4fe96.8526b",
        "type": "subflow:9791a478.8db8f8",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 810,
        "y": 1000,
        "wires": [
          []
        ]
      },
      {
        "id": "8bc2dff6.1f88e",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Delete APP ID",
        "func": "if(msg.appid_missing.length > 0) {\n    if(!msg.appid) {msg.appid = {} }\n    msg.appid.id = msg.appid_missing.pop().idp_id;\n    node.warn({\"Deleting AppID user\": msg})\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 1000,
        "wires": [
          [
            "f638be04.2791f",
            "7ff4fe96.8526b"
          ]
        ]
      },
      {
        "id": "f638be04.2791f",
        "type": "delay",
        "z": "92b74b12.836b78",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 600.6666870117188,
        "y": 1040,
        "wires": [
          [
            "8bc2dff6.1f88e"
          ]
        ]
      },
      {
        "id": "4419957b.11d7fc",
        "type": "subflow:3962857e.44abba",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 490,
        "y": 2280,
        "wires": [
          [
            "4de32139.9a97"
          ]
        ]
      },
      {
        "id": "4de32139.9a97",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Info AppID",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"User Info AppID\"\n    });\nmsg.records = {\n    \"doc_type\": \"user\",\n    \"object\": \"user\",\n    \"format\": \"JSON\",\n    \"returns\": [\"user\"],\n    \"id\": msg.req.params.userID\n};\nvar appid_users = global.get(\"APPID\").users\nmsg.user = [appid_users.records[appid_users.c_ids.indexOf(msg.records.id)]]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 2280,
        "wires": [
          [
            "337f46aa.6006ea"
          ]
        ]
      },
      {
        "id": "3210fa78.a284b6",
        "type": "http in",
        "z": "1dff07f1.603c08",
        "name": "",
        "url": "/users/user/:userID/appid",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 2280,
        "wires": [
          [
            "1be0df5b.e90391"
          ]
        ]
      },
      {
        "id": "2282ccc2.7ea4a4",
        "type": "subflow:bc6ff87.05a2908",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1050,
        "y": 2260,
        "wires": []
      },
      {
        "id": "5bc4d822.7c9658",
        "type": "comment",
        "z": "1dff07f1.603c08",
        "name": "*[ ] User Info AppID",
        "info": "Checks and returns user AppID info if it exists",
        "x": 110,
        "y": 2240,
        "wires": []
      },
      {
        "id": "71319811.7e2ee8",
        "type": "subflow:2638fa4d.cb43e6",
        "z": "1dff07f1.603c08",
        "name": "",
        "x": 1240,
        "y": 2300,
        "wires": []
      },
      {
        "id": "16872e79.ce6f22",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Not Found",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 400,\n    \"message\": \"User with id: \" + msg.records.id + \" was not found.\",\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 2300,
        "wires": [
          [
            "71319811.7e2ee8"
          ]
        ]
      },
      {
        "id": "337f46aa.6006ea",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "User Found?",
        "func": "if (msg.hasOwnProperty(\"user\") && msg.user.length > 0) {\n    return [msg,null];\n}\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 850,
        "y": 2280,
        "wires": [
          [
            "2282ccc2.7ea4a4"
          ],
          [
            "16872e79.ce6f22"
          ]
        ],
        "outputLabels": [
          "found",
          "not found"
        ]
      },
      {
        "id": "1be0df5b.e90391",
        "type": "function",
        "z": "1dff07f1.603c08",
        "name": "Enc",
        "func": "msg.force_encryption = true;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 2280,
        "wires": [
          [
            "4419957b.11d7fc"
          ]
        ]
      },
      {
        "id": "640ac807.e12c78",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/:deviceID/KORE/modify_plan_codes",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 1220,
        "wires": [
          [
            "3ff0e8c.7279e18"
          ]
        ]
      },
      {
        "id": "998c7add.6524b8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/:deviceID/KORE/device_status",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 900,
        "wires": [
          [
            "dc53ae32.cc78b"
          ]
        ]
      },
      {
        "id": "ee94c615.a6d3a8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/:deviceID/KORE/modify_device_custom_info",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 260,
        "y": 560,
        "wires": [
          [
            "ad4d16d7.a27ac8"
          ]
        ]
      },
      {
        "id": "6e258c55.f99a64",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/:deviceID/KORE/reactivate",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 380,
        "wires": [
          [
            "cc6048c0.ed4cf8"
          ]
        ]
      },
      {
        "id": "6aeae83f.6dd918",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/devices/device/:deviceID/KORE/activate_to_state",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 220,
        "y": 200,
        "wires": [
          [
            "6f3005b7.1b698c"
          ]
        ]
      },
      {
        "id": "aee4d49f.d7f7c8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/sim/reactivate",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 420,
        "wires": [
          [
            "cc6048c0.ed4cf8"
          ]
        ]
      },
      {
        "id": "e0ae0bf7.2d9ae8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/sim/modify_device_custom_info",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 600,
        "wires": [
          [
            "ad4d16d7.a27ac8"
          ]
        ]
      },
      {
        "id": "efc596bb.b6d6f8",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/sim/deactivate",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 740,
        "wires": [
          [
            "c393c069.a7c09"
          ]
        ]
      },
      {
        "id": "3b1ea62d.032d9a",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/sim/status",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 940,
        "wires": [
          [
            "dc53ae32.cc78b"
          ]
        ]
      },
      {
        "id": "620136a4.0c9928",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/plan_codes",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 1080,
        "wires": [
          [
            "b5c4a534.d50fa8"
          ]
        ]
      },
      {
        "id": "4ee95eec.50386",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/sim/modify_plan_codes",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 1260,
        "wires": [
          [
            "3ff0e8c.7279e18"
          ]
        ]
      },
      {
        "id": "d2ae0e69.be647",
        "type": "http in",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "url": "/sims/sim/activate_to_state",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 240,
        "wires": [
          [
            "6f3005b7.1b698c"
          ]
        ]
      },
      {
        "id": "bca0653e.bd7688",
        "type": "comment",
        "z": "92b74b12.836b78",
        "name": "APP ID Setup",
        "info": "",
        "x": 90,
        "y": 1240,
        "wires": []
      },
      {
        "id": "fa6e48a2.f91f88",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "APP ID DIsable Password RegEx",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 170,
        "y": 1280,
        "wires": [
          [
            "de624c1.fb6b2b"
          ]
        ]
      },
      {
        "id": "de624c1.fb6b2b",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Mgmt Token",
        "func": "msg.iam = {\n    \"type\": \"appid\",\n    \"mgmt\": true\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 1280,
        "wires": [
          [
            "1d4142b9.be075d"
          ]
        ]
      },
      {
        "id": "1d4142b9.be075d",
        "type": "subflow:ab306e30.d0cc3",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 580,
        "y": 1280,
        "wires": [
          [
            "9dfb927c.4d7f6"
          ]
        ]
      },
      {
        "id": "9dfb927c.4d7f6",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Disable Password RegEx",
        "func": "msg.payload = {\n    \"regex\": \".*[A-Za-z0-9].*\",\n    \"error_message\": \"The password must contain at least 1 alphabetical character or a number\"\n};\nmsg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.appidServiceEndpoint + \"/management/v4/\" + global.get(\"VCAP_APPID\").credentials.tenantId + \"/\";\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.method = \"PUT\";\nmsg.url = msg.appid.mgmt_url + \"config/cloud_directory/password_regex\";\nmsg.headers = msg.appid.headers;\nnode.warn(msg)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 1280,
        "wires": [
          [
            "260feefd.04db32"
          ]
        ]
      },
      {
        "id": "260feefd.04db32",
        "type": "http request",
        "z": "92b74b12.836b78",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1000,
        "y": 1280,
        "wires": [
          [
            "f1c1e4c6.2cab28"
          ]
        ]
      },
      {
        "id": "f1c1e4c6.2cab28",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Request Results",
        "func": "if (msg.statusCode === 200) {\n    node.warn({\"APP ID Password RegEx successfully updated\": msg});\n} else {\n    node.warn({\"APP ID FAILED to update Password RegEx\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 1280,
        "wires": [
          []
        ]
      },
      {
        "id": "efc52a.dca0bad8",
        "type": "inject",
        "z": "92b74b12.836b78",
        "name": "APP ID Enable Password RegEx",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 170,
        "y": 1320,
        "wires": [
          [
            "96cd6020.d9e9e"
          ]
        ]
      },
      {
        "id": "96cd6020.d9e9e",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Get Mgmt Token",
        "func": "msg.iam = {\n    \"type\": \"appid\",\n    \"mgmt\": true\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 400,
        "y": 1320,
        "wires": [
          [
            "d7569e83.118ad"
          ]
        ]
      },
      {
        "id": "d7569e83.118ad",
        "type": "subflow:ab306e30.d0cc3",
        "z": "92b74b12.836b78",
        "name": "",
        "x": 580,
        "y": 1320,
        "wires": [
          [
            "5d21703a.183b5"
          ]
        ]
      },
      {
        "id": "5d21703a.183b5",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Enable Password RegEx",
        "func": "msg.payload = {\n    \"regex\": \"^(?=.*[a-z])(?=.*[A-Z])(?=.*\\\\d)(?=.*[#$.^+=!*()@%&]).{8,20}$\", //global.get(\"REGEXP\").password,\n    \"error_message\": \"The password must contain at least 1 lower case and upper case character a number and one of these symbols [#$.^+=!*()@%&]\"\n};\nmsg.appid.mgmt_url = global.get(\"VCAP_APPID\").credentials.appidServiceEndpoint + \"/management/v4/\" + global.get(\"VCAP_APPID\").credentials.tenantId + \"/\";\nmsg.appid.headers = { \"Authorization\": msg.appid.authorization }\nmsg.method = \"PUT\";\nmsg.url = msg.appid.mgmt_url + \"config/cloud_directory/password_regex\";\nmsg.headers = msg.appid.headers;\nreturn msg;\n\n/*{\n    \"regex\": \"^(?=.*[a-z])(?=.*[A-Z])(?=.*\\\\d)(?=.*[#$.^+=!*()@%&]).{8,20}$\",\n    \"error_message\": \"The password must contain at least 1 lower case and upper case character a number and one of these symbols [#$.^+=!*()@%&]\"\n}*/",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 1320,
        "wires": [
          [
            "cc4ebe8c.a5db7"
          ]
        ]
      },
      {
        "id": "cc4ebe8c.a5db7",
        "type": "http request",
        "z": "92b74b12.836b78",
        "name": "APPID MGMT",
        "method": "use",
        "ret": "obj",
        "url": "",
        "tls": "",
        "x": 1000,
        "y": 1320,
        "wires": [
          [
            "e7e9a6ed.245808"
          ]
        ]
      },
      {
        "id": "e7e9a6ed.245808",
        "type": "function",
        "z": "92b74b12.836b78",
        "name": "Request Results",
        "func": "if (msg.statusCode === 200) {\n    node.warn({\"APP ID Password RegEx successfully updated\": msg});\n} else {\n    node.warn({\"APP ID FAILED to update Password RegEx\": msg});\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1180,
        "y": 1320,
        "wires": [
          []
        ]
      },
      {
        "id": "85fdf298.da17f",
        "type": "comment",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB",
        "info": "",
        "x": 80,
        "y": 40,
        "wires": []
      },
      {
        "id": "343fcbd6.c73474",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 100,
        "wires": [
          [
            "a51d7394.95aa3"
          ]
        ]
      },
      {
        "id": "a51d7394.95aa3",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Case Audit",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Case Audit\"\n    });\nmsg.records = {\n    \"returns\": [\"case_audit\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"CASE_NO\", \"DOC_ID\", \"FILE_NAME\", \"CASE_START_TIME_range_begin\", \"CASE_START_TIME_range_end\", \"JOB_STATUS\"]};\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.CASE_AUDIT\",\n    \"sort\": \"ORDER BY CASE_START_TIME DESC\",\n    \"limit\": 100,\n    \"object\": \"case_audit\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 100,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "10197903.66fa77",
        "type": "subflow:71afa3f9.81defc",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 900,
        "y": 220,
        "wires": [
          [
            "f49e05a2.6a60d8"
          ]
        ]
      },
      {
        "id": "f49e05a2.6a60d8",
        "type": "subflow:5b840ccd.bdbfc4",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 1060,
        "y": 220,
        "wires": [
          [
            "82f0b93.2ad0148"
          ]
        ]
      },
      {
        "id": "82f0b93.2ad0148",
        "type": "subflow:bc6ff87.05a2908",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 1230,
        "y": 220,
        "wires": []
      },
      {
        "id": "d3e91b02.31fc58",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/cases",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 140,
        "wires": [
          [
            "18604523.83434b"
          ]
        ]
      },
      {
        "id": "18604523.83434b",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 140,
        "wires": [
          [
            "9337e8b1.ea6eb8"
          ]
        ]
      },
      {
        "id": "9337e8b1.ea6eb8",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Cases",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Cases\"\n    });\nmsg.records = {\n    \"returns\": [\"cases\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"CASE_ID\",\"USER_ID\",\"FACILITY_ID\",\"MACHINE_ID\",\"LOCATION_ID\",\"VERSION_ID\",\"CASE_NO\",\"LOG_ID\",\"CASE_TYPE\",\"SYSTEM_SN\",\"SYSTEM_TYPE\",\"FLAG\",\"CATEGORY1\",\"CATEGORY2\",\"CASE_STATUS\",\"CREATED_BY\",\"START_TIME_range_begin\",\"START_TIME_range_end\"]};\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.CASE\",\n    \"sort\": \"ORDER BY START_TIME DESC\",\n    \"limit\": 100,\n    \"object\": \"cases\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 140,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "1801d191.d2d90e",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Phase Events",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Phase Events\"\n    });\nmsg.records = {\n    \"returns\": [\"phase_events\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"PHASE_ID\",\"CASE_ID\",\"EVENT_ID\",\"EVENT_NAME\",\"SYSTEM_SN\",\"FACILITY_NAME\",\"SURGEON_NAME\",\"ROOM_NAME\",\"CASE_NUMBER\",\"TECHNIQUE\",\"MODE\",\"MODE_TYPE\",\"NEEDLE\",\"GRADE\",\"UNUSED1\",\"UNUSED2\",\"SUBMODE_ID\",\"US_SUBMODE\",\"PHASE_DATETIME_range_begin\",\"PHASE_DATETIME_range_end\"]};\n\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.PHASE_EVENT\",\n    \"sort\": \"ORDER BY PHASE_DATETIME DESC\",\n    \"limit\": 100,\n    \"object\": \"phase_events\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 180,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "c2e6d6ad.b542c8",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 180,
        "wires": [
          [
            "1801d191.d2d90e"
          ]
        ]
      },
      {
        "id": "8e3096aa.21c908",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/phase_events",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 180,
        "wires": [
          [
            "c2e6d6ad.b542c8"
          ]
        ]
      },
      {
        "id": "296dbddb.a4a782",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Users",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Users\"\n    });\nmsg.records = {\n    \"returns\": [\"users\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"USER_ID\",\"UID\",\"STATUS\",\"CREATED_BY\",\"MODIFIED_BY\",\"CREATED_DATETIME_range_begin\",\"CREATED_DATETIME_range_end\"]};\n\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.USER_MASTER\",\n    \"sort\": \"ORDER BY CREATED_DATETIME DESC\",\n    \"limit\": 100,\n    \"object\": \"users\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 640,
        "y": 260,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "d9d949bf.2c0cd8",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 260,
        "wires": [
          [
            "296dbddb.a4a782"
          ]
        ]
      },
      {
        "id": "88d59ef1.39505",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/users",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 260,
        "wires": [
          [
            "d9d949bf.2c0cd8"
          ]
        ]
      },
      {
        "id": "3d68c754.570218",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Case Facts",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Case Facts\"\n    });\nmsg.records = {\n    \"returns\": [\"case_facts\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"CASE_FACT_ID\",\"CASE_ID\",\"USER_ID\",\"PHASE_EVENT_ID\",\"CASE_NO\",\"MODE\",\"SUBMODE\",\"FACILITY\",\"FACILITY_ID\",\"MACHINE\",\"MACHINE_ID\",\"CASE_TYPE\",\"CASE_LABEL\",\"CREATED_BY\"]};\n\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.CASE_FACT\",\n    \"sort\": \"ORDER BY EVENT_DATETIME DESC\",\n    \"limit\": 100,\n    \"object\": \"case_facts\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 220,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "389615af.ee0b1a",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 220,
        "wires": [
          [
            "3d68c754.570218"
          ]
        ]
      },
      {
        "id": "11be3429.700a0c",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/case_facts",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 220,
        "wires": [
          [
            "389615af.ee0b1a"
          ]
        ]
      },
      {
        "id": "e8f34b1.5ddabb8",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Facilities",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Facilities\"\n    });\nmsg.records = {\n    \"returns\": [\"facilities\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"FACILITY_ID\",\"FACILITY_ACCOUNT_ID\",\"FACILITY_NAME\",\"FACILITY_ADDRESS\",\"CREATED_BY\",\"MODIFIED_BY\",\"CREATED_DATETIME_range_begin\",\"CREATED_DATETIME_range_end\"]};\n\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.FACILITY_MASTER\",\n    \"sort\": \"ORDER BY CREATED_DATETIME DESC\",\n    \"limit\": 100,\n    \"object\": \"facilities\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 300,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "329fc9a3.16bc46",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 300,
        "wires": [
          [
            "e8f34b1.5ddabb8"
          ]
        ]
      },
      {
        "id": "8b75456f.3fd7a8",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/facilities",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 300,
        "wires": [
          [
            "329fc9a3.16bc46"
          ]
        ]
      },
      {
        "id": "bf91760d.37baa8",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Machines",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Machines\"\n    });\nmsg.records = {\n    \"returns\": [\"machines\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"MACHINE_ID\",\"SYSTEM_SN\",\"SYSTEM_TYPE\",\"CREATED_BY\",\"MODIFIED_BY\",\"CREATED_DATETIME_range_begin\",\"CREATED_DATETIME_range_end\"]};\n\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.MACHINE_MASTER\",\n    \"sort\": \"ORDER BY SYSTEM_SN DESC\",\n    \"limit\": 100,\n    \"object\": \"machines\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 340,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "5a94863.9519678",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 340,
        "wires": [
          [
            "bf91760d.37baa8"
          ]
        ]
      },
      {
        "id": "460d51f9.2457c",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/machines",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 340,
        "wires": [
          [
            "5a94863.9519678"
          ]
        ]
      },
      {
        "id": "24426e48.147232",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/case_audit",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 100,
        "wires": [
          [
            "343fcbd6.c73474"
          ]
        ]
      },
      {
        "id": "8e087da9.ec6ef",
        "type": "comment",
        "z": "92b74b12.836b78",
        "name": "Delete inactive devices in APP ID",
        "info": "",
        "x": 150,
        "y": 1120,
        "wires": []
      },
      {
        "id": "ff6d23a8.e555f",
        "type": "function",
        "z": "8c1ef78e.3b4798",
        "name": "DashDB Locations",
        "func": "msg.api = Object.assign(msg.api,\n    {\n        \"name\": \"DashDB Locations\"\n    });\nmsg.records = {\n    \"returns\": [\"locations\"]\n};\nmsg.inputs = {\n    \"required\": [],\n    \"allowed\": [\"filter_options\"]};\nmsg.filters = {\n    \"required\": [],\n    \"allowed\": [\"LOCATION_ID\",\"CARRIER\",\"CELLID\",\"LOCATION_AREA_CODE\",\"MOBILE_COUNTRY_CODE\",\"MOBILE_NETWORK_CODE\",\"GPS_LAT\",\"GPS_LONG\",\"STREET_ADDRESS\",\"CITY\"]};\n\nmsg.dashdb = {\n    \"select\": \"SELECT * FROM REPORT_DB.LOCATION_MASTER\",\n    \"sort\": \"ORDER BY CITY DESC\",\n    \"limit\": 100,\n    \"object\": \"locations\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 380,
        "wires": [
          [
            "10197903.66fa77"
          ]
        ]
      },
      {
        "id": "ec7fe3e0.16806",
        "type": "subflow:3962857e.44abba",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "x": 450,
        "y": 380,
        "wires": [
          [
            "ff6d23a8.e555f"
          ]
        ]
      },
      {
        "id": "9d2457e7.22fd68",
        "type": "http in",
        "z": "8c1ef78e.3b4798",
        "name": "",
        "url": "/dashdb/locations",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 380,
        "wires": [
          [
            "ec7fe3e0.16806"
          ]
        ]
      },
      {
        "id": "fcbe3ce0.afe1e",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "EDHR Sims",
        "func": "msg.records.sim_present = [];\nmsg.sims = [];\nvar edhr = msg.edhr[0];\nif (edhr.hasOwnProperty(\"modlist\")){\n    if (edhr.modlist.hasOwnProperty(\"sim1_iccid\") && edhr.modlist.sim1_iccid.present === \"PRESENT\"){ msg.records.sim_present.push(edhr.modlist.sim1_iccid.SN) }\n    if (edhr.modlist.hasOwnProperty(\"sim2_iccid\") && edhr.modlist.sim2_iccid.present === \"PRESENT\"){ msg.records.sim_present.push(edhr.modlist.sim2_iccid.SN) }\n}\nif (msg.records.sim_present.length > 0) {\n    msg.sim_provider = {\n        \"req_type\": \"status\",\n        \"sim_iccid\": msg.records.sim_present.pop(),\n        \"object\": \"sim\"\n    }\n    return [msg,null];\n}\nmsg.records.returns.splice(msg.records.returns.indexOf(\"sims\"), 1)\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "x": 2370,
        "y": 280,
        "wires": [
          [
            "547b5bc9.3f8334"
          ],
          [
            "45b0ab31.18db54"
          ]
        ],
        "outputLabels": [
          "sims present",
          "no sims"
        ]
      },
      {
        "id": "64799739.52d7e8",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Set Custom Info",
        "func": "if (msg.hasOwnProperty(\"sim\") && msg.sim.length > 0  && msg.sim[0].status === \"Deactivated\") {\n    return[null,msg]\n} else {\n    msg.sim_provider.body = {\n        \"deviceNumber\": msg.sim_provider.sim_iccid,\n        \"customField1\": msg.device[0].system_type,\n        \"customField2\": msg.device[0]._id,\n        \"customField3\": \"\",\n        \"customField4\": \"\",\n        \"customField5\": \"\",\n        \"customField6\": \"\"\n    }\n    msg.sim_provider.req_type = \"update_info\"\n    return [msg,null];\n}",
        "outputs": 2,
        "noerr": 0,
        "x": 2700,
        "y": 260,
        "wires": [
          [
            "1a89e870.280498"
          ],
          [
            "9cef31e9.a7408"
          ]
        ],
        "outputLabels": [
          "sim active",
          "sim not active"
        ]
      },
      {
        "id": "c34852a.da908b",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Deactivate Sim",
        "func": "if(msg.inputs.field_birth) {\n    delete msg.sim_provider.req_type;\n} else {\n    msg.sim_provider.req_type = \"deactivate\";\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3040,
        "y": 240,
        "wires": [
          [
            "1fb16923.bc9157"
          ]
        ]
      },
      {
        "id": "9cef31e9.a7408",
        "type": "function",
        "z": "c13a158d.882c9",
        "name": "Next Sim",
        "func": "if (msg.records.sim_present.length > 0) {\n    msg.sim_provider.sim_iccid = msg.records.sim_present.pop()\n    msg.kore = {\n        \"request\": \"queryDevice\",\n        \"return_obj\": \"d\",\n        \"object\": \"sim\",\n        \"body\": { \"deviceNumber\": msg.sim_provider.sim_iccid }\n    }\n    msg.sims.push(msg.sim[0]);\n    return [null,msg];\n}\nmsg.sims.push(msg.sim[0]);\nmsg.records.delete = [\"__type\", \"requestStatus\", \"MSISDNOrMDN\", \"currentDataPlan\", \"currentSMSPlan\", \"futureDataPlan\", \"futureSMSPlan\", \"dailyDataThreshold\", \"dailySMSThreshold\", \"monthlyDataThreshold\", \"monthlySMSThreshold\", \"customField4\", \"customField5\", \"customField6\", \"lstHistoryOverLastYear\", \"lstFeatures\", \"staticIP\", \"voiceDispatchNumber\", \"mostRecentLocateId\", \"previousLocateId\", \"mostRecentLocateDate\", \"mostRecentLatitude\", \"mostRecentLongitude\", \"mostRecentAddress\", \"previousLocateDate\", \"previousLatitude\", \"previousLongitude\", \"previousAddress\", \"lstExtFeatures\"];\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "x": 3360,
        "y": 260,
        "wires": [
          [
            "45b0ab31.18db54"
          ],
          [
            "df0facf9.de32f"
          ]
        ],
        "outputLabels": [
          "done",
          "loop"
        ]
      },
      {
        "id": "547b5bc9.3f8334",
        "type": "subflow:80a169dd.f18e78",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2530,
        "y": 260,
        "wires": [
          [
            "64799739.52d7e8"
          ]
        ]
      },
      {
        "id": "1a89e870.280498",
        "type": "subflow:80a169dd.f18e78",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 2870,
        "y": 240,
        "wires": [
          [
            "c34852a.da908b"
          ]
        ]
      },
      {
        "id": "1fb16923.bc9157",
        "type": "subflow:80a169dd.f18e78",
        "z": "c13a158d.882c9",
        "name": "",
        "x": 3210,
        "y": 240,
        "wires": [
          [
            "9cef31e9.a7408"
          ]
        ]
      },
      {
        "id": "ed1d24e.f4bc6d8",
        "type": "function",
        "z": "3962857e.44abba",
        "name": "Missing Credentials",
        "func": "if(!msg.hasOwnProperty(\"errors\")){msg.errors = []}\nmsg.errors.push({\n    \"code\": 401,\n    \"message\": {\n        \"code\": \"missing_credentials\",\n        \"description\":\"Unauthorized - Setup is missing credential file linked to system\"\n    }\n})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 140,
        "wires": [
          [
            "f795cb6f.150988"
          ]
        ]
      },
      {
        "id": "b32e3a8f.3bed18",
        "type": "function",
        "z": "80a169dd.f18e78",
        "name": "KORE Sim",
        "func": "if(msg.sim_provider.details) {\n    msg.sim_provider.delete = [\"__type\", \"requestStatus\", \"staticIP\", \"voiceDispatchNumber\", \"mostRecentLocateId\", \"previousLocateId\", \"mostRecentLocateDate\", \"mostRecentLatitude\", \"mostRecentLongitude\", \"mostRecentAddress\", \"previousLocateDate\", \"previousLatitude\", \"previousLongitude\", \"previousAddress\", \"lstExtFeatures\"]\n} else {\n    msg.sim_provider.delete = [\"__type\", \"requestStatus\", \"MSISDNOrMDN\", \"IMSIOrMIN\", \"currentDataPlan\", \"currentSMSPlan\", \"futureDataPlan\", \"futureSMSPlan\", \"dailyDataThreshold\", \"dailySMSThreshold\", \"monthlyDataThreshold\", \"monthlySMSThreshold\", \"customField1\", \"customField2\", \"customField3\", \"customField4\", \"customField5\", \"customField6\", \"lstHistoryOverLastYear\", \"lstFeatures\", \"staticIP\", \"voiceDispatchNumber\", \"mostRecentLocateId\", \"previousLocateId\", \"mostRecentLocateDate\", \"mostRecentLatitude\", \"mostRecentLongitude\", \"mostRecentAddress\", \"previousLocateDate\", \"previousLatitude\", \"previousLongitude\", \"previousAddress\", \"lstExtFeatures\", \"costCenter\"];\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1910,
        "y": 340,
        "wires": [
          [
            "b8d8f269.e59ea"
          ]
        ]
      },
      {
        "id": "a0a5577b.8dd158",
        "type": "subflow:80a169dd.f18e78",
        "z": "c1ec6ee7.981a18",
        "name": "",
        "x": 1630,
        "y": 740,
        "wires": [
          [
            "761ba67.0445c58"
          ]
        ]
      },
      {
        "id": "4d35c5c1.9be15c",
        "type": "catch",
        "z": "5dbd57cc.fc9bb8",
        "name": "",
        "scope": [
          "b5f8e84c.b5b468"
        ],
        "x": 70,
        "y": 40,
        "wires": [
          [
            "dce52df7.73922"
          ]
        ]
      },
      {
        "id": "dce52df7.73922",
        "type": "function",
        "z": "5dbd57cc.fc9bb8",
        "name": "Email Error",
        "func": "node.error(\"ERROR: Email send FAILED\")\nnode.warn({\"EMAIL ERROR\": msg})\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 210,
        "y": 40,
        "wires": [
          []
        ]
      }
    ]
  }